import{r as i,j as e}from"./index-CZE4Emnq.js";import{d as O}from"./dayjs.min-CnUzT33n.js";import{O as ae,g as se,b8 as r,aM as x,aL as s,aB as f,aX as w,aV as h,ac as F,b5 as oe,aY as le}from"./IdurarOs-QyX9qaVp.js";import{ag as ie,O as ce,l as U,f as z,T as p,d as de,k as ue}from"./ErpApp-C4nlOv7S.js";import{c as me}from"./omrFormat-DnoBT9dY.js";import{A as pe}from"./index-ZuXc2cE4.js";import{C as he}from"./index-CJVnROOn.js";import{S as xe}from"./index-D-f7_sak.js";import{F as fe}from"./Table-B0OV9lnU.js";import{M as N}from"./index-D_Iny5RF.js";import{D as g}from"./index-BKqFnDjH.js";import{s as m}from"./index-DYgSJ7qL.js";import{P as je}from"./index-ZfNXicBO.js";import{P as ye}from"./PlusOutlined-DNId2NLQ.js";import{E as ge}from"./ExclamationCircleOutlined-CDsiE6Ao.js";import"./Skeleton-NJ_axQXU.js";import"./index-DHJTYrEo.js";import"./ActionButton-43bIcezm.js";import"./fade-C5VLvKC6.js";var we={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372 0-89 31.3-170.8 83.5-234.8l523.3 523.3C682.8 852.7 601 884 512 884zm288.5-137.2L277.2 223.5C341.2 171.3 423 140 512 140c205.4 0 372 166.6 372 372 0 89-31.3 170.8-83.5 234.8z"}}]},name:"stop",theme:"outlined"},Se=function(c,a){return i.createElement(ae,se({},c,{ref:a,icon:we}))};const De=i.forwardRef(Se),{Text:I}=le,{TextArea:P}=w;function S(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function A(){return{...S(),"Content-Type":"application/json"}}function Ce(){var o,c;try{return((c=(o=JSON.parse(localStorage.getItem("auth")||"{}"))==null?void 0:o.current)==null?void 0:c.role)||"staff"}catch{return"staff"}}const q=()=>["owner","admin","gm","manager"].includes(Ce()),be={customer:"blue",supplier:"orange",framework:"purple",nda:"default",service:"cyan",maintenance:"gold"},Te={draft:"default",active:"success",expired:"error",terminated:"warning",renewed:"processing"};function Oe(o){return o?Math.ceil((new Date(o)-Date.now())/864e5):null}function Ie({endDate:o,status:c}){if(c==="expired")return e.jsx(p,{color:"error",children:"Expired"});if(c==="terminated")return e.jsx(p,{color:"warning",children:"Terminated"});const a=Oe(o);return a===null?null:a<0?e.jsxs(p,{color:"error",children:["Overdue ",-a,"d"]}):a<=30?e.jsxs(p,{color:"warning",children:[a," days left"]}):a<=60?e.jsxs(p,{color:"orange",children:[a," days left"]}):e.jsxs(p,{color:"success",children:[a," days"]})}function He(){const[o,c]=i.useState([]),[a,J]=i.useState({}),[D,Y]=i.useState([]),[H,B]=i.useState(!1),[u,C]=i.useState({open:!1,record:null}),[M,E]=i.useState({open:!1,id:null}),[$,k]=i.useState({open:!1,id:null}),[b,K]=i.useState("all"),[T]=r.useForm(),[v]=r.useForm(),[R]=r.useForm(),j=async()=>{B(!0);const[t,n,l]=await Promise.all([fetch(h+"contract/list",{headers:S()}).then(d=>d.json()).catch(()=>({})),fetch(h+"contract/stats",{headers:S()}).then(d=>d.json()).catch(()=>({})),fetch(h+"contract/expiring",{headers:S()}).then(d=>d.json()).catch(()=>({}))]);t.success&&c(t.result||[]),n.success&&J(n.result||{}),l.success&&Y(l.result||[]),B(!1)};i.useEffect(()=>{j()},[]);const W=()=>{T.resetFields(),C({open:!0,record:null})},X=t=>{T.setFieldsValue({...t,startDate:t.startDate?O(t.startDate):null,endDate:t.endDate?O(t.endDate):null,renewalDate:t.renewalDate?O(t.renewalDate):null}),C({open:!0,record:t})},G=async t=>{var _,L,V;const n={...t,startDate:(_=t.startDate)==null?void 0:_.toISOString(),endDate:(L=t.endDate)==null?void 0:L.toISOString(),renewalDate:(V=t.renewalDate)==null?void 0:V.toISOString()},l=u.record?`contract/update/${u.record._id}`:"contract/create",d=u.record?"PATCH":"POST",y=await fetch(h+l,{method:d,headers:A(),body:JSON.stringify(n)}).then(re=>re.json()).catch(()=>({}));y.success?(m.success(y.message),C({open:!1,record:null}),j()):m.error(y.message||"Failed")},Q=async t=>{const n=await fetch(h+`contract/delete/${t}`,{method:"DELETE",headers:S()}).then(l=>l.json()).catch(()=>({}));n.success?(m.success("Deleted"),j()):m.error(n.message)},Z=async t=>{const n=await fetch(h+`contract/terminate/${M.id}`,{method:"PATCH",headers:A(),body:JSON.stringify({reason:t.reason})}).then(l=>l.json()).catch(()=>({}));n.success?(m.success("Contract terminated"),E({open:!1}),j()):m.error(n.message)},ee=async t=>{var l,d;const n=await fetch(h+`contract/renew/${$.id}`,{method:"PATCH",headers:A(),body:JSON.stringify({newEndDate:(l=t.newEndDate)==null?void 0:l.toISOString(),newRenewalDate:(d=t.newRenewalDate)==null?void 0:d.toISOString()})}).then(y=>y.json()).catch(()=>({}));n.success?(m.success("Contract renewed"),k({open:!1}),j()):m.error(n.message)},te=b==="all"?o:o.filter(t=>t.status===b),ne=[{title:"#",dataIndex:"contractNumber",width:100,render:t=>e.jsx(I,{strong:!0,style:{color:"#034D57"},children:t})},{title:"Title",dataIndex:"title",render:(t,n)=>e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:t}),e.jsx(I,{type:"secondary",style:{fontSize:11},children:n.partyName})]})},{title:"Type",dataIndex:"contractType",width:110,render:t=>e.jsx(p,{color:be[t],children:t==null?void 0:t.toUpperCase()})},{title:"Value",dataIndex:"value",width:130,render:t=>t?me(t):e.jsx(I,{type:"secondary",children:"—"})},{title:"End Date",dataIndex:"endDate",width:110,render:t=>t?O(t).format("DD MMM YYYY"):"—"},{title:"Time Left",key:"daysLeft",width:120,render:(t,n)=>e.jsx(Ie,{endDate:n.endDate,status:n.status})},{title:"Status",dataIndex:"status",width:100,render:t=>e.jsx(p,{color:Te[t],children:t==null?void 0:t.toUpperCase()})},{title:"",key:"actions",width:150,render:(t,n)=>q()?e.jsxs(U,{size:4,children:[e.jsx(F,{title:"Edit",children:e.jsx(f,{size:"small",icon:e.jsx(oe,{}),onClick:()=>X(n)})}),n.status==="active"&&e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"Terminate",children:e.jsx(f,{size:"small",danger:!0,icon:e.jsx(De,{}),onClick:()=>{v.resetFields(),E({open:!0,id:n._id})}})}),e.jsx(F,{title:"Renew",children:e.jsx(f,{size:"small",icon:e.jsx(de,{}),style:{color:"#4CB480"},onClick:()=>{R.resetFields(),k({open:!0,id:n._id})}})})]}),e.jsx(je,{title:"Delete this contract?",onConfirm:()=>Q(n._id),children:e.jsx(f,{size:"small",danger:!0,icon:e.jsx(ue,{})})})]}):e.jsx(I,{type:"secondary",style:{fontSize:11},children:"View only"})}];return e.jsxs("div",{style:{padding:24},children:[e.jsxs(x,{justify:"space-between",align:"middle",style:{marginBottom:20},children:[e.jsx(s,{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[e.jsx(ie,{style:{fontSize:22,color:"#034D57"}}),e.jsx("span",{style:{fontSize:20,fontWeight:700,color:"#034D57"},children:"Contract Management"})]})}),q()&&e.jsx(s,{children:e.jsx(f,{type:"primary",icon:e.jsx(ye,{}),onClick:W,style:{background:"#034D57"},children:"New Contract"})})]}),D.length>0&&e.jsx(pe,{type:"warning",showIcon:!0,icon:e.jsx(ge,{}),message:`${D.length} contract${D.length>1?"s":""} expiring within 30 days`,description:D.map(t=>`${t.contractNumber} — ${t.title} (${t.partyName})`).join(", "),style:{marginBottom:16}}),e.jsx(x,{gutter:16,style:{marginBottom:20},children:[{title:"Active",value:a.active||0,color:"#4CB480"},{title:"Expiring Soon",value:a.expiring||0,color:"#fa8c16"},{title:"Expired",value:a.expired||0,color:"#ff4d4f"},{title:"Total Value (Active)",value:a.totalValue?Number(a.totalValue).toLocaleString("en-US",{minimumFractionDigits:3}):"0.000",color:"#034D57",prefix:e.jsx(ce,{size:14})}].map(t=>e.jsx(s,{span:6,children:e.jsx(he,{size:"small",style:{textAlign:"center",borderTop:`3px solid ${t.color}`},children:e.jsx(xe,{title:t.title,value:t.value,prefix:t.prefix,valueStyle:{color:t.color,fontSize:22}})})},t.title))}),e.jsx(U,{style:{marginBottom:12},children:["all","active","expiring","expired","terminated"].map(t=>e.jsx(f,{size:"small",type:b===t?"primary":"default",onClick:()=>K(t),style:b===t?{background:"#034D57"}:{},children:t==="expiring"?"Expiring Soon":t.charAt(0).toUpperCase()+t.slice(1)},t))}),e.jsx(fe,{columns:ne,dataSource:te,rowKey:"_id",loading:H,size:"small",pagination:{pageSize:20}}),e.jsx(N,{open:u.open,title:u.record?`Edit Contract — ${u.record.contractNumber}`:"New Contract",onCancel:()=>C({open:!1,record:null}),onOk:()=>T.submit(),width:680,okText:u.record?"Save Changes":"Create Contract",okButtonProps:{style:{background:"#034D57"}},children:e.jsxs(r,{form:T,layout:"vertical",onFinish:G,children:[e.jsxs(x,{gutter:16,children:[e.jsx(s,{span:16,children:e.jsx(r.Item,{name:"title",label:"Contract Title",rules:[{required:!0}],children:e.jsx(w,{})})}),e.jsx(s,{span:8,children:e.jsx(r.Item,{name:"contractType",label:"Type",rules:[{required:!0}],children:e.jsx(z,{options:["customer","supplier","framework","nda","service","maintenance"].map(t=>({value:t,label:t.charAt(0).toUpperCase()+t.slice(1)}))})})})]}),e.jsxs(x,{gutter:16,children:[e.jsx(s,{span:8,children:e.jsx(r.Item,{name:"partyType",label:"Party Type",children:e.jsx(z,{options:[{value:"client",label:"Client"},{value:"vendor",label:"Vendor"},{value:"other",label:"Other"}]})})}),e.jsx(s,{span:16,children:e.jsx(r.Item,{name:"partyName",label:"Party Name",rules:[{required:!0}],children:e.jsx(w,{})})})]}),e.jsxs(x,{gutter:16,children:[e.jsx(s,{span:8,children:e.jsx(r.Item,{name:"value",label:"Contract Value (OMR)",children:e.jsx(w,{type:"number",step:"0.001",min:0})})}),e.jsx(s,{span:8,children:e.jsx(r.Item,{name:"startDate",label:"Start Date",children:e.jsx(g,{style:{width:"100%"}})})}),e.jsx(s,{span:8,children:e.jsx(r.Item,{name:"endDate",label:"End Date",rules:[{required:!0}],children:e.jsx(g,{style:{width:"100%"}})})})]}),e.jsxs(x,{gutter:16,children:[e.jsx(s,{span:12,children:e.jsx(r.Item,{name:"renewalDate",label:"Renewal Date (optional)",children:e.jsx(g,{style:{width:"100%"}})})}),e.jsx(s,{span:12,children:e.jsx(r.Item,{name:"alertDays",label:"Alert Days Before Expiry",children:e.jsx(w,{type:"number",defaultValue:30})})})]}),e.jsx(r.Item,{name:"description",label:"Key Terms / Scope",children:e.jsx(P,{rows:3})}),e.jsx(r.Item,{name:"notes",label:"Notes",children:e.jsx(P,{rows:2})}),!u.record&&e.jsx(r.Item,{name:"status",label:"Status",initialValue:"active",children:e.jsx(z,{options:[{value:"draft",label:"Draft"},{value:"active",label:"Active"}]})})]})}),e.jsx(N,{open:M.open,title:"Terminate Contract",onCancel:()=>E({open:!1}),onOk:()=>v.submit(),okText:"Terminate",okButtonProps:{danger:!0},children:e.jsx(r,{form:v,layout:"vertical",onFinish:Z,children:e.jsx(r.Item,{name:"reason",label:"Termination Reason",rules:[{required:!0}],children:e.jsx(P,{rows:3,placeholder:"Reason for termination..."})})})}),e.jsx(N,{open:$.open,title:"Renew Contract",onCancel:()=>k({open:!1}),onOk:()=>R.submit(),okText:"Renew",okButtonProps:{style:{background:"#4CB480"}},children:e.jsxs(r,{form:R,layout:"vertical",onFinish:ee,children:[e.jsx(r.Item,{name:"newEndDate",label:"New End Date",rules:[{required:!0}],children:e.jsx(g,{style:{width:"100%"}})}),e.jsx(r.Item,{name:"newRenewalDate",label:"Next Renewal Date (optional)",children:e.jsx(g,{style:{width:"100%"}})})]})})]})}export{He as default};
