import{r,j as t}from"./index-DCzm5dYH.js";import{b as U}from"./omrFormat-Dsvn8I6O.js";import{d as m}from"./dayjs.min-CaCYvAJ2.js";import{b8 as s,aV as u,aB as o,aM as A,aL as a,aX as T,aY as W,ac as G}from"./IdurarOs-5H8D4UsJ.js";import{F as Q}from"./Table-BCwmfyLN.js";import{M as K}from"./index-CwsGysb2.js";import{f as D,k as M,l as O,T as R}from"./ErpApp-BJzr13dj.js";import{T as f}from"./index-BulYuMtM.js";import{D as N}from"./index-B1FqXQtc.js";import{S as q}from"./index-kCZpe5vY.js";import{s as y}from"./index-CPOrKpva.js";import{P as X}from"./index-DVhdscOK.js";import{P as F}from"./PlusOutlined-BqRacPGF.js";import{T as Z}from"./ThunderboltOutlined-D5P64Uiz.js";import"./ActionButton-D2FNOrMo.js";import"./fade-C2b5p5I8.js";const{Title:ee}=W;function g(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function te(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`,"Content-Type":"application/json"}}const E={weekly:"Weekly",monthly:"Monthly",quarterly:"Quarterly",biannual:"Every 6 months",annual:"Annual"};function fe(){const[P,L]=r.useState([]),[z,b]=r.useState(!1),[V,k]=r.useState(!1),[h,v]=r.useState(null),[_,B]=r.useState([]),[p]=s.useForm(),[w,c]=r.useState([{key:0,itemName:"",quantity:1,price:0}]),j=async()=>{b(!0);const e=await fetch(u+"recurringinvoice/list",{headers:g()}).then(n=>n.json()).catch(()=>({}));e.success&&L(e.result||[]),b(!1)};r.useEffect(()=>{j(),fetch(u+"client/listAll",{headers:g()}).then(e=>e.json()).then(e=>e.result&&B(e.result)).catch(()=>{})},[]);const C=(e=null)=>{var n,i;v(e),e?(p.setFieldsValue({...e,startDate:e.startDate?m(e.startDate):null,endDate:e.endDate?m(e.endDate):null,client:((n=e.client)==null?void 0:n._id)||e.client}),(i=e.items)!=null&&i.length&&c(e.items.map((d,l)=>({...d,key:l})))):(p.setFieldsValue({frequency:"monthly",dayOfMonth:1,taxRate:5,currency:"OMR",isActive:!0,autoSend:!1}),c([{key:0,itemName:"",quantity:1,price:0}])),k(!0)},I=()=>{k(!1),p.resetFields(),v(null),c([{key:0,itemName:"",quantity:1,price:0}])},Y=async e=>{var d,l;const n=h?u+`recurringinvoice/update/${h._id}`:u+"recurringinvoice/create",i=await fetch(n,{method:h?"PATCH":"POST",headers:te(),body:JSON.stringify({...e,items:w.map(x=>({...x,total:x.quantity*x.price})),startDate:(d=e.startDate)==null?void 0:d.toISOString(),endDate:(l=e.endDate)==null?void 0:l.toISOString()})}).then(x=>x.json()).catch(()=>({}));i.success?(y.success(h?"Updated":"Created"),I(),j()):y.error(i.message||"Failed")},$=async e=>{const n=await fetch(u+`recurringinvoice/generate/${e}`,{method:"POST",headers:g()}).then(i=>i.json()).catch(()=>({}));n.success?y.success("Invoice generated!"):y.error(n.message||"Failed"),j()},J=async e=>{await fetch(u+`recurringinvoice/delete/${e}`,{method:"DELETE",headers:g()}),y.success("Deleted"),j()},S=(e,n,i)=>c(d=>d.map(l=>l.key===e?{...l,[n]:i}:l)),H=[{title:"Name",dataIndex:"name",ellipsis:!0,render:(e,n)=>t.jsx("a",{onClick:()=>C(n),style:{color:"#034D57",fontWeight:600},children:e})},{title:"Client",dataIndex:["client","name"],render:e=>e||"—"},{title:"Frequency",dataIndex:"frequency",render:e=>E[e]||e},{title:"Next Run",dataIndex:"nextRunAt",render:e=>e?t.jsx(R,{color:m(e)<m()?"red":"blue",children:m(e).format("DD MMM YYYY")}):"—"},{title:"Generated",dataIndex:"generatedCount",align:"center",render:e=>e||0},{title:"Status",dataIndex:"isActive",render:e=>t.jsx(R,{color:e?"green":"default",children:e?"Active":"Paused"})},{title:"",width:90,render:(e,n)=>t.jsxs(O,{children:[t.jsx(G,{title:"Generate now",children:t.jsx(o,{size:"small",icon:t.jsx(Z,{}),onClick:()=>$(n._id)})}),t.jsx(X,{title:"Delete?",onConfirm:()=>J(n._id),children:t.jsx(o,{size:"small",danger:!0,icon:t.jsx(M,{})})})]})}];return t.jsxs("div",{style:{padding:24},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsx(ee,{level:4,style:{margin:0,color:"#034D57"},children:"Recurring Invoices"}),t.jsx(o,{type:"primary",icon:t.jsx(F,{}),onClick:()=>C(),style:{background:"#034D57"},children:"New Recurring"})]}),t.jsx(Q,{columns:H,dataSource:P,rowKey:"_id",loading:z,size:"small"}),t.jsx(K,{title:h?"Edit Recurring Invoice":"New Recurring Invoice",open:V,onCancel:I,footer:null,width:700,children:t.jsxs(s,{form:p,layout:"vertical",onFinish:Y,children:[t.jsxs(A,{gutter:12,children:[t.jsx(a,{xs:24,sm:16,children:t.jsx(s.Item,{name:"name",label:"Name / Label",rules:[{required:!0}],children:t.jsx(T,{placeholder:"e.g. Monthly Retainer — RAFO"})})}),t.jsx(a,{xs:24,sm:8,children:t.jsx(s.Item,{name:"currency",label:"Currency",initialValue:"OMR",children:t.jsx(D,{options:["OMR","USD"].map(e=>({value:e,label:e}))})})}),t.jsx(a,{xs:24,sm:12,children:t.jsx(s.Item,{name:"client",label:"Client",rules:[{required:!0}],children:t.jsx(D,{showSearch:!0,filterOption:(e,n)=>n.label.toLowerCase().includes(e.toLowerCase()),options:_.map(e=>({value:e._id,label:e.name}))})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"frequency",label:"Frequency",initialValue:"monthly",children:t.jsx(D,{options:Object.entries(E).map(([e,n])=>({value:e,label:n}))})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"dayOfMonth",label:"Day of Month",initialValue:1,children:t.jsx(f,{min:1,max:28,style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"startDate",label:"Start Date",rules:[{required:!0}],initialValue:m(),children:t.jsx(N,{style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"endDate",label:"End Date",children:t.jsx(N,{style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:8,children:t.jsx(s.Item,{name:"taxRate",label:"Tax %",initialValue:5,children:t.jsx(f,{min:0,max:100,style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:8,children:t.jsx(s.Item,{name:"isActive",label:"Active",valuePropName:"checked",initialValue:!0,children:t.jsx(q,{})})}),t.jsx(a,{xs:12,sm:8,children:t.jsx(s.Item,{name:"autoSend",label:"Auto-send email",valuePropName:"checked",initialValue:!1,children:t.jsx(q,{})})})]}),t.jsx("div",{style:{margin:"12px 0 6px",fontWeight:600},children:"Line Items"}),w.map(e=>t.jsxs(A,{gutter:8,style:{marginBottom:4},children:[t.jsx(a,{flex:"auto",children:t.jsx(T,{size:"small",placeholder:"Item description",value:e.itemName,onChange:n=>S(e.key,"itemName",n.target.value)})}),t.jsx(a,{style:{width:70},children:t.jsx(f,{size:"small",min:0,precision:0,value:e.quantity,onChange:n=>S(e.key,"quantity",n||1),style:{width:"100%"}})}),t.jsx(a,{style:{width:110},children:t.jsx(f,{size:"small",min:0,precision:3,value:e.price,onChange:n=>S(e.key,"price",n||0),style:{width:"100%"},addonAfter:U()})}),t.jsx(a,{children:t.jsx(o,{size:"small",danger:!0,icon:t.jsx(M,{}),onClick:()=>c(n=>n.filter(i=>i.key!==e.key))})})]},e.key)),t.jsx(o,{size:"small",type:"dashed",icon:t.jsx(F,{}),onClick:()=>c(e=>[...e,{key:Date.now(),itemName:"",quantity:1,price:0}]),style:{marginTop:6},children:"Add Line"}),t.jsx("div",{style:{textAlign:"right",marginTop:16},children:t.jsxs(O,{children:[t.jsx(o,{onClick:I,children:"Cancel"}),t.jsx(o,{type:"primary",htmlType:"submit",style:{background:"#034D57"},children:"Save"})]})})]})})]})}export{fe as default};
