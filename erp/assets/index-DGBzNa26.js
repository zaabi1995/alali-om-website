import{m as J,r as i,j as t}from"./index-BcLHfmte.js";import{aZ as A,aB as b,aM as Y,aL as X,a_ as ee,U as te,aY as re}from"./IdurarOs-CAA7UmI0.js";import{R as se}from"./ReloadOutlined-Da9CksPk.js";import{s as R}from"./index-CJYL2ELi.js";import{C as O}from"./index-DWTf_gVa.js";import{S as oe}from"./index-DSY577fm.js";import{r as ae,e as q,T as f,D as le,t as ne,v as ie}from"./ErpApp-CrEd8Ed2.js";import{T as ce}from"./index-D1ScPv_Q.js";import{T as de}from"./ThunderboltOutlined-O3m4ZXLG.js";import{F as ue}from"./Table-DN9_T6-a.js";import"./Skeleton-E-DIzMqP.js";import"./PlusOutlined-BfQRORD2.js";function L(){var y,p;try{const g=(p=(y=JSON.parse(localStorage.getItem("auth")||"{}"))==null?void 0:y.current)==null?void 0:p.token;return g?{Authorization:`Bearer ${g}`}:{}}catch{return{}}}const{Title:he,Text:T}=re,{Option:d}=q,u="#034D57",N="#4CB480",ye={new:"blue",in_progress:"processing",researched:"purple",quoted:"success",won:"green",lost:"red",expired:"default"},fe={ior:"red",routine:"orange",normal:"default"},pe=[{key:"ALL",label:"All"},{key:"RAFO",label:"RAFO"},{key:"RNO",label:"RNO"},{key:"AGD",label:"AGD"},{key:"MOD",label:"MOD"},{key:"PROC",label:"PROC"},{key:"HAS",label:"HAS"},{key:"RAOBOD",label:"RAOBOD"},{key:"RMSG",label:"RMSG"},{key:"EVAL",label:"EVAL"},{key:"ROP",label:"ROP"},{key:"OTHER",label:"Other"}];function Le(){var P,_,D,B,E;const y=J(),[p,g]=i.useState([]),[$,z]=i.useState(!0),[s,F]=i.useState(null),[me,Q]=i.useState({}),[j,I]=i.useState({current:1,pageSize:25,total:0}),[m,U]=i.useState("ALL"),[c,S]=i.useState({status:"",priority:"all",q:""}),[G,V]=i.useState(""),[k,w]=i.useState([]),v=i.useCallback(async()=>{try{const r=await(await fetch(A+"rfq/stats",{headers:L()})).json();r.success&&F(r.result)}catch{}},[]),x=i.useCallback(async(e=1)=>{z(!0);try{const r=new URLSearchParams({page:e,items:j.pageSize,...c.status&&c.status!=="active"?{status:c.status}:c.status==="active"?{status:"new,in_progress,researched"}:{},...c.priority!=="all"?{priority:c.priority}:{},...m!=="ALL"?{client:m}:{},...c.q?{q:c.q}:{}}),a=await(await fetch(A+`rfq/list?${r}`,{headers:L()})).json();if(a.success){g(a.result||[]),I(h=>{var n,M;return{...h,current:e,total:((n=a.pagination)==null?void 0:n.total)||((M=a.result)==null?void 0:M.length)||0}});const l={};(a.result||[]).forEach(h=>{l[h.client]=(l[h.client]||0)+1}),Q(l)}}catch{}finally{z(!1)}},[c,m,j.pageSize]);i.useEffect(()=>{v()},[]),i.useEffect(()=>{x(1)},[c,m]);const C=e=>{if(!e.receivedAt)return null;const r=new Date(e.receivedAt),o=e.priority==="ior"?7:10,a=new Date(r.getTime()+o*864e5);return Math.ceil((a-new Date)/864e5)},H=[{title:"RFQ Number",dataIndex:"rfqNumber",key:"rfqNumber",width:150,render:(e,r)=>t.jsxs("div",{children:[t.jsx(T,{strong:!0,style:{color:u,cursor:"pointer",fontSize:13},onClick:()=>y(`/rfq/${r._id}`),children:e||"â€”"}),r.priority==="ior"&&t.jsx(f,{color:"red",style:{marginLeft:4,fontSize:10},children:"IOR"})]})},{title:"Client",dataIndex:"client",key:"client",width:80,render:e=>t.jsx(f,{color:u,style:{color:"#fff",fontSize:11},children:e})},{title:"Subject",dataIndex:"subject",key:"subject",ellipsis:!0,render:(e,r)=>t.jsx("span",{style:{cursor:"pointer",color:"#374151"},onClick:()=>y(`/rfq/${r._id}`),children:e})},{title:"Priority",dataIndex:"priority",key:"priority",width:90,render:e=>t.jsx(f,{color:fe[e]||"default",children:(e||"").toUpperCase()})},{title:"Status",dataIndex:"status",key:"status",width:110,render:e=>t.jsx(f,{color:ye[e]||"default",children:e==null?void 0:e.replace("_"," ")})},{title:"Parts",key:"parts",width:70,render:(e,r)=>t.jsx(ie,{count:r.partsCount||0,showZero:!0,style:{backgroundColor:r.partsCount>0?N:"#e5e7eb",color:r.partsCount>0?"#fff":"#9ca3af"}})},{title:"Received",dataIndex:"receivedAt",key:"receivedAt",width:100,render:e=>e?new Date(e).toLocaleDateString("en-GB",{timeZone:"Asia/Muscat",day:"2-digit",month:"short"}):"â€”"},{title:"Deadline",key:"deadline",width:110,sorter:(e,r)=>{const o=C(e),a=C(r);return o-a},render:(e,r)=>{if(["expired","quoted","won","lost"].includes(r.status))return t.jsx(T,{type:"secondary",style:{fontSize:11},children:"â€”"});const o=C(r);if(o===null)return t.jsx(T,{type:"secondary",style:{fontSize:11},children:"â€”"});let a,l;return o<0?(a="#ef4444",l=`${Math.abs(o)}d overdue`):o<=2?(a="#ef4444",l=`${o}d left`):o<=5?(a="#f59e0b",l=`${o}d left`):(a="#22c55e",l=`${o}d left`),t.jsx(f,{color:a,style:{fontSize:11,fontWeight:600},children:l})}},{title:"",key:"action",width:60,render:(e,r)=>t.jsx(b,{size:"small",type:"link",style:{color:u,padding:0},onClick:()=>y(`/rfq/${r._id}`),children:"View â†’"})}],W=((P=s==null?void 0:s.byPriority)==null?void 0:P.ior)||0,K=(((_=s==null?void 0:s.byStatus)==null?void 0:_.new)||0)+(((D=s==null?void 0:s.byStatus)==null?void 0:D.in_progress)||0)+(((B=s==null?void 0:s.byStatus)==null?void 0:B.researched)||0),Z=((E=s==null?void 0:s.byStatus)==null?void 0:E.quoted)||0;return t.jsxs("div",{style:{padding:20,background:"#f0f2f5",minHeight:"100vh"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsx(he,{level:3,style:{color:u,margin:0},children:"ðŸ“‹ RFQ Management"}),t.jsx(b,{icon:t.jsx(se,{}),onClick:()=>{v(),x(1)},style:{borderColor:u,color:u},children:"Refresh"}),t.jsx(b,{size:"small",onClick:()=>{const e=["RFQ Number","Client","Subject","Priority","Status","Parts","Received"],r=p.map(n=>[n.rfqNumber||"",n.client||"",(n.subject||"").replace(/,/g,";"),n.priority||"",n.status||"",n.partsCount||0,n.receivedAt?new Date(n.receivedAt).toLocaleDateString("en-GB"):""]),o=[e.join(","),...r.map(n=>n.join(","))].join(`
`),a=new Blob([o],{type:"text/csv"}),l=URL.createObjectURL(a),h=document.createElement("a");h.href=l,h.download=`rfqs-${new Date().toISOString().slice(0,10)}.csv`,h.click(),URL.revokeObjectURL(l),R.success("CSV exported")},style:{borderColor:"#6366f1",color:"#6366f1"},children:"Export CSV"})]}),t.jsx(Y,{gutter:[12,12],style:{marginBottom:16},children:[{title:"Total RFQs",value:(s==null?void 0:s.total)||0,color:u},{title:"Active",value:K,color:"#3b82f6"},{title:"IOR Priority",value:W,color:"#ef4444"},{title:"Total Parts",value:(s==null?void 0:s.totalParts)||0,color:"#6366f1"},{title:"Quoted",value:Z,color:N},{title:"Vendors",value:(s==null?void 0:s.totalVendors)||0,color:"#f59e0b"}].map(({title:e,value:r,color:o})=>t.jsx(X,{xs:8,sm:4,children:t.jsx(O,{size:"small",style:{borderTop:`3px solid ${o}`,borderRadius:8,textAlign:"center"},children:t.jsx(oe,{title:e,value:r,valueStyle:{color:o,fontSize:18,fontWeight:700}})})},e))}),t.jsx(O,{size:"small",style:{marginBottom:12,borderRadius:8},children:t.jsxs(ae,{wrap:!0,children:[t.jsx(ee.Search,{placeholder:"Search RFQ#, part, subject...",value:G,onChange:e=>V(e.target.value),onSearch:e=>S(r=>({...r,q:e})),onPressEnter:e=>S(r=>({...r,q:e.target.value})),style:{width:260},prefix:t.jsx(te,{style:{color:"#9ca3af"}})}),t.jsxs(q,{value:c.status||"active",onChange:e=>S(r=>({...r,status:e})),style:{width:140},children:[t.jsx(d,{value:"active",children:"Active"}),t.jsx(d,{value:"new",children:"New"}),t.jsx(d,{value:"in_progress",children:"In Progress"}),t.jsx(d,{value:"researched",children:"Researched"}),t.jsx(d,{value:"quoted",children:"Quoted"}),t.jsx(d,{value:"won",children:"Won"}),t.jsx(d,{value:"lost",children:"Lost"}),t.jsx(d,{value:"",children:"All Statuses"})]}),t.jsxs(q,{value:c.priority,onChange:e=>S(r=>({...r,priority:e})),style:{width:120},children:[t.jsx(d,{value:"all",children:"All Priority"}),t.jsx(d,{value:"ior",children:"ðŸš¨ IOR"}),t.jsx(d,{value:"routine",children:"Routine"}),t.jsx(d,{value:"normal",children:"Normal"})]})]})}),t.jsxs(O,{style:{borderRadius:8},bodyStyle:{padding:0},children:[t.jsx(ce,{activeKey:m,onChange:e=>{U(e),x(1)},size:"small",style:{paddingLeft:8},items:pe.map(({key:e,label:r})=>({key:e,label:t.jsxs("span",{children:[e==="ALL"?t.jsx(de,{}):null," ",r]})}))}),k.length>0&&t.jsxs("div",{style:{marginBottom:12,padding:"8px 12px",background:"#f0f6f7",borderRadius:8,display:"flex",alignItems:"center",gap:12},children:[t.jsxs(f,{color:u,children:[k.length," selected"]}),t.jsx(le,{menu:{items:[{key:"in_progress",label:"Mark In Progress"},{key:"quoted",label:"Mark Quoted"},{key:"won",label:"Mark Won"},{key:"lost",label:"Mark Lost"},{key:"expired",label:"Mark Expired"}],onClick:async({key:e})=>{try{const o=await(await fetch(A+"rfq/bulk-status",{method:"POST",headers:{...L(),"Content-Type":"application/json"},body:JSON.stringify({ids:k,status:e})})).json();o.success?(R.success(`${o.result.modified} RFQs updated to ${e}`),w([]),x(j.current),v()):R.error(o.message||"Failed")}catch(r){R.error("Error: "+r.message)}}},children:t.jsxs(b,{size:"small",type:"primary",style:{background:u,borderColor:u},children:["Bulk Action ",t.jsx(ne,{})]})}),t.jsx(b,{size:"small",onClick:()=>w([]),children:"Clear"})]}),t.jsx(ue,{rowKey:"_id",rowSelection:{selectedRowKeys:k,onChange:w,columnWidth:36},columns:H,dataSource:p,loading:$,size:"small",pagination:{...j,showSizeChanger:!1,showTotal:e=>`${e} RFQs`,onChange:e=>{I(r=>({...r,current:e})),x(e)}},rowClassName:e=>e.priority==="ior"?"ior-row":"",style:{fontSize:13},scroll:{x:950},onRow:e=>({onClick:r=>{r.target.closest(".ant-checkbox-wrapper")||y(`/rfq/${e._id}`)},style:{cursor:"pointer"}})})]}),t.jsx("style",{children:`
        .ior-row td { background: #fff5f5 !important; }
        .ior-row:hover td { background: #ffe4e4 !important; }
        .ant-tabs-tab { font-size: 12px !important; }
      `})]})}export{Le as default};
