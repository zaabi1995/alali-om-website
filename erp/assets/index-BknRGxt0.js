import{m as X,o as G,r as h,j as e}from"./index-DCPoF18Q.js";import{d as I}from"./dayjs.min-BfZbO4Md.js";import{b8 as i,aV as y,aB as p,aM as w,aL as n,aX as v,aY as J}from"./IdurarOs-36KeyrIs.js";import{C as j}from"./index-B0hILtK3.js";import{e as c,r as K}from"./ErpApp-BmqyEhL9.js";import{D as O}from"./index-BXkfmRGq.js";import{T as k}from"./index-bCuOje51.js";import{F as Q}from"./Table-DV-_NL6F.js";import{s as S}from"./index-DJ9hgZOD.js";import{P as Y}from"./index-Bw2bG_6Z.js";import{A as Z}from"./ArrowLeftOutlined-CrHXb71a.js";import{P as N}from"./PlusOutlined-B7gL6haF.js";import{S as ee}from"./SaveOutlined-DMD2ns1F.js";import{D as te}from"./DeleteOutlined-D1-OuSFx.js";import"./Skeleton-CywRa_UZ.js";import"./index-DuJkkBYn.js";import"./ClockCircleOutlined-BxRz2v_u.js";import"./ActionButton-DUvWW_Gi.js";const{Title:se,Text:Se}=J,{TextArea:F}=v;function re(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`,"Content-Type":"application/json"}}const R=["OMR","USD","EUR","GBP","AED","SAR"],z={key:Date.now(),partNumber:"",description:"",quantity:1,unit:"EA",unitPrice:0,currency:"OMR",hsCode:""};function be(){const f=X(),{id:d}=G(),[b]=i.useForm(),[g,C]=h.useState([{...z}]),[B,E]=h.useState([]),[V,L]=h.useState([]),[M,A]=h.useState(!1),[x,D]=h.useState("OMR");h.useEffect(()=>{const t={Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`};fetch(y+"vendor/listAll",{headers:t}).then(s=>s.json()).then(s=>{s.result&&E(s.result)}).catch(()=>{}),fetch(y+"invoice/listAll",{headers:t}).then(s=>s.json()).then(s=>{s.result&&L(s.result)}).catch(()=>{}),d&&fetch(y+`purchaseorder/read/${d}`,{headers:t}).then(s=>s.json()).then(s=>{var r,l,o;if(s.success&&s.result){const a=s.result;D(a.currency||"OMR"),b.setFieldsValue({vendor:((r=a.vendor)==null?void 0:r._id)||a.vendor,date:a.date?I(a.date):null,deliveryDate:a.deliveryDate?I(a.deliveryDate):null,invoice:((l=a.invoice)==null?void 0:l._id)||a.invoice,currency:a.currency||"OMR",vendorRef:a.vendorRef,incoterms:a.incoterms||"FCA",paymentTerms:a.paymentTerms||"Net 30",deliveryAddress:a.deliveryAddress,shippingCost:a.shippingCost||0,status:a.status||"draft",notes:a.notes}),(o=a.items)!=null&&o.length&&C(a.items.map((P,u)=>({...P,key:u})))}}).catch(()=>{})},[d]);const T=()=>C(t=>[...t,{...z,key:Date.now(),currency:x}]),_=t=>C(s=>s.filter(r=>r.key!==t)),m=(t,s,r)=>C(l=>l.map(o=>o.key===t?{...o,[s]:r}:o)),q=()=>{const t=g.reduce((r,l)=>r+parseFloat(l.unitPrice||0)*parseFloat(l.quantity||0),0),s=parseFloat(b.getFieldValue("shippingCost")||0);return{sub:t,total:t+s}},U=async t=>{var o,a;if(!g.length){S.error("Add at least one item");return}A(!0);const s={...t,date:(o=t.date)==null?void 0:o.toISOString(),deliveryDate:((a=t.deliveryDate)==null?void 0:a.toISOString())||null,items:g},r=d?y+`purchaseorder/update/${d}`:y+"purchaseorder/create",l=d?"PATCH":"POST";try{const u=await(await fetch(r,{method:l,headers:re(),body:JSON.stringify(s)})).json();u.success?(S.success(u.message||"Saved"),f(`/purchase-order/read/${u.result._id}`)):S.error(u.message||"Failed")}catch{S.error("Network error")}finally{A(!1)}},{sub:$,total:H}=q(),W=[{title:"Part Number",dataIndex:"partNumber",width:130,render:(t,s)=>e.jsx(v,{size:"small",value:t,placeholder:"P/N",onChange:r=>m(s.key,"partNumber",r.target.value)})},{title:"Description",dataIndex:"description",width:220,render:(t,s)=>e.jsx(v,{size:"small",value:t,placeholder:"Description",onChange:r=>m(s.key,"description",r.target.value)})},{title:"Qty",dataIndex:"quantity",width:80,render:(t,s)=>e.jsx(k,{size:"small",min:0,value:t,style:{width:"100%"},onChange:r=>m(s.key,"quantity",r)})},{title:"Unit",dataIndex:"unit",width:70,render:(t,s)=>e.jsx(c,{size:"small",value:t,style:{width:"100%"},onChange:r=>m(s.key,"unit",r),options:["EA","SET","PKG","LOT","MTR","KG","LTR","BOX"].map(r=>({value:r,label:r}))})},{title:"Unit Price",dataIndex:"unitPrice",width:100,render:(t,s)=>e.jsx(k,{size:"small",min:0,value:t,step:.01,precision:4,style:{width:"100%"},onChange:r=>m(s.key,"unitPrice",r)})},{title:"Curr.",dataIndex:"currency",width:80,render:(t,s)=>e.jsx(c,{size:"small",value:t||x,style:{width:"100%"},onChange:r=>m(s.key,"currency",r),options:R.map(r=>({value:r,label:r}))})},{title:"HS Code",dataIndex:"hsCode",width:90,render:(t,s)=>e.jsx(v,{size:"small",value:t,placeholder:"HS",onChange:r=>m(s.key,"hsCode",r.target.value)})},{title:"Total",width:100,align:"right",render:(t,s)=>e.jsx("strong",{style:{color:"#034D57"},children:(parseFloat(s.unitPrice||0)*parseFloat(s.quantity||0)).toFixed(3)})},{title:"",width:40,render:(t,s)=>e.jsx(Y,{title:"Remove?",onConfirm:()=>_(s.key),okText:"Yes",cancelText:"No",children:e.jsx(p,{size:"small",danger:!0,type:"text",icon:e.jsx(te,{})})})}];return e.jsxs("div",{style:{padding:"24px",maxWidth:1200},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:20},children:[e.jsx(p,{icon:e.jsx(Z,{}),onClick:()=>f("/purchase-order")}),e.jsx(se,{level:4,style:{margin:0,color:"#034D57"},children:d?"Edit Purchase Order":"New Purchase Order"})]}),e.jsxs(i,{form:b,layout:"vertical",onFinish:U,children:[e.jsxs(w,{gutter:24,children:[e.jsx(n,{xs:24,md:14,children:e.jsx(j,{title:"Order Details",size:"small",style:{marginBottom:16},children:e.jsxs(w,{gutter:16,children:[e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"vendor",label:"Vendor / Supplier",rules:[{required:!0}],children:e.jsx(c,{showSearch:!0,placeholder:"Select vendor",filterOption:(t,s)=>s.label.toLowerCase().includes(t.toLowerCase()),options:B.map(t=>({value:t._id,label:t.companyName}))})})}),e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"invoice",label:"Linked Invoice (optional)",children:e.jsx(c,{showSearch:!0,allowClear:!0,placeholder:"Link to invoice",filterOption:(t,s)=>s.label.toLowerCase().includes(t.toLowerCase()),options:V.map(t=>({value:t._id,label:`INV-${t.number}/${t.year}`}))})})}),e.jsx(n,{xs:24,sm:8,children:e.jsx(i.Item,{name:"date",label:"PO Date",rules:[{required:!0}],initialValue:I(),children:e.jsx(O,{style:{width:"100%"}})})}),e.jsx(n,{xs:24,sm:8,children:e.jsx(i.Item,{name:"deliveryDate",label:"Required By",children:e.jsx(O,{style:{width:"100%"}})})}),e.jsx(n,{xs:24,sm:8,children:e.jsx(i.Item,{name:"currency",label:"Currency",initialValue:"OMR",children:e.jsx(c,{options:R.map(t=>({value:t,label:t})),onChange:t=>D(t)})})}),e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"vendorRef",label:"Vendor Quote Ref",children:e.jsx(v,{placeholder:"Vendor's quote/reference number"})})}),e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"status",label:"Status",initialValue:"draft",children:e.jsx(c,{options:["draft","sent","acknowledged","shipped","received","cancelled"].map(t=>({value:t,label:t.charAt(0).toUpperCase()+t.slice(1)}))})})}),e.jsx(n,{xs:24,children:e.jsx(i.Item,{name:"deliveryAddress",label:"Deliver To Address",children:e.jsx(F,{rows:2,placeholder:"Delivery address"})})})]})})}),e.jsxs(n,{xs:24,md:10,children:[e.jsxs(j,{title:"Terms",size:"small",style:{marginBottom:16},children:[e.jsx(i.Item,{name:"incoterms",label:"Incoterms",initialValue:"FCA",children:e.jsx(c,{options:["FCA","DAP","DDP","EXW","FOB","CIF","CPT"].map(t=>({value:t,label:t}))})}),e.jsx(i.Item,{name:"paymentTerms",label:"Payment Terms",initialValue:"Net 30",children:e.jsx(c,{options:["Advance","Net 15","Net 30","Net 45","Net 60","50/50","25/50/25"].map(t=>({value:t,label:t}))})}),e.jsx(i.Item,{name:"shippingCost",label:"Shipping Cost",initialValue:0,children:e.jsx(k,{min:0,precision:4,style:{width:"100%"},addonAfter:x})})]}),e.jsx(j,{size:"small",style:{background:"#f0f6f7"},children:e.jsxs(w,{gutter:8,children:[e.jsxs(n,{span:12,children:[e.jsx("div",{style:{fontSize:11,color:"#888"},children:"Subtotal"}),e.jsxs("div",{style:{fontWeight:700,color:"#034D57"},children:[$.toFixed(3)," ",x]})]}),e.jsxs(n,{span:12,children:[e.jsx("div",{style:{fontSize:11,color:"#888"},children:"Total"}),e.jsxs("div",{style:{fontWeight:800,fontSize:16,color:"#034D57"},children:[H.toFixed(3)," ",x]})]})]})})]})]}),e.jsx(j,{title:"Line Items",size:"small",style:{marginBottom:16},extra:e.jsx(p,{size:"small",icon:e.jsx(N,{}),onClick:T,style:{color:"#4CB480",borderColor:"#4CB480"},children:"Add Item"}),children:e.jsx("div",{style:{overflowX:"auto"},children:e.jsx(Q,{columns:W,dataSource:g,rowKey:"key",pagination:!1,size:"small",locale:{emptyText:e.jsx(p,{type:"dashed",onClick:T,icon:e.jsx(N,{}),children:"Add first item"})}})})}),e.jsx(j,{title:"Notes",size:"small",style:{marginBottom:16},children:e.jsx(i.Item,{name:"notes",noStyle:!0,children:e.jsx(F,{rows:3,placeholder:"Special terms, notes, instructions..."})})}),e.jsx("div",{style:{textAlign:"right"},children:e.jsxs(K,{children:[e.jsx(p,{onClick:()=>f("/purchase-order"),children:"Cancel"}),e.jsx(p,{type:"primary",htmlType:"submit",loading:M,icon:e.jsx(ee,{}),style:{background:"#034D57",borderColor:"#034D57"},children:d?"Update":"Create Purchase Order"})]})})]})]})}export{be as default};
