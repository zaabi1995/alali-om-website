import{r as l,j as t}from"./index-BolfsKLq.js";import{b as U}from"./omrFormat-FMhdtvvG.js";import{d as m}from"./dayjs.min-CAlYWd28.js";import{aH as s,az as u,ai as o,aB as A,aC as a,aE as T,ar as W,T as G}from"./IdurarOs-ImGZrK6V.js";import{F as Q}from"./Table-DwPC3CMf.js";import{M as K}from"./index-DlaCiiP-.js";import{S as D}from"./index-B4i0fLDO.js";import{T as f}from"./index-DjaKzJDI.js";import{D as O}from"./index-8VRd4o8X.js";import{S as R}from"./index-CsjwnBW5.js";import{m as M}from"./ErpApp-CPyzesRl.js";import{s as p}from"./index-Bcg4oSX2.js";import{T as N}from"./index-HROpVfrd.js";import{P as X}from"./index-Cbsb8sNQ.js";import{P as q}from"./PlusOutlined-CXeZI9c1.js";import{D as E}from"./DeleteOutlined-Drg8rgxA.js";import{T as Z}from"./ThunderboltOutlined-C0exu4-p.js";import"./pickAttrs-rA9L7BI5.js";import"./DownOutlined-CA7fmMYD.js";import"./Pagination-xSPnpsLs.js";import"./ActionButton-qVzEXLW3.js";import"./useClosable-B9lNjp8n.js";import"./fade-CMN8M_Sw.js";import"./ClockCircleOutlined-C3FhYHW8.js";const{Title:ee}=W;function g(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function te(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`,"Content-Type":"application/json"}}const F={weekly:"Weekly",monthly:"Monthly",quarterly:"Quarterly",biannual:"Every 6 months",annual:"Annual"};function we(){const[P,z]=l.useState([]),[L,b]=l.useState(!1),[_,k]=l.useState(!1),[h,v]=l.useState(null),[V,B]=l.useState([]),[y]=s.useForm(),[w,c]=l.useState([{key:0,itemName:"",quantity:1,price:0}]),j=async()=>{b(!0);const e=await fetch(u+"recurringinvoice/list",{headers:g()}).then(n=>n.json()).catch(()=>({}));e.success&&z(e.result||[]),b(!1)};l.useEffect(()=>{j(),fetch(u+"client/listAll",{headers:g()}).then(e=>e.json()).then(e=>e.result&&B(e.result)).catch(()=>{})},[]);const C=(e=null)=>{var n,i;v(e),e?(y.setFieldsValue({...e,startDate:e.startDate?m(e.startDate):null,endDate:e.endDate?m(e.endDate):null,client:((n=e.client)==null?void 0:n._id)||e.client}),(i=e.items)!=null&&i.length&&c(e.items.map((d,r)=>({...d,key:r})))):(y.setFieldsValue({frequency:"monthly",dayOfMonth:1,taxRate:5,currency:"OMR",isActive:!0,autoSend:!1}),c([{key:0,itemName:"",quantity:1,price:0}])),k(!0)},I=()=>{k(!1),y.resetFields(),v(null),c([{key:0,itemName:"",quantity:1,price:0}])},$=async e=>{var d,r;const n=h?u+`recurringinvoice/update/${h._id}`:u+"recurringinvoice/create",i=await fetch(n,{method:h?"PATCH":"POST",headers:te(),body:JSON.stringify({...e,items:w.map(x=>({...x,total:x.quantity*x.price})),startDate:(d=e.startDate)==null?void 0:d.toISOString(),endDate:(r=e.endDate)==null?void 0:r.toISOString()})}).then(x=>x.json()).catch(()=>({}));i.success?(p.success(h?"Updated":"Created"),I(),j()):p.error(i.message||"Failed")},H=async e=>{const n=await fetch(u+`recurringinvoice/generate/${e}`,{method:"POST",headers:g()}).then(i=>i.json()).catch(()=>({}));n.success?p.success("Invoice generated!"):p.error(n.message||"Failed"),j()},J=async e=>{await fetch(u+`recurringinvoice/delete/${e}`,{method:"DELETE",headers:g()}),p.success("Deleted"),j()},S=(e,n,i)=>c(d=>d.map(r=>r.key===e?{...r,[n]:i}:r)),Y=[{title:"Name",dataIndex:"name",ellipsis:!0,render:(e,n)=>t.jsx("a",{onClick:()=>C(n),style:{color:"#034D57",fontWeight:600},children:e})},{title:"Client",dataIndex:["client","name"],render:e=>e||"—"},{title:"Frequency",dataIndex:"frequency",render:e=>F[e]||e},{title:"Next Run",dataIndex:"nextRunAt",render:e=>e?t.jsx(N,{color:m(e)<m()?"red":"blue",children:m(e).format("DD MMM YYYY")}):"—"},{title:"Generated",dataIndex:"generatedCount",align:"center",render:e=>e||0},{title:"Status",dataIndex:"isActive",render:e=>t.jsx(N,{color:e?"green":"default",children:e?"Active":"Paused"})},{title:"",width:90,render:(e,n)=>t.jsxs(M,{children:[t.jsx(G,{title:"Generate now",children:t.jsx(o,{size:"small",icon:t.jsx(Z,{}),onClick:()=>H(n._id)})}),t.jsx(X,{title:"Delete?",onConfirm:()=>J(n._id),children:t.jsx(o,{size:"small",danger:!0,icon:t.jsx(E,{})})})]})}];return t.jsxs("div",{style:{padding:24},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsx(ee,{level:4,style:{margin:0,color:"#034D57"},children:"Recurring Invoices"}),t.jsx(o,{type:"primary",icon:t.jsx(q,{}),onClick:()=>C(),style:{background:"#034D57"},children:"New Recurring"})]}),t.jsx(Q,{columns:Y,dataSource:P,rowKey:"_id",loading:L,size:"small"}),t.jsx(K,{title:h?"Edit Recurring Invoice":"New Recurring Invoice",open:_,onCancel:I,footer:null,width:700,children:t.jsxs(s,{form:y,layout:"vertical",onFinish:$,children:[t.jsxs(A,{gutter:12,children:[t.jsx(a,{xs:24,sm:16,children:t.jsx(s.Item,{name:"name",label:"Name / Label",rules:[{required:!0}],children:t.jsx(T,{placeholder:"e.g. Monthly Retainer — RAFO"})})}),t.jsx(a,{xs:24,sm:8,children:t.jsx(s.Item,{name:"currency",label:"Currency",initialValue:"OMR",children:t.jsx(D,{options:["OMR","USD"].map(e=>({value:e,label:e}))})})}),t.jsx(a,{xs:24,sm:12,children:t.jsx(s.Item,{name:"client",label:"Client",rules:[{required:!0}],children:t.jsx(D,{showSearch:!0,filterOption:(e,n)=>n.label.toLowerCase().includes(e.toLowerCase()),options:V.map(e=>({value:e._id,label:e.name}))})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"frequency",label:"Frequency",initialValue:"monthly",children:t.jsx(D,{options:Object.entries(F).map(([e,n])=>({value:e,label:n}))})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"dayOfMonth",label:"Day of Month",initialValue:1,children:t.jsx(f,{min:1,max:28,style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"startDate",label:"Start Date",rules:[{required:!0}],initialValue:m(),children:t.jsx(O,{style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"endDate",label:"End Date",children:t.jsx(O,{style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:8,children:t.jsx(s.Item,{name:"taxRate",label:"Tax %",initialValue:5,children:t.jsx(f,{min:0,max:100,style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:8,children:t.jsx(s.Item,{name:"isActive",label:"Active",valuePropName:"checked",initialValue:!0,children:t.jsx(R,{})})}),t.jsx(a,{xs:12,sm:8,children:t.jsx(s.Item,{name:"autoSend",label:"Auto-send email",valuePropName:"checked",initialValue:!1,children:t.jsx(R,{})})})]}),t.jsx("div",{style:{margin:"12px 0 6px",fontWeight:600},children:"Line Items"}),w.map(e=>t.jsxs(A,{gutter:8,style:{marginBottom:4},children:[t.jsx(a,{flex:"auto",children:t.jsx(T,{size:"small",placeholder:"Item description",value:e.itemName,onChange:n=>S(e.key,"itemName",n.target.value)})}),t.jsx(a,{style:{width:70},children:t.jsx(f,{size:"small",min:0,precision:0,value:e.quantity,onChange:n=>S(e.key,"quantity",n||1),style:{width:"100%"}})}),t.jsx(a,{style:{width:110},children:t.jsx(f,{size:"small",min:0,precision:3,value:e.price,onChange:n=>S(e.key,"price",n||0),style:{width:"100%"},addonAfter:U()})}),t.jsx(a,{children:t.jsx(o,{size:"small",danger:!0,icon:t.jsx(E,{}),onClick:()=>c(n=>n.filter(i=>i.key!==e.key))})})]},e.key)),t.jsx(o,{size:"small",type:"dashed",icon:t.jsx(q,{}),onClick:()=>c(e=>[...e,{key:Date.now(),itemName:"",quantity:1,price:0}]),style:{marginTop:6},children:"Add Line"}),t.jsx("div",{style:{textAlign:"right",marginTop:16},children:t.jsxs(M,{children:[t.jsx(o,{onClick:I,children:"Cancel"}),t.jsx(o,{type:"primary",htmlType:"submit",style:{background:"#034D57"},children:"Save"})]})})]})})]})}export{we as default};
