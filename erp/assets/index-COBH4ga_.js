import{m as A,o as M,r as n,j as e}from"./index-BcLHfmte.js";import{o as $}from"./omrFormat-Aq1zoC-t.js";import{d as B}from"./dayjs.min-DSUY3OVJ.js";import{aZ as y,aN as E,aB as i,b4 as F,aM as _,aL as L,aY as Y}from"./IdurarOs-CAA7UmI0.js";import{s as g}from"./index-CJYL2ELi.js";import{T as H,r as J,F as D}from"./ErpApp-CrEd8Ed2.js";import{C as u}from"./index-DWTf_gVa.js";import{D as C}from"./index-BW1z5_40.js";import{F as d}from"./Table-DN9_T6-a.js";import{M as V}from"./index-Bi06WD4Q.js";import{A as W}from"./ArrowLeftOutlined-DycoXxW-.js";import"./Skeleton-E-DIzMqP.js";import"./index-D1ScPv_Q.js";import"./PlusOutlined-BfQRORD2.js";import"./ActionButton-BtIqhtPT.js";import"./fade-ZZ0Tuw5j.js";const{Title:P,Text:b}=Y,q={draft:"default",issued:"blue",applied:"green",voided:"red"};function S(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function c(m){return $(m)}function me(){var k,I;const m=A(),{id:o}=M(),[t,w]=n.useState(null),[U,N]=n.useState(!0),[v,R]=n.useState(!1),[a,f]=n.useState(null),[O,h]=n.useState(!1);n.useEffect(()=>{fetch(y+`creditnote/read/${o}`,{headers:S()}).then(s=>s.json()).then(s=>{s.success&&w(s.result)}).catch(()=>g.error("Failed")).finally(()=>N(!1))},[o]);const p=async(s=!1)=>{R(!0);try{const r=await fetch(y+`creditnote/pdf/${o}`,{headers:S()});if(!r.ok)throw new Error("PDF failed");const l=await r.blob(),x=URL.createObjectURL(l);if(s){const j=document.createElement("a");j.href=x,j.download=`CN-${t==null?void 0:t.number}-${t==null?void 0:t.year}.pdf`,j.click(),URL.revokeObjectURL(x)}else f(x),h(!0)}catch(r){g.error(r.message)}finally{R(!1)}},T=async s=>{const l=await(await fetch(y+`creditnote/update/${o}`,{method:"PATCH",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify({status:s})})).json();l.success&&(w(l.result),g.success(`Status: ${s}`))};if(U)return e.jsx("div",{style:{textAlign:"center",padding:60},children:e.jsx(E,{size:"large"})});if(!t)return e.jsx("div",{style:{padding:24},children:"Not found."});const z=[{title:"#",width:40,render:(s,r,l)=>l+1},{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Qty",dataIndex:"quantity",width:70,align:"center"},{title:"Unit Price",dataIndex:"price",align:"right",render:c},{title:"Total",dataIndex:"total",align:"right",render:s=>e.jsxs("strong",{style:{color:"#e53e3e"},children:["(",c(s),")"]})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,flexWrap:"wrap",gap:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx(i,{icon:e.jsx(W,{}),onClick:()=>m("/credit-note")}),e.jsxs("div",{children:[e.jsxs(P,{level:4,style:{margin:0,color:"#e53e3e"},children:["Credit Note CN-",t.number,"/",t.year]}),e.jsx(H,{color:q[t.status]||"default",style:{marginTop:4},children:(k=t.status)==null?void 0:k.toUpperCase()})]})]}),e.jsxs(J,{wrap:!0,children:[t.status==="draft"&&e.jsx(i,{onClick:()=>T("issued"),style:{borderColor:"#1890ff",color:"#1890ff"},children:"Issue"}),t.status==="issued"&&e.jsx(i,{onClick:()=>T("applied"),style:{borderColor:"#4CB480",color:"#4CB480"},children:"Mark Applied"}),e.jsx(i,{icon:e.jsx(D,{}),onClick:()=>p(!1),loading:v,children:"Preview PDF"}),e.jsx(i,{icon:e.jsx(D,{}),onClick:()=>p(!0),loading:v,danger:!0,children:"Download PDF"}),e.jsx(i,{icon:e.jsx(F,{}),onClick:()=>m(`/credit-note/edit/${o}`),children:"Edit"})]})]}),e.jsxs(_,{gutter:16,style:{marginBottom:16},children:[e.jsx(L,{xs:24,md:12,children:e.jsxs(u,{size:"small",title:"Issued To",children:[e.jsx(P,{level:5,style:{color:"#034D57",marginTop:0},children:((I=t.client)==null?void 0:I.name)||"—"}),t.reason&&e.jsxs(b,{type:"secondary",style:{fontSize:12},children:["Reason: ",t.reason]})]})}),e.jsx(L,{xs:24,md:12,children:e.jsx(u,{size:"small",title:"Details",children:e.jsxs(C,{size:"small",column:1,children:[e.jsx(C.Item,{label:"Date",children:B(t.date).format("DD MMM YYYY")}),t.invoice&&e.jsxs(C.Item,{label:"Invoice Ref",children:["INV-",t.invoice.number,"/",t.invoice.year]})]})})})]}),e.jsx(u,{size:"small",title:"Items",style:{marginBottom:16},children:e.jsx(d,{columns:z,dataSource:t.items||[],rowKey:(s,r)=>r,pagination:!1,size:"small",summary:()=>e.jsxs(d.Summary.Row,{style:{background:"#fff5f5"},children:[e.jsx(d.Summary.Cell,{index:0,colSpan:3,children:e.jsx("strong",{children:"Totals"})}),t.taxRate>0&&e.jsx(d.Summary.Cell,{index:3,align:"right",children:e.jsxs(b,{type:"secondary",children:["Sub: (",c(t.subTotal),") + VAT: (",c(t.taxTotal),")"]})}),e.jsx(d.Summary.Cell,{index:4,align:"right",colSpan:t.taxRate>0?0:2,children:e.jsxs("strong",{style:{color:"#e53e3e",fontSize:15},children:["CREDIT: (",c(t.total),")"]})})]})})}),t.notes&&e.jsx(u,{size:"small",style:{borderLeft:"3px solid #f59e0b"},children:e.jsx(b,{children:t.notes})}),e.jsx(V,{title:`PDF — CN-${t.number}/${t.year}`,open:O,width:"80%",style:{top:20},onCancel:()=>{h(!1),a&&URL.revokeObjectURL(a),f(null)},footer:[e.jsx(i,{danger:!0,onClick:()=>p(!0),children:"Download"},"dl"),e.jsx(i,{onClick:()=>{h(!1),a&&URL.revokeObjectURL(a),f(null)},children:"Close"},"cl")],children:a&&e.jsx("iframe",{src:a,style:{width:"100%",height:"70vh",border:"none"}})})]})}export{me as default};
