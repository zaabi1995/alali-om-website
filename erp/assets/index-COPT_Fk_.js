import{r,j as e}from"./index-DWVcmqXa.js";import{u as A}from"./useMoney-CcN5EaxA.js";import{e as w,i as D}from"./ErpApp-C9DE2qQ1.js";import{c as T}from"./calculate-CoT1A6Sl.js";import{B as k,an as z,b as L,a1 as $,z as U,c as V,aM as W,aL as I,b7 as f,aN as F,a_ as R,aZ as G}from"./IdurarOs-USsksKtA.js";import{T as b}from"./index-DykdpYx1.js";import{D as K}from"./DeleteOutlined-Bvv7PJZR.js";const{Option:P}=w;function q(t){return t&&t.type&&(t.type.isSelectOption||t.type.isSelectOptGroup)}const Q=(t,g)=>{var l;const{prefixCls:m,className:y,popupClassName:x,dropdownClassName:d,children:u,dataSource:p}=t,a=k(u);let S;a.length===1&&z(a[0])&&!q(a[0])&&([S]=a);const _=S?()=>S:void 0;let h;a.length&&q(a[0])?h=u:h=p?p.map(c=>{if(z(c))return c;switch(typeof c){case"string":return r.createElement(P,{key:c,value:c},c);case"object":{const{value:C}=c;return r.createElement(P,{key:C,value:C},c.text)}default:return}}):[];const{getPrefixCls:N}=r.useContext(L),j=N("select",m),[o]=$("SelectLike",(l=t.dropdownStyle)===null||l===void 0?void 0:l.zIndex);return r.createElement(w,Object.assign({ref:g,suffixIcon:null},U(t,["dataSource","dropdownClassName"]),{prefixCls:j,popupClassName:x||d,dropdownStyle:Object.assign(Object.assign({},t.dropdownStyle),{zIndex:o}),className:V(`${j}-auto-complete`,y),mode:w.SECRET_COMBOBOX_MODE_DO_NOT_USE,getInputElement:_}),h)},O=r.forwardRef(Q),Z=D(O);O.Option=P;O._InternalPanelDoNotUseOrYouWillBeFired=Z;function H(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function re({field:t,remove:g,current:l=null,form:m}){const[y,x]=r.useState(void 0),[d,u]=r.useState(0),[p,a]=r.useState(0),[S,_]=r.useState([]),[h,N]=r.useState(!1),j=r.useRef(null),o=A(),c=s=>{a(s)},C=s=>{u(s)};r.useEffect(()=>{if(l){const{items:s,invoice:i}=l,n=i?i[t.fieldKey]:s==null?void 0:s[t.fieldKey];n&&(a(n.quantity),u(n.price))}},[l]),r.useEffect(()=>{x(T.multiply(d,p))},[d,p]);const B=s=>{if(j.current&&clearTimeout(j.current),!s||s.length<2){_([]);return}j.current=setTimeout(async()=>{N(!0);try{const i=await fetch(G+`product/search?q=${encodeURIComponent(s)}`,{headers:H()}).then(n=>n.json());i.success&&_((i.result||[]).map(n=>({value:n.name,label:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:600},children:n.name}),n.partNumber&&e.jsx("span",{style:{color:"#888",fontSize:11,marginLeft:6},children:n.partNumber}),n.description&&e.jsx("div",{style:{fontSize:11,color:"#aaa"},children:n.description.slice(0,60)})]}),e.jsx("span",{style:{color:"#034D57",fontWeight:700,fontSize:12,whiteSpace:"nowrap",marginLeft:8},children:parseFloat(n.salePrice||0).toFixed(3)})]}),_product:n})))}finally{N(!1)}},300)},M=(s,i)=>{var E;if(!(i!=null&&i._product)||!m)return;const n=i._product,v=m.getFieldValue("items")||[];v[t.name]={...v[t.name],itemName:n.name,description:n.description||"",price:n.salePrice||0},m.setFieldsValue({items:v}),u(n.salePrice||0),a(((E=v[t.name])==null?void 0:E.quantity)||1)};return e.jsxs(W,{gutter:[12,12],style:{position:"relative"},children:[e.jsx(I,{className:"gutter-row",span:5,children:e.jsx(f.Item,{name:[t.name,"itemName"],rules:[{required:!0,message:"Missing item name"},{pattern:/^(?!\s*$)[\s\S]+$/,message:"Item name required"}],children:e.jsx(O,{options:S,onSearch:B,onSelect:M,notFoundContent:h?e.jsx(F,{size:"small"}):null,dropdownMatchSelectWidth:340,children:e.jsx(R,{placeholder:"Item name (type to search catalog)",suffix:h?e.jsx(F,{size:"small"}):null})})})}),e.jsx(I,{className:"gutter-row",span:7,children:e.jsx(f.Item,{name:[t.name,"description"],children:e.jsx(R,{placeholder:"Description"})})}),e.jsx(I,{className:"gutter-row",span:3,children:e.jsx(f.Item,{name:[t.name,"quantity"],rules:[{required:!0}],children:e.jsx(b,{style:{width:"100%"},min:0,onChange:c})})}),e.jsx(I,{className:"gutter-row",span:4,children:e.jsx(f.Item,{name:[t.name,"price"],rules:[{required:!0}],children:e.jsx(b,{className:"moneyInput",onChange:C,min:0,controls:!1,addonAfter:o.currency_position==="after"?o.currency_symbol:void 0,addonBefore:o.currency_position==="before"?o.currency_symbol:void 0})})}),e.jsx(I,{className:"gutter-row",span:5,children:e.jsx(f.Item,{name:[t.name,"total"],children:e.jsx(f.Item,{children:e.jsx(b,{readOnly:!0,className:"moneyInput",value:y,min:0,controls:!1,addonAfter:o.currency_position==="after"?o.currency_symbol:void 0,addonBefore:o.currency_position==="before"?o.currency_symbol:void 0,formatter:s=>o.amountFormatter({amount:s,currency_code:o.currency_code})})})})}),e.jsx("div",{style:{position:"absolute",right:"-20px",top:"5px"},children:e.jsx(K,{onClick:()=>g(t.name)})})]})}function oe({updatePrice:t,value:g=0,readOnly:l=!1}){const{amountFormatter:m,currency_symbol:y,currency_position:x,cent_precision:d,currency_code:u}=A();return e.jsx(f.Item,{children:e.jsx(b,{readOnly:l,className:"moneyInput",onChange:t,precision:d||2,value:m({amount:g,currency_code:u}),controls:!1,addonAfter:x==="after"?y:void 0,addonBefore:x==="before"?y:void 0,formatter:p=>m({amount:p,currency_code:u})})})}export{re as I,oe as M};
