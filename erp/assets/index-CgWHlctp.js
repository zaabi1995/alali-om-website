import{m as q,o as B,r as m,j as e}from"./index-D8GYIxkt.js";import{d as b}from"./dayjs.min-B3sMHnXn.js";import{aG as o,ay as u,ai as h,aA as V,aB as c,aD as I,ar as $}from"./IdurarOs-Bp7g4t32.js";import{S as g}from"./index-B6OjbFu5.js";import{D as M}from"./index-DVduZBW9.js";import{T as v}from"./index-BclWlcPO.js";import{C as U}from"./index-12GqBLyk.js";import{F as G}from"./Table-C95qK4fz.js";import{j as H}from"./ErpApp-eMQ7IvFe.js";import{s as C}from"./index-Di1ZAexU.js";import{P as W}from"./index-DGUWN9FB.js";import{A as J}from"./ArrowLeftOutlined-nV2NY5TW.js";import{P as K}from"./PlusOutlined-BPzt_4wX.js";import{S as Q}from"./SaveOutlined-DemAhUGp.js";import{D as X}from"./DeleteOutlined-DTG8wLH9.js";import"./pickAttrs-Cgu4o-jt.js";import"./DownOutlined-PDxVrbmf.js";import"./ClockCircleOutlined-BlQSsYrm.js";import"./Skeleton-BCG8SEaS.js";import"./index-BYBg9C3K.js";import"./ActionButton-BKmasmgO.js";const{Title:Y}=$,{TextArea:Z}=I;function ee(){return{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`,"Content-Type":"application/json"}}const k={key:Date.now(),description:"",quantity:1,price:0};function Ie(){const p=q(),{id:n}=B(),[j]=o.useForm(),[f,x]=m.useState([{...k}]),[T,A]=m.useState([]),[R,F]=m.useState([]),[O,w]=m.useState(!1);m.useEffect(()=>{const s={Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`};fetch(u+"client/listAll",{headers:s}).then(t=>t.json()).then(t=>{t.result&&A(t.result)}),fetch(u+"invoice/listAll",{headers:s}).then(t=>t.json()).then(t=>{t.result&&F(t.result)}),n&&fetch(u+`creditnote/read/${n}`,{headers:s}).then(t=>t.json()).then(t=>{var a,l,r;if(t.success&&t.result){const i=t.result;j.setFieldsValue({client:((a=i.client)==null?void 0:a._id)||i.client,date:i.date?b(i.date):null,invoice:((l=i.invoice)==null?void 0:l._id)||i.invoice,reason:i.reason,taxRate:i.taxRate,status:i.status,notes:i.notes}),(r=i.items)!=null&&r.length&&x(i.items.map((d,L)=>({...d,key:L})))}})},[n]);const N=()=>x(s=>[...s,{...k,key:Date.now()}]),D=s=>x(t=>t.filter(a=>a.key!==s)),y=(s,t,a)=>x(l=>l.map(r=>r.key===s?{...r,[t]:a}:r)),S=f.reduce((s,t)=>s+parseFloat(t.price||0)*parseFloat(t.quantity||1),0),P=j.getFieldValue("taxRate")||0,_=S+S*(P/100),z=async s=>{var r;w(!0);const t={...s,date:(r=s.date)==null?void 0:r.toISOString(),items:f},a=n?u+`creditnote/update/${n}`:u+"creditnote/create",l=n?"PATCH":"POST";try{const d=await(await fetch(a,{method:l,headers:ee(),body:JSON.stringify(t)})).json();d.success?(C.success(d.message||"Saved"),p(`/credit-note/read/${d.result._id}`)):C.error(d.message||"Failed")}catch{C.error("Network error")}finally{w(!1)}},E=[{title:"Description",dataIndex:"description",render:(s,t)=>e.jsx(I,{size:"small",value:s,onChange:a=>y(t.key,"description",a.target.value)})},{title:"Qty",dataIndex:"quantity",width:80,render:(s,t)=>e.jsx(v,{size:"small",min:1,value:s,style:{width:"100%"},onChange:a=>y(t.key,"quantity",a)})},{title:"Unit Price (OMR)",dataIndex:"price",width:130,render:(s,t)=>e.jsx(v,{size:"small",min:0,value:s,precision:3,style:{width:"100%"},onChange:a=>y(t.key,"price",a)})},{title:"Total",width:100,align:"right",render:(s,t)=>e.jsxs("strong",{style:{color:"#e53e3e"},children:["(",(parseFloat(t.price||0)*parseFloat(t.quantity||1)).toFixed(3)," OMR)"]})},{title:"",width:40,render:(s,t)=>e.jsx(W,{title:"Remove?",onConfirm:()=>D(t.key),children:e.jsx(h,{size:"small",danger:!0,type:"text",icon:e.jsx(X,{})})})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:20},children:[e.jsx(h,{icon:e.jsx(J,{}),onClick:()=>p("/credit-note")}),e.jsx(Y,{level:4,style:{margin:0,color:"#e53e3e"},children:n?"Edit Credit Note":"New Credit Note"})]}),e.jsxs(o,{form:j,layout:"vertical",onFinish:z,children:[e.jsxs(V,{gutter:16,children:[e.jsx(c,{xs:24,md:12,children:e.jsx(o.Item,{name:"client",label:"Client",rules:[{required:!0}],children:e.jsx(g,{showSearch:!0,placeholder:"Select client",filterOption:(s,t)=>t.label.toLowerCase().includes(s.toLowerCase()),options:T.map(s=>({value:s._id,label:s.name}))})})}),e.jsx(c,{xs:24,md:12,children:e.jsx(o.Item,{name:"invoice",label:"Original Invoice",children:e.jsx(g,{showSearch:!0,allowClear:!0,placeholder:"Link to invoice",filterOption:(s,t)=>t.label.toLowerCase().includes(s.toLowerCase()),options:R.map(s=>({value:s._id,label:`INV-${s.number}/${s.year}`}))})})}),e.jsx(c,{xs:12,md:6,children:e.jsx(o.Item,{name:"date",label:"Date",rules:[{required:!0}],initialValue:b(),children:e.jsx(M,{style:{width:"100%"}})})}),e.jsx(c,{xs:12,md:6,children:e.jsx(o.Item,{name:"taxRate",label:"VAT Rate (%)",initialValue:0,children:e.jsx(v,{min:0,max:100,style:{width:"100%"}})})}),e.jsx(c,{xs:12,md:6,children:e.jsx(o.Item,{name:"status",label:"Status",initialValue:"draft",children:e.jsx(g,{options:["draft","issued","applied","voided"].map(s=>({value:s,label:s.charAt(0).toUpperCase()+s.slice(1)}))})})}),e.jsx(c,{xs:24,children:e.jsx(o.Item,{name:"reason",label:"Reason for Credit Note",children:e.jsx(I,{placeholder:"e.g. Goods returned, Overcharge, etc."})})})]}),e.jsxs(U,{title:"Items",size:"small",style:{marginBottom:12},extra:e.jsx(h,{size:"small",icon:e.jsx(K,{}),onClick:N,danger:!0,children:"Add Item"}),children:[e.jsx(G,{columns:E,dataSource:f,rowKey:"key",pagination:!1,size:"small"}),e.jsx("div",{style:{textAlign:"right",marginTop:8,padding:8,background:"#fff5f5",borderRadius:4},children:e.jsxs("span",{style:{color:"#e53e3e",fontWeight:700},children:["CREDIT TOTAL: (",_.toFixed(3)," OMR)"]})})]}),e.jsx(o.Item,{name:"notes",label:"Notes",children:e.jsx(Z,{rows:2})}),e.jsx("div",{style:{textAlign:"right"},children:e.jsxs(H,{children:[e.jsx(h,{onClick:()=>p("/credit-note"),children:"Cancel"}),e.jsx(h,{type:"primary",htmlType:"submit",loading:O,icon:e.jsx(Q,{}),danger:!0,children:n?"Update":"Create Credit Note"})]})})]})]})}export{Ie as default};
