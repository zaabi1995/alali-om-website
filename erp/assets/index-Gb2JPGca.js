import{r as p,m as _,j as e}from"./index-CTFV7Brr.js";import{g as J,e as k,k as M,w as V}from"./ErpApp-DMSXEY9U.js";import{b8 as o,aV as b,aM as $,aL as u,aX as f,aW as q,aB as m,aY as H}from"./IdurarOs-BuItXQtq.js";import{D as U}from"./index-BT22LTtk.js";import{T as z}from"./index-COzt4akP.js";import{s as h}from"./index-C0zoDyuO.js";import{P as W}from"./PlusOutlined-CSb8KqdM.js";import{C as Y}from"./CheckCircleOutlined-BiBUO-fx.js";import"./ClockCircleOutlined-hOEcQdMQ.js";const{Title:X,Text:G}=H;function S(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function K(){return{...S(),"Content-Type":"application/json"}}const C={account:null,accountName:"",description:"",debit:0,credit:0};function le(){const[v]=o.useForm(),[c,g]=p.useState([{...C},{...C}]),[w,D]=p.useState([]),[B,L]=p.useState(!1),[I,T]=p.useState(!1),j=_();p.useEffect(()=>{fetch(b+"account/listAll",{headers:S()}).then(t=>t.json()).then(t=>{t.success&&D(t.result||[])})},[]);const d=c.reduce((t,n)=>t+(parseFloat(n.debit)||0),0),x=c.reduce((t,n)=>t+(parseFloat(n.credit)||0),0),y=Math.abs(d-x)<.001,r=(t,n,s)=>{g(a=>a.map((i,l)=>l===t?{...i,[n]:s}:i))},O=()=>g(t=>[...t,{...C}]),E=t=>{c.length>2&&g(n=>n.filter((s,a)=>a!==t))},N=(t,n)=>{const s=w.find(a=>a._id===n);r(t,"account",n),r(t,"accountName",(s==null?void 0:s.name)||""),r(t,"accountCode",(s==null?void 0:s.code)||"")},P=async t=>{var s;const n=await v.validateFields();return{...n,date:(s=n.date)==null?void 0:s.toISOString(),lines:c.filter(a=>a.account),status:t}},A=async(t=!1)=>{const n=t?T:L;n(!0);try{const s=await P("draft"),a=await fetch(b+"journalentry/create",{method:"POST",headers:K(),body:JSON.stringify(s)}).then(l=>l.json());if(!a.success){h.error(a.message||"Create failed");return}const i=a.result._id;if(t){const l=await fetch(`${b}journalentry/post/${i}`,{method:"PATCH",headers:S()}).then(R=>R.json());if(!l.success){h.error(l.message),j("/journal-entry");return}h.success(l.message)}else h.success(a.message);j("/journal-entry")}catch(s){h.error(s.message||"Error")}finally{n(!1)}},F=w.map(t=>({value:t._id,label:`${t.code||""} — ${t.name}`}));return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsx(X,{level:4,style:{margin:"0 0 20px",color:"#034D57"},children:"New Journal Entry"}),e.jsx(o,{form:v,layout:"vertical",children:e.jsxs($,{gutter:16,children:[e.jsx(u,{span:6,children:e.jsx(o.Item,{name:"date",label:"Date",initialValue:J(),rules:[{required:!0}],children:e.jsx(U,{style:{width:"100%"}})})}),e.jsx(u,{span:6,children:e.jsx(o.Item,{name:"type",label:"Type",initialValue:"general",children:e.jsx(k,{options:["general","sales","purchase","payment","adjustment","opening"].map(t=>({value:t,label:t.charAt(0).toUpperCase()+t.slice(1)}))})})}),e.jsx(u,{span:6,children:e.jsx(o.Item,{name:"reference",label:"Reference",children:e.jsx(f,{placeholder:"e.g. INV-5/2026"})})}),e.jsx(u,{span:6,children:e.jsx(o.Item,{name:"currency",label:"Currency",initialValue:"OMR",children:e.jsx(f,{})})}),e.jsx(u,{span:24,children:e.jsx(o.Item,{name:"description",label:"Description",rules:[{required:!0}],children:e.jsx(f,{placeholder:"Brief description of this entry"})})})]})}),e.jsx(q,{style:{margin:"12px 0"}}),e.jsxs("div",{style:{marginBottom:8,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(G,{strong:!0,children:"Journal Lines"}),e.jsx(m,{size:"small",icon:e.jsx(W,{}),onClick:O,children:"Add Line"})]}),e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",marginBottom:12},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{background:"#034D57",color:"#fff"},children:[e.jsx("th",{style:{padding:"7px 10px",textAlign:"left",fontSize:11,width:"35%"},children:"Account"}),e.jsx("th",{style:{padding:"7px 10px",textAlign:"left",fontSize:11},children:"Description"}),e.jsx("th",{style:{padding:"7px 10px",textAlign:"right",fontSize:11,width:"15%"},children:"Debit"}),e.jsx("th",{style:{padding:"7px 10px",textAlign:"right",fontSize:11,width:"15%"},children:"Credit"}),e.jsx("th",{style:{width:30}})]})}),e.jsxs("tbody",{children:[c.map((t,n)=>e.jsxs("tr",{style:{background:n%2===0?"#fff":"#f9fbfc",borderBottom:"1px solid #edf2f3"},children:[e.jsx("td",{style:{padding:"4px 6px"},children:e.jsx(k,{showSearch:!0,style:{width:"100%"},placeholder:"Select account",value:t.account||void 0,onChange:s=>N(n,s),options:F,filterOption:(s,a)=>{var i;return(i=a.label)==null?void 0:i.toLowerCase().includes(s.toLowerCase())},size:"small"})}),e.jsx("td",{style:{padding:"4px 6px"},children:e.jsx(f,{size:"small",value:t.description,onChange:s=>r(n,"description",s.target.value),placeholder:"Line note"})}),e.jsx("td",{style:{padding:"4px 6px"},children:e.jsx(z,{size:"small",style:{width:"100%"},min:0,precision:3,value:t.debit||0,onChange:s=>{r(n,"debit",s||0),s>0&&r(n,"credit",0)}})}),e.jsx("td",{style:{padding:"4px 6px"},children:e.jsx(z,{size:"small",style:{width:"100%"},min:0,precision:3,value:t.credit||0,onChange:s=>{r(n,"credit",s||0),s>0&&r(n,"debit",0)}})}),e.jsx("td",{style:{padding:"4px 6px"},children:c.length>2&&e.jsx(M,{onClick:()=>E(n),style:{color:"#e53e3e",cursor:"pointer"}})})]},n)),e.jsxs("tr",{style:{background:"#034D57",color:"#fff",fontWeight:700},children:[e.jsx("td",{colSpan:2,style:{padding:"8px 10px",fontSize:12},children:"TOTALS"}),e.jsx("td",{style:{padding:"8px 10px",textAlign:"right",fontSize:13,color:"#4CB480"},children:d.toFixed(3)}),e.jsx("td",{style:{padding:"8px 10px",textAlign:"right",fontSize:13,color:"#4CB480"},children:x.toFixed(3)}),e.jsx("td",{})]})]})]}),!y&&d+x>0&&e.jsxs("div",{style:{background:"#fff5f5",border:"1px solid #fca5a5",padding:"8px 14px",borderRadius:6,marginBottom:12,color:"#e53e3e",fontSize:12},children:["⚠️ Unbalanced by ",Math.abs(d-x).toFixed(3)," — debit and credit must be equal to post"]}),y&&d>0&&e.jsx("div",{style:{background:"#f0fff4",border:"1px solid #86efac",padding:"8px 14px",borderRadius:6,marginBottom:12,color:"#4CB480",fontSize:12},children:"✓ Entry is balanced"}),e.jsxs(V,{children:[e.jsx(m,{onClick:()=>A(!1),loading:B,children:"Save as Draft"}),e.jsx(m,{type:"primary",icon:e.jsx(Y,{}),onClick:()=>A(!0),loading:I,disabled:!y||d===0,style:{background:"#034D57",borderColor:"#034D57"},children:"Save & Post"}),e.jsx(m,{onClick:()=>j("/journal-entry"),children:"Cancel"})]})]})}export{le as default};
