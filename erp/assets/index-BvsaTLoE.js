import{r as l,j as e,v as O,m as K}from"./index-CTFV7Brr.js";import{aZ as p,aB as x,aN as P,aY as z,b4 as L,aT as Q,aM as W,aL as A}from"./IdurarOs-BuItXQtq.js";import{w,b as F,g as d,T as S,aj as H,ak as q,L as G}from"./ErpApp-DMSXEY9U.js";import{o as h}from"./omrFormat-D-sM2f67.js";import{F as M}from"./Table-DWRONg7I.js";import{M as $}from"./index-CXsfvZca.js";import{D as o}from"./index-uwGX5jNl.js";import{D as T}from"./DownloadOutlined-C6ToU-vF.js";import{A as R}from"./index-D9QNx9RM.js";import{P as _}from"./progress-DBK4vIju.js";import{C as Y}from"./index-DpRBerau.js";import{S as B}from"./index-CM04OVhd.js";import{T as Z}from"./index-CzggDZE3.js";import{F as E}from"./FileDoneOutlined-BwGKl6eQ.js";import"./ActionButton-Bjdgb5lM.js";import"./fade-DUlGpPzz.js";import"./Skeleton-CK9OjjLh.js";import"./PlusOutlined-CSb8KqdM.js";const{Title:N}=z;function J({token:m}){var a;const[D,v]=l.useState([]),[j,u]=l.useState(!1),[s,f]=l.useState(null),[b,c]=l.useState(!1);l.useEffect(()=>{y()},[]);const y=async()=>{try{u(!0);const r=await p.get({entity:"portal/quotes",headers:{Authorization:`Bearer ${m}`}});r.success&&v(r.result||[])}catch(r){console.error("Failed to fetch quotes:",r)}finally{u(!1)}},k=async r=>{try{const t=await p.get({entity:`portal/quotes/${r}`,headers:{Authorization:`Bearer ${m}`}});t.success&&(f(t.result),c(!0))}catch(t){console.error("Failed to fetch quote details:",t)}},n=r=>{window.open(`/download/quote/quote-${r}.pdf`,"_blank")},g=r=>({draft:"default",pending:"processing",sent:"blue",accepted:"success",rejected:"error",expired:"warning"})[r]||"default",I=[{title:"Quote #",dataIndex:"number",key:"number",render:r=>e.jsx("strong",{children:r})},{title:"Date",dataIndex:"date",key:"date",render:r=>r?d(r).format("MMM DD, YYYY"):"-"},{title:"Status",dataIndex:"status",key:"status",render:r=>e.jsx(S,{color:g(r),children:r==null?void 0:r.toUpperCase()})},{title:"Amount",dataIndex:"total",key:"total",render:r=>h(r)},{title:"Actions",key:"actions",render:(r,t)=>e.jsxs(w,{children:[e.jsx(x,{type:"primary",size:"small",icon:e.jsx(L,{}),onClick:()=>k(t._id),children:"View"}),e.jsx(x,{size:"small",icon:e.jsx(T,{}),onClick:()=>n(t._id),children:"PDF"})]})}];return e.jsxs(e.Fragment,{children:[e.jsx(M,{columns:I,dataSource:D,rowKey:"_id",loading:j,pagination:{pageSize:10},locale:{emptyText:"No quotes found"}}),e.jsx($,{title:e.jsxs(w,{children:[e.jsx(F,{style:{color:"#034D57"}}),e.jsx("span",{children:"Quote Details"})]}),open:b,onCancel:()=>c(!1),footer:[e.jsx(x,{onClick:()=>c(!1),children:"Close"},"close"),e.jsx(x,{type:"primary",icon:e.jsx(T,{}),onClick:()=>n(s==null?void 0:s._id),children:"Download PDF"},"download")],width:800,children:s?e.jsxs(e.Fragment,{children:[e.jsxs(o,{column:2,bordered:!0,size:"small",style:{marginBottom:16},children:[e.jsx(o.Item,{label:"Quote #",span:2,children:e.jsx("strong",{children:s.number})}),e.jsx(o.Item,{label:"Date",children:d(s.date).format("MMMM DD, YYYY")}),e.jsx(o.Item,{label:"Valid Until",children:s.expiredDate?d(s.expiredDate).format("MMMM DD, YYYY"):"-"}),e.jsx(o.Item,{label:"Status",span:2,children:e.jsx(S,{color:g(s.status),children:(a=s.status)==null?void 0:a.toUpperCase()})})]}),s.description&&e.jsxs("div",{style:{marginBottom:16},children:[e.jsx(N,{level:5,children:"Description"}),e.jsx("p",{children:s.description})]}),s.items&&s.items.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(N,{level:5,children:"Items"}),e.jsx(M,{columns:[{title:"Item",dataIndex:"itemName",key:"itemName"},{title:"Quantity",dataIndex:"quantity",key:"quantity"},{title:"Unit Price",dataIndex:"price",key:"price",render:r=>h(r)},{title:"Total",dataIndex:"total",key:"total",render:r=>h(r)}],dataSource:s.items,rowKey:(r,t)=>t,pagination:!1,size:"small",style:{marginBottom:16}})]}),e.jsxs(o,{column:1,bordered:!0,size:"small",children:[e.jsx(o.Item,{label:"Subtotal",children:h(s.total-(s.taxTotal||0))}),e.jsx(o.Item,{label:"Tax",children:h(s.taxTotal||0)}),e.jsx(o.Item,{label:"Total",children:e.jsx("strong",{children:h(s.total)})})]})]}):e.jsx(P,{})})]})}const{Title:V}=z;function X({token:m}){var r;const[D,v]=l.useState([]),[j,u]=l.useState(!1),[s,f]=l.useState(null),[b,c]=l.useState(!1);l.useEffect(()=>{y()},[]);const y=async()=>{try{u(!0);const t=await p.get({entity:"portal/invoices",headers:{Authorization:`Bearer ${m}`}});t.success&&v(t.result||[])}catch(t){console.error("Failed to fetch invoices:",t)}finally{u(!1)}},k=async t=>{try{const i=await p.get({entity:`portal/invoices/${t}`,headers:{Authorization:`Bearer ${m}`}});i.success&&(f(i.result),c(!0))}catch(i){console.error("Failed to fetch invoice details:",i)}},n=t=>{window.open(`/download/invoice/invoice-${t}.pdf`,"_blank")},g=t=>({draft:"default",pending:"processing",sent:"blue",paid:"success",overdue:"error",cancelled:"warning"})[t]||"default",I=t=>t.status==="paid"?{text:"PAID",color:"success"}:t.credit>0?{text:"PARTIAL",color:"warning"}:d(t.expiredDate).isBefore(d())?{text:"OVERDUE",color:"error"}:{text:"UNPAID",color:"default"},a=[{title:"Invoice #",dataIndex:"number",key:"number",render:t=>e.jsx("strong",{children:t})},{title:"Date",dataIndex:"date",key:"date",render:t=>t?d(t).format("MMM DD, YYYY"):"-"},{title:"Due Date",dataIndex:"expiredDate",key:"expiredDate",render:t=>t?d(t).format("MMM DD, YYYY"):"-"},{title:"Status",dataIndex:"status",key:"status",render:t=>e.jsx(S,{color:g(t),children:t==null?void 0:t.toUpperCase()})},{title:"Amount",dataIndex:"total",key:"total",render:t=>h(t)},{title:"Balance",key:"balance",render:(t,i)=>{const C=I(i);return e.jsxs(w,{direction:"vertical",size:0,children:["omrCell(record.credit || 0)",e.jsx(S,{color:C.color,style:{fontSize:10,padding:"0 4px"},children:C.text})]})}},{title:"Actions",key:"actions",render:(t,i)=>e.jsxs(w,{children:[e.jsx(x,{type:"primary",size:"small",icon:e.jsx(L,{}),onClick:()=>k(i._id),children:"View"}),e.jsx(x,{size:"small",icon:e.jsx(T,{}),onClick:()=>n(i._id),children:"PDF"})]})}];return e.jsxs(e.Fragment,{children:[e.jsx(M,{columns:a,dataSource:D,rowKey:"_id",loading:j,pagination:{pageSize:10},locale:{emptyText:"No invoices found"}}),e.jsx($,{title:e.jsxs(w,{children:[e.jsx(H,{style:{color:"#4CB480"}}),e.jsx("span",{children:"Invoice Details"})]}),open:b,onCancel:()=>c(!1),footer:[e.jsx(x,{onClick:()=>c(!1),children:"Close"},"close"),e.jsx(x,{type:"primary",icon:e.jsx(T,{}),onClick:()=>n(s==null?void 0:s._id),children:"Download PDF"},"download")],width:800,children:s?e.jsxs(e.Fragment,{children:[s.credit>0&&e.jsx(R,{message:`Balance Due: ${s.credit.toFixed(3)} OMR`,description:"This invoice has an outstanding balance. Please contact us for payment details.",type:"warning",showIcon:!0,style:{marginBottom:16}}),e.jsxs(o,{column:2,bordered:!0,size:"small",style:{marginBottom:16},children:[e.jsx(o.Item,{label:"Invoice #",span:2,children:e.jsx("strong",{children:s.number})}),e.jsx(o.Item,{label:"Invoice Date",children:d(s.date).format("MMMM DD, YYYY")}),e.jsx(o.Item,{label:"Due Date",children:s.expiredDate?d(s.expiredDate).format("MMMM DD, YYYY"):"-"}),e.jsx(o.Item,{label:"Status",span:2,children:e.jsx(S,{color:g(s.status),children:(r=s.status)==null?void 0:r.toUpperCase()})})]}),s.description&&e.jsxs("div",{style:{marginBottom:16},children:[e.jsx(V,{level:5,children:"Description"}),e.jsx("p",{children:s.description})]}),s.items&&s.items.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(V,{level:5,children:"Items"}),e.jsx(M,{columns:[{title:"Item",dataIndex:"itemName",key:"itemName"},{title:"Quantity",dataIndex:"quantity",key:"quantity"},{title:"Unit Price",dataIndex:"price",key:"price",render:t=>h(t)},{title:"Total",dataIndex:"total",key:"total",render:t=>h(t)}],dataSource:s.items,rowKey:(t,i)=>i,pagination:!1,size:"small",style:{marginBottom:16}})]}),e.jsxs(o,{column:1,bordered:!0,size:"small",children:[e.jsx(o.Item,{label:"Subtotal",children:"omrCell(selectedInvoice.total - (selectedInvoice.taxTotal || 0))"}),e.jsx(o.Item,{label:"Tax",children:"omrCell(selectedInvoice.taxTotal || 0)"}),e.jsx(o.Item,{label:"Total",children:e.jsx("strong",{children:"omrCell(selectedInvoice.total)"})}),e.jsx(o.Item,{label:"Amount Paid",children:"omrCell(selectedInvoice.total - (selectedInvoice.credit || 0))"}),e.jsx(o.Item,{label:"Balance Due",children:e.jsx("strong",{style:{color:s.credit>0?"#ff4d4f":"#52c41a"},children:"omrCell(selectedInvoice.credit || 0)"})})]})]}):e.jsx(P,{})})]})}const{Title:ee,Paragraph:te}=z;function se({token:m}){var I;const[D,v]=l.useState([]),[j,u]=l.useState(!1),[s,f]=l.useState(null),[b,c]=l.useState(!1);l.useEffect(()=>{y()},[]);const y=async()=>{try{u(!0);const a=await p.get({entity:"portal/projects",headers:{Authorization:`Bearer ${m}`}});a.success&&v(a.result||[])}catch(a){console.error("Failed to fetch projects:",a)}finally{u(!1)}},k=async a=>{try{const r=await p.get({entity:`portal/projects/${a}`,headers:{Authorization:`Bearer ${m}`}});r.success&&(f(r.result),c(!0))}catch(r){console.error("Failed to fetch project details:",r)}},n=a=>({active:"success",planning:"processing",completed:"default",onhold:"warning",cancelled:"error"})[a]||"default",g=[{title:"Project Name",dataIndex:"name",key:"name",render:a=>e.jsx("strong",{children:a})},{title:"Status",dataIndex:"status",key:"status",render:a=>e.jsx(S,{color:n(a),children:(a==null?void 0:a.toUpperCase())||"ACTIVE"})},{title:"Start Date",dataIndex:"startDate",key:"startDate",render:a=>a?d(a).format("MMM DD, YYYY"):"-"},{title:"End Date",dataIndex:"endDate",key:"endDate",render:a=>a?d(a).format("MMM DD, YYYY"):"-"},{title:"Progress",dataIndex:"progress",key:"progress",render:a=>e.jsx(_,{percent:a||0,size:"small"})},{title:"Actions",key:"actions",render:(a,r)=>e.jsx(x,{type:"primary",size:"small",icon:e.jsx(L,{}),onClick:()=>k(r._id),children:"View"})}];return e.jsxs(e.Fragment,{children:[e.jsx(M,{columns:g,dataSource:D,rowKey:"_id",loading:j,pagination:{pageSize:10},locale:{emptyText:"No projects found"}}),e.jsx($,{title:e.jsxs(w,{children:[e.jsx(q,{style:{color:"#1890ff"}}),e.jsx("span",{children:"Project Details"})]}),open:b,onCancel:()=>c(!1),footer:[e.jsx(x,{onClick:()=>c(!1),children:"Close"},"close")],width:800,children:s?e.jsxs(e.Fragment,{children:[e.jsxs(o,{column:2,bordered:!0,size:"small",style:{marginBottom:16},children:[e.jsx(o.Item,{label:"Project Name",span:2,children:e.jsx("strong",{children:s.name})}),e.jsx(o.Item,{label:"Status",span:2,children:e.jsx(S,{color:n(s.status),children:((I=s.status)==null?void 0:I.toUpperCase())||"ACTIVE"})}),e.jsx(o.Item,{label:"Start Date",children:s.startDate?d(s.startDate).format("MMMM DD, YYYY"):"-"}),e.jsx(o.Item,{label:"End Date",children:s.endDate?d(s.endDate).format("MMMM DD, YYYY"):"-"}),s.budget&&e.jsx(o.Item,{label:"Budget",span:2,children:h(s.budget)}),e.jsx(o.Item,{label:"Progress",span:2,children:e.jsx(_,{percent:s.progress||0})})]}),s.description&&e.jsxs("div",{style:{marginTop:16},children:[e.jsx(ee,{level:5,children:"Description"}),e.jsx(te,{children:s.description})]})]}):e.jsx(P,{})})]})}const{Header:re,Content:ae}=Q,{Title:U,Text:oe}=z;function Se(){const m=O(),D=K(),[v,j]=l.useState(!0),[u,s]=l.useState(null),[f,b]=l.useState({quotes:0,invoices:0,projects:0}),[c,y]=l.useState(null),n=new URLSearchParams(m.search).get("token");l.useEffect(()=>{if(!n){y("No access token provided. Please use the link sent to your email."),j(!1);return}localStorage.setItem("portalToken",n),g()},[n]);const g=async()=>{try{j(!0);const t=await p.get({entity:"portal/info",headers:{Authorization:`Bearer ${n}`}});t.success?(s(t.result),await I()):y(t.message||"Failed to load client information.")}catch(t){y(t.message||"Invalid or expired access token.")}finally{j(!1)}},I=async()=>{try{const[t,i,C]=await Promise.all([p.get({entity:"portal/quotes",headers:{Authorization:`Bearer ${n}`}}),p.get({entity:"portal/invoices",headers:{Authorization:`Bearer ${n}`}}),p.get({entity:"portal/projects",headers:{Authorization:`Bearer ${n}`}})]);b({quotes:t.success?t.result.length:0,invoices:i.success?i.result.length:0,projects:C.success?C.result.length:0})}catch(t){console.error("Failed to fetch stats:",t)}},a=()=>{localStorage.removeItem("portalToken"),D("/")};if(v)return e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(P,{size:"large",tip:"Loading client portal..."})});if(c)return e.jsx("div",{style:{padding:"48px",maxWidth:600,margin:"0 auto"},children:e.jsx(R,{message:"Access Error",description:c,type:"error",showIcon:!0,action:e.jsx(x,{type:"primary",onClick:()=>D("/"),children:"Go Back"})})});const r=[{key:"quotes",label:e.jsxs("span",{children:[e.jsx(F,{})," Quotes"]}),children:e.jsx(J,{token:n})},{key:"invoices",label:e.jsxs("span",{children:[e.jsx(E,{})," Invoices"]}),children:e.jsx(X,{token:n})},{key:"projects",label:e.jsxs("span",{children:[e.jsx(q,{})," Projects"]}),children:e.jsx(se,{token:n})}];return e.jsxs(Q,{style:{minHeight:"100vh",background:"#f0f2f5"},children:[e.jsxs(re,{style:{background:"#fff",padding:"0 24px",boxShadow:"0 1px 4px rgba(0,21,41,.08)",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:16},children:[e.jsx("div",{style:{background:"#034D57",color:"#fff",padding:"8px 16px",borderRadius:4,fontWeight:"bold",fontSize:18},children:"ALALI"}),e.jsx(U,{level:4,style:{margin:0},children:"Client Portal"})]}),e.jsx(x,{icon:e.jsx(G,{}),onClick:a,children:"Logout"})]}),e.jsx(ae,{style:{padding:"24px"},children:e.jsxs("div",{style:{maxWidth:1200,margin:"0 auto"},children:[e.jsxs(Y,{style:{marginBottom:24},children:[e.jsxs(U,{level:3,children:["Welcome, ",u==null?void 0:u.name,"!"]}),e.jsx(oe,{type:"secondary",children:"This is your secure portal to view quotes, invoices, and projects from Alali Investment."})]}),e.jsxs(W,{gutter:16,style:{marginBottom:24},children:[e.jsx(A,{xs:24,sm:8,children:e.jsx(Y,{children:e.jsx(B,{title:"Total Quotes",value:f.quotes,prefix:e.jsx(F,{}),valueStyle:{color:"#034D57"}})})}),e.jsx(A,{xs:24,sm:8,children:e.jsx(Y,{children:e.jsx(B,{title:"Total Invoices",value:f.invoices,prefix:e.jsx(E,{}),valueStyle:{color:"#4CB480"}})})}),e.jsx(A,{xs:24,sm:8,children:e.jsx(Y,{children:e.jsx(B,{title:"Active Projects",value:f.projects,prefix:e.jsx(q,{}),valueStyle:{color:"#1890ff"}})})})]}),e.jsx(Y,{children:e.jsx(Z,{defaultActiveKey:"quotes",items:r})})]})})]})}export{Se as default};
