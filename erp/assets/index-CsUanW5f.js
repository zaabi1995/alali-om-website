import{r as o,j as t}from"./index-C236tqC8.js";import{o as I}from"./omrFormat-D9zakjTj.js";import{d as l}from"./dayjs.min-BePh7Oku.js";import{aG as c,ai as f,aA as q,aB as x,c9 as J,aI as L,ar as K,ay as d}from"./IdurarOs-CIvrJM3G.js";import{F as M}from"./Table-BXAYilt4.js";import{M as w}from"./index-DIWJIPsd.js";import{C as g}from"./index-DKmxjtwJ.js";import{S as y}from"./index-f2gLqROF.js";import{A as U}from"./index-71oNUNq5.js";import{T as A}from"./index-C-MdfhzB.js";import{S as W}from"./index-D07aC4PS.js";import{T as G}from"./index-iX9YJgKp.js";import{D as Q}from"./index-D5L4Ge1X.js";import{s as u}from"./index-BTpainSG.js";import{R as V}from"./ErpApp-DwaI_8s0.js";import{P as X}from"./PlusOutlined-DUjbHxHh.js";import{C as Z}from"./CheckCircleOutlined-CeSDzCbO.js";import"./pickAttrs-DhldMqNY.js";import"./DownOutlined-C4yJOkOC.js";import"./ActionButton-C2LqLN_L.js";import"./useClosable-BwSv22Km.js";import"./fade-BorYK4_e.js";import"./Skeleton-BfIMR0fQ.js";import"./index-C-HV-BqQ.js";import"./ClockCircleOutlined-DveV7d10.js";const{Title:R,Text:Ie}=K,{RangePicker:ee}=Q;function S(){return{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`}}function j(){return{...S(),"Content-Type":"application/json"}}function Me(){var b,D;const[T,P]=o.useState([]),[Y,F]=o.useState([]),[$,k]=o.useState(!1),[s,r]=o.useState(null),[O,p]=o.useState(!1),[_,C]=o.useState(!1),[B]=c.useForm(),h=async()=>{k(!0);const[e,a]=await Promise.all([fetch(d+"bankreconciliation/list?items=20",{headers:S()}).then(n=>n.json()).catch(()=>({})),fetch(d+"bankaccount/list",{headers:S()}).then(n=>n.json()).catch(()=>({}))]);e.success&&P(e.result||[]),a.success&&F(a.result||[]),k(!1)};o.useEffect(()=>{h()},[]);const z=async()=>{let e;try{e=await B.validateFields()}catch{return}C(!0);try{const a={bankAccountId:e.bankAccountId,periodStart:e.period[0].toISOString(),periodEnd:e.period[1].toISOString(),statementBalance:e.statementBalance},n=await fetch(d+"bankreconciliation/start",{method:"POST",headers:j(),body:JSON.stringify(a)}).then(i=>i.json());n.success?(u.success(n.message),p(!1),r(n.result),h()):u.error(n.message||"Failed")}finally{C(!1)}},E=async(e,a)=>{const n=await fetch(`${d}bankreconciliation/update-items/${e}`,{method:"PATCH",headers:j(),body:JSON.stringify({clearedItems:a})}).then(i=>i.json()).catch(()=>({}));n.success&&r(n.result)},N=async e=>{const a=await fetch(`${d}bankreconciliation/complete/${e}`,{method:"PATCH",headers:j()}).then(n=>n.json()).catch(()=>({}));a.success?(u.success(a.message),r(null),h()):u.error(a.message||"Failed")},v=[{title:"Bank Account",dataIndex:"bankAccount",render:e=>(e==null?void 0:e.accountName)||"—"},{title:"Period",render:(e,a)=>`${l(a.periodStart).format("DD MMM")} – ${l(a.periodEnd).format("DD MMM YYYY")}`},{title:"Statement Balance",dataIndex:"statementBalance",align:"right",render:e=>I(e)},{title:"Difference",dataIndex:"difference",align:"right",render:e=>t.jsx("span",{style:{color:Math.abs(e)<.01?"#4CB480":"#e53e3e",fontWeight:700},children:e==null?void 0:e.toFixed(3)})},{title:"Status",dataIndex:"status",render:e=>t.jsx(A,{color:e==="reconciled"?"success":"default",children:e==null?void 0:e.toUpperCase()})},{title:"",render:(e,a)=>a.status==="draft"&&t.jsx(f,{size:"small",onClick:()=>r(a),style:{color:"#034D57"},children:"Open"})}];return t.jsxs("div",{style:{padding:24},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsxs(R,{level:4,style:{margin:0,color:"#034D57"},children:[t.jsx(V,{style:{marginRight:8}}),"Bank Reconciliation"]}),t.jsx(f,{type:"primary",icon:t.jsx(X,{}),onClick:()=>p(!0),style:{background:"#034D57",borderColor:"#034D57"},children:"Start Reconciliation"})]}),t.jsx(M,{columns:v,dataSource:T,rowKey:"_id",loading:$,size:"small",pagination:!1,onRow:e=>({onClick:()=>e.status==="draft"&&r(e)})}),s&&t.jsxs(w,{title:`Reconciliation — ${l(s.periodStart).format("DD MMM")} to ${l(s.periodEnd).format("DD MMM YYYY")}`,open:!!s,onCancel:()=>r(null),footer:null,width:800,children:[t.jsxs(q,{gutter:16,style:{marginBottom:16},children:[t.jsx(x,{span:8,children:t.jsx(g,{size:"small",children:t.jsx(y,{title:"Statement Balance",value:(b=s.statementBalance)==null?void 0:b.toFixed(3),valueStyle:{color:"#034D57"}})})}),t.jsx(x,{span:8,children:t.jsx(g,{size:"small",children:t.jsx(y,{title:"Cleared Balance",value:(s.statementBalance-s.difference).toFixed(3)})})}),t.jsx(x,{span:8,children:t.jsx(g,{size:"small",children:t.jsx(y,{title:"Difference",value:(D=s.difference)==null?void 0:D.toFixed(3),valueStyle:{color:Math.abs(s.difference)<.01?"#4CB480":"#e53e3e",fontWeight:700}})})})]}),Math.abs(s.difference)<.01&&t.jsx(U,{type:"success",message:"✓ Balanced — ready to reconcile",style:{marginBottom:12}}),t.jsx(R,{level:5,style:{color:"#034D57",marginBottom:8},children:"Transactions — check off what matches your statement"}),t.jsx(M,{size:"small",pagination:!1,dataSource:s.clearedItems||[],rowKey:(e,a)=>a,columns:[{title:"✓",width:40,render:(e,a,n)=>t.jsx(J,{checked:a.cleared,onChange:i=>{const m=[...s.clearedItems];m[n]={...m[n],cleared:i.target.checked};const H={...s,clearedItems:m};r(H),E(s._id,m)}})},{title:"Date",dataIndex:"date",width:100,render:e=>l(e).format("DD MMM YYYY")},{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Type",dataIndex:"type",width:90,render:e=>t.jsx(A,{color:e==="deposit"?"green":"red",children:e})},{title:"Amount",dataIndex:"amount",align:"right",render:e=>I(e)}],rowClassName:e=>e.cleared?"row-cleared":""}),t.jsx(L,{}),t.jsx("div",{style:{textAlign:"right"},children:t.jsx(f,{type:"primary",icon:t.jsx(Z,{}),disabled:Math.abs(s.difference)>.01,onClick:()=>N(s._id),style:{background:"#4CB480",borderColor:"#4CB480"},children:"Complete Reconciliation"})})]}),t.jsx(w,{title:"Start New Reconciliation",open:O,onCancel:()=>p(!1),onOk:z,okText:"Start",confirmLoading:_,okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:t.jsxs(c,{form:B,layout:"vertical",style:{marginTop:12},children:[t.jsx(c.Item,{name:"bankAccountId",label:"Bank Account",rules:[{required:!0}],children:t.jsx(W,{options:Y.map(e=>({value:e._id,label:`${e.accountName} (${e.currency})`}))})}),t.jsx(c.Item,{name:"period",label:"Statement Period",rules:[{required:!0}],children:t.jsx(ee,{style:{width:"100%"}})}),t.jsx(c.Item,{name:"statementBalance",label:"Closing Balance on Bank Statement",rules:[{required:!0}],children:t.jsx(G,{style:{width:"100%"},min:0,precision:3,placeholder:"0.000"})})]})})]})}export{Me as default};
