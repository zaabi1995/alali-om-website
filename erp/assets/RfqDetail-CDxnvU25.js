import{r as l,o as A,m as O,j as e}from"./index-P0d3qDOI.js";import{O as N,g as B,aV as p,aN as F,aM as x,aL as d,aB as u,aW as L,aY as T}from"./IdurarOs-C9Hfvmhw.js";import{A as P}from"./index-lSvV4oKT.js";import{B as Q}from"./Breadcrumb-B14q5kE8.js";import{C as m}from"./index-D7ycNofp.js";import{l as C,T as h}from"./ErpApp-DhsEC5_U.js";import{F as _}from"./FileDoneOutlined-B6c6-_Q7.js";import{D as a}from"./index-CHp4KoHR.js";import{F as $}from"./Table-cLwJzRkI.js";import{s as f}from"./index-GLktio_A.js";import{A as H}from"./ArrowLeftOutlined-WCgDpsBv.js";import{C as M}from"./CheckCircleOutlined-C1gnfKMP.js";import{C as E}from"./CloseCircleOutlined-D70cVxqP.js";import"./Skeleton-HlVWT2JN.js";import"./index-uRPskGn0.js";import"./PlusOutlined-7jHXhlhV.js";var V={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M854.6 288.6L639.4 73.4c-6-6-14.1-9.4-22.6-9.4H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V311.3c0-8.5-3.4-16.7-9.4-22.7zM790.2 326H602V137.8L790.2 326zm1.8 562H232V136h302v216a42 42 0 0042 42h216v494zM544 472c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v108H372c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h108v108c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V644h108c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8H544V472z"}}]},name:"file-add",theme:"outlined"},W=function(n,t){return l.createElement(N,B({},n,{ref:t,icon:V}))};const G=l.forwardRef(W);function g(){var i,n;try{const t=(n=(i=JSON.parse(localStorage.getItem("auth")||"{}"))==null?void 0:i.current)==null?void 0:n.token;return t?{Authorization:`Bearer ${t}`}:{}}catch{return{}}}const{Title:U,Text:y}=T,Y={new:"blue",in_progress:"processing",researched:"purple",quoted:"success",won:"green",lost:"red",expired:"default"},J={ior:"red",routine:"orange",normal:"default"};function me(){var w;const{id:i}=A(),n=O(),[t,j]=l.useState(null),[o,q]=l.useState([]),[D,R]=l.useState(!0),[v,b]=l.useState(!1);l.useEffect(()=>{fetch(p+`rfq/withparts/${i}`,{headers:g()}).then(r=>r.json()).then(r=>{if(r.success){const{parts:s,...c}=r.result;j(c),q(s||[])}R(!1)})},[i]);const k=async()=>{b(!0);const s=await(await fetch(p+`rfq/generate-quote/${i}`,{method:"POST",headers:g()})).json();b(!1),s.success?(f.success(`Quote #${s.result.quoteNumber} created!`),setTimeout(()=>n(`/quote/read/${s.result.quoteId}`),800)):f.error(s.message||"Failed to generate quote")},S=async r=>{(await(await fetch(p+`rfq/update/${i}`,{method:"PATCH",headers:g(),body:JSON.stringify({status:r})})).json()).success&&(f.success("Status updated"),j(I=>({...I,status:r})))},z=[{title:"Part Number",dataIndex:"partNumber",key:"partNumber",width:140,render:r=>e.jsx(y,{strong:!0,style:{color:"#034D57"},children:r||"—"})},{title:"NSN",dataIndex:"nsn",key:"nsn",width:130,render:r=>r||"—"},{title:"Description",dataIndex:"description",key:"description",ellipsis:!0,render:r=>r||"—"},{title:"Qty",dataIndex:"quantity",key:"quantity",width:60,align:"center"},{title:"Unit",dataIndex:"unit",key:"unit",width:60,align:"center"},{title:"Research",dataIndex:"status",key:"status",width:100,render:r=>{const s={done:"success",pending:"default",researching:"processing",no_results:"warning"};return e.jsx(h,{color:s[r]||"default",style:{fontSize:11},children:r})}},{title:"Sell Price (OMR)",dataIndex:"unitSellPrice",key:"unitSellPrice",width:120,align:"right",render:(r,s)=>{const c=r||s.unitCostOmr;return c?c.toFixed(3):"—"}},{title:"Recommendation",dataIndex:"recommendation",key:"recommendation",ellipsis:!0,render:r=>r?e.jsx(y,{type:"secondary",style:{fontSize:12},children:r}):"—"}];return D?e.jsx("div",{style:{textAlign:"center",padding:80},children:e.jsx(F,{size:"large",tip:"Loading RFQ..."})}):t?e.jsxs("div",{style:{paddingBottom:40},children:[e.jsx(Q,{style:{marginBottom:16},items:[{title:e.jsx("span",{style:{cursor:"pointer",color:"#034D57"},onClick:()=>n("/rfq"),children:"RFQs"})},{title:t.rfqNumber||t.subject||i}]}),e.jsx(m,{style:{borderRadius:8,marginBottom:16,borderLeft:`4px solid ${t.priority==="ior"?"#ff4d4f":t.priority==="routine"?"#fa8c16":"#034D57"}`},bodyStyle:{padding:"16px 20px"},children:e.jsxs(x,{align:"middle",justify:"space-between",wrap:!0,gutter:[8,8],children:[e.jsx(d,{children:e.jsxs(C,{wrap:!0,size:8,children:[e.jsx(u,{icon:e.jsx(H,{}),onClick:()=>n("/rfq"),type:"text",size:"small"}),e.jsx(U,{level:4,style:{margin:0,color:"#034D57"},children:t.rfqNumber||t.subject}),e.jsx(h,{color:J[t.priority]||"default",style:{fontWeight:600},children:(w=t.priority)==null?void 0:w.toUpperCase()}),e.jsx(h,{color:Y[t.status]||"default",children:t.status})]})}),e.jsx(d,{children:e.jsxs(C,{wrap:!0,size:8,children:[["new","in_progress","researched"].includes(t.status)&&e.jsx(u,{type:"primary",icon:e.jsx(G,{}),loading:v,onClick:k,style:{background:"#034D57",borderColor:"#034D57"},children:"Generate Quote"}),t.quote&&e.jsx(u,{icon:e.jsx(_,{}),type:"primary",ghost:!0,style:{borderColor:"#4CB480",color:"#4CB480"},onClick:()=>n(`/quote/read/${t.quote._id||t.quote}`),children:"View Quote"}),t.status!=="won"&&t.status!=="expired"&&e.jsx(u,{icon:e.jsx(M,{}),style:{borderColor:"#52c41a",color:"#52c41a"},onClick:()=>S("won"),children:"Mark Won"}),!["lost","expired"].includes(t.status)&&e.jsx(u,{icon:e.jsx(E,{}),danger:!0,ghost:!0,onClick:()=>S("lost"),children:"Mark Lost"})]})})]})}),e.jsxs(x,{gutter:[16,16],children:[e.jsx(d,{xs:24,md:10,children:e.jsx(m,{title:e.jsx("span",{style:{color:"#034D57",fontWeight:600},children:"RFQ Details"}),size:"small",style:{borderRadius:8,height:"100%"},children:e.jsxs(a,{column:1,size:"small",labelStyle:{color:"#888",fontSize:12},contentStyle:{fontSize:13},children:[e.jsx(a.Item,{label:"RFQ Number",children:t.rfqNumber||"—"}),e.jsx(a.Item,{label:"Client",children:e.jsx(h,{color:"geekblue",children:t.client||"—"})}),e.jsx(a.Item,{label:"Sender",children:t.senderEmail||"—"}),e.jsx(a.Item,{label:"Received",children:t.receivedAt?new Date(t.receivedAt).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}):"—"}),e.jsx(a.Item,{label:"Deadline",children:t.deadlineAt?e.jsx("span",{style:{color:new Date(t.deadlineAt)<new Date?"#ff4d4f":"#333"},children:new Date(t.deadlineAt).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}):"—"}),e.jsx(a.Item,{label:"Parts Count",children:o.length}),t.notes&&e.jsx(a.Item,{label:"Notes",children:t.notes})]})})}),e.jsx(d,{xs:24,md:14,children:e.jsxs(m,{title:e.jsx("span",{style:{color:"#034D57",fontWeight:600},children:"Email Subject"}),size:"small",style:{borderRadius:8,height:"100%"},children:[e.jsx(y,{style:{color:"#555",fontSize:14},children:t.subject||t.rfqNumber||"—"}),t.emailBody&&e.jsxs(e.Fragment,{children:[e.jsx(L,{style:{margin:"12px 0"}}),e.jsxs("div",{style:{maxHeight:200,overflowY:"auto",fontSize:12,color:"#666",whiteSpace:"pre-wrap",lineHeight:1.6},children:[t.emailBody.slice(0,800),t.emailBody.length>800?"...":""]})]})]})})]}),e.jsx(m,{title:e.jsxs(x,{justify:"space-between",align:"middle",children:[e.jsx(d,{children:e.jsxs("span",{style:{color:"#034D57",fontWeight:600},children:["Parts (",o.length,")"]})}),e.jsx(d,{children:e.jsxs(h,{color:o.some(r=>r.status==="done")?"success":"default",style:{fontSize:12},children:[o.filter(r=>r.status==="done").length," / ",o.length," researched"]})})]}),size:"small",style:{borderRadius:8,marginTop:16},bodyStyle:{padding:0},children:o.length===0?e.jsx("div",{style:{padding:32,textAlign:"center",color:"#999"},children:"No parts extracted from this RFQ yet"}):e.jsx("div",{style:{overflowX:"auto"},children:e.jsx($,{dataSource:o,columns:z,rowKey:"_id",size:"small",pagination:o.length>20?{pageSize:20}:!1,rowClassName:r=>r.status==="no_results"?"part-no-results":""})})}),e.jsx("style",{children:".part-no-results { background: #fffbe6 !important; }"})]}):e.jsx(P,{type:"error",message:"RFQ not found"})}export{me as default};
