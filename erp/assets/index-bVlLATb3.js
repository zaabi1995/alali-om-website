import{r as d,j as e}from"./index-CB_AWKJY.js";import{b8 as s,aB as o,aX as T,cM as z,aY as H,aV as m,b5 as Y}from"./IdurarOs-20-QWMXR.js";import{C as V}from"./index-ByWerc77.js";import{F as K}from"./Table-r_Zm9lDt.js";import{M as F}from"./index--olNpC1x.js";import{f as I,F as W,T as S,l as E,c as X,k as G}from"./ErpApp-Cy5crc22.js";import{s as r}from"./index-CvT_fNtU.js";import{P as Q}from"./index-CcsZN35Z.js";import{P as Z}from"./PlusOutlined-YO2bg1HW.js";import"./Skeleton-C4FpL5iW.js";import"./index-2JQk6u8I.js";import"./ActionButton-CQP3RUHL.js";import"./fade-CEgBSdG5.js";const{Text:D,Title:ee}=H,{TextArea:te}=T,{Option:b}=I;function v(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function k(){return{...v(),"Content-Type":"application/json"}}function ae(){var u,h;try{return((h=(u=JSON.parse(localStorage.getItem("auth")||"{}"))==null?void 0:u.current)==null?void 0:h.role)||"staff"}catch{return"staff"}}const _=()=>["owner","admin","gm","manager"].includes(ae()),ne={letter:"blue",contract:"green",nda:"orange",other:"default"};function xe(){var N;const[u,h]=d.useState([]),[R,O]=d.useState(!1),[p,f]=d.useState({open:!1,record:null}),[c,j]=d.useState({open:!1,template:null}),[x,w]=d.useState({open:!1,content:""}),[g]=s.useForm(),[y]=s.useForm(),C=async()=>{O(!0);const t=await fetch(m+"documenttemplate/list",{headers:v()}).then(a=>a.json()).catch(()=>({}));t.success&&h(t.result||[]),O(!1)};d.useEffect(()=>{C()},[]);const L=()=>{g.resetFields(),f({open:!0,record:null})},M=t=>{g.setFieldsValue(t),f({open:!0,record:t})},$=async t=>{const a=p.record?`documenttemplate/update/${p.record._id}`:"documenttemplate/create",n=p.record?"PATCH":"POST",l=await fetch(m+a,{method:n,headers:k(),body:JSON.stringify(t)}).then(i=>i.json()).catch(()=>({}));l.success?(r.success(l.message||"Template saved"),f({open:!1,record:null}),C()):r.error(l.message||"Failed to save template")},q=async t=>{const a=await fetch(m+`documenttemplate/delete/${t}`,{method:"DELETE",headers:v()}).then(n=>n.json()).catch(()=>({}));a.success?(r.success("Template deleted"),C()):r.error(a.message||"Failed to delete")},A=t=>{y.resetFields(),j({open:!0,template:t})},U=async t=>{const a=await fetch(m+`documenttemplate/fill/${c.template._id}`,{method:"POST",headers:k(),body:JSON.stringify({data:t})}).then(n=>n.json()).catch(()=>({}));a.success?(w({open:!0,content:a.result.content,subject:a.result.subject}),j({open:!1,template:null})):r.error(a.message||"Failed to fill template")},J=async t=>{try{const a=await fetch(m+`documenttemplate/generate-pdf/${c.template._id}`,{method:"POST",headers:k(),body:JSON.stringify({data:t})});if(a.ok){const n=await a.blob(),l=window.URL.createObjectURL(n),i=document.createElement("a");i.href=l,i.download=`${c.template.templateName.replace(/\s+/g,"_")}.pdf`,document.body.appendChild(i),i.click(),i.remove(),window.URL.revokeObjectURL(l),r.success("PDF downloaded")}else r.error("Failed to generate PDF")}catch{r.error("Error downloading PDF")}},P=t=>{const a=t.match(/{([^}]+)}/g);return a?[...new Set(a.map(n=>n.replace(/[{}]/g,"")))]:[]},B=[{title:"Template Name",dataIndex:"templateName",key:"templateName",render:t=>e.jsx(D,{strong:!0,children:t})},{title:"Type",dataIndex:"templateType",key:"templateType",render:t=>e.jsx(S,{color:ne[t]||"default",children:t})},{title:"Subject",dataIndex:"subject",key:"subject",ellipsis:!0},{title:"Placeholders",key:"placeholders",render:(t,a)=>{const n=P(a.content);return n.length>0?e.jsxs(E,{wrap:!0,size:"small",children:[n.slice(0,3).map(l=>e.jsx(S,{children:`{${l}}`},l)),n.length>3&&e.jsxs(S,{children:["+",n.length-3," more"]})]}):e.jsx(D,{type:"secondary",children:"None"})}},{title:"Actions",key:"actions",render:(t,a)=>e.jsxs(E,{children:[e.jsx(o,{type:"link",icon:e.jsx(X,{}),onClick:()=>A(a),children:"Fill"}),_()&&e.jsxs(e.Fragment,{children:[e.jsx(o,{type:"link",icon:e.jsx(Y,{}),onClick:()=>M(a)}),e.jsx(Q,{title:"Delete this template?",onConfirm:()=>q(a._id),okText:"Yes",cancelText:"No",children:e.jsx(o,{type:"link",danger:!0,icon:e.jsx(G,{})})})]})]})}];return e.jsxs("div",{style:{padding:24},children:[e.jsxs(V,{children:[e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(ee,{level:3,children:"Document Templates"}),_()&&e.jsx(o,{type:"primary",icon:e.jsx(Z,{}),onClick:L,children:"New Template"})]}),e.jsx(K,{dataSource:u,columns:B,loading:R,rowKey:"_id",pagination:{pageSize:10}})]}),e.jsx(F,{title:p.record?"Edit Template":"New Template",open:p.open,onCancel:()=>f({open:!1,record:null}),onOk:()=>g.submit(),width:800,okText:"Save",children:e.jsxs(s,{form:g,onFinish:$,layout:"vertical",children:[e.jsx(s.Item,{label:"Template Name",name:"templateName",rules:[{required:!0,message:"Required"}],children:e.jsx(T,{placeholder:"e.g., Award Letter"})}),e.jsx(s.Item,{label:"Type",name:"templateType",rules:[{required:!0,message:"Required"}],children:e.jsxs(I,{children:[e.jsx(b,{value:"letter",children:"Letter"}),e.jsx(b,{value:"contract",children:"Contract"}),e.jsx(b,{value:"nda",children:"NDA"}),e.jsx(b,{value:"other",children:"Other"})]})}),e.jsx(s.Item,{label:"Subject",name:"subject",children:e.jsx(T,{placeholder:"Document subject (optional)"})}),e.jsx(s.Item,{label:"Content",name:"content",rules:[{required:!0,message:"Required"}],extra:"Use {placeholder} for variables, e.g., {client_name}, {date}, {amount}",children:e.jsx(te,{rows:12,placeholder:`Dear {client_name},

We are pleased to inform you...`})})]})}),e.jsx(F,{title:`Fill Template: ${((N=c.template)==null?void 0:N.templateName)||""}`,open:c.open,onCancel:()=>j({open:!1,template:null}),footer:[e.jsx(o,{onClick:()=>j({open:!1,template:null}),children:"Cancel"},"cancel"),e.jsx(o,{type:"default",onClick:()=>y.submit(),children:"Preview"},"preview"),e.jsx(o,{type:"primary",icon:e.jsx(W,{}),onClick:()=>y.validateFields().then(t=>J(t)),children:"Download PDF"},"pdf")],width:600,children:e.jsx(s,{form:y,onFinish:U,layout:"vertical",children:c.template&&P(c.template.content).map(t=>e.jsx(s.Item,{label:t.replace(/_/g," ").replace(/\b\w/g,a=>a.toUpperCase()),name:t,rules:[{required:!0,message:"Required"}],children:e.jsx(T,{placeholder:`Enter ${t}`})},t))})}),e.jsx(F,{title:x.subject||"Document Preview",open:x.open,onCancel:()=>w({open:!1,content:"",subject:""}),footer:[e.jsx(o,{onClick:()=>w({open:!1,content:"",subject:""}),children:"Close"},"close"),e.jsx(o,{icon:e.jsx(z,{}),onClick:()=>{navigator.clipboard.writeText(x.content),r.success("Copied to clipboard")},children:"Copy"},"copy")],width:700,children:e.jsx("div",{style:{whiteSpace:"pre-wrap",padding:16,backgroundColor:"#f5f5f5",borderRadius:4},children:x.content})})]})}export{xe as default};
