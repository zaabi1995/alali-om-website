import{m as M,o as H,r as c,j as e}from"./index-xKceigQ0.js";import{d as I}from"./dayjs.min-D6_-DZvu.js";import{b7 as i,aZ as u,aB as h,aM as J,aL as n,a_ as C,aY as W}from"./IdurarOs-DWdCVvum.js";import{C as S}from"./index-BUWaePBC.js";import{e as p,r as B}from"./ErpApp-CrOwuTkb.js";import{D as A}from"./index-Drfp11gL.js";import{T as j}from"./index-DzdMc7U4.js";import{F as G}from"./Table-CQKa0NzZ.js";import{s as y}from"./index-BKLH6gXI.js";import{A as K}from"./ArrowLeftOutlined-B-ziqUHn.js";import{P as Q}from"./PlusOutlined-YwBt1xJq.js";import{S as Y}from"./SaveOutlined-BaV8pD4I.js";import{D as Z}from"./DeleteOutlined-Bv5Kfpjd.js";import"./Skeleton-CEIVYFMG.js";import"./index-C7CQP6Zi.js";import"./ClockCircleOutlined-Dj8TUoQ8.js";const{Title:X}=W,{TextArea:ee}=C;function te(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`,"Content-Type":"application/json"}}function w(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function ge(){const g=M(),{id:l}=H(),[O]=i.useForm(),[z,R]=c.useState([]),[V,_]=c.useState([]),[m,x]=c.useState([{key:0,description:"",quantity:1,unitPrice:0,total:0}]),[f,k]=c.useState(0),[L,D]=c.useState(!1);c.useEffect(()=>{fetch(u+"vendor/listAll",{headers:w()}).then(t=>t.json()).then(t=>t.result&&R(t.result)).catch(()=>{}),fetch(u+"purchaseorder/list",{headers:w()}).then(t=>t.json()).then(t=>t.result&&_(t.result)).catch(()=>{}),l&&fetch(u+`vendorbill/read/${l}`,{headers:w()}).then(t=>t.json()).then(t=>{var s,r,o;if(t.success&&t.result){const a=t.result;O.setFieldsValue({...a,date:a.date?I(a.date):null,dueDate:a.dueDate?I(a.dueDate):null,vendor:((s=a.vendor)==null?void 0:s._id)||a.vendor,purchaseOrder:((r=a.purchaseOrder)==null?void 0:r._id)||a.purchaseOrder}),(o=a.items)!=null&&o.length&&x(a.items.map((T,d)=>({...T,key:d}))),k(a.taxRate||0)}}).catch(()=>{})},[l]);const F=t=>t.map(s=>({...s,total:parseFloat(((s.quantity||1)*(s.unitPrice||0)).toFixed(3))})),v=(t,s,r)=>{const o=m.map(a=>a.key===t?{...a,[s]:r}:a);x(F(o))},N=()=>x(t=>[...t,{key:Date.now(),description:"",quantity:1,unitPrice:0,total:0}]),q=t=>x(s=>s.filter(r=>r.key!==t)),b=m.reduce((t,s)=>t+(s.total||0),0),P=parseFloat((b*f/100).toFixed(3)),E=parseFloat((b+P).toFixed(3)),$=async t=>{var o,a;if(m.length===0)return y.error("Add at least one item");D(!0);const s={...t,date:(o=t.date)==null?void 0:o.toISOString(),dueDate:(a=t.dueDate)==null?void 0:a.toISOString(),items:F(m),taxRate:f},r=l?u+`vendorbill/update/${l}`:u+"vendorbill/create";try{const d=await(await fetch(r,{method:l?"PATCH":"POST",headers:te(),body:JSON.stringify(s)})).json();d.success?(y.success(d.message||"Saved"),g(`/vendor-bill/read/${d.result._id}`)):y.error(d.message||"Failed")}catch{y.error("Network error")}finally{D(!1)}},U=[{title:"Description",dataIndex:"description",render:(t,s)=>e.jsx(C,{size:"small",value:t,onChange:r=>v(s.key,"description",r.target.value),placeholder:"Item description"})},{title:"Qty",dataIndex:"quantity",width:80,render:(t,s)=>e.jsx(j,{size:"small",min:0,precision:2,value:t,onChange:r=>v(s.key,"quantity",r||0),style:{width:"100%"}})},{title:"Unit Price",dataIndex:"unitPrice",width:130,render:(t,s)=>e.jsx(j,{size:"small",min:0,precision:4,value:t,onChange:r=>v(s.key,"unitPrice",r||0),style:{width:"100%"}})},{title:"Total",dataIndex:"total",width:100,align:"right",render:t=>e.jsx("b",{children:parseFloat(t||0).toFixed(3)})},{title:"",width:40,render:(t,s)=>e.jsx(h,{size:"small",type:"text",danger:!0,icon:e.jsx(Z,{}),onClick:()=>q(s.key)})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:20},children:[e.jsx(h,{icon:e.jsx(K,{}),onClick:()=>g("/vendor-bill")}),e.jsx(X,{level:4,style:{margin:0,color:"#034D57"},children:l?"Edit Bill":"New Vendor Bill"})]}),e.jsxs(i,{form:O,layout:"vertical",onFinish:$,children:[e.jsx(S,{title:"Bill Details",size:"small",style:{marginBottom:16},children:e.jsxs(J,{gutter:16,children:[e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"vendor",label:"Vendor",rules:[{required:!0}],children:e.jsx(p,{showSearch:!0,filterOption:(t,s)=>s.label.toLowerCase().includes(t.toLowerCase()),placeholder:"Select vendor",options:z.map(t=>({value:t._id,label:t.companyName}))})})}),e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"vendorRef",label:"Vendor Invoice #",children:e.jsx(C,{placeholder:"Vendor's invoice number"})})}),e.jsx(n,{xs:12,sm:6,children:e.jsx(i.Item,{name:"date",label:"Bill Date",rules:[{required:!0}],initialValue:I(),children:e.jsx(A,{style:{width:"100%"}})})}),e.jsx(n,{xs:12,sm:6,children:e.jsx(i.Item,{name:"dueDate",label:"Due Date",children:e.jsx(A,{style:{width:"100%"}})})}),e.jsx(n,{xs:12,sm:6,children:e.jsx(i.Item,{name:"currency",label:"Currency",initialValue:"OMR",children:e.jsx(p,{options:["OMR","USD","EUR","GBP","AED"].map(t=>({value:t,label:t}))})})}),e.jsx(n,{xs:12,sm:6,children:e.jsx(i.Item,{name:"exchangeRate",label:"Rate to OMR",initialValue:1,children:e.jsx(j,{min:0,precision:6,style:{width:"100%"}})})}),e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"purchaseOrder",label:"Linked PO (optional)",children:e.jsx(p,{showSearch:!0,allowClear:!0,filterOption:(t,s)=>s.label.toLowerCase().includes(t.toLowerCase()),placeholder:"Link to PO",options:V.map(t=>({value:t._id,label:`PO-${t.number}/${t.year}`}))})})}),e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"status",label:"Status",initialValue:"draft",children:e.jsx(p,{options:["draft","received","approved","partially_paid","paid","overdue","cancelled"].map(t=>({value:t,label:t.replace(/_/g," ").replace(/\b\w/g,s=>s.toUpperCase())}))})})})]})}),e.jsxs(S,{title:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("span",{children:"Line Items"}),e.jsx(h,{size:"small",icon:e.jsx(Q,{}),onClick:N,type:"dashed",children:"Add Item"})]}),size:"small",style:{marginBottom:16},children:[e.jsx(G,{columns:U,dataSource:m,rowKey:"key",pagination:!1,size:"small"}),e.jsx("div",{style:{textAlign:"right",marginTop:12},children:e.jsxs(B,{direction:"vertical",size:2,style:{minWidth:200},children:[e.jsxs("div",{children:[e.jsx("span",{style:{color:"#888"},children:"Subtotal: "}),e.jsx("b",{children:b.toFixed(3)})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("span",{style:{color:"#888"},children:"Tax %: "}),e.jsx(j,{size:"small",min:0,max:100,value:f,onChange:t=>k(t||0),style:{width:70}}),e.jsx("b",{children:P.toFixed(3)})]}),e.jsxs("div",{style:{fontSize:16,fontWeight:700,color:"#034D57"},children:["Total: ",E.toFixed(3)]})]})})]}),e.jsx(S,{size:"small",style:{marginBottom:16},children:e.jsx(i.Item,{name:"notes",label:"Notes",children:e.jsx(ee,{rows:2})})}),e.jsx("div",{style:{textAlign:"right"},children:e.jsxs(B,{children:[e.jsx(h,{onClick:()=>g("/vendor-bill"),children:"Cancel"}),e.jsx(h,{type:"primary",htmlType:"submit",loading:L,icon:e.jsx(Y,{}),style:{background:"#034D57"},children:l?"Update":"Create Bill"})]})})]})]})}export{ge as default};
