import{m as A,o as M,r as n,j as e}from"./index-CfD99eWM.js";import{o as $}from"./omrFormat-DaDUL0TV.js";import{T as B,w as E,F as L,g as F}from"./ErpApp-5RKUdHDV.js";import{aV as g,aN as _,aB as i,b5 as Y,aM as V,aL as D,aY as H}from"./IdurarOs-CIf1RHA4.js";import{s as y}from"./index-DE8wEg85.js";import{C as m}from"./index-3Eb24upP.js";import{D as C}from"./index-g-F5wqfX.js";import{F as d}from"./Table-D2HkX3gJ.js";import{M as J}from"./index-ljet-ASd.js";import{A as W}from"./ArrowLeftOutlined-nIbloWvE.js";import"./Skeleton-OgAJrl8z.js";import"./index-C2hiuglI.js";import"./PlusOutlined-C4PIKCeA.js";import"./ActionButton-CVmzQOIY.js";import"./fade-By_iT9J6.js";const{Title:P,Text:b}=H,q={draft:"default",issued:"blue",applied:"green",voided:"red"};function S(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function c(u){return $(u)}function ce(){var k,I;const u=A(),{id:o}=M(),[t,w]=n.useState(null),[U,N]=n.useState(!0),[v,R]=n.useState(!1),[a,f]=n.useState(null),[O,h]=n.useState(!1);n.useEffect(()=>{fetch(g+`creditnote/read/${o}`,{headers:S()}).then(s=>s.json()).then(s=>{s.success&&w(s.result)}).catch(()=>y.error("Failed")).finally(()=>N(!1))},[o]);const x=async(s=!1)=>{R(!0);try{const r=await fetch(g+`creditnote/pdf/${o}`,{headers:S()});if(!r.ok)throw new Error("PDF failed");const l=await r.blob(),p=URL.createObjectURL(l);if(s){const j=document.createElement("a");j.href=p,j.download=`CN-${t==null?void 0:t.number}-${t==null?void 0:t.year}.pdf`,j.click(),URL.revokeObjectURL(p)}else f(p),h(!0)}catch(r){y.error(r.message)}finally{R(!1)}},T=async s=>{const l=await(await fetch(g+`creditnote/update/${o}`,{method:"PATCH",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify({status:s})})).json();l.success&&(w(l.result),y.success(`Status: ${s}`))};if(U)return e.jsx("div",{style:{textAlign:"center",padding:60},children:e.jsx(_,{size:"large"})});if(!t)return e.jsx("div",{style:{padding:24},children:"Not found."});const z=[{title:"#",width:40,render:(s,r,l)=>l+1},{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Qty",dataIndex:"quantity",width:70,align:"center"},{title:"Unit Price",dataIndex:"price",align:"right",render:c},{title:"Total",dataIndex:"total",align:"right",render:s=>e.jsxs("strong",{style:{color:"#e53e3e"},children:["(",c(s),")"]})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,flexWrap:"wrap",gap:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx(i,{icon:e.jsx(W,{}),onClick:()=>u("/credit-note")}),e.jsxs("div",{children:[e.jsxs(P,{level:4,style:{margin:0,color:"#e53e3e"},children:["Credit Note CN-",t.number,"/",t.year]}),e.jsx(B,{color:q[t.status]||"default",style:{marginTop:4},children:(k=t.status)==null?void 0:k.toUpperCase()})]})]}),e.jsxs(E,{wrap:!0,children:[t.status==="draft"&&e.jsx(i,{onClick:()=>T("issued"),style:{borderColor:"#1890ff",color:"#1890ff"},children:"Issue"}),t.status==="issued"&&e.jsx(i,{onClick:()=>T("applied"),style:{borderColor:"#4CB480",color:"#4CB480"},children:"Mark Applied"}),e.jsx(i,{icon:e.jsx(L,{}),onClick:()=>x(!1),loading:v,children:"Preview PDF"}),e.jsx(i,{icon:e.jsx(L,{}),onClick:()=>x(!0),loading:v,danger:!0,children:"Download PDF"}),e.jsx(i,{icon:e.jsx(Y,{}),onClick:()=>u(`/credit-note/edit/${o}`),children:"Edit"})]})]}),e.jsxs(V,{gutter:16,style:{marginBottom:16},children:[e.jsx(D,{xs:24,md:12,children:e.jsxs(m,{size:"small",title:"Issued To",children:[e.jsx(P,{level:5,style:{color:"#034D57",marginTop:0},children:((I=t.client)==null?void 0:I.name)||"—"}),t.reason&&e.jsxs(b,{type:"secondary",style:{fontSize:12},children:["Reason: ",t.reason]})]})}),e.jsx(D,{xs:24,md:12,children:e.jsx(m,{size:"small",title:"Details",children:e.jsxs(C,{size:"small",column:1,children:[e.jsx(C.Item,{label:"Date",children:F(t.date).format("DD MMM YYYY")}),t.invoice&&e.jsxs(C.Item,{label:"Invoice Ref",children:["INV-",t.invoice.number,"/",t.invoice.year]})]})})})]}),e.jsx(m,{size:"small",title:"Items",style:{marginBottom:16},children:e.jsx(d,{columns:z,dataSource:t.items||[],rowKey:(s,r)=>r,pagination:!1,size:"small",summary:()=>e.jsxs(d.Summary.Row,{style:{background:"#fff5f5"},children:[e.jsx(d.Summary.Cell,{index:0,colSpan:3,children:e.jsx("strong",{children:"Totals"})}),t.taxRate>0&&e.jsx(d.Summary.Cell,{index:3,align:"right",children:e.jsxs(b,{type:"secondary",children:["Sub: (",c(t.subTotal),") + VAT: (",c(t.taxTotal),")"]})}),e.jsx(d.Summary.Cell,{index:4,align:"right",colSpan:t.taxRate>0?0:2,children:e.jsxs("strong",{style:{color:"#e53e3e",fontSize:15},children:["CREDIT: (",c(t.total),")"]})})]})})}),t.notes&&e.jsx(m,{size:"small",style:{borderLeft:"3px solid #f59e0b"},children:e.jsx(b,{children:t.notes})}),e.jsx(J,{title:`PDF — CN-${t.number}/${t.year}`,open:O,width:"80%",style:{top:20},onCancel:()=>{h(!1),a&&URL.revokeObjectURL(a),f(null)},footer:[e.jsx(i,{danger:!0,onClick:()=>x(!0),children:"Download"},"dl"),e.jsx(i,{onClick:()=>{h(!1),a&&URL.revokeObjectURL(a),f(null)},children:"Close"},"cl")],children:a&&e.jsx("iframe",{src:a,style:{width:"100%",height:"70vh",border:"none"}})})]})}export{ce as default};
