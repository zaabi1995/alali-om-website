import{r as o,o as F,m as B,j as e}from"./index-C8-4hbts.js";import{O as C,g as z,aZ as p,aN as N,aM as f,aL as c,aB as u,b9 as H,aY as L}from"./IdurarOs-CbjQM2OW.js";import{A as T}from"./index-dPXGmIaz.js";import{B as P}from"./Breadcrumb-SKG_cQ_B.js";import{C as m}from"./index-BFvp7tVQ.js";import{r as v,T as h}from"./ErpApp-D5jYyPXL.js";import{D as l}from"./index-CiHYozfT.js";import{F as $}from"./Table-CK_5JiFu.js";import{s as x}from"./index-BLjLk_k2.js";import{A as M}from"./ArrowLeftOutlined-Dktl2KvX.js";import{C as Q}from"./CheckCircleOutlined-4nRBFMOQ.js";import{C as _}from"./CloseCircleOutlined-ju31sSny.js";import"./Skeleton-BYeS7Qau.js";import"./index-HqqZIfn_.js";import"./PlusOutlined-VHvzcD8O.js";var E={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M854.6 288.6L639.4 73.4c-6-6-14.1-9.4-22.6-9.4H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V311.3c0-8.5-3.4-16.7-9.4-22.7zM790.2 326H602V137.8L790.2 326zm1.8 562H232V136h302v216a42 42 0 0042 42h216v494zM544 472c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v108H372c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h108v108c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V644h108c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8H544V472z"}}]},name:"file-add",theme:"outlined"},V=function(s,t){return o.createElement(C,z({},s,{ref:t,icon:E}))};const W=o.forwardRef(V);var G={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M688 312v-48c0-4.4-3.6-8-8-8H296c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h384c4.4 0 8-3.6 8-8zm-392 88c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h184c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8H296zm376 116c-119.3 0-216 96.7-216 216s96.7 216 216 216 216-96.7 216-216-96.7-216-216-216zm107.5 323.5C750.8 868.2 712.6 884 672 884s-78.8-15.8-107.5-44.5C535.8 810.8 520 772.6 520 732s15.8-78.8 44.5-107.5C593.2 595.8 631.4 580 672 580s78.8 15.8 107.5 44.5C808.2 653.2 824 691.4 824 732s-15.8 78.8-44.5 107.5zM761 656h-44.3c-2.6 0-5 1.2-6.5 3.3l-63.5 87.8-23.1-31.9a7.92 7.92 0 00-6.5-3.3H573c-6.5 0-10.3 7.4-6.5 12.7l73.8 102.1c3.2 4.4 9.7 4.4 12.9 0l114.2-158c3.9-5.3.1-12.7-6.4-12.7zM440 852H208V148h560v344c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V108c0-17.7-14.3-32-32-32H168c-17.7 0-32 14.3-32 32v784c0 17.7 14.3 32 32 32h272c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"}}]},name:"file-done",theme:"outlined"},U=function(s,t){return o.createElement(C,z({},s,{ref:t,icon:G}))};const Y=o.forwardRef(U);function g(){var n,s;try{const t=(s=(n=JSON.parse(localStorage.getItem("auth")||"{}"))==null?void 0:n.current)==null?void 0:s.token;return t?{Authorization:`Bearer ${t}`}:{}}catch{return{}}}const{Title:J,Text:y}=L,K={new:"blue",in_progress:"processing",researched:"purple",quoted:"success",won:"green",lost:"red",expired:"default"},X={ior:"red",routine:"orange",normal:"default"};function pe(){var S;const{id:n}=F(),s=B(),[t,j]=o.useState(null),[a,D]=o.useState([]),[q,R]=o.useState(!0),[k,b]=o.useState(!1);o.useEffect(()=>{fetch(p+`rfq/withparts/${n}`,{headers:g()}).then(r=>r.json()).then(r=>{if(r.success){const{parts:i,...d}=r.result;j(d),D(i||[])}R(!1)})},[n]);const O=async()=>{b(!0);const i=await(await fetch(p+`rfq/generate-quote/${n}`,{method:"POST",headers:g()})).json();b(!1),i.success?(x.success(`Quote #${i.result.quoteNumber} created!`),setTimeout(()=>s(`/quote/read/${i.result.quoteId}`),800)):x.error(i.message||"Failed to generate quote")},w=async r=>{(await(await fetch(p+`rfq/update/${n}`,{method:"PATCH",headers:g(),body:JSON.stringify({status:r})})).json()).success&&(x.success("Status updated"),j(A=>({...A,status:r})))},I=[{title:"Part Number",dataIndex:"partNumber",key:"partNumber",width:140,render:r=>e.jsx(y,{strong:!0,style:{color:"#034D57"},children:r||"—"})},{title:"NSN",dataIndex:"nsn",key:"nsn",width:130,render:r=>r||"—"},{title:"Description",dataIndex:"description",key:"description",ellipsis:!0,render:r=>r||"—"},{title:"Qty",dataIndex:"quantity",key:"quantity",width:60,align:"center"},{title:"Unit",dataIndex:"unit",key:"unit",width:60,align:"center"},{title:"Research",dataIndex:"status",key:"status",width:100,render:r=>{const i={done:"success",pending:"default",researching:"processing",no_results:"warning"};return e.jsx(h,{color:i[r]||"default",style:{fontSize:11},children:r})}},{title:"Sell Price (OMR)",dataIndex:"unitSellPrice",key:"unitSellPrice",width:120,align:"right",render:(r,i)=>{const d=r||i.unitCostOmr;return d?d.toFixed(3):"—"}},{title:"Recommendation",dataIndex:"recommendation",key:"recommendation",ellipsis:!0,render:r=>r?e.jsx(y,{type:"secondary",style:{fontSize:12},children:r}):"—"}];return q?e.jsx("div",{style:{textAlign:"center",padding:80},children:e.jsx(N,{size:"large",tip:"Loading RFQ..."})}):t?e.jsxs("div",{style:{paddingBottom:40},children:[e.jsx(P,{style:{marginBottom:16},items:[{title:e.jsx("span",{style:{cursor:"pointer",color:"#034D57"},onClick:()=>s("/rfq"),children:"RFQs"})},{title:t.rfqNumber||t.subject||n}]}),e.jsx(m,{style:{borderRadius:8,marginBottom:16,borderLeft:`4px solid ${t.priority==="ior"?"#ff4d4f":t.priority==="routine"?"#fa8c16":"#034D57"}`},bodyStyle:{padding:"16px 20px"},children:e.jsxs(f,{align:"middle",justify:"space-between",wrap:!0,gutter:[8,8],children:[e.jsx(c,{children:e.jsxs(v,{wrap:!0,size:8,children:[e.jsx(u,{icon:e.jsx(M,{}),onClick:()=>s("/rfq"),type:"text",size:"small"}),e.jsx(J,{level:4,style:{margin:0,color:"#034D57"},children:t.rfqNumber||t.subject}),e.jsx(h,{color:X[t.priority]||"default",style:{fontWeight:600},children:(S=t.priority)==null?void 0:S.toUpperCase()}),e.jsx(h,{color:K[t.status]||"default",children:t.status})]})}),e.jsx(c,{children:e.jsxs(v,{wrap:!0,size:8,children:[["new","in_progress","researched"].includes(t.status)&&e.jsx(u,{type:"primary",icon:e.jsx(W,{}),loading:k,onClick:O,style:{background:"#034D57",borderColor:"#034D57"},children:"Generate Quote"}),t.quote&&e.jsx(u,{icon:e.jsx(Y,{}),type:"primary",ghost:!0,style:{borderColor:"#4CB480",color:"#4CB480"},onClick:()=>s(`/quote/read/${t.quote._id||t.quote}`),children:"View Quote"}),t.status!=="won"&&t.status!=="expired"&&e.jsx(u,{icon:e.jsx(Q,{}),style:{borderColor:"#52c41a",color:"#52c41a"},onClick:()=>w("won"),children:"Mark Won"}),!["lost","expired"].includes(t.status)&&e.jsx(u,{icon:e.jsx(_,{}),danger:!0,ghost:!0,onClick:()=>w("lost"),children:"Mark Lost"})]})})]})}),e.jsxs(f,{gutter:[16,16],children:[e.jsx(c,{xs:24,md:10,children:e.jsx(m,{title:e.jsx("span",{style:{color:"#034D57",fontWeight:600},children:"RFQ Details"}),size:"small",style:{borderRadius:8,height:"100%"},children:e.jsxs(l,{column:1,size:"small",labelStyle:{color:"#888",fontSize:12},contentStyle:{fontSize:13},children:[e.jsx(l.Item,{label:"RFQ Number",children:t.rfqNumber||"—"}),e.jsx(l.Item,{label:"Client",children:e.jsx(h,{color:"geekblue",children:t.client||"—"})}),e.jsx(l.Item,{label:"Sender",children:t.senderEmail||"—"}),e.jsx(l.Item,{label:"Received",children:t.receivedAt?new Date(t.receivedAt).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}):"—"}),e.jsx(l.Item,{label:"Deadline",children:t.deadlineAt?e.jsx("span",{style:{color:new Date(t.deadlineAt)<new Date?"#ff4d4f":"#333"},children:new Date(t.deadlineAt).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}):"—"}),e.jsx(l.Item,{label:"Parts Count",children:a.length}),t.notes&&e.jsx(l.Item,{label:"Notes",children:t.notes})]})})}),e.jsx(c,{xs:24,md:14,children:e.jsxs(m,{title:e.jsx("span",{style:{color:"#034D57",fontWeight:600},children:"Email Subject"}),size:"small",style:{borderRadius:8,height:"100%"},children:[e.jsx(y,{style:{color:"#555",fontSize:14},children:t.subject||t.rfqNumber||"—"}),t.emailBody&&e.jsxs(e.Fragment,{children:[e.jsx(H,{style:{margin:"12px 0"}}),e.jsxs("div",{style:{maxHeight:200,overflowY:"auto",fontSize:12,color:"#666",whiteSpace:"pre-wrap",lineHeight:1.6},children:[t.emailBody.slice(0,800),t.emailBody.length>800?"...":""]})]})]})})]}),e.jsx(m,{title:e.jsxs(f,{justify:"space-between",align:"middle",children:[e.jsx(c,{children:e.jsxs("span",{style:{color:"#034D57",fontWeight:600},children:["Parts (",a.length,")"]})}),e.jsx(c,{children:e.jsxs(h,{color:a.some(r=>r.status==="done")?"success":"default",style:{fontSize:12},children:[a.filter(r=>r.status==="done").length," / ",a.length," researched"]})})]}),size:"small",style:{borderRadius:8,marginTop:16},bodyStyle:{padding:0},children:a.length===0?e.jsx("div",{style:{padding:32,textAlign:"center",color:"#999"},children:"No parts extracted from this RFQ yet"}):e.jsx("div",{style:{overflowX:"auto"},children:e.jsx($,{dataSource:a,columns:I,rowKey:"_id",size:"small",pagination:a.length>20?{pageSize:20}:!1,rowClassName:r=>r.status==="no_results"?"part-no-results":""})})}),e.jsx("style",{children:".part-no-results { background: #fffbe6 !important; }"})]}):e.jsx(T,{type:"error",message:"RFQ not found"})}export{pe as default};
