import{r as s,j as e}from"./index-CYKalyeL.js";import{d as O}from"./dayjs.min-DGHWcPFV.js";import{X as H,b as J,aH as n,aB as x,aC as i,ai as f,aE as w,az as h,T as z,ax as oe,ar as le}from"./IdurarOs-BGw2PPGe.js";import{c as ie}from"./omrFormat-B-E0oCKV.js";import{A as ce}from"./index-DpmZfUgC.js";import{C as de}from"./index-DcFHw6qe.js";import{S as ue}from"./index-CtMb3PWt.js";import{$ as me,m as U,c as pe}from"./ErpApp-CeydZZZJ.js";import{F as he}from"./Table-CBI2Olew.js";import{M as F}from"./index-Ci2EwPC-.js";import{S as M}from"./index-BGUfHx-u.js";import{D as g}from"./index-DQ1EhqQV.js";import{s as m}from"./index-BQgCxPOT.js";import{T as p}from"./index-BkNufn0G.js";import{P as xe}from"./index-BNG2szad.js";import{P as fe}from"./PlusOutlined-FeH87sEb.js";import{D as je}from"./DeleteOutlined-D2OLi6gq.js";import"./pickAttrs-CsXZNnOo.js";import"./Skeleton-BxPCSHmg.js";import"./index-CAMKOCuO.js";import"./DownOutlined-Bn5vGHe8.js";import"./Pagination-CRz1TW9a.js";import"./ActionButton-C9t4i8h5.js";import"./useClosable-BvmnJMVE.js";import"./fade-CBBaJpqm.js";import"./ClockCircleOutlined-B1tuOUVZ.js";var ye={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}},{tag:"path",attrs:{d:"M464 688a48 48 0 1096 0 48 48 0 10-96 0zm24-112h48c4.4 0 8-3.6 8-8V296c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8z"}}]},name:"exclamation-circle",theme:"outlined"},ge=function(l,a){return s.createElement(H,J({},l,{ref:a,icon:ye}))};const we=s.forwardRef(ge);var Se={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372 0-89 31.3-170.8 83.5-234.8l523.3 523.3C682.8 852.7 601 884 512 884zm288.5-137.2L277.2 223.5C341.2 171.3 423 140 512 140c205.4 0 372 166.6 372 372 0 89-31.3 170.8-83.5 234.8z"}}]},name:"stop",theme:"outlined"},De=function(l,a){return s.createElement(H,J({},l,{ref:a,icon:Se}))};const Ce=s.forwardRef(De),{Text:I}=le,{TextArea:N}=w;function S(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function P(){return{...S(),"Content-Type":"application/json"}}function be(){var o,l;try{return((l=(o=JSON.parse(localStorage.getItem("auth")||"{}"))==null?void 0:o.current)==null?void 0:l.role)||"staff"}catch{return"staff"}}const q=()=>["owner","admin","gm","manager"].includes(be()),Te={customer:"blue",supplier:"orange",framework:"purple",nda:"default",service:"cyan",maintenance:"gold"},Oe={draft:"default",active:"success",expired:"error",terminated:"warning",renewed:"processing"};function Ie(o){return o?Math.ceil((new Date(o)-Date.now())/864e5):null}function Ee({endDate:o,status:l}){if(l==="expired")return e.jsx(p,{color:"error",children:"Expired"});if(l==="terminated")return e.jsx(p,{color:"warning",children:"Terminated"});const a=Ie(o);return a===null?null:a<0?e.jsxs(p,{color:"error",children:["Overdue ",-a,"d"]}):a<=30?e.jsxs(p,{color:"warning",children:[a," days left"]}):a<=60?e.jsxs(p,{color:"orange",children:[a," days left"]}):e.jsxs(p,{color:"success",children:[a," days"]})}function tt(){const[o,l]=s.useState([]),[a,Y]=s.useState({}),[D,K]=s.useState([]),[W,$]=s.useState(!1),[u,C]=s.useState({open:!1,record:null}),[A,E]=s.useState({open:!1,id:null}),[B,v]=s.useState({open:!1,id:null}),[b,X]=s.useState("all"),[T]=n.useForm(),[R]=n.useForm(),[k]=n.useForm(),j=async()=>{$(!0);const[t,r,c]=await Promise.all([fetch(h+"contract/list",{headers:S()}).then(d=>d.json()).catch(()=>({})),fetch(h+"contract/stats",{headers:S()}).then(d=>d.json()).catch(()=>({})),fetch(h+"contract/expiring",{headers:S()}).then(d=>d.json()).catch(()=>({}))]);t.success&&l(t.result||[]),r.success&&Y(r.result||{}),c.success&&K(c.result||[]),$(!1)};s.useEffect(()=>{j()},[]);const G=()=>{T.resetFields(),C({open:!0,record:null})},Q=t=>{T.setFieldsValue({...t,startDate:t.startDate?O(t.startDate):null,endDate:t.endDate?O(t.endDate):null,renewalDate:t.renewalDate?O(t.renewalDate):null}),C({open:!0,record:t})},Z=async t=>{var _,V,L;const r={...t,startDate:(_=t.startDate)==null?void 0:_.toISOString(),endDate:(V=t.endDate)==null?void 0:V.toISOString(),renewalDate:(L=t.renewalDate)==null?void 0:L.toISOString()},c=u.record?`contract/update/${u.record._id}`:"contract/create",d=u.record?"PATCH":"POST",y=await fetch(h+c,{method:d,headers:P(),body:JSON.stringify(r)}).then(se=>se.json()).catch(()=>({}));y.success?(m.success(y.message),C({open:!1,record:null}),j()):m.error(y.message||"Failed")},ee=async t=>{const r=await fetch(h+`contract/delete/${t}`,{method:"DELETE",headers:S()}).then(c=>c.json()).catch(()=>({}));r.success?(m.success("Deleted"),j()):m.error(r.message)},te=async t=>{const r=await fetch(h+`contract/terminate/${A.id}`,{method:"PATCH",headers:P(),body:JSON.stringify({reason:t.reason})}).then(c=>c.json()).catch(()=>({}));r.success?(m.success("Contract terminated"),E({open:!1}),j()):m.error(r.message)},re=async t=>{var c,d;const r=await fetch(h+`contract/renew/${B.id}`,{method:"PATCH",headers:P(),body:JSON.stringify({newEndDate:(c=t.newEndDate)==null?void 0:c.toISOString(),newRenewalDate:(d=t.newRenewalDate)==null?void 0:d.toISOString()})}).then(y=>y.json()).catch(()=>({}));r.success?(m.success("Contract renewed"),v({open:!1}),j()):m.error(r.message)},ne=b==="all"?o:o.filter(t=>t.status===b),ae=[{title:"#",dataIndex:"contractNumber",width:100,render:t=>e.jsx(I,{strong:!0,style:{color:"#034D57"},children:t})},{title:"Title",dataIndex:"title",render:(t,r)=>e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:t}),e.jsx(I,{type:"secondary",style:{fontSize:11},children:r.partyName})]})},{title:"Type",dataIndex:"contractType",width:110,render:t=>e.jsx(p,{color:Te[t],children:t==null?void 0:t.toUpperCase()})},{title:"Value",dataIndex:"value",width:130,render:t=>t?ie(t):e.jsx(I,{type:"secondary",children:"—"})},{title:"End Date",dataIndex:"endDate",width:110,render:t=>t?O(t).format("DD MMM YYYY"):"—"},{title:"Time Left",key:"daysLeft",width:120,render:(t,r)=>e.jsx(Ee,{endDate:r.endDate,status:r.status})},{title:"Status",dataIndex:"status",width:100,render:t=>e.jsx(p,{color:Oe[t],children:t==null?void 0:t.toUpperCase()})},{title:"",key:"actions",width:150,render:(t,r)=>q()?e.jsxs(U,{size:4,children:[e.jsx(z,{title:"Edit",children:e.jsx(f,{size:"small",icon:e.jsx(oe,{}),onClick:()=>Q(r)})}),r.status==="active"&&e.jsxs(e.Fragment,{children:[e.jsx(z,{title:"Terminate",children:e.jsx(f,{size:"small",danger:!0,icon:e.jsx(Ce,{}),onClick:()=>{R.resetFields(),E({open:!0,id:r._id})}})}),e.jsx(z,{title:"Renew",children:e.jsx(f,{size:"small",icon:e.jsx(pe,{}),style:{color:"#4CB480"},onClick:()=>{k.resetFields(),v({open:!0,id:r._id})}})})]}),e.jsx(xe,{title:"Delete this contract?",onConfirm:()=>ee(r._id),children:e.jsx(f,{size:"small",danger:!0,icon:e.jsx(je,{})})})]}):e.jsx(I,{type:"secondary",style:{fontSize:11},children:"View only"})}];return e.jsxs("div",{style:{padding:24},children:[e.jsxs(x,{justify:"space-between",align:"middle",style:{marginBottom:20},children:[e.jsx(i,{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[e.jsx(me,{style:{fontSize:22,color:"#034D57"}}),e.jsx("span",{style:{fontSize:20,fontWeight:700,color:"#034D57"},children:"Contract Management"})]})}),q()&&e.jsx(i,{children:e.jsx(f,{type:"primary",icon:e.jsx(fe,{}),onClick:G,style:{background:"#034D57"},children:"New Contract"})})]}),D.length>0&&e.jsx(ce,{type:"warning",showIcon:!0,icon:e.jsx(we,{}),message:`${D.length} contract${D.length>1?"s":""} expiring within 30 days`,description:D.map(t=>`${t.contractNumber} — ${t.title} (${t.partyName})`).join(", "),style:{marginBottom:16}}),e.jsx(x,{gutter:16,style:{marginBottom:20},children:[{title:"Active",value:a.active||0,color:"#4CB480"},{title:"Expiring Soon",value:a.expiring||0,color:"#fa8c16"},{title:"Expired",value:a.expired||0,color:"#ff4d4f"},{title:"Total Value (Active)",value:a.totalValue?`OMR ${Number(a.totalValue).toLocaleString("en-US",{minimumFractionDigits:3})}`:"OMR 0",color:"#034D57"}].map(t=>e.jsx(i,{span:6,children:e.jsx(de,{size:"small",style:{textAlign:"center",borderTop:`3px solid ${t.color}`},children:e.jsx(ue,{title:t.title,value:t.value,valueStyle:{color:t.color,fontSize:22}})})},t.title))}),e.jsx(U,{style:{marginBottom:12},children:["all","active","expiring","expired","terminated"].map(t=>e.jsx(f,{size:"small",type:b===t?"primary":"default",onClick:()=>X(t),style:b===t?{background:"#034D57"}:{},children:t==="expiring"?"Expiring Soon":t.charAt(0).toUpperCase()+t.slice(1)},t))}),e.jsx(he,{columns:ae,dataSource:ne,rowKey:"_id",loading:W,size:"small",pagination:{pageSize:20}}),e.jsx(F,{open:u.open,title:u.record?`Edit Contract — ${u.record.contractNumber}`:"New Contract",onCancel:()=>C({open:!1,record:null}),onOk:()=>T.submit(),width:680,okText:u.record?"Save Changes":"Create Contract",okButtonProps:{style:{background:"#034D57"}},children:e.jsxs(n,{form:T,layout:"vertical",onFinish:Z,children:[e.jsxs(x,{gutter:16,children:[e.jsx(i,{span:16,children:e.jsx(n.Item,{name:"title",label:"Contract Title",rules:[{required:!0}],children:e.jsx(w,{})})}),e.jsx(i,{span:8,children:e.jsx(n.Item,{name:"contractType",label:"Type",rules:[{required:!0}],children:e.jsx(M,{options:["customer","supplier","framework","nda","service","maintenance"].map(t=>({value:t,label:t.charAt(0).toUpperCase()+t.slice(1)}))})})})]}),e.jsxs(x,{gutter:16,children:[e.jsx(i,{span:8,children:e.jsx(n.Item,{name:"partyType",label:"Party Type",children:e.jsx(M,{options:[{value:"client",label:"Client"},{value:"vendor",label:"Vendor"},{value:"other",label:"Other"}]})})}),e.jsx(i,{span:16,children:e.jsx(n.Item,{name:"partyName",label:"Party Name",rules:[{required:!0}],children:e.jsx(w,{})})})]}),e.jsxs(x,{gutter:16,children:[e.jsx(i,{span:8,children:e.jsx(n.Item,{name:"value",label:"Contract Value (OMR)",children:e.jsx(w,{type:"number",step:"0.001",min:0})})}),e.jsx(i,{span:8,children:e.jsx(n.Item,{name:"startDate",label:"Start Date",children:e.jsx(g,{style:{width:"100%"}})})}),e.jsx(i,{span:8,children:e.jsx(n.Item,{name:"endDate",label:"End Date",rules:[{required:!0}],children:e.jsx(g,{style:{width:"100%"}})})})]}),e.jsxs(x,{gutter:16,children:[e.jsx(i,{span:12,children:e.jsx(n.Item,{name:"renewalDate",label:"Renewal Date (optional)",children:e.jsx(g,{style:{width:"100%"}})})}),e.jsx(i,{span:12,children:e.jsx(n.Item,{name:"alertDays",label:"Alert Days Before Expiry",children:e.jsx(w,{type:"number",defaultValue:30})})})]}),e.jsx(n.Item,{name:"description",label:"Key Terms / Scope",children:e.jsx(N,{rows:3})}),e.jsx(n.Item,{name:"notes",label:"Notes",children:e.jsx(N,{rows:2})}),!u.record&&e.jsx(n.Item,{name:"status",label:"Status",initialValue:"active",children:e.jsx(M,{options:[{value:"draft",label:"Draft"},{value:"active",label:"Active"}]})})]})}),e.jsx(F,{open:A.open,title:"Terminate Contract",onCancel:()=>E({open:!1}),onOk:()=>R.submit(),okText:"Terminate",okButtonProps:{danger:!0},children:e.jsx(n,{form:R,layout:"vertical",onFinish:te,children:e.jsx(n.Item,{name:"reason",label:"Termination Reason",rules:[{required:!0}],children:e.jsx(N,{rows:3,placeholder:"Reason for termination..."})})})}),e.jsx(F,{open:B.open,title:"Renew Contract",onCancel:()=>v({open:!1}),onOk:()=>k.submit(),okText:"Renew",okButtonProps:{style:{background:"#4CB480"}},children:e.jsxs(n,{form:k,layout:"vertical",onFinish:re,children:[e.jsx(n.Item,{name:"newEndDate",label:"New End Date",rules:[{required:!0}],children:e.jsx(g,{style:{width:"100%"}})}),e.jsx(n.Item,{name:"newRenewalDate",label:"Next Renewal Date (optional)",children:e.jsx(g,{style:{width:"100%"}})})]})})]})}export{tt as default};
