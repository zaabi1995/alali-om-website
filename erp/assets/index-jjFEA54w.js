import{m as R,o as H,r as x,j as e}from"./index-C236tqC8.js";import{d as I}from"./dayjs.min-BePh7Oku.js";import{aG as s,ay as y,ai as h,aA as D,aB as d,aD as o,ar as U}from"./IdurarOs-CIvrJM3G.js";import{C as g}from"./index-DKmxjtwJ.js";import{S as u}from"./index-D07aC4PS.js";import{D as N}from"./index-D5L4Ge1X.js";import{F as V}from"./Table-BXAYilt4.js";import{l as G}from"./ErpApp-DwaI_8s0.js";import{s as f}from"./index-BTpainSG.js";import{T as A}from"./index-iX9YJgKp.js";import{P as K}from"./index-Fz1z0WsF.js";import{A as M}from"./ArrowLeftOutlined-f_2GitlY.js";import{P as O}from"./PlusOutlined-DUjbHxHh.js";import{S as W}from"./SaveOutlined-DCPC5MIt.js";import{D as X}from"./DeleteOutlined-uR4T3fw6.js";import"./Skeleton-BfIMR0fQ.js";import"./index-C-HV-BqQ.js";import"./pickAttrs-DhldMqNY.js";import"./DownOutlined-C4yJOkOC.js";import"./ClockCircleOutlined-DveV7d10.js";import"./ActionButton-C2LqLN_L.js";const{Title:J,Text:Y}=U,{TextArea:T}=o;function Q(){const c=localStorage.getItem("x-auth-token");return c?{Authorization:`Bearer ${c}`,"Content-Type":"application/json"}:{"Content-Type":"application/json"}}const z={key:Date.now(),partNumber:"",nsn:"",description:"",quantityOrdered:1,quantityShipped:1,unit:"EA",condition:"New",serialNumber:"",batchNumber:"",countryOfOrigin:"",hsCode:""};function fe(){const c=R(),{id:n}=H(),[b]=s.useForm(),[p,j]=x.useState([{...z}]),[B,P]=x.useState([]),[F,E]=x.useState([]),[L,w]=x.useState(!1);x.useEffect(()=>{fetch(y+"client/listAll",{headers:{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`}}).then(t=>t.json()).then(t=>{t.result&&P(t.result)}).catch(()=>{}),fetch(y+"invoice/listAll",{headers:{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`}}).then(t=>t.json()).then(t=>{t.result&&E(t.result)}).catch(()=>{}),n&&fetch(y+`deliverynote/read/${n}`,{headers:{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`}}).then(t=>t.json()).then(t=>{var r,i,m;if(t.success&&t.result){const a=t.result;b.setFieldsValue({client:((r=a.client)==null?void 0:r._id)||a.client,date:a.date?I(a.date):null,shipDate:a.shipDate?I(a.shipDate):null,invoice:((i=a.invoice)==null?void 0:i._id)||a.invoice,carrier:a.carrier,trackingNumber:a.trackingNumber,incoterms:a.incoterms||"FCA",deliveryAddress:a.deliveryAddress,status:a.status,notes:a.notes}),(m=a.items)!=null&&m.length&&j(a.items.map((v,C)=>({...v,key:C})))}}).catch(()=>{})},[n]);const k=()=>j(t=>[...t,{...z,key:Date.now()}]),q=t=>j(r=>r.filter(i=>i.key!==t)),l=(t,r,i)=>{j(m=>m.map(a=>a.key===t?{...a,[r]:i}:a))},_=async t=>{var a,v;if(!p.length){f.error("Add at least one item");return}w(!0);const r={...t,date:(a=t.date)==null?void 0:a.toISOString(),shipDate:((v=t.shipDate)==null?void 0:v.toISOString())||null,items:p},i=n?y+`deliverynote/update/${n}`:y+"deliverynote/create",m=n?"PATCH":"POST";try{const S=await(await fetch(i,{method:m,headers:Q(),body:JSON.stringify(r)})).json();S.success?(f.success(n?"Delivery Note updated":"Delivery Note created"),c(`/delivery-note/read/${S.result._id}`)):f.error(S.message||"Failed to save")}catch{f.error("Network error")}finally{w(!1)}},$=[{title:"Part Number",dataIndex:"partNumber",width:130,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"P/N",onChange:i=>l(r.key,"partNumber",i.target.value)})},{title:"NSN",dataIndex:"nsn",width:120,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"NSN",onChange:i=>l(r.key,"nsn",i.target.value)})},{title:"Description",dataIndex:"description",width:200,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"Description",onChange:i=>l(r.key,"description",i.target.value)})},{title:"Ordered",dataIndex:"quantityOrdered",width:80,render:(t,r)=>e.jsx(A,{size:"small",min:0,value:t,style:{width:"100%"},onChange:i=>l(r.key,"quantityOrdered",i)})},{title:"Shipped",dataIndex:"quantityShipped",width:80,render:(t,r)=>e.jsx(A,{size:"small",min:0,value:t,style:{width:"100%"},onChange:i=>l(r.key,"quantityShipped",i)})},{title:"Unit",dataIndex:"unit",width:70,render:(t,r)=>e.jsx(u,{size:"small",value:t,style:{width:"100%"},onChange:i=>l(r.key,"unit",i),options:["EA","SET","PKG","LOT","MTR","KG","LTR","BOX"].map(i=>({value:i,label:i}))})},{title:"Condition",dataIndex:"condition",width:90,render:(t,r)=>e.jsx(u,{size:"small",value:t,style:{width:"100%"},onChange:i=>l(r.key,"condition",i),options:["New","Used","Refurb","Inspect"].map(i=>({value:i,label:i}))})},{title:"S/N",dataIndex:"serialNumber",width:100,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"S/N",onChange:i=>l(r.key,"serialNumber",i.target.value)})},{title:"COO",dataIndex:"countryOfOrigin",width:70,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"COO",onChange:i=>l(r.key,"countryOfOrigin",i.target.value)})},{title:"HS Code",dataIndex:"hsCode",width:90,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"HS",onChange:i=>l(r.key,"hsCode",i.target.value)})},{title:"",width:40,render:(t,r)=>e.jsx(K,{title:"Remove?",onConfirm:()=>q(r.key),okText:"Yes",cancelText:"No",children:e.jsx(h,{size:"small",danger:!0,type:"text",icon:e.jsx(X,{})})})}];return e.jsxs("div",{style:{padding:"24px",maxWidth:1200},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:20},children:[e.jsx(h,{icon:e.jsx(M,{}),onClick:()=>c("/delivery-note")}),e.jsx(J,{level:4,style:{margin:0,color:"#034D57"},children:n?"Edit Delivery Note":"New Delivery Note"})]}),e.jsxs(s,{form:b,layout:"vertical",onFinish:_,children:[e.jsxs(D,{gutter:24,children:[e.jsx(d,{xs:24,md:14,children:e.jsx(g,{title:"Delivery Details",size:"small",style:{marginBottom:16},children:e.jsxs(D,{gutter:16,children:[e.jsx(d,{xs:24,sm:12,children:e.jsx(s.Item,{name:"client",label:"Client",rules:[{required:!0,message:"Select a client"}],children:e.jsx(u,{showSearch:!0,placeholder:"Select client",filterOption:(t,r)=>r.label.toLowerCase().includes(t.toLowerCase()),options:B.map(t=>({value:t._id,label:t.name}))})})}),e.jsx(d,{xs:24,sm:12,children:e.jsx(s.Item,{name:"invoice",label:"Invoice Reference (optional)",children:e.jsx(u,{showSearch:!0,allowClear:!0,placeholder:"Link to invoice",filterOption:(t,r)=>r.label.toLowerCase().includes(t.toLowerCase()),options:F.map(t=>({value:t._id,label:`INV-${t.number}/${t.year}`}))})})}),e.jsx(d,{xs:24,sm:12,children:e.jsx(s.Item,{name:"date",label:"Date",rules:[{required:!0}],initialValue:I(),children:e.jsx(N,{style:{width:"100%"}})})}),e.jsx(d,{xs:24,sm:12,children:e.jsx(s.Item,{name:"shipDate",label:"Ship Date",children:e.jsx(N,{style:{width:"100%"}})})}),e.jsx(d,{xs:24,children:e.jsx(s.Item,{name:"deliveryAddress",label:"Delivery Address",children:e.jsx(T,{rows:2,placeholder:"Full delivery address"})})})]})})}),e.jsx(d,{xs:24,md:10,children:e.jsxs(g,{title:"Shipping Info",size:"small",style:{marginBottom:16},children:[e.jsx(s.Item,{name:"carrier",label:"Carrier",children:e.jsx(o,{placeholder:"DHL, Aramex, FedEx..."})}),e.jsx(s.Item,{name:"trackingNumber",label:"Tracking Number",children:e.jsx(o,{placeholder:"Tracking / AWB number"})}),e.jsx(s.Item,{name:"incoterms",label:"Incoterms",initialValue:"FCA",children:e.jsx(u,{options:["FCA","DAP","DDP","EXW","FOB","CIF","CPT"].map(t=>({value:t,label:t}))})}),e.jsx(s.Item,{name:"status",label:"Status",initialValue:"draft",children:e.jsx(u,{options:[{value:"draft",label:"Draft"},{value:"printed",label:"Printed"},{value:"dispatched",label:"Dispatched"},{value:"delivered",label:"Delivered"}]})})]})})]}),e.jsxs(g,{title:"Line Items",size:"small",style:{marginBottom:16},extra:e.jsx(h,{size:"small",icon:e.jsx(O,{}),onClick:k,style:{color:"#4CB480",borderColor:"#4CB480"},children:"Add Item"}),children:[e.jsx("div",{style:{overflowX:"auto"},children:e.jsx(V,{columns:$,dataSource:p,rowKey:"key",pagination:!1,size:"small",locale:{emptyText:e.jsx(h,{type:"dashed",onClick:k,icon:e.jsx(O,{}),children:"Add first item"})}})}),e.jsx("div",{style:{marginTop:12,textAlign:"right"},children:e.jsxs(Y,{type:"secondary",style:{fontSize:12},children:["Total: ",p.reduce((t,r)=>t+(r.quantityShipped||0),0)," units shipped  / ",p.reduce((t,r)=>t+(r.quantityOrdered||0),0)," ordered"]})})]}),e.jsx(g,{title:"Notes",size:"small",style:{marginBottom:16},children:e.jsx(s.Item,{name:"notes",noStyle:!0,children:e.jsx(T,{rows:3,placeholder:"Special instructions, remarks..."})})}),e.jsx("div",{style:{textAlign:"right"},children:e.jsxs(G,{children:[e.jsx(h,{onClick:()=>c("/delivery-note"),children:"Cancel"}),e.jsx(h,{type:"primary",htmlType:"submit",loading:L,icon:e.jsx(W,{}),style:{background:"#034D57",borderColor:"#034D57"},children:n?"Update":"Create Delivery Note"})]})})]})]})}export{fe as default};
