import{m as q,o as B,r as m,j as e}from"./index-C8-4hbts.js";import{o as V}from"./omrFormat-DicYQ1VJ.js";import{e as g,r as $,O as M}from"./ErpApp-D5jYyPXL.js";import{d as b}from"./dayjs.min-Ctavsg0I.js";import{b7 as o,aZ as u,aB as h,aM as U,aL as d,a_ as I,aY as J}from"./IdurarOs-CbjQM2OW.js";import{D as H}from"./index-CbwYzZTj.js";import{T as v}from"./index-BfzeSpx5.js";import{C as W}from"./index-BFvp7tVQ.js";import{F as G}from"./Table-CK_5JiFu.js";import{s as C}from"./index-BLjLk_k2.js";import{P as K}from"./index-BxYLosRB.js";import{A as Q}from"./ArrowLeftOutlined-Dktl2KvX.js";import{P as Y}from"./PlusOutlined-VHvzcD8O.js";import{S as Z}from"./SaveOutlined-mmdq5c89.js";import{D as X}from"./DeleteOutlined-DNCIIFPY.js";import"./ClockCircleOutlined-BceiyZA9.js";import"./Skeleton-BYeS7Qau.js";import"./index-HqqZIfn_.js";import"./ActionButton-CNQQc2KQ.js";const{Title:ee}=J,{TextArea:te}=I;function se(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`,"Content-Type":"application/json"}}const k={key:Date.now(),description:"",quantity:1,price:0};function Ie(){const p=q(),{id:n}=B(),[j]=o.useForm(),[f,x]=m.useState([{...k}]),[T,O]=m.useState([]),[A,F]=m.useState([]),[N,w]=m.useState(!1);m.useEffect(()=>{const s={Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`};fetch(u+"client/listAll",{headers:s}).then(t=>t.json()).then(t=>{t.result&&O(t.result)}),fetch(u+"invoice/listAll",{headers:s}).then(t=>t.json()).then(t=>{t.result&&F(t.result)}),n&&fetch(u+`creditnote/read/${n}`,{headers:s}).then(t=>t.json()).then(t=>{var a,l,i;if(t.success&&t.result){const r=t.result;j.setFieldsValue({client:((a=r.client)==null?void 0:a._id)||r.client,date:r.date?b(r.date):null,invoice:((l=r.invoice)==null?void 0:l._id)||r.invoice,reason:r.reason,taxRate:r.taxRate,status:r.status,notes:r.notes}),(i=r.items)!=null&&i.length&&x(r.items.map((c,E)=>({...c,key:E})))}})},[n]);const R=()=>x(s=>[...s,{...k,key:Date.now()}]),_=s=>x(t=>t.filter(a=>a.key!==s)),y=(s,t,a)=>x(l=>l.map(i=>i.key===s?{...i,[t]:a}:i)),S=f.reduce((s,t)=>s+parseFloat(t.price||0)*parseFloat(t.quantity||1),0),z=j.getFieldValue("taxRate")||0,D=S+S*(z/100),P=async s=>{var i;w(!0);const t={...s,date:(i=s.date)==null?void 0:i.toISOString(),items:f},a=n?u+`creditnote/update/${n}`:u+"creditnote/create",l=n?"PATCH":"POST";try{const c=await(await fetch(a,{method:l,headers:se(),body:JSON.stringify(t)})).json();c.success?(C.success(c.message||"Saved"),p(`/credit-note/read/${c.result._id}`)):C.error(c.message||"Failed")}catch{C.error("Network error")}finally{w(!1)}},L=[{title:"Description",dataIndex:"description",render:(s,t)=>e.jsx(I,{size:"small",value:s,onChange:a=>y(t.key,"description",a.target.value)})},{title:"Qty",dataIndex:"quantity",width:80,render:(s,t)=>e.jsx(v,{size:"small",min:1,value:s,style:{width:"100%"},onChange:a=>y(t.key,"quantity",a)})},{title:"Unit Price (OMR)",dataIndex:"price",width:130,render:(s,t)=>e.jsx(v,{size:"small",min:0,value:s,precision:3,style:{width:"100%"},onChange:a=>y(t.key,"price",a)})},{title:"Total",width:100,align:"right",render:(s,t)=>e.jsxs("strong",{style:{color:"#e53e3e"},children:["(",(parseFloat(t.price||0)*parseFloat(t.quantity||1)).toFixed(3)," ",e.jsx(M,{size:10,color:"#e53e3e"}),")"]})},{title:"",width:40,render:(s,t)=>e.jsx(K,{title:"Remove?",onConfirm:()=>_(t.key),children:e.jsx(h,{size:"small",danger:!0,type:"text",icon:e.jsx(X,{})})})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:20},children:[e.jsx(h,{icon:e.jsx(Q,{}),onClick:()=>p("/credit-note")}),e.jsx(ee,{level:4,style:{margin:0,color:"#e53e3e"},children:n?"Edit Credit Note":"New Credit Note"})]}),e.jsxs(o,{form:j,layout:"vertical",onFinish:P,children:[e.jsxs(U,{gutter:16,children:[e.jsx(d,{xs:24,md:12,children:e.jsx(o.Item,{name:"client",label:"Client",rules:[{required:!0}],children:e.jsx(g,{showSearch:!0,placeholder:"Select client",filterOption:(s,t)=>t.label.toLowerCase().includes(s.toLowerCase()),options:T.map(s=>({value:s._id,label:s.name}))})})}),e.jsx(d,{xs:24,md:12,children:e.jsx(o.Item,{name:"invoice",label:"Original Invoice",children:e.jsx(g,{showSearch:!0,allowClear:!0,placeholder:"Link to invoice",filterOption:(s,t)=>t.label.toLowerCase().includes(s.toLowerCase()),options:A.map(s=>({value:s._id,label:`INV-${s.number}/${s.year}`}))})})}),e.jsx(d,{xs:12,md:6,children:e.jsx(o.Item,{name:"date",label:"Date",rules:[{required:!0}],initialValue:b(),children:e.jsx(H,{style:{width:"100%"}})})}),e.jsx(d,{xs:12,md:6,children:e.jsx(o.Item,{name:"taxRate",label:"VAT Rate (%)",initialValue:0,children:e.jsx(v,{min:0,max:100,style:{width:"100%"}})})}),e.jsx(d,{xs:12,md:6,children:e.jsx(o.Item,{name:"status",label:"Status",initialValue:"draft",children:e.jsx(g,{options:["draft","issued","applied","voided"].map(s=>({value:s,label:s.charAt(0).toUpperCase()+s.slice(1)}))})})}),e.jsx(d,{xs:24,children:e.jsx(o.Item,{name:"reason",label:"Reason for Credit Note",children:e.jsx(I,{placeholder:"e.g. Goods returned, Overcharge, etc."})})})]}),e.jsxs(W,{title:"Items",size:"small",style:{marginBottom:12},extra:e.jsx(h,{size:"small",icon:e.jsx(Y,{}),onClick:R,danger:!0,children:"Add Item"}),children:[e.jsx(G,{columns:L,dataSource:f,rowKey:"key",pagination:!1,size:"small"}),e.jsx("div",{style:{textAlign:"right",marginTop:8,padding:8,background:"#fff5f5",borderRadius:4},children:e.jsxs("span",{style:{color:"#e53e3e",fontWeight:700},children:["CREDIT TOTAL: (",V(D),")"]})})]}),e.jsx(o.Item,{name:"notes",label:"Notes",children:e.jsx(te,{rows:2})}),e.jsx("div",{style:{textAlign:"right"},children:e.jsxs($,{children:[e.jsx(h,{onClick:()=>p("/credit-note"),children:"Cancel"}),e.jsx(h,{type:"primary",htmlType:"submit",loading:N,icon:e.jsx(Z,{}),danger:!0,children:n?"Update":"Create Credit Note"})]})})]})]})}export{Ie as default};
