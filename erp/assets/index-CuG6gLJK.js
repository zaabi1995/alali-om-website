import{m as $,o as B,r as l,j as e}from"./index-DeIE1Bku.js";import{o as E}from"./omrFormat-CIhR5PyA.js";import{d as F}from"./dayjs.min-DHoYJ7H2.js";import{ay as y,aC as M,ai as i,aw as N,aA as _,aB as D,ar as Y}from"./IdurarOs-D11Jo8U6.js";import{s as g}from"./index-SNFmEwNI.js";import{T as H}from"./index-Bqn5fdGc.js";import{k as V}from"./ErpApp-CXOE83Uv.js";import{C as f}from"./index-Bs59dhqk.js";import{D as C}from"./index-BeEqSyz-.js";import{F as d}from"./Table-DH6yOErw.js";import{M as W}from"./index-_cwprQLv.js";import{A as q}from"./ArrowLeftOutlined-Dd3nyKdb.js";import{F as L}from"./FilePdfOutlined-DO1jekDv.js";import"./useClosable-DJ58o6lM.js";import"./Skeleton-Dsc-KUr0.js";import"./index-DADNMuvq.js";import"./PlusOutlined-CrXATTM_.js";import"./pickAttrs-CTn3gRel.js";import"./index-VRGIXFgc.js";import"./DownOutlined-DyhjlyDP.js";import"./ActionButton-CiUhlW3T.js";import"./fade-CSnBdUIJ.js";const{Title:P,Text:b}=Y,J={draft:"default",issued:"blue",applied:"green",voided:"red"};function S(){return{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`}}function c(m){return E(m)}function je(){var k,I;const m=$(),{id:n}=B(),[t,w]=l.useState(null),[U,A]=l.useState(!0),[v,R]=l.useState(!1),[o,u]=l.useState(null),[z,p]=l.useState(!1);l.useEffect(()=>{fetch(y+`creditnote/read/${n}`,{headers:S()}).then(s=>s.json()).then(s=>{s.success&&w(s.result)}).catch(()=>g.error("Failed")).finally(()=>A(!1))},[n]);const x=async(s=!1)=>{R(!0);try{const r=await fetch(y+`creditnote/pdf/${n}`,{headers:S()});if(!r.ok)throw new Error("PDF failed");const a=await r.blob(),h=URL.createObjectURL(a);if(s){const j=document.createElement("a");j.href=h,j.download=`CN-${t==null?void 0:t.number}-${t==null?void 0:t.year}.pdf`,j.click(),URL.revokeObjectURL(h)}else u(h),p(!0)}catch(r){g.error(r.message)}finally{R(!1)}},T=async s=>{const a=await(await fetch(y+`creditnote/update/${n}`,{method:"PATCH",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify({status:s})})).json();a.success&&(w(a.result),g.success(`Status: ${s}`))};if(U)return e.jsx("div",{style:{textAlign:"center",padding:60},children:e.jsx(M,{size:"large"})});if(!t)return e.jsx("div",{style:{padding:24},children:"Not found."});const O=[{title:"#",width:40,render:(s,r,a)=>a+1},{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Qty",dataIndex:"quantity",width:70,align:"center"},{title:"Unit Price",dataIndex:"price",align:"right",render:c},{title:"Total",dataIndex:"total",align:"right",render:s=>e.jsxs("strong",{style:{color:"#e53e3e"},children:["(",c(s),")"]})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,flexWrap:"wrap",gap:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx(i,{icon:e.jsx(q,{}),onClick:()=>m("/credit-note")}),e.jsxs("div",{children:[e.jsxs(P,{level:4,style:{margin:0,color:"#e53e3e"},children:["Credit Note CN-",t.number,"/",t.year]}),e.jsx(H,{color:J[t.status]||"default",style:{marginTop:4},children:(k=t.status)==null?void 0:k.toUpperCase()})]})]}),e.jsxs(V,{wrap:!0,children:[t.status==="draft"&&e.jsx(i,{onClick:()=>T("issued"),style:{borderColor:"#1890ff",color:"#1890ff"},children:"Issue"}),t.status==="issued"&&e.jsx(i,{onClick:()=>T("applied"),style:{borderColor:"#4CB480",color:"#4CB480"},children:"Mark Applied"}),e.jsx(i,{icon:e.jsx(L,{}),onClick:()=>x(!1),loading:v,children:"Preview PDF"}),e.jsx(i,{icon:e.jsx(L,{}),onClick:()=>x(!0),loading:v,danger:!0,children:"Download PDF"}),e.jsx(i,{icon:e.jsx(N,{}),onClick:()=>m(`/credit-note/edit/${n}`),children:"Edit"})]})]}),e.jsxs(_,{gutter:16,style:{marginBottom:16},children:[e.jsx(D,{xs:24,md:12,children:e.jsxs(f,{size:"small",title:"Issued To",children:[e.jsx(P,{level:5,style:{color:"#034D57",marginTop:0},children:((I=t.client)==null?void 0:I.name)||"—"}),t.reason&&e.jsxs(b,{type:"secondary",style:{fontSize:12},children:["Reason: ",t.reason]})]})}),e.jsx(D,{xs:24,md:12,children:e.jsx(f,{size:"small",title:"Details",children:e.jsxs(C,{size:"small",column:1,children:[e.jsx(C.Item,{label:"Date",children:F(t.date).format("DD MMM YYYY")}),t.invoice&&e.jsxs(C.Item,{label:"Invoice Ref",children:["INV-",t.invoice.number,"/",t.invoice.year]})]})})})]}),e.jsx(f,{size:"small",title:"Items",style:{marginBottom:16},children:e.jsx(d,{columns:O,dataSource:t.items||[],rowKey:(s,r)=>r,pagination:!1,size:"small",summary:()=>e.jsxs(d.Summary.Row,{style:{background:"#fff5f5"},children:[e.jsx(d.Summary.Cell,{index:0,colSpan:3,children:e.jsx("strong",{children:"Totals"})}),t.taxRate>0&&e.jsx(d.Summary.Cell,{index:3,align:"right",children:e.jsxs(b,{type:"secondary",children:["Sub: (",c(t.subTotal),") + VAT: (",c(t.taxTotal),")"]})}),e.jsx(d.Summary.Cell,{index:4,align:"right",colSpan:t.taxRate>0?0:2,children:e.jsxs("strong",{style:{color:"#e53e3e",fontSize:15},children:["CREDIT: (",c(t.total),")"]})})]})})}),t.notes&&e.jsx(f,{size:"small",style:{borderLeft:"3px solid #f59e0b"},children:e.jsx(b,{children:t.notes})}),e.jsx(W,{title:`PDF — CN-${t.number}/${t.year}`,open:z,width:"80%",style:{top:20},onCancel:()=>{p(!1),o&&URL.revokeObjectURL(o),u(null)},footer:[e.jsx(i,{danger:!0,onClick:()=>x(!0),children:"Download"},"dl"),e.jsx(i,{onClick:()=>{p(!1),o&&URL.revokeObjectURL(o),u(null)},children:"Close"},"cl")],children:o&&e.jsx("iframe",{src:o,style:{width:"100%",height:"70vh",border:"none"}})})]})}export{je as default};
