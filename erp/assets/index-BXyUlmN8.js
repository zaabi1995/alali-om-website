import{m as q,o as B,r as m,j as e}from"./index-DUJms0D6.js";import{o as V}from"./omrFormat-C4CQjmYz.js";import{l as $,O as U}from"./ErpApp-DDkabuKV.js";import{d as b}from"./dayjs.min-BzahnmbO.js";import{aG as o,ay as u,ai as p,aA as M,aB as c,aD as I,ar as G}from"./IdurarOs-B30-LCOQ.js";import{S as g}from"./index-dR7Ye1Yy.js";import{D as H}from"./index-XnR4brO4.js";import{T as v}from"./index-CkFZCKkj.js";import{C as W}from"./index-CyAxxhY0.js";import{F as J}from"./Table-B0UCs-zn.js";import{s as C}from"./index-Bcgt9tpb.js";import{P as K}from"./index-DFrivB9v.js";import{A as Q}from"./ArrowLeftOutlined-CweelRkS.js";import{P as X}from"./PlusOutlined-CXK5kHAC.js";import{S as Y}from"./SaveOutlined-BjXl2Atb.js";import{D as Z}from"./DeleteOutlined-Cwki4DTc.js";import"./pickAttrs-DfTUuTsA.js";import"./DownOutlined-BJeYAz_H.js";import"./ClockCircleOutlined-Dlg_N99Y.js";import"./Skeleton-DxrcQ8CB.js";import"./index-HdV2iirx.js";import"./ActionButton-4R6uE_jt.js";const{Title:ee}=G,{TextArea:te}=I;function se(){return{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`,"Content-Type":"application/json"}}const k={key:Date.now(),description:"",quantity:1,price:0};function be(){const h=q(),{id:n}=B(),[j]=o.useForm(),[f,x]=m.useState([{...k}]),[T,A]=m.useState([]),[O,F]=m.useState([]),[R,w]=m.useState(!1);m.useEffect(()=>{const s={Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`};fetch(u+"client/listAll",{headers:s}).then(t=>t.json()).then(t=>{t.result&&A(t.result)}),fetch(u+"invoice/listAll",{headers:s}).then(t=>t.json()).then(t=>{t.result&&F(t.result)}),n&&fetch(u+`creditnote/read/${n}`,{headers:s}).then(t=>t.json()).then(t=>{var a,l,r;if(t.success&&t.result){const i=t.result;j.setFieldsValue({client:((a=i.client)==null?void 0:a._id)||i.client,date:i.date?b(i.date):null,invoice:((l=i.invoice)==null?void 0:l._id)||i.invoice,reason:i.reason,taxRate:i.taxRate,status:i.status,notes:i.notes}),(r=i.items)!=null&&r.length&&x(i.items.map((d,L)=>({...d,key:L})))}})},[n]);const N=()=>x(s=>[...s,{...k,key:Date.now()}]),D=s=>x(t=>t.filter(a=>a.key!==s)),y=(s,t,a)=>x(l=>l.map(r=>r.key===s?{...r,[t]:a}:r)),S=f.reduce((s,t)=>s+parseFloat(t.price||0)*parseFloat(t.quantity||1),0),z=j.getFieldValue("taxRate")||0,P=S+S*(z/100),_=async s=>{var r;w(!0);const t={...s,date:(r=s.date)==null?void 0:r.toISOString(),items:f},a=n?u+`creditnote/update/${n}`:u+"creditnote/create",l=n?"PATCH":"POST";try{const d=await(await fetch(a,{method:l,headers:se(),body:JSON.stringify(t)})).json();d.success?(C.success(d.message||"Saved"),h(`/credit-note/read/${d.result._id}`)):C.error(d.message||"Failed")}catch{C.error("Network error")}finally{w(!1)}},E=[{title:"Description",dataIndex:"description",render:(s,t)=>e.jsx(I,{size:"small",value:s,onChange:a=>y(t.key,"description",a.target.value)})},{title:"Qty",dataIndex:"quantity",width:80,render:(s,t)=>e.jsx(v,{size:"small",min:1,value:s,style:{width:"100%"},onChange:a=>y(t.key,"quantity",a)})},{title:"Unit Price (OMR)",dataIndex:"price",width:130,render:(s,t)=>e.jsx(v,{size:"small",min:0,value:s,precision:3,style:{width:"100%"},onChange:a=>y(t.key,"price",a)})},{title:"Total",width:100,align:"right",render:(s,t)=>e.jsxs("strong",{style:{color:"#e53e3e"},children:["(",(parseFloat(t.price||0)*parseFloat(t.quantity||1)).toFixed(3)," ",e.jsx(U,{size:10,color:"#e53e3e"}),")"]})},{title:"",width:40,render:(s,t)=>e.jsx(K,{title:"Remove?",onConfirm:()=>D(t.key),children:e.jsx(p,{size:"small",danger:!0,type:"text",icon:e.jsx(Z,{})})})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:20},children:[e.jsx(p,{icon:e.jsx(Q,{}),onClick:()=>h("/credit-note")}),e.jsx(ee,{level:4,style:{margin:0,color:"#e53e3e"},children:n?"Edit Credit Note":"New Credit Note"})]}),e.jsxs(o,{form:j,layout:"vertical",onFinish:_,children:[e.jsxs(M,{gutter:16,children:[e.jsx(c,{xs:24,md:12,children:e.jsx(o.Item,{name:"client",label:"Client",rules:[{required:!0}],children:e.jsx(g,{showSearch:!0,placeholder:"Select client",filterOption:(s,t)=>t.label.toLowerCase().includes(s.toLowerCase()),options:T.map(s=>({value:s._id,label:s.name}))})})}),e.jsx(c,{xs:24,md:12,children:e.jsx(o.Item,{name:"invoice",label:"Original Invoice",children:e.jsx(g,{showSearch:!0,allowClear:!0,placeholder:"Link to invoice",filterOption:(s,t)=>t.label.toLowerCase().includes(s.toLowerCase()),options:O.map(s=>({value:s._id,label:`INV-${s.number}/${s.year}`}))})})}),e.jsx(c,{xs:12,md:6,children:e.jsx(o.Item,{name:"date",label:"Date",rules:[{required:!0}],initialValue:b(),children:e.jsx(H,{style:{width:"100%"}})})}),e.jsx(c,{xs:12,md:6,children:e.jsx(o.Item,{name:"taxRate",label:"VAT Rate (%)",initialValue:0,children:e.jsx(v,{min:0,max:100,style:{width:"100%"}})})}),e.jsx(c,{xs:12,md:6,children:e.jsx(o.Item,{name:"status",label:"Status",initialValue:"draft",children:e.jsx(g,{options:["draft","issued","applied","voided"].map(s=>({value:s,label:s.charAt(0).toUpperCase()+s.slice(1)}))})})}),e.jsx(c,{xs:24,children:e.jsx(o.Item,{name:"reason",label:"Reason for Credit Note",children:e.jsx(I,{placeholder:"e.g. Goods returned, Overcharge, etc."})})})]}),e.jsxs(W,{title:"Items",size:"small",style:{marginBottom:12},extra:e.jsx(p,{size:"small",icon:e.jsx(X,{}),onClick:N,danger:!0,children:"Add Item"}),children:[e.jsx(J,{columns:E,dataSource:f,rowKey:"key",pagination:!1,size:"small"}),e.jsx("div",{style:{textAlign:"right",marginTop:8,padding:8,background:"#fff5f5",borderRadius:4},children:e.jsxs("span",{style:{color:"#e53e3e",fontWeight:700},children:["CREDIT TOTAL: (",V(P),")"]})})]}),e.jsx(o.Item,{name:"notes",label:"Notes",children:e.jsx(te,{rows:2})}),e.jsx("div",{style:{textAlign:"right"},children:e.jsxs($,{children:[e.jsx(p,{onClick:()=>h("/credit-note"),children:"Cancel"}),e.jsx(p,{type:"primary",htmlType:"submit",loading:R,icon:e.jsx(Y,{}),danger:!0,children:n?"Update":"Create Credit Note"})]})})]})]})}export{be as default};
