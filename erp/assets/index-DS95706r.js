import{r as l,m as W,j as e}from"./index-xKceigQ0.js";import{o as b}from"./omrFormat-CELVQ6Ci.js";import{O as X,g as Y,aM as I,aL as f,a_ as Z,aB as y,aY as ee,aZ as C,ac as te}from"./IdurarOs-DWdCVvum.js";import{C as T}from"./index-BUWaePBC.js";import{e as F,r as P,T as R}from"./ErpApp-CrOwuTkb.js";import{F as B}from"./Table-CQKa0NzZ.js";import{s as j}from"./index-BKLH6gXI.js";import{R as re}from"./ReloadOutlined-Dkc9CJBy.js";import{G as se}from"./GlobalOutlined-CCnuRi5S.js";import"./Skeleton-CEIVYFMG.js";import"./index-C7CQP6Zi.js";import"./PlusOutlined-YwBt1xJq.js";var ne={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 472a40 40 0 1080 0 40 40 0 10-80 0zm367 352.9L696.3 352V178H768v-68H256v68h71.7v174L145 824.9c-2.8 7.4-4.3 15.2-4.3 23.1 0 35.3 28.7 64 64 64h614.6c7.9 0 15.7-1.5 23.1-4.3 33-12.7 49.4-49.8 36.6-82.8zM395.7 364.7V180h232.6v184.7L719.2 600c-20.7-5.3-42.1-8-63.9-8-61.2 0-119.2 21.5-165.3 60a188.78 188.78 0 01-121.3 43.9c-32.7 0-64.1-8.3-91.8-23.7l118.8-307.5zM210.5 844l41.7-107.8c35.7 18.1 75.4 27.8 116.6 27.8 61.2 0 119.2-21.5 165.3-60 33.9-28.2 76.3-43.9 121.3-43.9 35 0 68.4 9.5 97.6 27.1L813.5 844h-603z"}}]},name:"experiment",theme:"outlined"},ae=function(d,c){return l.createElement(X,Y({},d,{ref:c,icon:ne}))};const q=l.forwardRef(ae);function _(){var h,d;try{const c=(d=(h=JSON.parse(localStorage.getItem("auth")||"{}"))==null?void 0:h.current)==null?void 0:d.token;return c?{Authorization:`Bearer ${c}`}:{}}catch{return{}}}const{Title:ie,Text:o}=ee,{Option:g}=F;function je(){const h=W(),[d,c]=l.useState([]),[$,z]=l.useState(!0),[m,A]=l.useState({current:1,pageSize:30,total:0}),[S,v]=l.useState(""),[E,D]=l.useState("all"),[w,L]=l.useState([]),[k,M]=l.useState({}),[K,O]=l.useState({}),p=async(t=1,r=S,s=E)=>{z(!0);const a=new URLSearchParams({page:t,items:30,...r&&{fields:"partNumber,nsn,description",q:r},...s!=="all"&&{filter:"status",equal:s}}),i=await(await fetch(C+`part/list?${a}`,{headers:_()})).json();i.success!==!1&&(c(i.result||[]),A(u=>{var x;return{...u,current:t,total:((x=i.pagination)==null?void 0:x.count)||0}})),z(!1)};l.useEffect(()=>{p()},[]);const U=async t=>{if(!k[t]){O(r=>({...r,[t]:!0}));try{const s=await(await fetch(C+`procurement/part/${t}`,{headers:_()})).json();s.success!==!1&&s.result&&M(a=>({...a,[t]:s.result}))}catch{j.error("Failed to load supplier data")}finally{O(r=>({...r,[t]:!1}))}}},V=(t,r)=>{t?(L([...w,r._id]),U(r._id)):L(w.filter(s=>s!==r._id))},N=async(t,r)=>{r.stopPropagation();try{const a=await(await fetch(C+`procurement/part/${t}/research`,{method:"POST",headers:_()})).json();a.success!==!1?(j.success("Research started for this part"),c(d.map(n=>n._id===t?{...n,status:"researching"}:n))):j.error(a.message||"Failed to start research")}catch{j.error("Failed to trigger research")}},H=t=>{const r=k[t._id];if(!r||!r.suppliers||r.suppliers.length===0)return null;const s=r.suppliers.map(a=>a.priceOmr).filter(a=>a&&a>0);return s.length===0?null:Math.min(...s)},Q={done:"success",pending:"default",researching:"processing",no_results:"warning"},G=t=>{const r=k[t._id];if(K[t._id])return e.jsx("div",{style:{padding:16,textAlign:"center"},children:"Loading supplier data..."});if(!r||!r.suppliers||r.suppliers.length===0)return e.jsxs("div",{style:{padding:16,textAlign:"center"},children:[e.jsx(o,{type:"secondary",children:"No supplier results found for this part"}),t.status!=="researching"&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx(y,{type:"link",icon:e.jsx(q,{}),onClick:n=>N(t._id,n),style:{marginTop:8},children:"Trigger Research"})]})]});const a=[{title:"Supplier",dataIndex:["vendor","companyName"],key:"supplier",render:(n,i)=>{var u;return e.jsxs(P,{children:[e.jsx(o,{strong:!0,style:{color:"#034D57"},children:n||"Unknown"}),((u=i.vendor)==null?void 0:u.score)>0&&e.jsx(R,{color:"blue",style:{fontSize:10},children:i.vendor.score})]})}},{title:"Website",dataIndex:["vendor","website"],key:"website",render:n=>n?e.jsxs("a",{href:n,target:"_blank",rel:"noopener noreferrer",onClick:i=>i.stopPropagation(),children:[e.jsx(se,{})," Visit"]}):"—"},{title:"Country",dataIndex:["vendor","country"],key:"country",render:n=>n?e.jsx(R,{children:n}):"—"},{title:"Price",dataIndex:"priceOmr",key:"price",align:"right",render:n=>n?e.jsx(o,{strong:!0,style:{color:"#4CB480",fontSize:14},children:b(n)}):"—"},{title:"Contact",key:"contact",render:(n,i)=>{var u,x;return e.jsxs(P,{direction:"vertical",size:0,children:[((u=i.vendor)==null?void 0:u.contactEmail)&&e.jsx(o,{style:{fontSize:11},children:i.vendor.contactEmail}),((x=i.vendor)==null?void 0:x.contactPhone)&&e.jsx(o,{style:{fontSize:11},children:i.vendor.contactPhone})]})}}];return e.jsx("div",{style:{padding:"8px 24px"},children:e.jsx(B,{columns:a,dataSource:r.suppliers,rowKey:"_id",pagination:!1,size:"small"})})},J=[{title:"Part Number",dataIndex:"partNumber",key:"partNumber",width:150,render:t=>e.jsx(o,{strong:!0,style:{color:"#034D57"},children:t||"—"})},{title:"NSN",dataIndex:"nsn",key:"nsn",width:140,render:t=>t?e.jsx(o,{code:!0,style:{fontSize:12},children:t}):"—"},{title:"Description",dataIndex:"description",key:"description",ellipsis:!0,render:t=>t||"—"},{title:"Qty",dataIndex:"quantity",key:"quantity",width:60,align:"center"},{title:"Best Price",key:"bestPrice",width:110,align:"right",render:(t,r)=>{const s=H(r);return s?e.jsx(te,{title:"Lowest price from suppliers",children:e.jsx(o,{strong:!0,style:{color:"#4CB480"},children:b(s)})}):"—"}},{title:"Research",dataIndex:"status",key:"status",width:110,render:(t,r)=>e.jsxs(P,{children:[e.jsx(R,{color:Q[t]||"default",style:{fontSize:11},children:t}),t!=="researching"&&t!=="done"&&e.jsx(y,{type:"link",size:"small",icon:e.jsx(q,{}),onClick:s=>N(r._id,s),style:{padding:0,fontSize:11},children:"Run"})]})},{title:"Sell Price",dataIndex:"unitSellPrice",key:"unitSellPrice",width:110,align:"right",render:(t,r)=>{const s=t||r.unitCostOmr;return s?e.jsx(o,{strong:!0,children:b(s)}):"—"}},{title:"RFQ",dataIndex:["rfq","rfqNumber"],key:"rfq",width:130,render:(t,r)=>{var s;return r.rfq?e.jsx(y,{type:"link",size:"small",style:{padding:0,color:"#034D57",fontSize:12},onClick:()=>h(`/rfq/${r.rfq._id||r.rfq}`),children:t||((s=r.rfq)==null?void 0:s.subject)||"→ View RFQ"}):"—"}}];return e.jsxs("div",{style:{paddingBottom:24},children:[e.jsx(I,{justify:"space-between",align:"middle",style:{marginBottom:16},children:e.jsx(f,{children:e.jsxs(ie,{level:4,style:{margin:0,color:"#034D57"},children:["Parts Catalog — ",m.total.toLocaleString()]})})}),e.jsx(T,{style:{marginBottom:16,borderRadius:8},bodyStyle:{padding:"12px 16px"},children:e.jsxs(I,{gutter:[8,8],align:"middle",children:[e.jsx(f,{xs:24,sm:12,md:8,children:e.jsx(Z.Search,{placeholder:"Search part #, NSN, description...",value:S,onChange:t=>v(t.target.value),onSearch:t=>{v(t),p(1,t)},allowClear:!0,onClear:()=>{v(""),p(1,"")}})}),e.jsx(f,{xs:12,sm:6,md:4,children:e.jsxs(F,{style:{width:"100%"},value:E,onChange:t=>{D(t),p(1,S,t)},children:[e.jsx(g,{value:"all",children:"All Status"}),e.jsx(g,{value:"done",children:"Researched"}),e.jsx(g,{value:"pending",children:"Pending"}),e.jsx(g,{value:"no_results",children:"No Results"}),e.jsx(g,{value:"researching",children:"In Progress"})]})}),e.jsx(f,{children:e.jsx(y,{icon:e.jsx(re,{}),onClick:()=>p(),children:"Refresh"})})]})}),e.jsx(T,{style:{borderRadius:8},bodyStyle:{padding:0},children:e.jsx("div",{style:{overflowX:"auto"},children:e.jsx(B,{dataSource:d,columns:J,rowKey:"_id",loading:$,size:"small",expandable:{expandedRowRender:G,expandedRowKeys:w,onExpand:V,rowExpandable:t=>!0},pagination:{current:m.current,pageSize:m.pageSize,total:m.total,showSizeChanger:!1,showTotal:t=>`${t} parts`,onChange:t=>p(t)}})})})]})}export{je as default};
