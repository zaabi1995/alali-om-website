import{m as R,o as V,r as x,j as e}from"./index-DCzm5dYH.js";import{d as b}from"./dayjs.min-CaCYvAJ2.js";import{b8 as s,aV as y,aB as u,aM as k,aL as d,aX as o,aY as H}from"./IdurarOs-5H8D4UsJ.js";import{C as g}from"./index-t2nl2h8r.js";import{f as h,l as J,k as U}from"./ErpApp-BJzr13dj.js";import{D}from"./index-B1FqXQtc.js";import{F as M}from"./Table-BCwmfyLN.js";import{s as f}from"./index-CPOrKpva.js";import{T as O}from"./index-BulYuMtM.js";import{P as X}from"./index-DVhdscOK.js";import{A as K}from"./ArrowLeftOutlined-CnixpGQp.js";import{P as A}from"./PlusOutlined-BqRacPGF.js";import{S as W}from"./SaveOutlined-B6hul4q8.js";import"./Skeleton-BSD5JXt8.js";import"./index-8VTgkq8a.js";import"./ActionButton-D2FNOrMo.js";const{Title:G,Text:Y}=H,{TextArea:T}=o;function Q(){const c=((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token;return c?{Authorization:`Bearer ${c}`,"Content-Type":"application/json"}:{"Content-Type":"application/json"}}const z={key:Date.now(),partNumber:"",nsn:"",description:"",quantityOrdered:1,quantityShipped:1,unit:"EA",condition:"New",serialNumber:"",batchNumber:"",countryOfOrigin:"",hsCode:""};function xe(){const c=R(),{id:n}=V(),[I]=s.useForm(),[p,j]=x.useState([{...z}]),[B,P]=x.useState([]),[F,L]=x.useState([]),[E,w]=x.useState(!1);x.useEffect(()=>{fetch(y+"client/listAll",{headers:{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}).then(t=>t.json()).then(t=>{t.result&&P(t.result)}).catch(()=>{}),fetch(y+"invoice/listAll",{headers:{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}).then(t=>t.json()).then(t=>{t.result&&L(t.result)}).catch(()=>{}),n&&fetch(y+`deliverynote/read/${n}`,{headers:{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}).then(t=>t.json()).then(t=>{var r,a,m;if(t.success&&t.result){const i=t.result;I.setFieldsValue({client:((r=i.client)==null?void 0:r._id)||i.client,date:i.date?b(i.date):null,shipDate:i.shipDate?b(i.shipDate):null,invoice:((a=i.invoice)==null?void 0:a._id)||i.invoice,carrier:i.carrier,trackingNumber:i.trackingNumber,incoterms:i.incoterms||"FCA",deliveryAddress:i.deliveryAddress,status:i.status,notes:i.notes}),(m=i.items)!=null&&m.length&&j(i.items.map((v,C)=>({...v,key:C})))}}).catch(()=>{})},[n]);const N=()=>j(t=>[...t,{...z,key:Date.now()}]),q=t=>j(r=>r.filter(a=>a.key!==t)),l=(t,r,a)=>{j(m=>m.map(i=>i.key===t?{...i,[r]:a}:i))},_=async t=>{var i,v;if(!p.length){f.error("Add at least one item");return}w(!0);const r={...t,date:(i=t.date)==null?void 0:i.toISOString(),shipDate:((v=t.shipDate)==null?void 0:v.toISOString())||null,items:p},a=n?y+`deliverynote/update/${n}`:y+"deliverynote/create",m=n?"PATCH":"POST";try{const S=await(await fetch(a,{method:m,headers:Q(),body:JSON.stringify(r)})).json();S.success?(f.success(n?"Delivery Note updated":"Delivery Note created"),c(`/delivery-note/read/${S.result._id}`)):f.error(S.message||"Failed to save")}catch{f.error("Network error")}finally{w(!1)}},$=[{title:"Part Number",dataIndex:"partNumber",width:130,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"P/N",onChange:a=>l(r.key,"partNumber",a.target.value)})},{title:"NSN",dataIndex:"nsn",width:120,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"NSN",onChange:a=>l(r.key,"nsn",a.target.value)})},{title:"Description",dataIndex:"description",width:200,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"Description",onChange:a=>l(r.key,"description",a.target.value)})},{title:"Ordered",dataIndex:"quantityOrdered",width:80,render:(t,r)=>e.jsx(O,{size:"small",min:0,value:t,style:{width:"100%"},onChange:a=>l(r.key,"quantityOrdered",a)})},{title:"Shipped",dataIndex:"quantityShipped",width:80,render:(t,r)=>e.jsx(O,{size:"small",min:0,value:t,style:{width:"100%"},onChange:a=>l(r.key,"quantityShipped",a)})},{title:"Unit",dataIndex:"unit",width:70,render:(t,r)=>e.jsx(h,{size:"small",value:t,style:{width:"100%"},onChange:a=>l(r.key,"unit",a),options:["EA","SET","PKG","LOT","MTR","KG","LTR","BOX"].map(a=>({value:a,label:a}))})},{title:"Condition",dataIndex:"condition",width:90,render:(t,r)=>e.jsx(h,{size:"small",value:t,style:{width:"100%"},onChange:a=>l(r.key,"condition",a),options:["New","Used","Refurb","Inspect"].map(a=>({value:a,label:a}))})},{title:"S/N",dataIndex:"serialNumber",width:100,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"S/N",onChange:a=>l(r.key,"serialNumber",a.target.value)})},{title:"COO",dataIndex:"countryOfOrigin",width:70,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"COO",onChange:a=>l(r.key,"countryOfOrigin",a.target.value)})},{title:"HS Code",dataIndex:"hsCode",width:90,render:(t,r)=>e.jsx(o,{size:"small",value:t,placeholder:"HS",onChange:a=>l(r.key,"hsCode",a.target.value)})},{title:"",width:40,render:(t,r)=>e.jsx(X,{title:"Remove?",onConfirm:()=>q(r.key),okText:"Yes",cancelText:"No",children:e.jsx(u,{size:"small",danger:!0,type:"text",icon:e.jsx(U,{})})})}];return e.jsxs("div",{style:{padding:"24px",maxWidth:1200},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:20},children:[e.jsx(u,{icon:e.jsx(K,{}),onClick:()=>c("/delivery-note")}),e.jsx(G,{level:4,style:{margin:0,color:"#034D57"},children:n?"Edit Delivery Note":"New Delivery Note"})]}),e.jsxs(s,{form:I,layout:"vertical",onFinish:_,children:[e.jsxs(k,{gutter:24,children:[e.jsx(d,{xs:24,md:14,children:e.jsx(g,{title:"Delivery Details",size:"small",style:{marginBottom:16},children:e.jsxs(k,{gutter:16,children:[e.jsx(d,{xs:24,sm:12,children:e.jsx(s.Item,{name:"client",label:"Client",rules:[{required:!0,message:"Select a client"}],children:e.jsx(h,{showSearch:!0,placeholder:"Select client",filterOption:(t,r)=>r.label.toLowerCase().includes(t.toLowerCase()),options:B.map(t=>({value:t._id,label:t.name}))})})}),e.jsx(d,{xs:24,sm:12,children:e.jsx(s.Item,{name:"invoice",label:"Invoice Reference (optional)",children:e.jsx(h,{showSearch:!0,allowClear:!0,placeholder:"Link to invoice",filterOption:(t,r)=>r.label.toLowerCase().includes(t.toLowerCase()),options:F.map(t=>({value:t._id,label:`INV-${t.number}/${t.year}`}))})})}),e.jsx(d,{xs:24,sm:12,children:e.jsx(s.Item,{name:"date",label:"Date",rules:[{required:!0}],initialValue:b(),children:e.jsx(D,{style:{width:"100%"}})})}),e.jsx(d,{xs:24,sm:12,children:e.jsx(s.Item,{name:"shipDate",label:"Ship Date",children:e.jsx(D,{style:{width:"100%"}})})}),e.jsx(d,{xs:24,children:e.jsx(s.Item,{name:"deliveryAddress",label:"Delivery Address",children:e.jsx(T,{rows:2,placeholder:"Full delivery address"})})})]})})}),e.jsx(d,{xs:24,md:10,children:e.jsxs(g,{title:"Shipping Info",size:"small",style:{marginBottom:16},children:[e.jsx(s.Item,{name:"carrier",label:"Carrier",children:e.jsx(o,{placeholder:"DHL, Aramex, FedEx..."})}),e.jsx(s.Item,{name:"trackingNumber",label:"Tracking Number",children:e.jsx(o,{placeholder:"Tracking / AWB number"})}),e.jsx(s.Item,{name:"incoterms",label:"Incoterms",initialValue:"FCA",children:e.jsx(h,{options:["FCA","DAP","DDP","EXW","FOB","CIF","CPT"].map(t=>({value:t,label:t}))})}),e.jsx(s.Item,{name:"status",label:"Status",initialValue:"draft",children:e.jsx(h,{options:[{value:"draft",label:"Draft"},{value:"printed",label:"Printed"},{value:"dispatched",label:"Dispatched"},{value:"delivered",label:"Delivered"}]})})]})})]}),e.jsxs(g,{title:"Line Items",size:"small",style:{marginBottom:16},extra:e.jsx(u,{size:"small",icon:e.jsx(A,{}),onClick:N,style:{color:"#4CB480",borderColor:"#4CB480"},children:"Add Item"}),children:[e.jsx("div",{style:{overflowX:"auto"},children:e.jsx(M,{columns:$,dataSource:p,rowKey:"key",pagination:!1,size:"small",locale:{emptyText:e.jsx(u,{type:"dashed",onClick:N,icon:e.jsx(A,{}),children:"Add first item"})}})}),e.jsx("div",{style:{marginTop:12,textAlign:"right"},children:e.jsxs(Y,{type:"secondary",style:{fontSize:12},children:["Total: ",p.reduce((t,r)=>t+(r.quantityShipped||0),0)," units shipped  / ",p.reduce((t,r)=>t+(r.quantityOrdered||0),0)," ordered"]})})]}),e.jsx(g,{title:"Notes",size:"small",style:{marginBottom:16},children:e.jsx(s.Item,{name:"notes",noStyle:!0,children:e.jsx(T,{rows:3,placeholder:"Special instructions, remarks..."})})}),e.jsx("div",{style:{textAlign:"right"},children:e.jsxs(J,{children:[e.jsx(u,{onClick:()=>c("/delivery-note"),children:"Cancel"}),e.jsx(u,{type:"primary",htmlType:"submit",loading:E,icon:e.jsx(W,{}),style:{background:"#034D57",borderColor:"#034D57"},children:n?"Update":"Create Delivery Note"})]})})]})]})}export{xe as default};
