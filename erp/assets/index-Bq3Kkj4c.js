import{m as H,o as J,r as c,j as e}from"./index-BolfsKLq.js";import{d as S}from"./dayjs.min-CAlYWd28.js";import{aH as i,az as u,ai as h,aB as M,aC as n,aE as C,ar as W}from"./IdurarOs-ImGZrK6V.js";import{C as I}from"./index-B1-0owN0.js";import{S as x}from"./index-B4i0fLDO.js";import{D as B}from"./index-8VRd4o8X.js";import{T as j}from"./index-DjaKzJDI.js";import{F as G}from"./Table-DwPC3CMf.js";import{m as z}from"./ErpApp-CPyzesRl.js";import{s as y}from"./index-Bcg4oSX2.js";import{A as K}from"./ArrowLeftOutlined-CS_jDWyb.js";import{P as Q}from"./PlusOutlined-CXeZI9c1.js";import{S as X}from"./SaveOutlined-CodiroIL.js";import{D as Y}from"./DeleteOutlined-Drg8rgxA.js";import"./Skeleton-D8BNZGpQ.js";import"./index-SyqhotZh.js";import"./pickAttrs-rA9L7BI5.js";import"./DownOutlined-CA7fmMYD.js";import"./ClockCircleOutlined-C3FhYHW8.js";import"./Pagination-xSPnpsLs.js";const{Title:Z}=W,{TextArea:ee}=C;function te(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`,"Content-Type":"application/json"}}function w(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function Se(){const f=H(),{id:l}=J(),[O]=i.useForm(),[A,R]=c.useState([]),[V,_]=c.useState([]),[m,p]=c.useState([{key:0,description:"",quantity:1,unitPrice:0,total:0}]),[g,D]=c.useState(0),[L,k]=c.useState(!1);c.useEffect(()=>{fetch(u+"vendor/listAll",{headers:w()}).then(t=>t.json()).then(t=>t.result&&R(t.result)).catch(()=>{}),fetch(u+"purchaseorder/list",{headers:w()}).then(t=>t.json()).then(t=>t.result&&_(t.result)).catch(()=>{}),l&&fetch(u+`vendorbill/read/${l}`,{headers:w()}).then(t=>t.json()).then(t=>{var s,r,o;if(t.success&&t.result){const a=t.result;O.setFieldsValue({...a,date:a.date?S(a.date):null,dueDate:a.dueDate?S(a.dueDate):null,vendor:((s=a.vendor)==null?void 0:s._id)||a.vendor,purchaseOrder:((r=a.purchaseOrder)==null?void 0:r._id)||a.purchaseOrder}),(o=a.items)!=null&&o.length&&p(a.items.map((T,d)=>({...T,key:d}))),D(a.taxRate||0)}}).catch(()=>{})},[l]);const F=t=>t.map(s=>({...s,total:parseFloat(((s.quantity||1)*(s.unitPrice||0)).toFixed(3))})),v=(t,s,r)=>{const o=m.map(a=>a.key===t?{...a,[s]:r}:a);p(F(o))},N=()=>p(t=>[...t,{key:Date.now(),description:"",quantity:1,unitPrice:0,total:0}]),E=t=>p(s=>s.filter(r=>r.key!==t)),b=m.reduce((t,s)=>t+(s.total||0),0),P=parseFloat((b*g/100).toFixed(3)),q=parseFloat((b+P).toFixed(3)),U=async t=>{var o,a;if(m.length===0)return y.error("Add at least one item");k(!0);const s={...t,date:(o=t.date)==null?void 0:o.toISOString(),dueDate:(a=t.dueDate)==null?void 0:a.toISOString(),items:F(m),taxRate:g},r=l?u+`vendorbill/update/${l}`:u+"vendorbill/create";try{const d=await(await fetch(r,{method:l?"PATCH":"POST",headers:te(),body:JSON.stringify(s)})).json();d.success?(y.success(d.message||"Saved"),f(`/vendor-bill/read/${d.result._id}`)):y.error(d.message||"Failed")}catch{y.error("Network error")}finally{k(!1)}},$=[{title:"Description",dataIndex:"description",render:(t,s)=>e.jsx(C,{size:"small",value:t,onChange:r=>v(s.key,"description",r.target.value),placeholder:"Item description"})},{title:"Qty",dataIndex:"quantity",width:80,render:(t,s)=>e.jsx(j,{size:"small",min:0,precision:2,value:t,onChange:r=>v(s.key,"quantity",r||0),style:{width:"100%"}})},{title:"Unit Price",dataIndex:"unitPrice",width:130,render:(t,s)=>e.jsx(j,{size:"small",min:0,precision:4,value:t,onChange:r=>v(s.key,"unitPrice",r||0),style:{width:"100%"}})},{title:"Total",dataIndex:"total",width:100,align:"right",render:t=>e.jsx("b",{children:parseFloat(t||0).toFixed(3)})},{title:"",width:40,render:(t,s)=>e.jsx(h,{size:"small",type:"text",danger:!0,icon:e.jsx(Y,{}),onClick:()=>E(s.key)})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:20},children:[e.jsx(h,{icon:e.jsx(K,{}),onClick:()=>f("/vendor-bill")}),e.jsx(Z,{level:4,style:{margin:0,color:"#034D57"},children:l?"Edit Bill":"New Vendor Bill"})]}),e.jsxs(i,{form:O,layout:"vertical",onFinish:U,children:[e.jsx(I,{title:"Bill Details",size:"small",style:{marginBottom:16},children:e.jsxs(M,{gutter:16,children:[e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"vendor",label:"Vendor",rules:[{required:!0}],children:e.jsx(x,{showSearch:!0,filterOption:(t,s)=>s.label.toLowerCase().includes(t.toLowerCase()),placeholder:"Select vendor",options:A.map(t=>({value:t._id,label:t.companyName}))})})}),e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"vendorRef",label:"Vendor Invoice #",children:e.jsx(C,{placeholder:"Vendor's invoice number"})})}),e.jsx(n,{xs:12,sm:6,children:e.jsx(i.Item,{name:"date",label:"Bill Date",rules:[{required:!0}],initialValue:S(),children:e.jsx(B,{style:{width:"100%"}})})}),e.jsx(n,{xs:12,sm:6,children:e.jsx(i.Item,{name:"dueDate",label:"Due Date",children:e.jsx(B,{style:{width:"100%"}})})}),e.jsx(n,{xs:12,sm:6,children:e.jsx(i.Item,{name:"currency",label:"Currency",initialValue:"USD",children:e.jsx(x,{options:["USD","OMR","EUR","GBP","AED"].map(t=>({value:t,label:t}))})})}),e.jsx(n,{xs:12,sm:6,children:e.jsx(i.Item,{name:"exchangeRate",label:"Rate to OMR",initialValue:1,children:e.jsx(j,{min:0,precision:6,style:{width:"100%"}})})}),e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"purchaseOrder",label:"Linked PO (optional)",children:e.jsx(x,{showSearch:!0,allowClear:!0,filterOption:(t,s)=>s.label.toLowerCase().includes(t.toLowerCase()),placeholder:"Link to PO",options:V.map(t=>({value:t._id,label:`PO-${t.number}/${t.year}`}))})})}),e.jsx(n,{xs:24,sm:12,children:e.jsx(i.Item,{name:"status",label:"Status",initialValue:"draft",children:e.jsx(x,{options:["draft","received","approved","partially_paid","paid","overdue","cancelled"].map(t=>({value:t,label:t.replace(/_/g," ").replace(/\b\w/g,s=>s.toUpperCase())}))})})})]})}),e.jsxs(I,{title:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("span",{children:"Line Items"}),e.jsx(h,{size:"small",icon:e.jsx(Q,{}),onClick:N,type:"dashed",children:"Add Item"})]}),size:"small",style:{marginBottom:16},children:[e.jsx(G,{columns:$,dataSource:m,rowKey:"key",pagination:!1,size:"small"}),e.jsx("div",{style:{textAlign:"right",marginTop:12},children:e.jsxs(z,{direction:"vertical",size:2,style:{minWidth:200},children:[e.jsxs("div",{children:[e.jsx("span",{style:{color:"#888"},children:"Subtotal: "}),e.jsx("b",{children:b.toFixed(3)})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("span",{style:{color:"#888"},children:"Tax %: "}),e.jsx(j,{size:"small",min:0,max:100,value:g,onChange:t=>D(t||0),style:{width:70}}),e.jsx("b",{children:P.toFixed(3)})]}),e.jsxs("div",{style:{fontSize:16,fontWeight:700,color:"#034D57"},children:["Total: ",q.toFixed(3)]})]})})]}),e.jsx(I,{size:"small",style:{marginBottom:16},children:e.jsx(i.Item,{name:"notes",label:"Notes",children:e.jsx(ee,{rows:2})})}),e.jsx("div",{style:{textAlign:"right"},children:e.jsxs(z,{children:[e.jsx(h,{onClick:()=>f("/vendor-bill"),children:"Cancel"}),e.jsx(h,{type:"primary",htmlType:"submit",loading:L,icon:e.jsx(X,{}),style:{background:"#034D57"},children:l?"Update":"Create Bill"})]})})]})]})}export{Se as default};
