import{r as a,j as e}from"./index-DUJms0D6.js";import{o as p}from"./omrFormat-C4CQjmYz.js";import{d as Te}from"./dayjs.min-BzahnmbO.js";import{aG as S,ai as u,aA as le,aB as M,aI as Pe,aD as ae,ar as ke,ay as y,T as ze,aw as Ie}from"./IdurarOs-B30-LCOQ.js";import{C as _e}from"./index-CyAxxhY0.js";import{F as ne}from"./Table-B0UCs-zn.js";import{M as re}from"./index-BEcbaSPx.js";import{S as ie}from"./index-dR7Ye1Yy.js";import{T as D}from"./index-CkFZCKkj.js";import{A as Re}from"./index-DFhXwPca.js";import{T as Be}from"./index-HdV2iirx.js";import{s as d}from"./index-Bcgt9tpb.js";import{T as E}from"./index-DvoWVJab.js";import{T as de,R as Me,l as ce,F as Ee}from"./ErpApp-DDkabuKV.js";import{P as pe}from"./index-DFrivB9v.js";import{P as me}from"./PlusOutlined-CXK5kHAC.js";import{D as ue}from"./DeleteOutlined-Cwki4DTc.js";import{C as Ne}from"./CheckCircleOutlined-QNZ-WepX.js";import"./Skeleton-DxrcQ8CB.js";import"./pickAttrs-DfTUuTsA.js";import"./DownOutlined-BJeYAz_H.js";import"./ActionButton-4R6uE_jt.js";import"./useClosable-BcPbIM0E.js";import"./fade-DETort7_.js";const{Title:Fe,Text:x}=ke;function P(){return{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`}}function N(){return{...P(),"Content-Type":"application/json"}}const he={draft:"default",approved:"processing",paid:"success"},v=["January","February","March","April","May","June","July","August","September","October","November","December"],Le=["housing","transport","food","phone","bonus","other"],$e=["absence","late","half_day","advance","other"],T=m=>(m||[]).reduce((k,z)=>k+(z.amount||0),0),b=m=>(m||0).toFixed(3);function mt(){var ee,te,se;const[m,k]=a.useState([]),[z,F]=a.useState(!1),[C,L]=a.useState(null),[ye,I]=a.useState(!1),[xe,$]=a.useState(!1),[H]=S.useForm(),[i,_]=a.useState(null),[fe,G]=a.useState(!1),[f,J]=a.useState([]),[w,U]=a.useState([]),[W,Y]=a.useState(0),[A,K]=a.useState(0),[V,q]=a.useState(""),g=async()=>{F(!0);const s=await fetch(y+"payrollrun/list?items=24",{headers:P()}).then(t=>t.json()).catch(()=>({}));s.success&&k(s.result||[]),F(!1)};a.useEffect(()=>{g()},[]);const c=m[0];m.reduce((s,t)=>({headcount:Math.max(s.headcount,t.headcount||0),gross:s.gross+(t.totalGross||0),deductions:s.deductions+(t.totalDeductions||0),net:s.net+(t.totalNet||0)}),{headcount:0,gross:0,deductions:0,net:0});const ge=async()=>{let s;try{s=await H.validateFields()}catch{return}$(!0);try{const t=await fetch(y+"payroll/generate",{method:"POST",headers:N(),body:JSON.stringify(s)}).then(o=>o.json());t.success?(d.success(t.message),I(!1),g()):d.error(t.message||"Failed")}finally{$(!1)}},je=async s=>{const t=await fetch(`${y}payroll/approve/${s}`,{method:"PATCH",headers:P()}).then(o=>o.json()).catch(()=>({}));t.success?(d.success(t.message),g()):d.error(t.message)},Se=async s=>{const t=await fetch(`${y}payroll/mark-paid/${s}`,{method:"PATCH",headers:N(),body:JSON.stringify({paidVia:"Bank Transfer"})}).then(o=>o.json()).catch(()=>({}));t.success?(d.success(t.message),g()):d.error(t.message)},ve=async(s,t,o,h,R)=>{try{const O=await fetch(`${y}payroll/payslip-pdf/${s}/${t}`,{headers:P()});if(!O.ok){d.error("PDF generation failed");return}const j=await O.blob(),n=URL.createObjectURL(j),l=document.createElement("a");l.href=n,l.download=`PaySlip-${o.replace(/\s+/g,"-")}-${v[h-1]}-${R}.pdf`,l.click(),URL.revokeObjectURL(n)}catch{d.error("PDF download failed")}},be=(s,t)=>{_({run:s,slip:t}),J(JSON.parse(JSON.stringify(t.allowances||[]))),U((t.deductions||[]).filter(o=>o.type!=="pasi").map(o=>JSON.parse(JSON.stringify(o)))),Y(t.overtimeHours||0),K(t.overtimeAmt||0),q(t.notes||"")},Ce=async()=>{if(i){G(!0);try{const s={allowances:f.filter(o=>o.amount>0),deductions:w.filter(o=>o.amount>0),overtimeHours:W,overtimeAmt:A,notes:V},t=await fetch(`${y}payroll/update-slip/${i.run._id}/${i.slip._id}`,{method:"PATCH",headers:N(),body:JSON.stringify(s)}).then(o=>o.json());t.success?(d.success(t.message),_(null),g()):d.error(t.message||"Failed")}finally{G(!1)}}},Q=({items:s,setItems:t,types:o,addLabel:h})=>{const R=()=>t(n=>[...n,{type:o[0],description:"",amount:0}]),O=n=>t(l=>l.filter((r,B)=>B!==n)),j=(n,l,r)=>t(B=>B.map((oe,De)=>De===n?{...oe,[l]:r}:oe));return e.jsxs("div",{children:[s.map((n,l)=>e.jsxs("div",{style:{display:"flex",gap:6,marginBottom:6,alignItems:"center"},children:[e.jsx(ie,{size:"small",style:{width:120},value:n.type,onChange:r=>j(l,"type",r),options:o.map(r=>({value:r,label:r.charAt(0).toUpperCase()+r.slice(1).replace("_"," ")}))}),e.jsx(ae,{size:"small",style:{flex:1},placeholder:"Description",value:n.description,onChange:r=>j(l,"description",r.target.value)}),e.jsx(D,{size:"small",style:{width:110},min:0,precision:3,placeholder:"0.000",value:n.amount,onChange:r=>j(l,"amount",r||0),addonBefore:"OMR"}),e.jsx(ue,{onClick:()=>O(l),style:{color:"#e53e3e",cursor:"pointer",fontSize:14}})]},l)),e.jsx(u,{size:"small",icon:e.jsx(me,{}),onClick:R,style:{marginTop:4},children:h})]})},X=i?(i.slip.basicSalary||0)+T(f)+(A||0):0,Z=T(w),we=Math.max(0,X-Z),Ae=[{title:"Period",render:(s,t)=>e.jsxs(x,{strong:!0,style:{color:"#034D57"},children:[v[t.month-1]," ",t.year]})},{title:"Headcount",dataIndex:"headcount",align:"center",render:s=>e.jsx(E,{icon:e.jsx(de,{}),children:s})},{title:"Gross Pay",dataIndex:"totalGross",align:"right",render:s=>p(s)},{title:"PASI (Emp)",dataIndex:"totalPasiEmployee",align:"right",render:s=>s>0?e.jsx("span",{style:{color:"#b7700a",fontSize:12},children:p(s)}):e.jsx("span",{style:{color:"#ccc"},children:"—"})},{title:"Deductions",dataIndex:"totalDeductions",align:"right",render:s=>s>0?e.jsx("span",{style:{color:"#e53e3e"},children:p(s)}):"—"},{title:"Net Pay",dataIndex:"totalNet",align:"right",render:s=>e.jsx("strong",{style:{color:"#4CB480"},children:p(s)})},{title:"Status",dataIndex:"status",render:s=>e.jsx(E,{color:he[s],children:s==null?void 0:s.toUpperCase()})},{title:"",width:220,render:(s,t)=>e.jsxs(ce,{size:4,children:[t.status==="draft"&&e.jsx(pe,{title:"Approve this payroll run?",onConfirm:()=>je(t._id),okText:"Approve",children:e.jsx(u,{size:"small",type:"primary",style:{background:"#034D57",borderColor:"#034D57"},icon:e.jsx(Ne,{}),children:"Approve"})}),t.status==="approved"&&e.jsx(pe,{title:"Mark all pay slips as paid?",onConfirm:()=>Se(t._id),okText:"Confirm",children:e.jsx(u,{size:"small",style:{background:"#4CB480",borderColor:"#4CB480",color:"#fff"},children:"Mark Paid"})}),e.jsx(u,{size:"small",onClick:()=>L(C===t._id?null:t._id),children:C===t._id?"Close":"View Slips"})]})}],Oe=s=>[{title:"Employee",render:(t,o)=>e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:o.name}),e.jsxs(x,{type:"secondary",style:{fontSize:11},children:[o.department," · ",o.employeeId]})]})},{title:"Attendance",align:"center",render:(t,o)=>e.jsxs(x,{style:{fontSize:11},children:[e.jsxs("span",{style:{color:"#4CB480"},children:["✓",o.workingDays||0]})," ",e.jsxs("span",{style:{color:"#e53e3e"},children:["✗",o.absentDays||0]}),o.overtimeHours>0&&e.jsxs("span",{style:{color:"#b7700a"},children:[" OT:",(o.overtimeHours||0).toFixed(1),"h"]})]})},{title:"Basic",dataIndex:"basicSalary",align:"right",render:t=>p(t)},{title:"Allowances",align:"right",render:(t,o)=>{const h=T(o.allowances)+(o.overtimeAmt||0);return h>0?e.jsx("span",{style:{color:"#047857"},children:p(h)}):"—"}},{title:"Deductions",align:"right",render:(t,o)=>o.totalDeductions>0?e.jsx("span",{style:{color:"#e53e3e"},children:p(o.totalDeductions)}):"—"},{title:"Net Pay",dataIndex:"netPay",align:"right",render:t=>e.jsx("strong",{style:{color:"#4CB480"},children:p(t)})},{title:"Status",dataIndex:"status",render:t=>e.jsx(E,{color:he[t],style:{fontSize:10},children:t==null?void 0:t.toUpperCase()})},{title:"",width:110,render:(t,o)=>e.jsxs(ce,{size:4,children:[s.status!=="paid"&&e.jsx(ze,{title:"Edit allowances / deductions",children:e.jsx(u,{size:"small",icon:e.jsx(Ie,{}),onClick:()=>be(s,o)})}),e.jsx(u,{size:"small",icon:e.jsx(Ee,{}),onClick:()=>ve(s._id,o._id,o.name,s.month,s.year),children:"PDF"})]})}];return e.jsxs("div",{style:{padding:24},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx(Fe,{level:4,style:{margin:0,color:"#034D57"},children:"Payroll"}),e.jsx(u,{type:"primary",icon:e.jsx(me,{}),onClick:()=>I(!0),style:{background:"#034D57",borderColor:"#034D57"},children:"Generate Payroll Run"})]}),c&&e.jsx(le,{gutter:12,style:{marginBottom:18},children:[{label:`Headcount (${v[(c.month||1)-1]} ${c.year})`,value:c.headcount,prefix:e.jsx(de,{}),color:"#034D57"},{label:"Latest Gross Pay",value:(ee=c.totalGross)==null?void 0:ee.toFixed(3),prefix:"OMR",color:"#1a1a1a"},{label:"Latest Deductions",value:(te=c.totalDeductions)==null?void 0:te.toFixed(3),prefix:"OMR",color:"#e53e3e"},{label:"Latest Net Pay",value:(se=c.totalNet)==null?void 0:se.toFixed(3),prefix:"OMR",color:"#4CB480"},{label:"PASI Employer Cost",value:(c.totalPasiEmployer||0).toFixed(3),prefix:"OMR",color:"#b7700a"}].map((s,t)=>e.jsx(M,{span:Math.floor(24/5),children:e.jsxs(_e,{size:"small",bodyStyle:{padding:"10px 14px"},children:[e.jsx("div",{style:{fontSize:10,color:"#888",textTransform:"uppercase",marginBottom:4},children:s.label}),e.jsxs("div",{style:{fontSize:18,fontWeight:700,color:s.color},children:[s.prefix," ",s.value]})]})},t))}),e.jsx(ne,{columns:Ae,dataSource:m,rowKey:"_id",loading:z,size:"small",pagination:!1,expandable:{expandedRowKeys:C?[C]:[],onExpand:(s,t)=>L(o=>o===t._id?null:t._id),expandedRowRender:s=>e.jsx("div",{style:{padding:"8px 0 12px"},children:e.jsx(ne,{size:"small",pagination:!1,dataSource:s.paySlips||[],rowKey:"_id",columns:Oe(s)})})}}),e.jsx(re,{title:"Generate Monthly Payroll",open:ye,onCancel:()=>I(!1),onOk:ge,okText:"Generate",confirmLoading:xe,okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:e.jsxs(S,{form:H,layout:"vertical",style:{marginTop:12},children:[e.jsxs(le,{gutter:12,children:[e.jsx(M,{span:12,children:e.jsx(S.Item,{name:"month",label:"Month",rules:[{required:!0}],children:e.jsx(ie,{options:v.map((s,t)=>({value:t+1,label:s})),placeholder:"Select month"})})}),e.jsx(M,{span:12,children:e.jsx(S.Item,{name:"year",label:"Year",initialValue:Te().year(),rules:[{required:!0}],children:e.jsx(D,{style:{width:"100%"},min:2020,max:2100})})})]}),e.jsx(Re,{type:"info",showIcon:!0,style:{fontSize:12},message:"Automatically generates pay slips for all active employees. Includes standard allowances from their profile, and deducts absences from attendance records."})]})}),i&&e.jsxs(re,{title:e.jsxs("span",{children:["Edit Pay Slip — ",e.jsx("strong",{style:{color:"#034D57"},children:i.slip.name}),e.jsxs(x,{type:"secondary",style:{fontSize:12,marginLeft:8},children:[v[(i.run.month||1)-1]," ",i.run.year]})]}),open:!!i,onCancel:()=>_(null),onOk:Ce,okText:"Save Changes",confirmLoading:fe,width:700,okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:[e.jsxs("div",{style:{background:"#f0f6f7",borderRadius:6,padding:"10px 14px",marginBottom:16,display:"flex",gap:24},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"Basic"}),e.jsxs("div",{style:{fontWeight:700},children:["OMR ",b(i.slip.basicSalary)]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"+ Allowances"}),e.jsxs("div",{style:{fontWeight:700,color:"#047857"},children:["OMR ",b(T(f)+A)]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"Gross"}),e.jsxs("div",{style:{fontWeight:700},children:["OMR ",b(X)]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"– Deductions"}),e.jsxs("div",{style:{fontWeight:700,color:"#e53e3e"},children:["OMR ",b(Z)]})]}),e.jsxs("div",{style:{marginLeft:"auto",textAlign:"right"},children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"NET PAY"}),e.jsxs("div",{style:{fontWeight:800,fontSize:18,color:"#034D57"},children:["OMR ",b(we)]})]})]}),e.jsx(Be,{items:[{key:"allowances",label:e.jsxs("span",{children:[e.jsx(Me,{})," Allowances (",f.length,")"]}),children:e.jsxs("div",{children:[e.jsx(x,{type:"secondary",style:{fontSize:11,display:"block",marginBottom:10},children:"Add housing, transport, food, phone, bonus or any custom allowance."}),e.jsx(Q,{items:f,setItems:J,types:Le,addLabel:"Add Allowance"}),e.jsx(Pe,{style:{margin:"12px 0"}}),e.jsxs("div",{style:{display:"flex",gap:16,alignItems:"flex-end"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:11,color:"#888",marginBottom:4},children:"Overtime Hours"}),e.jsx(D,{size:"small",min:0,precision:2,value:W,onChange:s=>Y(s||0),addonAfter:"hrs",style:{width:120}})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:11,color:"#888",marginBottom:4},children:"Overtime Amount"}),e.jsx(D,{size:"small",min:0,precision:3,value:A,onChange:s=>K(s||0),addonBefore:"OMR",style:{width:150}})]})]})]})},{key:"deductions",label:e.jsxs("span",{children:[e.jsx(ue,{})," Deductions (",w.length,")"]}),children:e.jsxs("div",{children:[e.jsx(x,{type:"secondary",style:{fontSize:11,display:"block",marginBottom:10},children:"PASI is auto-calculated from employee settings. Add absence, advances, or custom deductions here."}),e.jsx(Q,{items:w,setItems:U,types:$e,addLabel:"Add Deduction"})]})},{key:"notes",label:"Notes",children:e.jsx(S.Item,{label:"Internal notes (shown on pay slip)",children:e.jsx(ae.TextArea,{rows:4,value:V,onChange:s=>q(s.target.value),placeholder:"e.g. Includes Ramadan bonus, partial month..."})})}]})]})]})}export{mt as default};
