import{r as o,j as t}from"./index-qzPW9k5C.js";import{o as I}from"./omrFormat-BQCFoS4E.js";import{d as c}from"./dayjs.min-IeqEFdrM.js";import{aH as l,ai as f,aB as v,aC as x,c1 as q,aJ as L,ar as W,az as d}from"./IdurarOs-DNtyhAIr.js";import{F as M}from"./Table-BEwP-RQB.js";import{M as w}from"./index-a_INRcyO.js";import{C as g}from"./index-BT6S6B4u.js";import{S as y}from"./index-ByIMSrJ7.js";import{A as K}from"./index-Cos0J3J8.js";import{T as A}from"./index-BcmoYINL.js";import{S as U}from"./index-B6mZ1Nih.js";import{T as G}from"./index-BCL6CBrr.js";import{D as Q}from"./index-z8alQHp7.js";import{s as u}from"./index-DjpUES0Y.js";import{W as V}from"./ErpApp-C6krObaP.js";import{P as X}from"./PlusOutlined-BhF-bFT8.js";import{C as Z}from"./CheckCircleOutlined-Wzb60QX0.js";import"./pickAttrs-HYIWXRHU.js";import"./DownOutlined-Cv0sD8Lj.js";import"./Pagination-DLTxefs_.js";import"./index-Bcrj0uk5.js";import"./ActionButton-BYIDHq6f.js";import"./useClosable-D4tg0jNW.js";import"./fade-Uq_gSESL.js";import"./Skeleton-r7dioW59.js";import"./index-C5J7yocW.js";import"./ClockCircleOutlined-CBV0ymDz.js";const{Title:T,Text:we}=W,{RangePicker:ee}=Q;function S(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function j(){return{...S(),"Content-Type":"application/json"}}function Ae(){var b,D;const[R,P]=o.useState([]),[Y,F]=o.useState([]),[O,k]=o.useState(!1),[s,n]=o.useState(null),[$,p]=o.useState(!1),[_,C]=o.useState(!1),[B]=l.useForm(),h=async()=>{k(!0);const[e,a]=await Promise.all([fetch(d+"bankreconciliation/list?items=20",{headers:S()}).then(r=>r.json()).catch(()=>({})),fetch(d+"bankaccount/list",{headers:S()}).then(r=>r.json()).catch(()=>({}))]);e.success&&P(e.result||[]),a.success&&F(a.result||[]),k(!1)};o.useEffect(()=>{h()},[]);const z=async()=>{let e;try{e=await B.validateFields()}catch{return}C(!0);try{const a={bankAccountId:e.bankAccountId,periodStart:e.period[0].toISOString(),periodEnd:e.period[1].toISOString(),statementBalance:e.statementBalance},r=await fetch(d+"bankreconciliation/start",{method:"POST",headers:j(),body:JSON.stringify(a)}).then(i=>i.json());r.success?(u.success(r.message),p(!1),n(r.result),h()):u.error(r.message||"Failed")}finally{C(!1)}},N=async(e,a)=>{const r=await fetch(`${d}bankreconciliation/update-items/${e}`,{method:"PATCH",headers:j(),body:JSON.stringify({clearedItems:a})}).then(i=>i.json()).catch(()=>({}));r.success&&n(r.result)},E=async e=>{const a=await fetch(`${d}bankreconciliation/complete/${e}`,{method:"PATCH",headers:j()}).then(r=>r.json()).catch(()=>({}));a.success?(u.success(a.message),n(null),h()):u.error(a.message||"Failed")},H=[{title:"Bank Account",dataIndex:"bankAccount",render:e=>(e==null?void 0:e.accountName)||"—"},{title:"Period",render:(e,a)=>`${c(a.periodStart).format("DD MMM")} – ${c(a.periodEnd).format("DD MMM YYYY")}`},{title:"Statement Balance",dataIndex:"statementBalance",align:"right",render:e=>I(e)},{title:"Difference",dataIndex:"difference",align:"right",render:e=>t.jsx("span",{style:{color:Math.abs(e)<.01?"#4CB480":"#e53e3e",fontWeight:700},children:e==null?void 0:e.toFixed(3)})},{title:"Status",dataIndex:"status",render:e=>t.jsx(A,{color:e==="reconciled"?"success":"default",children:e==null?void 0:e.toUpperCase()})},{title:"",render:(e,a)=>a.status==="draft"&&t.jsx(f,{size:"small",onClick:()=>n(a),style:{color:"#034D57"},children:"Open"})}];return t.jsxs("div",{style:{padding:24},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsxs(T,{level:4,style:{margin:0,color:"#034D57"},children:[t.jsx(V,{style:{marginRight:8}}),"Bank Reconciliation"]}),t.jsx(f,{type:"primary",icon:t.jsx(X,{}),onClick:()=>p(!0),style:{background:"#034D57",borderColor:"#034D57"},children:"Start Reconciliation"})]}),t.jsx(M,{columns:H,dataSource:R,rowKey:"_id",loading:O,size:"small",pagination:!1,onRow:e=>({onClick:()=>e.status==="draft"&&n(e)})}),s&&t.jsxs(w,{title:`Reconciliation — ${c(s.periodStart).format("DD MMM")} to ${c(s.periodEnd).format("DD MMM YYYY")}`,open:!!s,onCancel:()=>n(null),footer:null,width:800,children:[t.jsxs(v,{gutter:16,style:{marginBottom:16},children:[t.jsx(x,{span:8,children:t.jsx(g,{size:"small",children:t.jsx(y,{title:"Statement Balance",value:(b=s.statementBalance)==null?void 0:b.toFixed(3),valueStyle:{color:"#034D57"}})})}),t.jsx(x,{span:8,children:t.jsx(g,{size:"small",children:t.jsx(y,{title:"Cleared Balance",value:(s.statementBalance-s.difference).toFixed(3)})})}),t.jsx(x,{span:8,children:t.jsx(g,{size:"small",children:t.jsx(y,{title:"Difference",value:(D=s.difference)==null?void 0:D.toFixed(3),valueStyle:{color:Math.abs(s.difference)<.01?"#4CB480":"#e53e3e",fontWeight:700}})})})]}),Math.abs(s.difference)<.01&&t.jsx(K,{type:"success",message:"✓ Balanced — ready to reconcile",style:{marginBottom:12}}),t.jsx(T,{level:5,style:{color:"#034D57",marginBottom:8},children:"Transactions — check off what matches your statement"}),t.jsx(M,{size:"small",pagination:!1,dataSource:s.clearedItems||[],rowKey:(e,a)=>a,columns:[{title:"✓",width:40,render:(e,a,r)=>t.jsx(q,{checked:a.cleared,onChange:i=>{const m=[...s.clearedItems];m[r]={...m[r],cleared:i.target.checked};const J={...s,clearedItems:m};n(J),N(s._id,m)}})},{title:"Date",dataIndex:"date",width:100,render:e=>c(e).format("DD MMM YYYY")},{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Type",dataIndex:"type",width:90,render:e=>t.jsx(A,{color:e==="deposit"?"green":"red",children:e})},{title:"Amount",dataIndex:"amount",align:"right",render:e=>I(e)}],rowClassName:e=>e.cleared?"row-cleared":""}),t.jsx(L,{}),t.jsx("div",{style:{textAlign:"right"},children:t.jsx(f,{type:"primary",icon:t.jsx(Z,{}),disabled:Math.abs(s.difference)>.01,onClick:()=>E(s._id),style:{background:"#4CB480",borderColor:"#4CB480"},children:"Complete Reconciliation"})})]}),t.jsx(w,{title:"Start New Reconciliation",open:$,onCancel:()=>p(!1),onOk:z,okText:"Start",confirmLoading:_,okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:t.jsxs(l,{form:B,layout:"vertical",style:{marginTop:12},children:[t.jsx(l.Item,{name:"bankAccountId",label:"Bank Account",rules:[{required:!0}],children:t.jsx(U,{options:Y.map(e=>({value:e._id,label:`${e.accountName} (${e.currency})`}))})}),t.jsx(l.Item,{name:"period",label:"Statement Period",rules:[{required:!0}],children:t.jsx(ee,{style:{width:"100%"}})}),t.jsx(l.Item,{name:"statementBalance",label:"Closing Balance on Bank Statement",rules:[{required:!0}],children:t.jsx(G,{style:{width:"100%"},min:0,precision:3,placeholder:"0.000"})})]})})]})}export{Ae as default};
