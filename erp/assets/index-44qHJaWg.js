import{m as $,o as A,r as m,j as e}from"./index-CKjWyx67.js";import{d as O}from"./dayjs.min-CIecPvxL.js";import{ay as p,aC as B,ai as s,aw as z,aA as E,aB as P,ar as Y}from"./IdurarOs-BgMdBggr.js";import{s as x}from"./index-XM48pMGy.js";import{T as _}from"./index-XVJtUZ3d.js";import{j as q,H}from"./ErpApp-M1iameEO.js";import{C as f}from"./index-ZIE74Uk7.js";import{D as l}from"./index-CegXI76Z.js";import{F as h}from"./Table-DqQBpqxK.js";import{M as W}from"./index-Bl6IZgWr.js";import{A as J}from"./ArrowLeftOutlined-b4ymjTZt.js";import{C as K}from"./CheckCircleOutlined-BrIDV9vn.js";import{F as b}from"./FilePdfOutlined-Ch7tVI7b.js";import"./useClosable-jXBiFFW8.js";import"./Skeleton-BIytMwGH.js";import"./index-Bvd6GFZp.js";import"./PlusOutlined-BVkVZY4D.js";import"./pickAttrs-DdF16Fa2.js";import"./index-DJ9T48TP.js";import"./DownOutlined-BY38r6sB.js";import"./ActionButton--BPorTej.js";import"./fade-Cn8jLJnP.js";const{Title:N,Text:L}=Y;function y(){const o=localStorage.getItem("x-auth-token");return o?{Authorization:`Bearer ${o}`}:{}}const V={draft:"default",printed:"blue",dispatched:"orange",delivered:"green"};function je(){var w,k,I;const o=$(),{id:d}=A(),[t,C]=m.useState(null),[R,U]=m.useState(!0),[v,u]=m.useState(!1),[c,j]=m.useState(null),[T,g]=m.useState(!1);m.useEffect(()=>{fetch(p+`deliverynote/read/${d}`,{headers:y()}).then(r=>r.json()).then(r=>{r.success&&C(r.result)}).catch(()=>x.error("Failed to load")).finally(()=>U(!1))},[d]);const D=async r=>{const i=await(await fetch(p+`deliverynote/update/${d}`,{method:"PATCH",headers:{...y(),"Content-Type":"application/json"},body:JSON.stringify({status:r})})).json();i.success&&(C(i.result),x.success(`Status updated to ${r}`))},F=async()=>{u(!0);try{const r=await fetch(p+`deliverynote/pdf/${d}`,{headers:y()});if(!r.ok)throw new Error("PDF generation failed");const n=await r.blob(),i=URL.createObjectURL(n);j(i),g(!0)}catch(r){x.error("Could not generate PDF: "+r.message)}finally{u(!1)}},S=async()=>{u(!0);try{const r=await fetch(p+`deliverynote/pdf/${d}`,{headers:y()});if(!r.ok)throw new Error("PDF generation failed");const n=await r.blob(),i=URL.createObjectURL(n),a=document.createElement("a");a.href=i,a.download=`DN-${t==null?void 0:t.number}-${t==null?void 0:t.year}.pdf`,a.click(),URL.revokeObjectURL(i)}catch(r){x.error("Could not generate PDF: "+r.message)}finally{u(!1)}};if(R)return e.jsx("div",{style:{textAlign:"center",padding:60},children:e.jsx(B,{size:"large"})});if(!t)return e.jsx("div",{style:{padding:24},children:"Delivery note not found."});const M=[{title:"#",width:40,render:(r,n,i)=>i+1},{title:"Part Number",dataIndex:"partNumber",render:r=>e.jsx("strong",{children:r||"—"})},{title:"NSN",dataIndex:"nsn",render:r=>r||"—"},{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Ordered",dataIndex:"quantityOrdered",align:"center"},{title:"Shipped",dataIndex:"quantityShipped",align:"center",render:r=>e.jsx("strong",{style:{color:"#034D57"},children:r})},{title:"Unit",dataIndex:"unit"},{title:"Condition",dataIndex:"condition"},{title:"S/N",dataIndex:"serialNumber",render:r=>r||"—"},{title:"Batch",dataIndex:"batchNumber",render:r=>r||"—"},{title:"COO",dataIndex:"countryOfOrigin",render:r=>r||"—"},{title:"HS Code",dataIndex:"hsCode",render:r=>r||"—"}];return e.jsxs("div",{style:{padding:"24px",maxWidth:1100},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,flexWrap:"wrap",gap:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx(s,{icon:e.jsx(J,{}),onClick:()=>o("/delivery-note")}),e.jsxs("div",{children:[e.jsxs(N,{level:4,style:{margin:0,color:"#034D57"},children:["Delivery Note DN-",t.number,"/",t.year]}),e.jsx(_,{color:V[t.status]||"default",style:{marginTop:4},children:(w=t.status)==null?void 0:w.toUpperCase()})]})]}),e.jsxs(q,{wrap:!0,children:[t.status==="draft"&&e.jsx(s,{icon:e.jsx(H,{}),onClick:()=>D("dispatched"),style:{borderColor:"#fa8c16",color:"#fa8c16"},children:"Mark Dispatched"}),t.status==="dispatched"&&e.jsx(s,{icon:e.jsx(K,{}),onClick:()=>D("delivered"),style:{borderColor:"#4CB480",color:"#4CB480"},children:"Mark Delivered"}),e.jsx(s,{icon:e.jsx(b,{}),onClick:F,loading:v,children:"Preview PDF"}),e.jsx(s,{icon:e.jsx(b,{}),onClick:S,loading:v,style:{background:"#034D57",borderColor:"#034D57",color:"#fff"},children:"Download PDF"}),e.jsx(s,{icon:e.jsx(z,{}),onClick:()=>o(`/delivery-note/edit/${d}`),children:"Edit"})]})]}),e.jsxs(E,{gutter:16,style:{marginBottom:16},children:[e.jsx(P,{xs:24,md:12,children:e.jsxs(f,{size:"small",title:"Deliver To",style:{height:"100%"},children:[e.jsx(N,{level:5,style:{color:"#034D57",marginTop:0},children:((k=t.client)==null?void 0:k.name)||"—"}),t.deliveryAddress&&e.jsx(L,{type:"secondary",style:{whiteSpace:"pre-line",fontSize:12},children:t.deliveryAddress})]})}),e.jsx(P,{xs:24,md:12,children:e.jsx(f,{size:"small",title:"Shipping Details",style:{height:"100%"},children:e.jsxs(l,{size:"small",column:1,children:[e.jsx(l.Item,{label:"Date",children:O(t.date).format("DD MMM YYYY")}),t.shipDate&&e.jsx(l.Item,{label:"Ship Date",children:O(t.shipDate).format("DD MMM YYYY")}),t.carrier&&e.jsx(l.Item,{label:"Carrier",children:t.carrier}),t.trackingNumber&&e.jsx(l.Item,{label:"Tracking #",children:t.trackingNumber}),t.incoterms&&e.jsx(l.Item,{label:"Incoterms",children:t.incoterms}),t.invoice&&e.jsx(l.Item,{label:"Invoice Ref",children:e.jsxs("a",{onClick:()=>o(`/invoice/read/${t.invoice._id||t.invoice}`),children:["INV-",t.invoice.number,"/",t.invoice.year]})})]})})})]}),e.jsx(f,{size:"small",title:`Line Items (${((I=t.items)==null?void 0:I.length)||0})`,style:{marginBottom:16},children:e.jsx("div",{style:{overflowX:"auto"},children:e.jsx(h,{columns:M,dataSource:t.items||[],rowKey:(r,n)=>n,pagination:!1,size:"small",summary:()=>{var r,n;return e.jsxs(h.Summary.Row,{style:{background:"#f0f6f7"},children:[e.jsx(h.Summary.Cell,{index:0,colSpan:4,children:e.jsx("strong",{children:"Totals"})}),e.jsx(h.Summary.Cell,{index:4,align:"center",children:e.jsx("strong",{children:(r=t.items)==null?void 0:r.reduce((i,a)=>i+(a.quantityOrdered||0),0)})}),e.jsx(h.Summary.Cell,{index:5,align:"center",children:e.jsx("strong",{style:{color:"#034D57"},children:(n=t.items)==null?void 0:n.reduce((i,a)=>i+(a.quantityShipped||0),0)})}),e.jsx(h.Summary.Cell,{index:6,colSpan:6})]})}})})}),t.notes&&e.jsx(f,{size:"small",title:"Notes",style:{marginBottom:16,borderLeft:"3px solid #f59e0b"},children:e.jsx(L,{children:t.notes})}),e.jsx(W,{title:`PDF Preview — DN-${t.number}/${t.year}`,open:T,onCancel:()=>{g(!1),c&&URL.revokeObjectURL(c),j(null)},footer:[e.jsx(s,{type:"primary",icon:e.jsx(b,{}),onClick:S,style:{background:"#034D57",borderColor:"#034D57"},children:"Download"},"download"),e.jsx(s,{onClick:()=>{g(!1),c&&URL.revokeObjectURL(c),j(null)},children:"Close"},"close")],width:"80%",style:{top:20},children:c&&e.jsx("iframe",{src:c,style:{width:"100%",height:"70vh",border:"none"},title:"Delivery Note PDF"})})]})}export{je as default};
