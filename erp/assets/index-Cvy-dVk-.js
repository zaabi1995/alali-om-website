import{r,j as t}from"./index-D8GYIxkt.js";import{d as m}from"./dayjs.min-B3sMHnXn.js";import{aG as s,ay as u,ai as o,aA as A,aB as a,aD as T,ar as U,T as W}from"./IdurarOs-Bp7g4t32.js";import{F as J}from"./Table-C95qK4fz.js";import{M as Q}from"./index-CRZm9bkJ.js";import{S}from"./index-B6OjbFu5.js";import{T as f}from"./index-BclWlcPO.js";import{D as R}from"./index-DVduZBW9.js";import{S as M}from"./index-BSrz22rd.js";import{j as O}from"./ErpApp-eMQ7IvFe.js";import{s as p}from"./index-Di1ZAexU.js";import{T as q}from"./index-BapNQfCS.js";import{P as K}from"./index-DGUWN9FB.js";import{P as N}from"./PlusOutlined-BPzt_4wX.js";import{D as F}from"./DeleteOutlined-DTG8wLH9.js";import{T as X}from"./ThunderboltOutlined-PhQGNJjT.js";import"./pickAttrs-Cgu4o-jt.js";import"./DownOutlined-PDxVrbmf.js";import"./ActionButton-BKmasmgO.js";import"./useClosable-Cp59dJiR.js";import"./fade-lez0brI5.js";import"./ClockCircleOutlined-BlQSsYrm.js";const{Title:Z}=U;function g(){return{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`}}function ee(){return{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`,"Content-Type":"application/json"}}const E={weekly:"Weekly",monthly:"Monthly",quarterly:"Quarterly",biannual:"Every 6 months",annual:"Annual"};function ke(){const[P,z]=r.useState([]),[L,k]=r.useState(!1),[_,v]=r.useState(!1),[h,w]=r.useState(null),[V,B]=r.useState([]),[y]=s.useForm(),[b,c]=r.useState([{key:0,itemName:"",quantity:1,price:0}]),j=async()=>{k(!0);const e=await fetch(u+"recurringinvoice/list",{headers:g()}).then(n=>n.json()).catch(()=>({}));e.success&&z(e.result||[]),k(!1)};r.useEffect(()=>{j(),fetch(u+"client/listAll",{headers:g()}).then(e=>e.json()).then(e=>e.result&&B(e.result)).catch(()=>{})},[]);const C=(e=null)=>{var n,i;w(e),e?(y.setFieldsValue({...e,startDate:e.startDate?m(e.startDate):null,endDate:e.endDate?m(e.endDate):null,client:((n=e.client)==null?void 0:n._id)||e.client}),(i=e.items)!=null&&i.length&&c(e.items.map((d,l)=>({...d,key:l})))):(y.setFieldsValue({frequency:"monthly",dayOfMonth:1,taxRate:5,currency:"OMR",isActive:!0,autoSend:!1}),c([{key:0,itemName:"",quantity:1,price:0}])),v(!0)},I=()=>{v(!1),y.resetFields(),w(null),c([{key:0,itemName:"",quantity:1,price:0}])},$=async e=>{var d,l;const n=h?u+`recurringinvoice/update/${h._id}`:u+"recurringinvoice/create",i=await fetch(n,{method:h?"PATCH":"POST",headers:ee(),body:JSON.stringify({...e,items:b.map(x=>({...x,total:x.quantity*x.price})),startDate:(d=e.startDate)==null?void 0:d.toISOString(),endDate:(l=e.endDate)==null?void 0:l.toISOString()})}).then(x=>x.json()).catch(()=>({}));i.success?(p.success(h?"Updated":"Created"),I(),j()):p.error(i.message||"Failed")},Y=async e=>{const n=await fetch(u+`recurringinvoice/generate/${e}`,{method:"POST",headers:g()}).then(i=>i.json()).catch(()=>({}));n.success?p.success("Invoice generated!"):p.error(n.message||"Failed"),j()},G=async e=>{await fetch(u+`recurringinvoice/delete/${e}`,{method:"DELETE",headers:g()}),p.success("Deleted"),j()},D=(e,n,i)=>c(d=>d.map(l=>l.key===e?{...l,[n]:i}:l)),H=[{title:"Name",dataIndex:"name",ellipsis:!0,render:(e,n)=>t.jsx("a",{onClick:()=>C(n),style:{color:"#034D57",fontWeight:600},children:e})},{title:"Client",dataIndex:["client","name"],render:e=>e||"—"},{title:"Frequency",dataIndex:"frequency",render:e=>E[e]||e},{title:"Next Run",dataIndex:"nextRunAt",render:e=>e?t.jsx(q,{color:m(e)<m()?"red":"blue",children:m(e).format("DD MMM YYYY")}):"—"},{title:"Generated",dataIndex:"generatedCount",align:"center",render:e=>e||0},{title:"Status",dataIndex:"isActive",render:e=>t.jsx(q,{color:e?"green":"default",children:e?"Active":"Paused"})},{title:"",width:90,render:(e,n)=>t.jsxs(O,{children:[t.jsx(W,{title:"Generate now",children:t.jsx(o,{size:"small",icon:t.jsx(X,{}),onClick:()=>Y(n._id)})}),t.jsx(K,{title:"Delete?",onConfirm:()=>G(n._id),children:t.jsx(o,{size:"small",danger:!0,icon:t.jsx(F,{})})})]})}];return t.jsxs("div",{style:{padding:24},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsx(Z,{level:4,style:{margin:0,color:"#034D57"},children:"Recurring Invoices"}),t.jsx(o,{type:"primary",icon:t.jsx(N,{}),onClick:()=>C(),style:{background:"#034D57"},children:"New Recurring"})]}),t.jsx(J,{columns:H,dataSource:P,rowKey:"_id",loading:L,size:"small"}),t.jsx(Q,{title:h?"Edit Recurring Invoice":"New Recurring Invoice",open:_,onCancel:I,footer:null,width:700,children:t.jsxs(s,{form:y,layout:"vertical",onFinish:$,children:[t.jsxs(A,{gutter:12,children:[t.jsx(a,{xs:24,sm:16,children:t.jsx(s.Item,{name:"name",label:"Name / Label",rules:[{required:!0}],children:t.jsx(T,{placeholder:"e.g. Monthly Retainer — RAFO"})})}),t.jsx(a,{xs:24,sm:8,children:t.jsx(s.Item,{name:"currency",label:"Currency",initialValue:"OMR",children:t.jsx(S,{options:["OMR","USD"].map(e=>({value:e,label:e}))})})}),t.jsx(a,{xs:24,sm:12,children:t.jsx(s.Item,{name:"client",label:"Client",rules:[{required:!0}],children:t.jsx(S,{showSearch:!0,filterOption:(e,n)=>n.label.toLowerCase().includes(e.toLowerCase()),options:V.map(e=>({value:e._id,label:e.name}))})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"frequency",label:"Frequency",initialValue:"monthly",children:t.jsx(S,{options:Object.entries(E).map(([e,n])=>({value:e,label:n}))})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"dayOfMonth",label:"Day of Month",initialValue:1,children:t.jsx(f,{min:1,max:28,style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"startDate",label:"Start Date",rules:[{required:!0}],initialValue:m(),children:t.jsx(R,{style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:6,children:t.jsx(s.Item,{name:"endDate",label:"End Date",children:t.jsx(R,{style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:8,children:t.jsx(s.Item,{name:"taxRate",label:"Tax %",initialValue:5,children:t.jsx(f,{min:0,max:100,style:{width:"100%"}})})}),t.jsx(a,{xs:12,sm:8,children:t.jsx(s.Item,{name:"isActive",label:"Active",valuePropName:"checked",initialValue:!0,children:t.jsx(M,{})})}),t.jsx(a,{xs:12,sm:8,children:t.jsx(s.Item,{name:"autoSend",label:"Auto-send email",valuePropName:"checked",initialValue:!1,children:t.jsx(M,{})})})]}),t.jsx("div",{style:{margin:"12px 0 6px",fontWeight:600},children:"Line Items"}),b.map(e=>t.jsxs(A,{gutter:8,style:{marginBottom:4},children:[t.jsx(a,{flex:"auto",children:t.jsx(T,{size:"small",placeholder:"Item description",value:e.itemName,onChange:n=>D(e.key,"itemName",n.target.value)})}),t.jsx(a,{style:{width:70},children:t.jsx(f,{size:"small",min:0,precision:0,value:e.quantity,onChange:n=>D(e.key,"quantity",n||1),style:{width:"100%"}})}),t.jsx(a,{style:{width:110},children:t.jsx(f,{size:"small",min:0,precision:3,value:e.price,onChange:n=>D(e.key,"price",n||0),style:{width:"100%"},addonAfter:"OMR"})}),t.jsx(a,{children:t.jsx(o,{size:"small",danger:!0,icon:t.jsx(F,{}),onClick:()=>c(n=>n.filter(i=>i.key!==e.key))})})]},e.key)),t.jsx(o,{size:"small",type:"dashed",icon:t.jsx(N,{}),onClick:()=>c(e=>[...e,{key:Date.now(),itemName:"",quantity:1,price:0}]),style:{marginTop:6},children:"Add Line"}),t.jsx("div",{style:{textAlign:"right",marginTop:16},children:t.jsxs(O,{children:[t.jsx(o,{onClick:I,children:"Cancel"}),t.jsx(o,{type:"primary",htmlType:"submit",style:{background:"#034D57"},children:"Save"})]})})]})})]})}export{ke as default};
