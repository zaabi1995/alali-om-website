import{m as $,o as z,r as l,j as e}from"./index-DGBU46UJ.js";import{d as M}from"./dayjs.min-8Z1s2ZZV.js";import{ay as y,aC as B,ai as i,aw as E,aA as N,aB as D,ar as _}from"./IdurarOs-CJ9ViAhm.js";import{s as g}from"./index-C-NUezbm.js";import{T as Y}from"./index-BJe3uNvq.js";import{j as H}from"./ErpApp-CYUZ8TN2.js";import{C as u}from"./index-CjcNLPXh.js";import{D as C}from"./index-iOI7SQQY.js";import{F as d}from"./Table-D6trtlAr.js";import{M as V}from"./index-CpgbdYsj.js";import{A as W}from"./ArrowLeftOutlined-B33LkA-B.js";import{F as L}from"./FilePdfOutlined-DtId4j7R.js";import"./useClosable-CO9qeB94.js";import"./Skeleton-CtKtAXNJ.js";import"./index-CjgSDB-1.js";import"./PlusOutlined-WiqW7VqH.js";import"./pickAttrs-fHa9THfw.js";import"./index-DbQUCUwL.js";import"./DownOutlined-CLg65-LR.js";import"./ActionButton-CXYEvTjl.js";import"./fade-BqWjLN_a.js";const{Title:P,Text:b}=_,q={draft:"default",issued:"blue",applied:"green",voided:"red"};function S(){return{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`}}function c(m){return`${parseFloat(m||0).toFixed(3)} OMR`}function xe(){var k,I;const m=$(),{id:n}=z(),[t,w]=l.useState(null),[U,A]=l.useState(!0),[R,v]=l.useState(!1),[a,f]=l.useState(null),[F,p]=l.useState(!1);l.useEffect(()=>{fetch(y+`creditnote/read/${n}`,{headers:S()}).then(s=>s.json()).then(s=>{s.success&&w(s.result)}).catch(()=>g.error("Failed")).finally(()=>A(!1))},[n]);const x=async(s=!1)=>{v(!0);try{const r=await fetch(y+`creditnote/pdf/${n}`,{headers:S()});if(!r.ok)throw new Error("PDF failed");const o=await r.blob(),h=URL.createObjectURL(o);if(s){const j=document.createElement("a");j.href=h,j.download=`CN-${t==null?void 0:t.number}-${t==null?void 0:t.year}.pdf`,j.click(),URL.revokeObjectURL(h)}else f(h),p(!0)}catch(r){g.error(r.message)}finally{v(!1)}},T=async s=>{const o=await(await fetch(y+`creditnote/update/${n}`,{method:"PATCH",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify({status:s})})).json();o.success&&(w(o.result),g.success(`Status: ${s}`))};if(U)return e.jsx("div",{style:{textAlign:"center",padding:60},children:e.jsx(B,{size:"large"})});if(!t)return e.jsx("div",{style:{padding:24},children:"Not found."});const O=[{title:"#",width:40,render:(s,r,o)=>o+1},{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Qty",dataIndex:"quantity",width:70,align:"center"},{title:"Unit Price",dataIndex:"price",align:"right",render:c},{title:"Total",dataIndex:"total",align:"right",render:s=>e.jsxs("strong",{style:{color:"#e53e3e"},children:["(",c(s),")"]})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,flexWrap:"wrap",gap:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx(i,{icon:e.jsx(W,{}),onClick:()=>m("/credit-note")}),e.jsxs("div",{children:[e.jsxs(P,{level:4,style:{margin:0,color:"#e53e3e"},children:["Credit Note CN-",t.number,"/",t.year]}),e.jsx(Y,{color:q[t.status]||"default",style:{marginTop:4},children:(k=t.status)==null?void 0:k.toUpperCase()})]})]}),e.jsxs(H,{wrap:!0,children:[t.status==="draft"&&e.jsx(i,{onClick:()=>T("issued"),style:{borderColor:"#1890ff",color:"#1890ff"},children:"Issue"}),t.status==="issued"&&e.jsx(i,{onClick:()=>T("applied"),style:{borderColor:"#4CB480",color:"#4CB480"},children:"Mark Applied"}),e.jsx(i,{icon:e.jsx(L,{}),onClick:()=>x(!1),loading:R,children:"Preview PDF"}),e.jsx(i,{icon:e.jsx(L,{}),onClick:()=>x(!0),loading:R,danger:!0,children:"Download PDF"}),e.jsx(i,{icon:e.jsx(E,{}),onClick:()=>m(`/credit-note/edit/${n}`),children:"Edit"})]})]}),e.jsxs(N,{gutter:16,style:{marginBottom:16},children:[e.jsx(D,{xs:24,md:12,children:e.jsxs(u,{size:"small",title:"Issued To",children:[e.jsx(P,{level:5,style:{color:"#034D57",marginTop:0},children:((I=t.client)==null?void 0:I.name)||"—"}),t.reason&&e.jsxs(b,{type:"secondary",style:{fontSize:12},children:["Reason: ",t.reason]})]})}),e.jsx(D,{xs:24,md:12,children:e.jsx(u,{size:"small",title:"Details",children:e.jsxs(C,{size:"small",column:1,children:[e.jsx(C.Item,{label:"Date",children:M(t.date).format("DD MMM YYYY")}),t.invoice&&e.jsxs(C.Item,{label:"Invoice Ref",children:["INV-",t.invoice.number,"/",t.invoice.year]})]})})})]}),e.jsx(u,{size:"small",title:"Items",style:{marginBottom:16},children:e.jsx(d,{columns:O,dataSource:t.items||[],rowKey:(s,r)=>r,pagination:!1,size:"small",summary:()=>e.jsxs(d.Summary.Row,{style:{background:"#fff5f5"},children:[e.jsx(d.Summary.Cell,{index:0,colSpan:3,children:e.jsx("strong",{children:"Totals"})}),t.taxRate>0&&e.jsx(d.Summary.Cell,{index:3,align:"right",children:e.jsxs(b,{type:"secondary",children:["Sub: (",c(t.subTotal),") + VAT: (",c(t.taxTotal),")"]})}),e.jsx(d.Summary.Cell,{index:4,align:"right",colSpan:t.taxRate>0?0:2,children:e.jsxs("strong",{style:{color:"#e53e3e",fontSize:15},children:["CREDIT: (",c(t.total),")"]})})]})})}),t.notes&&e.jsx(u,{size:"small",style:{borderLeft:"3px solid #f59e0b"},children:e.jsx(b,{children:t.notes})}),e.jsx(V,{title:`PDF — CN-${t.number}/${t.year}`,open:F,width:"80%",style:{top:20},onCancel:()=>{p(!1),a&&URL.revokeObjectURL(a),f(null)},footer:[e.jsx(i,{danger:!0,onClick:()=>x(!0),children:"Download"},"dl"),e.jsx(i,{onClick:()=>{p(!1),a&&URL.revokeObjectURL(a),f(null)},children:"Close"},"cl")],children:a&&e.jsx("iframe",{src:a,style:{width:"100%",height:"70vh",border:"none"}})})]})}export{xe as default};
