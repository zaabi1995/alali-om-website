import{r as l,m as Ce,o as ke,j as e}from"./index-CB_AWKJY.js";import{d as y}from"./dayjs.min-rDaZbkwJ.js";import{O as we,g as Ie,b8 as o,aN as De,aM as Te,aL as te,aB as d,b5 as se,aS as Fe,aX as Y,aY as Me,aV as f}from"./IdurarOs-20-QWMXR.js";import{C as p}from"./index-ByWerc77.js";import{D as c}from"./index-cRZZR8u6.js";import{F as x}from"./Table-r_Zm9lDt.js";import{T as F}from"./Timeline-BhyQROLV.js";import{a7 as Ne,I as Oe,T as re,l as Pe,F as ie}from"./ErpApp-Cy5crc22.js";import{T as Ae}from"./index-2JQk6u8I.js";import{M}from"./index--olNpC1x.js";import{D as Re}from"./index-C66cNKtH.js";import{s as m}from"./index-CvT_fNtU.js";import{P as ze}from"./progress-DbVeEjhk.js";import{T as Le}from"./index-DHk3-eFe.js";import{A as Ye}from"./ArrowLeftOutlined-DzXe9_hW.js";import{C as ae}from"./CheckCircleOutlined-D2_dEbwQ.js";import"./Skeleton-C4FpL5iW.js";import"./PlusOutlined-YO2bg1HW.js";import"./ActionButton-CQP3RUHL.js";import"./fade-CEgBSdG5.js";var $e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M931.4 498.9L94.9 79.5c-3.4-1.7-7.3-2.1-11-1.2a15.99 15.99 0 00-11.7 19.3l86.2 352.2c1.3 5.3 5.2 9.6 10.4 11.3l147.7 50.7-147.6 50.7c-5.2 1.8-9.1 6-10.3 11.3L72.2 926.5c-.9 3.7-.5 7.6 1.2 10.9 3.9 7.9 13.5 11.1 21.5 7.2l836.5-417c3.1-1.5 5.6-4.1 7.2-7.1 3.9-8 .7-17.6-7.2-21.6zM170.8 826.3l50.3-205.6 295.2-101.3c2.3-.8 4.2-2.6 5-5 1.4-4.2-.8-8.7-5-10.2L221.1 403 171 198.2l628 314.9-628.2 313.2z"}}]},name:"send",theme:"outlined"},Be=function(h,t){return l.createElement(we,Ie({},h,{ref:t,icon:$e}))};const Ue=l.forwardRef(Be),{Title:ne,Text:u}=Me,{TextArea:z}=Y,L={draft:"default",sent:"blue",acknowledged:"cyan",shipped:"orange",partial:"gold",received:"green",closed:"default",cancelled:"red"};function j(){const g=((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token;return g?{Authorization:`Bearer ${g}`}:{}}function ot(){var H,q,V,J,K,W,Q,X,Z,G,ee;const g=Ce(),{id:h}=ke(),[t,le]=l.useState(null),[n,oe]=l.useState(null),[de,$]=l.useState(!0),[B,U]=l.useState(!1),[ce,_]=l.useState(!1),[v,N]=l.useState(null),[me,O]=l.useState(!1),[he,P]=l.useState(!1),[ue,A]=l.useState(!1),[pe,b]=l.useState(!1),[E,C]=l.useState(""),[k]=o.useForm(),[w]=o.useForm(),[I]=o.useForm(),D=async()=>{$(!0);try{const r=await(await fetch(f+`purchaseorder/read/${h}`,{headers:j()})).json();r.success&&le(r.result)}catch{m.error("Failed to load")}finally{$(!1)}},T=async()=>{try{const r=await(await fetch(f+`purchaseorder/${h}/tracking`,{headers:j()})).json();r.success&&oe(r.result)}catch(s){console.error("Tracking load failed:",s)}};l.useEffect(()=>{D(),T()},[h]);const xe=async(s,r="")=>{try{const a=await(await fetch(f+`purchaseorder/${h}/update-status`,{method:"PATCH",headers:{...j(),"Content-Type":"application/json"},body:JSON.stringify({status:s,notes:r})})).json();a.success?(m.success(`Status updated to ${s}`),b(!1),I.resetFields(),D(),T()):m.error(a.message||"Update failed")}catch{m.error("Network error")}},ye=async s=>{var r;try{(await(await fetch(f+`purchaseorder/${h}/add-shipment`,{method:"PATCH",headers:{...j(),"Content-Type":"application/json"},body:JSON.stringify({trackingNumber:s.trackingNumber,carrier:s.carrier,estimatedArrival:(r=s.estimatedArrival)==null?void 0:r.toISOString(),shippingNotes:s.shippingNotes})})).json()).success&&(m.success("Shipment details updated"),P(!1),k.resetFields(),D(),T())}catch{m.error("Failed to update shipment")}},fe=async s=>{const r=t.items.map((i,a)=>({itemIndex:a,quantityReceived:s[`qty_${a}`]||0})).filter(i=>i.quantityReceived>0);if(r.length===0){m.warning("Enter at least one quantity received");return}try{const a=await(await fetch(f+`purchaseorder/${h}/record-delivery`,{method:"POST",headers:{...j(),"Content-Type":"application/json"},body:JSON.stringify({items:r,notes:s.notes})})).json();a.success&&(m.success(a.message||"Delivery recorded"),A(!1),w.resetFields(),D(),T())}catch{m.error("Failed to record delivery")}},R=async(s=!1)=>{U(!0);try{const r=await fetch(f+`purchaseorder/pdf/${h}`,{headers:j()});if(!r.ok)throw new Error("PDF failed");const i=await r.blob(),a=URL.createObjectURL(i);if(s){const S=document.createElement("a");S.href=a,S.download=`PO-${t==null?void 0:t.number}-${t==null?void 0:t.year}.pdf`,S.click(),URL.revokeObjectURL(a)}else N(a),O(!0)}catch(r){m.error(r.message)}finally{U(!1)}},je=async()=>{_(!0);try{const r=await(await fetch(f+"purchaseorder/mail",{method:"POST",headers:{...j(),"Content-Type":"application/json"},body:JSON.stringify({id:h})})).json();r.success?m.success(r.message):m.error(r.message||"Email failed")}catch{m.error("Network error")}finally{_(!1)}};if(de)return e.jsx("div",{style:{textAlign:"center",padding:60},children:e.jsx(De,{size:"large"})});if(!t)return e.jsx("div",{style:{padding:24},children:"Not found."});const ge=[{title:"#",width:40,render:(s,r,i)=>i+1},{title:"Part Number",dataIndex:"partNumber",render:s=>e.jsx("strong",{children:s||"—"})},{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Qty",dataIndex:"quantity",align:"center"},{title:"Unit",dataIndex:"unit",width:60},{title:"Unit Price",dataIndex:"unitPrice",align:"right",render:(s,r)=>`${parseFloat(s||0).toFixed(4)} ${r.currency||t.currency}`},{title:"Total",dataIndex:"total",align:"right",render:(s,r)=>e.jsxs("strong",{children:[parseFloat(s||0).toFixed(3)," ",r.currency||t.currency]})},{title:"HS Code",dataIndex:"hsCode",render:s=>s||"—"}],ve=[{title:"#",width:40,render:(s,r,i)=>i+1},{title:"Part Number",dataIndex:"partNumber",ellipsis:!0},{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Ordered",dataIndex:"ordered",align:"center",render:s=>e.jsx("strong",{children:s})},{title:"Received",dataIndex:"received",align:"center",render:(s,r)=>e.jsx(u,{type:s>=r.ordered?"success":s>0?"warning":"secondary",children:e.jsx("strong",{children:s})})},{title:"Pending",dataIndex:"pending",align:"center",render:s=>e.jsx(u,{type:"secondary",children:s})},{title:"Progress",width:120,render:(s,r)=>{const i=r.ordered>0?Math.round(r.received/r.ordered*100):0;return e.jsx(ze,{percent:i,size:"small",status:i===100?"success":"active"})}}],be=[{title:"#",width:40,render:(s,r,i)=>i+1},{title:"Part Number",dataIndex:"partNumber",ellipsis:!0},{title:"Ordered",dataIndex:"quantity",align:"center"},{title:"Quantity Received",width:150,render:(s,r,i)=>e.jsx(o.Item,{name:`qty_${i}`,style:{margin:0},initialValue:0,children:e.jsx(Le,{min:0,max:r.quantity,style:{width:"100%"}})})}],Se=[{key:"details",label:"Details",children:e.jsxs(e.Fragment,{children:[e.jsxs(Te,{gutter:16,style:{marginBottom:16},children:[e.jsx(te,{xs:24,md:12,children:e.jsxs(p,{size:"small",title:"Vendor",style:{height:"100%"},children:[e.jsx(ne,{level:5,style:{color:"#034D57",marginTop:0},children:((H=t.vendor)==null?void 0:H.companyName)||"—"}),((q=t.vendor)==null?void 0:q.contactEmail)&&e.jsx(u,{type:"secondary",style:{fontSize:12},children:t.vendor.contactEmail}),((V=t.vendor)==null?void 0:V.country)&&e.jsx("div",{children:e.jsx(u,{type:"secondary",style:{fontSize:12},children:t.vendor.country})})]})}),e.jsx(te,{xs:24,md:12,children:e.jsx(p,{size:"small",title:"Order Details",style:{height:"100%"},children:e.jsxs(c,{size:"small",column:2,children:[e.jsx(c.Item,{label:"Date",children:y(t.date).format("DD MMM YYYY")}),t.deliveryDate&&e.jsx(c.Item,{label:"Required By",children:y(t.deliveryDate).format("DD MMM YYYY")}),e.jsx(c.Item,{label:"Currency",children:e.jsx("strong",{children:t.currency})}),t.vendorRef&&e.jsx(c.Item,{label:"Vendor Ref",children:t.vendorRef}),t.incoterms&&e.jsx(c.Item,{label:"Incoterms",children:t.incoterms}),t.paymentTerms&&e.jsx(c.Item,{label:"Payment",children:t.paymentTerms})]})})})]}),e.jsxs(p,{size:"small",title:`Line Items (${((J=t.items)==null?void 0:J.length)||0})`,style:{marginBottom:16},children:[e.jsx("div",{style:{overflowX:"auto"},children:e.jsx(x,{columns:ge,dataSource:t.items||[],rowKey:(s,r)=>r,pagination:!1,size:"small",summary:()=>e.jsxs(x.Summary.Row,{style:{background:"#f0f6f7"},children:[e.jsx(x.Summary.Cell,{index:0,colSpan:5,children:e.jsx("strong",{children:"Totals"})}),e.jsx(x.Summary.Cell,{index:5,align:"right",children:e.jsx(u,{type:"secondary",children:"Subtotal"})}),e.jsx(x.Summary.Cell,{index:6,align:"right",children:e.jsxs("strong",{children:[parseFloat(t.subTotal||0).toFixed(3)," ",t.currency]})}),e.jsx(x.Summary.Cell,{index:7})]})})}),e.jsxs("div",{style:{textAlign:"right",marginTop:8,padding:"8px 10px",background:"#034D57",borderRadius:4},children:[t.shippingCost>0&&e.jsxs("div",{style:{color:"#fff",fontSize:11},children:["Shipping: ",parseFloat(t.shippingCost).toFixed(3)," ",t.currency]}),e.jsxs("div",{style:{color:"#4CB480",fontWeight:800,fontSize:16},children:["TOTAL: ",parseFloat(t.total||0).toFixed(3)," ",t.currency]})]})]}),t.notes&&e.jsx(p,{size:"small",title:"Notes",style:{marginBottom:16,borderLeft:"3px solid #f59e0b"},children:e.jsx(u,{children:t.notes})})]})},{key:"tracking",label:e.jsxs("span",{children:[e.jsx(Ne,{})," Tracking & Fulfillment"]}),children:e.jsxs(e.Fragment,{children:[e.jsx(p,{size:"small",title:"Shipment Information",extra:e.jsx(d,{size:"small",onClick:()=>P(!0),icon:e.jsx(se,{}),children:"Update Shipment"}),style:{marginBottom:16},children:(K=t.shipment)!=null&&K.trackingNumber||(W=t.shipment)!=null&&W.carrier?e.jsxs(c,{size:"small",column:2,children:[t.shipment.trackingNumber&&e.jsx(c.Item,{label:"Tracking #",children:e.jsx("strong",{children:t.shipment.trackingNumber})}),t.shipment.carrier&&e.jsx(c.Item,{label:"Carrier",children:t.shipment.carrier}),t.shipment.estimatedArrival&&e.jsx(c.Item,{label:"ETA",children:y(t.shipment.estimatedArrival).format("DD MMM YYYY")}),t.shipment.actualArrival&&e.jsx(c.Item,{label:"Arrived",children:y(t.shipment.actualArrival).format("DD MMM YYYY")}),t.shipment.shippingNotes&&e.jsx(c.Item,{label:"Notes",span:2,children:t.shipment.shippingNotes})]}):e.jsx(u,{type:"secondary",children:"No shipment details yet"})}),e.jsx(p,{size:"small",title:"Item Delivery Status",extra:t.status!=="received"&&t.status!=="closed"&&e.jsx(d,{size:"small",type:"primary",onClick:()=>A(!0),icon:e.jsx(Oe,{}),children:"Record Delivery"}),style:{marginBottom:16},children:n!=null&&n.items?e.jsx(x,{columns:ve,dataSource:n.items,rowKey:(s,r)=>r,pagination:!1,size:"small"}):e.jsx(u,{type:"secondary",children:"Loading..."})}),(n==null?void 0:n.deliveries)&&n.deliveries.length>0&&e.jsx(p,{size:"small",title:"Delivery History",style:{marginBottom:16},children:e.jsx(F,{children:n.deliveries.map((s,r)=>{var i,a;return e.jsx(F.Item,{color:"green",children:e.jsxs("div",{children:[e.jsx("strong",{children:y(s.date).format("DD MMM YYYY HH:mm")}),e.jsxs("div",{style:{fontSize:12,color:"#666"},children:["Received by: ",(i=s.receivedBy)==null?void 0:i.name," ",(a=s.receivedBy)==null?void 0:a.surname]}),e.jsxs("div",{style:{fontSize:12},children:["Items: ",s.items.map(S=>`#${S.itemIndex+1} (${S.quantityReceived})`).join(", ")]}),s.notes&&e.jsx("div",{style:{fontSize:12,fontStyle:"italic"},children:s.notes})]})},r)})})}),(n==null?void 0:n.statusHistory)&&n.statusHistory.length>0&&e.jsx(p,{size:"small",title:"Status History",children:e.jsx(F,{children:n.statusHistory.map((s,r)=>{var i;return e.jsx(F.Item,{color:L[s.status]||"blue",children:e.jsxs("div",{children:[e.jsx(re,{color:L[s.status],children:s.status.toUpperCase()}),e.jsxs("div",{style:{fontSize:12,color:"#666"},children:[y(s.timestamp).format("DD MMM YYYY HH:mm")," by"," ",((i=s.changedBy)==null?void 0:i.name)||"System"]}),s.notes&&e.jsx("div",{style:{fontSize:12,fontStyle:"italic"},children:s.notes})]})},r)})})})]})}];return e.jsxs("div",{style:{padding:"24px",maxWidth:1200},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,flexWrap:"wrap",gap:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx(d,{icon:e.jsx(Ye,{}),onClick:()=>g("/purchase-order")}),e.jsxs("div",{children:[e.jsxs(ne,{level:4,style:{margin:0,color:"#034D57"},children:["Purchase Order PO-",t.number,"/",t.year]}),e.jsx(re,{color:L[t.status]||"default",style:{marginTop:4},children:(Q=t.status)==null?void 0:Q.toUpperCase()})]})]}),e.jsxs(Pe,{wrap:!0,children:[t.status==="draft"&&e.jsx(d,{icon:e.jsx(Ue,{}),onClick:()=>{C("sent"),b(!0)},style:{borderColor:"#1890ff",color:"#1890ff"},children:"Mark Sent"}),t.status==="sent"&&e.jsx(d,{icon:e.jsx(ae,{}),onClick:()=>{C("acknowledged"),b(!0)},style:{borderColor:"#4CB480",color:"#4CB480"},children:"Mark Acknowledged"}),t.status==="acknowledged"&&e.jsx(d,{onClick:()=>{C("shipped"),b(!0)},style:{borderColor:"#fa8c16",color:"#fa8c16"},children:"Mark Shipped"}),(t.status==="shipped"||t.status==="partial")&&e.jsx(d,{icon:e.jsx(ae,{}),onClick:()=>{C("received"),b(!0)},style:{borderColor:"#4CB480",color:"#4CB480"},children:"Mark Received"}),e.jsx(d,{icon:e.jsx(Fe,{}),onClick:je,loading:ce,children:"Email Vendor"}),e.jsx(d,{icon:e.jsx(ie,{}),onClick:()=>R(!1),loading:B,children:"Preview PDF"}),e.jsx(d,{icon:e.jsx(ie,{}),onClick:()=>R(!0),loading:B,style:{background:"#034D57",borderColor:"#034D57",color:"#fff"},children:"Download PDF"}),e.jsx(d,{icon:e.jsx(se,{}),onClick:()=>g(`/purchase-order/edit/${h}`),children:"Edit"})]})]}),e.jsx(Ae,{items:Se,defaultActiveKey:"details"}),e.jsx(M,{title:`PDF Preview — PO-${t.number}/${t.year}`,open:me,width:"80%",style:{top:20},onCancel:()=>{O(!1),v&&URL.revokeObjectURL(v),N(null)},footer:[e.jsx(d,{type:"primary",onClick:()=>R(!0),style:{background:"#034D57"},children:"Download"},"dl"),e.jsx(d,{onClick:()=>{O(!1),v&&URL.revokeObjectURL(v),N(null)},children:"Close"},"cl")],children:v&&e.jsx("iframe",{src:v,style:{width:"100%",height:"70vh",border:"none"},title:"PO PDF"})}),e.jsx(M,{title:"Update Shipment Details",open:he,onCancel:()=>{P(!1),k.resetFields()},onOk:()=>k.submit(),okText:"Save",children:e.jsxs(o,{form:k,layout:"vertical",onFinish:ye,initialValues:{trackingNumber:((X=t.shipment)==null?void 0:X.trackingNumber)||"",carrier:((Z=t.shipment)==null?void 0:Z.carrier)||"",estimatedArrival:(G=t.shipment)!=null&&G.estimatedArrival?y(t.shipment.estimatedArrival):null,shippingNotes:((ee=t.shipment)==null?void 0:ee.shippingNotes)||""},children:[e.jsx(o.Item,{label:"Tracking Number",name:"trackingNumber",children:e.jsx(Y,{placeholder:"e.g. 1Z999AA10123456784"})}),e.jsx(o.Item,{label:"Carrier",name:"carrier",children:e.jsx(Y,{placeholder:"e.g. DHL, FedEx, UPS"})}),e.jsx(o.Item,{label:"Estimated Arrival",name:"estimatedArrival",children:e.jsx(Re,{style:{width:"100%"}})}),e.jsx(o.Item,{label:"Notes",name:"shippingNotes",children:e.jsx(z,{rows:3,placeholder:"Any additional shipping notes..."})})]})}),e.jsx(M,{title:"Record Delivery",open:ue,onCancel:()=>{A(!1),w.resetFields()},onOk:()=>w.submit(),okText:"Record",width:700,children:e.jsxs(o,{form:w,layout:"vertical",onFinish:fe,children:[e.jsx(u,{type:"secondary",style:{marginBottom:12,display:"block"},children:"Enter the quantity received for each item. Leave as 0 for items not received in this delivery."}),e.jsx(x,{columns:be,dataSource:t.items||[],rowKey:(s,r)=>r,pagination:!1,size:"small"}),e.jsx(o.Item,{label:"Delivery Notes",name:"notes",style:{marginTop:16},children:e.jsx(z,{rows:2,placeholder:"Any notes about this delivery..."})})]})}),e.jsx(M,{title:`Update Status to ${E}`,open:pe,onCancel:()=>{b(!1),I.resetFields()},onOk:()=>I.submit(),okText:"Update",children:e.jsx(o,{form:I,layout:"vertical",onFinish:s=>xe(E,s.notes),children:e.jsx(o.Item,{label:"Notes (optional)",name:"notes",children:e.jsx(z,{rows:3,placeholder:"Any notes about this status change..."})})})})]})}export{ot as default};
