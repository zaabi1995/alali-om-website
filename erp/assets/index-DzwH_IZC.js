import{r as p,m as R,j as e}from"./index-COaFcvEx.js";import{d as J}from"./dayjs.min-BzW2oJxm.js";import{b7 as o,aZ as b,aM as M,aL as u,a_ as f,b9 as $,aB as m,aY as V}from"./IdurarOs-xaNdaDtf.js";import{D as q}from"./index-CXp9CO6H.js";import{e as D,r as H}from"./ErpApp-ylpRU2yB.js";import{T as z}from"./index-DgnfKOwn.js";import{s as h}from"./index-BxbWwr5Z.js";import{P as U}from"./PlusOutlined-Ct0BwzAe.js";import{D as W}from"./DeleteOutlined-Dc4sl4Zn.js";import{C as Y}from"./CheckCircleOutlined-DNYmOIGH.js";import"./ClockCircleOutlined-CqcQV-E2.js";const{Title:Z,Text:G}=V;function S(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function K(){return{...S(),"Content-Type":"application/json"}}const C={account:null,accountName:"",description:"",debit:0,credit:0};function ce(){const[v]=o.useForm(),[c,g]=p.useState([{...C},{...C}]),[w,k]=p.useState([]),[B,L]=p.useState(!1),[I,T]=p.useState(!1),j=R();p.useEffect(()=>{fetch(b+"account/listAll",{headers:S()}).then(t=>t.json()).then(t=>{t.success&&k(t.result||[])})},[]);const d=c.reduce((t,n)=>t+(parseFloat(n.debit)||0),0),x=c.reduce((t,n)=>t+(parseFloat(n.credit)||0),0),y=Math.abs(d-x)<.001,a=(t,n,s)=>{g(r=>r.map((i,l)=>l===t?{...i,[n]:s}:i))},O=()=>g(t=>[...t,{...C}]),E=t=>{c.length>2&&g(n=>n.filter((s,r)=>r!==t))},N=(t,n)=>{const s=w.find(r=>r._id===n);a(t,"account",n),a(t,"accountName",(s==null?void 0:s.name)||""),a(t,"accountCode",(s==null?void 0:s.code)||"")},P=async t=>{var s;const n=await v.validateFields();return{...n,date:(s=n.date)==null?void 0:s.toISOString(),lines:c.filter(r=>r.account),status:t}},A=async(t=!1)=>{const n=t?T:L;n(!0);try{const s=await P("draft"),r=await fetch(b+"journalentry/create",{method:"POST",headers:K(),body:JSON.stringify(s)}).then(l=>l.json());if(!r.success){h.error(r.message||"Create failed");return}const i=r.result._id;if(t){const l=await fetch(`${b}journalentry/post/${i}`,{method:"PATCH",headers:S()}).then(_=>_.json());if(!l.success){h.error(l.message),j("/journal-entry");return}h.success(l.message)}else h.success(r.message);j("/journal-entry")}catch(s){h.error(s.message||"Error")}finally{n(!1)}},F=w.map(t=>({value:t._id,label:`${t.code||""} — ${t.name}`}));return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsx(Z,{level:4,style:{margin:"0 0 20px",color:"#034D57"},children:"New Journal Entry"}),e.jsx(o,{form:v,layout:"vertical",children:e.jsxs(M,{gutter:16,children:[e.jsx(u,{span:6,children:e.jsx(o.Item,{name:"date",label:"Date",initialValue:J(),rules:[{required:!0}],children:e.jsx(q,{style:{width:"100%"}})})}),e.jsx(u,{span:6,children:e.jsx(o.Item,{name:"type",label:"Type",initialValue:"general",children:e.jsx(D,{options:["general","sales","purchase","payment","adjustment","opening"].map(t=>({value:t,label:t.charAt(0).toUpperCase()+t.slice(1)}))})})}),e.jsx(u,{span:6,children:e.jsx(o.Item,{name:"reference",label:"Reference",children:e.jsx(f,{placeholder:"e.g. INV-5/2026"})})}),e.jsx(u,{span:6,children:e.jsx(o.Item,{name:"currency",label:"Currency",initialValue:"OMR",children:e.jsx(f,{})})}),e.jsx(u,{span:24,children:e.jsx(o.Item,{name:"description",label:"Description",rules:[{required:!0}],children:e.jsx(f,{placeholder:"Brief description of this entry"})})})]})}),e.jsx($,{style:{margin:"12px 0"}}),e.jsxs("div",{style:{marginBottom:8,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(G,{strong:!0,children:"Journal Lines"}),e.jsx(m,{size:"small",icon:e.jsx(U,{}),onClick:O,children:"Add Line"})]}),e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",marginBottom:12},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{background:"#034D57",color:"#fff"},children:[e.jsx("th",{style:{padding:"7px 10px",textAlign:"left",fontSize:11,width:"35%"},children:"Account"}),e.jsx("th",{style:{padding:"7px 10px",textAlign:"left",fontSize:11},children:"Description"}),e.jsx("th",{style:{padding:"7px 10px",textAlign:"right",fontSize:11,width:"15%"},children:"Debit"}),e.jsx("th",{style:{padding:"7px 10px",textAlign:"right",fontSize:11,width:"15%"},children:"Credit"}),e.jsx("th",{style:{width:30}})]})}),e.jsxs("tbody",{children:[c.map((t,n)=>e.jsxs("tr",{style:{background:n%2===0?"#fff":"#f9fbfc",borderBottom:"1px solid #edf2f3"},children:[e.jsx("td",{style:{padding:"4px 6px"},children:e.jsx(D,{showSearch:!0,style:{width:"100%"},placeholder:"Select account",value:t.account||void 0,onChange:s=>N(n,s),options:F,filterOption:(s,r)=>{var i;return(i=r.label)==null?void 0:i.toLowerCase().includes(s.toLowerCase())},size:"small"})}),e.jsx("td",{style:{padding:"4px 6px"},children:e.jsx(f,{size:"small",value:t.description,onChange:s=>a(n,"description",s.target.value),placeholder:"Line note"})}),e.jsx("td",{style:{padding:"4px 6px"},children:e.jsx(z,{size:"small",style:{width:"100%"},min:0,precision:3,value:t.debit||0,onChange:s=>{a(n,"debit",s||0),s>0&&a(n,"credit",0)}})}),e.jsx("td",{style:{padding:"4px 6px"},children:e.jsx(z,{size:"small",style:{width:"100%"},min:0,precision:3,value:t.credit||0,onChange:s=>{a(n,"credit",s||0),s>0&&a(n,"debit",0)}})}),e.jsx("td",{style:{padding:"4px 6px"},children:c.length>2&&e.jsx(W,{onClick:()=>E(n),style:{color:"#e53e3e",cursor:"pointer"}})})]},n)),e.jsxs("tr",{style:{background:"#034D57",color:"#fff",fontWeight:700},children:[e.jsx("td",{colSpan:2,style:{padding:"8px 10px",fontSize:12},children:"TOTALS"}),e.jsx("td",{style:{padding:"8px 10px",textAlign:"right",fontSize:13,color:"#4CB480"},children:d.toFixed(3)}),e.jsx("td",{style:{padding:"8px 10px",textAlign:"right",fontSize:13,color:"#4CB480"},children:x.toFixed(3)}),e.jsx("td",{})]})]})]}),!y&&d+x>0&&e.jsxs("div",{style:{background:"#fff5f5",border:"1px solid #fca5a5",padding:"8px 14px",borderRadius:6,marginBottom:12,color:"#e53e3e",fontSize:12},children:["⚠️ Unbalanced by ",Math.abs(d-x).toFixed(3)," — debit and credit must be equal to post"]}),y&&d>0&&e.jsx("div",{style:{background:"#f0fff4",border:"1px solid #86efac",padding:"8px 14px",borderRadius:6,marginBottom:12,color:"#4CB480",fontSize:12},children:"✓ Entry is balanced"}),e.jsxs(H,{children:[e.jsx(m,{onClick:()=>A(!1),loading:B,children:"Save as Draft"}),e.jsx(m,{type:"primary",icon:e.jsx(Y,{}),onClick:()=>A(!0),loading:I,disabled:!y||d===0,style:{background:"#034D57",borderColor:"#034D57"},children:"Save & Post"}),e.jsx(m,{onClick:()=>j("/journal-entry"),children:"Cancel"})]})]})}export{ce as default};
