import{m as V,o as q,r as m,j as e}from"./index-P0d3qDOI.js";import{o as B}from"./omrFormat-DsLViM07.js";import{f as g,l as $,O as M,k as U}from"./ErpApp-DhsEC5_U.js";import{d as b}from"./dayjs.min-JkzBIzl3.js";import{b8 as n,aV as u,aB as h,aM as J,aL as d,aX as I,aY as H}from"./IdurarOs-C9Hfvmhw.js";import{D as W}from"./index-Brfpr6wL.js";import{T as v}from"./index-CDFo9eRn.js";import{C as G}from"./index-D7ycNofp.js";import{F as K}from"./Table-cLwJzRkI.js";import{s as C}from"./index-GLktio_A.js";import{P as Q}from"./index-DkjrDGJh.js";import{A as X}from"./ArrowLeftOutlined-WCgDpsBv.js";import{P as Y}from"./PlusOutlined-7jHXhlhV.js";import{S as Z}from"./SaveOutlined-CMCIYSss.js";import"./Skeleton-HlVWT2JN.js";import"./index-uRPskGn0.js";import"./ActionButton-I_KEJ-cH.js";const{Title:ee}=H,{TextArea:te}=I;function se(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`,"Content-Type":"application/json"}}const k={key:Date.now(),description:"",quantity:1,price:0};function ve(){const p=V(),{id:o}=q(),[j]=n.useForm(),[f,x]=m.useState([{...k}]),[T,O]=m.useState([]),[A,F]=m.useState([]),[N,w]=m.useState(!1);m.useEffect(()=>{const s={Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`};fetch(u+"client/listAll",{headers:s}).then(t=>t.json()).then(t=>{t.result&&O(t.result)}),fetch(u+"invoice/listAll",{headers:s}).then(t=>t.json()).then(t=>{t.result&&F(t.result)}),o&&fetch(u+`creditnote/read/${o}`,{headers:s}).then(t=>t.json()).then(t=>{var a,l,i;if(t.success&&t.result){const r=t.result;j.setFieldsValue({client:((a=r.client)==null?void 0:a._id)||r.client,date:r.date?b(r.date):null,invoice:((l=r.invoice)==null?void 0:l._id)||r.invoice,reason:r.reason,taxRate:r.taxRate,status:r.status,notes:r.notes}),(i=r.items)!=null&&i.length&&x(r.items.map((c,E)=>({...c,key:E})))}})},[o]);const R=()=>x(s=>[...s,{...k,key:Date.now()}]),z=s=>x(t=>t.filter(a=>a.key!==s)),y=(s,t,a)=>x(l=>l.map(i=>i.key===s?{...i,[t]:a}:i)),S=f.reduce((s,t)=>s+parseFloat(t.price||0)*parseFloat(t.quantity||1),0),P=j.getFieldValue("taxRate")||0,_=S+S*(P/100),D=async s=>{var i;w(!0);const t={...s,date:(i=s.date)==null?void 0:i.toISOString(),items:f},a=o?u+`creditnote/update/${o}`:u+"creditnote/create",l=o?"PATCH":"POST";try{const c=await(await fetch(a,{method:l,headers:se(),body:JSON.stringify(t)})).json();c.success?(C.success(c.message||"Saved"),p(`/credit-note/read/${c.result._id}`)):C.error(c.message||"Failed")}catch{C.error("Network error")}finally{w(!1)}},L=[{title:"Description",dataIndex:"description",render:(s,t)=>e.jsx(I,{size:"small",value:s,onChange:a=>y(t.key,"description",a.target.value)})},{title:"Qty",dataIndex:"quantity",width:80,render:(s,t)=>e.jsx(v,{size:"small",min:1,value:s,style:{width:"100%"},onChange:a=>y(t.key,"quantity",a)})},{title:"Unit Price (OMR)",dataIndex:"price",width:130,render:(s,t)=>e.jsx(v,{size:"small",min:0,value:s,precision:3,style:{width:"100%"},onChange:a=>y(t.key,"price",a)})},{title:"Total",width:100,align:"right",render:(s,t)=>e.jsxs("strong",{style:{color:"#e53e3e"},children:["(",(parseFloat(t.price||0)*parseFloat(t.quantity||1)).toFixed(3)," ",e.jsx(M,{size:10,color:"#e53e3e"}),")"]})},{title:"",width:40,render:(s,t)=>e.jsx(Q,{title:"Remove?",onConfirm:()=>z(t.key),children:e.jsx(h,{size:"small",danger:!0,type:"text",icon:e.jsx(U,{})})})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:20},children:[e.jsx(h,{icon:e.jsx(X,{}),onClick:()=>p("/credit-note")}),e.jsx(ee,{level:4,style:{margin:0,color:"#e53e3e"},children:o?"Edit Credit Note":"New Credit Note"})]}),e.jsxs(n,{form:j,layout:"vertical",onFinish:D,children:[e.jsxs(J,{gutter:16,children:[e.jsx(d,{xs:24,md:12,children:e.jsx(n.Item,{name:"client",label:"Client",rules:[{required:!0}],children:e.jsx(g,{showSearch:!0,placeholder:"Select client",filterOption:(s,t)=>t.label.toLowerCase().includes(s.toLowerCase()),options:T.map(s=>({value:s._id,label:s.name}))})})}),e.jsx(d,{xs:24,md:12,children:e.jsx(n.Item,{name:"invoice",label:"Original Invoice",children:e.jsx(g,{showSearch:!0,allowClear:!0,placeholder:"Link to invoice",filterOption:(s,t)=>t.label.toLowerCase().includes(s.toLowerCase()),options:A.map(s=>({value:s._id,label:`INV-${s.number}/${s.year}`}))})})}),e.jsx(d,{xs:12,md:6,children:e.jsx(n.Item,{name:"date",label:"Date",rules:[{required:!0}],initialValue:b(),children:e.jsx(W,{style:{width:"100%"}})})}),e.jsx(d,{xs:12,md:6,children:e.jsx(n.Item,{name:"taxRate",label:"VAT Rate (%)",initialValue:0,children:e.jsx(v,{min:0,max:100,style:{width:"100%"}})})}),e.jsx(d,{xs:12,md:6,children:e.jsx(n.Item,{name:"status",label:"Status",initialValue:"draft",children:e.jsx(g,{options:["draft","issued","applied","voided"].map(s=>({value:s,label:s.charAt(0).toUpperCase()+s.slice(1)}))})})}),e.jsx(d,{xs:24,children:e.jsx(n.Item,{name:"reason",label:"Reason for Credit Note",children:e.jsx(I,{placeholder:"e.g. Goods returned, Overcharge, etc."})})})]}),e.jsxs(G,{title:"Items",size:"small",style:{marginBottom:12},extra:e.jsx(h,{size:"small",icon:e.jsx(Y,{}),onClick:R,danger:!0,children:"Add Item"}),children:[e.jsx(K,{columns:L,dataSource:f,rowKey:"key",pagination:!1,size:"small"}),e.jsx("div",{style:{textAlign:"right",marginTop:8,padding:8,background:"#fff5f5",borderRadius:4},children:e.jsxs("span",{style:{color:"#e53e3e",fontWeight:700},children:["CREDIT TOTAL: (",B(_),")"]})})]}),e.jsx(n.Item,{name:"notes",label:"Notes",children:e.jsx(te,{rows:2})}),e.jsx("div",{style:{textAlign:"right"},children:e.jsxs($,{children:[e.jsx(h,{onClick:()=>p("/credit-note"),children:"Cancel"}),e.jsx(h,{type:"primary",htmlType:"submit",loading:N,icon:e.jsx(Z,{}),danger:!0,children:o?"Update":"Create Credit Note"})]})})]})]})}export{ve as default};
