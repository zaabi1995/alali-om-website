import{r as m,m as xe,j as e}from"./index-CYKalyeL.js";import{b as ye,o as P}from"./omrFormat-B-E0oCKV.js";import{d as D}from"./dayjs.min-DGHWcPFV.js";import{X as ge,b as fe,aH as a,aB as q,aC as o,ai as u,aE as g,aF as X,aG as z,ar as be,az as x,aw as Ce,ax as we}from"./IdurarOs-BGw2PPGe.js";import{C as w}from"./index-DcFHw6qe.js";import{S as E}from"./index-CtMb3PWt.js";import{F as Z}from"./Table-CBI2Olew.js";import{M as v}from"./index-Ci2EwPC-.js";import{S as l}from"./index-BGUfHx-u.js";import{D as ee}from"./index-DQ1EhqQV.js";import{T as M}from"./index-DQrhZTc_.js";import{D as d}from"./index-DoyC_WDq.js";import{T as U}from"./index-BkNufn0G.js";import{m as te}from"./ErpApp-CeydZZZJ.js";import{s as n}from"./index-BQgCxPOT.js";import{P as Ie}from"./index-BNG2szad.js";import{P as Oe}from"./PlusOutlined-FeH87sEb.js";import{D as qe}from"./DeleteOutlined-D2OLi6gq.js";import"./Skeleton-BxPCSHmg.js";import"./index-CAMKOCuO.js";import"./pickAttrs-CsXZNnOo.js";import"./DownOutlined-Bn5vGHe8.js";import"./Pagination-CRz1TW9a.js";import"./ActionButton-C9t4i8h5.js";import"./useClosable-BvmnJMVE.js";import"./fade-CBBaJpqm.js";import"./ClockCircleOutlined-B1tuOUVZ.js";var ve={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M847.9 592H152c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h605.2L612.9 851c-4.1 5.2-.4 13 6.3 13h72.5c4.9 0 9.5-2.2 12.6-6.1l168.8-214.1c16.5-21 1.6-51.8-25.2-51.8zM872 356H266.8l144.3-183c4.1-5.2.4-13-6.3-13h-72.5c-4.9 0-9.5 2.2-12.6 6.1L150.9 380.2c-16.5 21-1.6 51.8 25.1 51.8h696c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"swap",theme:"outlined"},Se=function(S,A){return m.createElement(ge,fe({},S,{ref:A,icon:ve}))};const Y=m.forwardRef(Se),{Title:ke,Text:V}=be,{TextArea:F}=g;function y(){const C=((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token;return C?{Authorization:`Bearer ${C}`}:{}}function Be(){return(JSON.parse(localStorage.getItem("auth"))||{}).current||{}}const se={draft:"default",submitted:"blue",approved:"green",rejected:"red",converted:"purple"},re={routine:"default",urgent:"orange",critical:"red"};function rt(){var W,G,Q,K;const C=xe(),S=Be(),A=S.role,k=["Manager","GM","Admin","Owner"].includes(A),[ie,ae]=m.useState([]),[ne,B]=m.useState(!1),[R,le]=m.useState({}),[oe,N]=m.useState(!1),[ce,_]=m.useState(!1),[T,I]=m.useState(!1),[r,O]=m.useState(null),[p]=a.useForm(),f=async()=>{B(!0);try{const s=await(await fetch(x+"purchaserequest/list",{headers:y()})).json();s.success&&ae(s.result||[])}catch{n.error("Failed to load purchase requests")}finally{B(!1)}},b=async()=>{try{const s=await(await fetch(x+"purchaserequest/stats",{headers:y()})).json();s.success&&le(s.result||{})}catch(t){console.error("Failed to load stats",t)}};m.useEffect(()=>{f(),b()},[]);const de=async t=>{try{const s={...t,requiredBy:t.requiredBy?t.requiredBy.toISOString():null},c=await(await fetch(x+"purchaserequest/create",{method:"POST",headers:{...y(),"Content-Type":"application/json"},body:JSON.stringify(s)})).json();c.success?(n.success(c.message||"Purchase Request created"),N(!1),p.resetFields(),f(),b()):n.error(c.message||"Failed to create")}catch{n.error("Error creating purchase request")}},ue=async t=>{try{const s={...t,requiredBy:t.requiredBy?t.requiredBy.toISOString():null},c=await(await fetch(x+`purchaserequest/update/${r._id}`,{method:"PATCH",headers:{...y(),"Content-Type":"application/json"},body:JSON.stringify(s)})).json();c.success?(n.success("Purchase Request updated"),_(!1),p.resetFields(),O(null),f(),b()):n.error(c.message||"Failed to update")}catch{n.error("Error updating purchase request")}},$=async t=>{try{const i=await(await fetch(x+`purchaserequest/approve/${t}`,{method:"POST",headers:y()})).json();i.success?(n.success("Purchase Request approved"),f(),b(),T&&I(!1)):n.error(i.message||"Failed to approve")}catch{n.error("Error approving purchase request")}},L=async t=>{v.confirm({title:"Reject Purchase Request",icon:e.jsx(z,{}),content:e.jsx(g.TextArea,{id:"reject-reason",placeholder:"Enter rejection reason...",rows:3,style:{marginTop:12}}),onOk:async()=>{const s=document.getElementById("reject-reason").value;if(!s.trim())return n.warning("Please provide a reason for rejection"),Promise.reject();try{const c=await(await fetch(x+`purchaserequest/reject/${t}`,{method:"POST",headers:{...y(),"Content-Type":"application/json"},body:JSON.stringify({reason:s})})).json();c.success?(n.success("Purchase Request rejected"),f(),b(),T&&I(!1)):n.error(c.message||"Failed to reject")}catch{n.error("Error rejecting purchase request")}}})},J=async t=>{v.confirm({title:"Convert to Purchase Order",icon:e.jsx(Y,{}),content:"This will create a new Purchase Order from this approved Purchase Request. Continue?",onOk:async()=>{try{const i=await(await fetch(x+`purchaserequest/convert/${t}`,{method:"POST",headers:y()})).json();i.success?(n.success(i.message||"Converted to Purchase Order"),f(),b(),T&&I(!1),i.po&&i.po._id&&C(`/purchase-order/read/${i.po._id}`)):n.error(i.message||"Failed to convert")}catch{n.error("Error converting to PO")}}})},he=async t=>{try{const i=await(await fetch(x+`purchaserequest/delete/${t}`,{method:"DELETE",headers:y()})).json();i.success?(n.success("Purchase Request deleted"),f(),b()):n.error(i.message||"Failed to delete")}catch{n.error("Error deleting purchase request")}},pe=()=>{p.resetFields(),p.setFieldsValue({urgency:"routine",items:[{description:"",quantity:1,unit:"pcs",estimatedUnitCost:0}]}),N(!0)},me=t=>{O(t),p.setFieldsValue({title:t.title,department:t.department,justification:t.justification,urgency:t.urgency,requiredBy:t.requiredBy?D(t.requiredBy):null,items:t.items||[],notes:t.notes}),_(!0)},H=async t=>{B(!0);try{const i=await(await fetch(x+`purchaserequest/read/${t._id}`,{headers:y()})).json();i.success?(O(i.result),I(!0)):n.error("Failed to load purchase request details")}catch{n.error("Error loading details")}finally{B(!1)}},je=[{title:"PR #",dataIndex:"prNumber",width:100,render:(t,s)=>e.jsx("a",{onClick:()=>H(s),style:{fontWeight:700,color:"#034D57"},children:t})},{title:"Title",dataIndex:"title",ellipsis:!0},{title:"Requested By",dataIndex:"requestedByName",width:150},{title:"Department",dataIndex:"department",width:120},{title:"Total Estimate",dataIndex:"totalEstimate",width:130,align:"right",render:t=>P(t,3)},{title:"Urgency",dataIndex:"urgency",width:100,render:t=>e.jsx(U,{color:re[t]||"default",children:t==null?void 0:t.toUpperCase()})},{title:"Status",dataIndex:"status",width:110,render:t=>e.jsx(U,{color:se[t]||"default",children:t==null?void 0:t.toUpperCase()})},{title:"Required By",dataIndex:"requiredBy",width:110,render:t=>t?D(t).format("DD MMM YYYY"):"—"},{title:"Actions",width:180,render:(t,s)=>{const i=s.requestedBy===S._id,c=i&&["draft","submitted"].includes(s.status),h=i&&s.status==="draft";return e.jsxs(te,{size:"small",children:[e.jsx(u,{size:"small",icon:e.jsx(Ce,{}),onClick:()=>H(s)}),c&&e.jsx(u,{size:"small",icon:e.jsx(we,{}),onClick:()=>me(s)}),k&&s.status==="submitted"&&e.jsxs(e.Fragment,{children:[e.jsx(u,{size:"small",type:"primary",icon:e.jsx(X,{}),style:{background:"#4CB480",borderColor:"#4CB480"},onClick:()=>$(s._id)}),e.jsx(u,{size:"small",danger:!0,icon:e.jsx(z,{}),onClick:()=>L(s._id)})]}),k&&s.status==="approved"&&e.jsx(u,{size:"small",type:"primary",icon:e.jsx(Y,{}),style:{background:"#034D57",borderColor:"#034D57"},onClick:()=>J(s._id),children:"Convert"}),h&&e.jsx(Ie,{title:"Delete this PR?",onConfirm:()=>he(s._id),okText:"Yes",cancelText:"No",children:e.jsx(u,{size:"small",danger:!0,icon:e.jsx(qe,{})})})]})}}];return e.jsxs("div",{style:{padding:"24px"},children:[e.jsxs(q,{gutter:16,style:{marginBottom:24},children:[e.jsx(o,{span:6,children:e.jsx(w,{children:e.jsx(E,{title:"Pending Approval",value:R.submitted||0,valueStyle:{color:"#1890ff"}})})}),e.jsx(o,{span:6,children:e.jsx(w,{children:e.jsx(E,{title:"Approved",value:R.approved||0,valueStyle:{color:"#4CB480"}})})}),e.jsx(o,{span:6,children:e.jsx(w,{children:e.jsx(E,{title:"Converted to PO",value:R.converted||0,valueStyle:{color:"#722ed1"}})})}),e.jsx(o,{span:6,children:e.jsx(w,{children:e.jsx(E,{title:"Total Value",value:(R.totalValue||0).toFixed(3),suffix:ye(12),valueStyle:{color:"#034D57"}})})})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx(ke,{level:4,style:{margin:0,color:"#034D57"},children:"Purchase Requests"}),e.jsx(u,{type:"primary",icon:e.jsx(Oe,{}),onClick:pe,style:{background:"#034D57",borderColor:"#034D57"},children:"New Purchase Request"})]}),e.jsx(Z,{columns:je,dataSource:ie,loading:ne,rowKey:"_id",pagination:{pageSize:20}}),e.jsx(v,{title:"New Purchase Request",open:oe,onCancel:()=>{N(!1),p.resetFields()},onOk:()=>p.submit(),width:800,okText:"Submit Request",okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:e.jsxs(a,{form:p,layout:"vertical",onFinish:de,children:[e.jsx(a.Item,{name:"title",label:"Title",rules:[{required:!0,message:"Title is required"}],children:e.jsx(g,{placeholder:"Short description of what's needed"})}),e.jsxs(q,{gutter:16,children:[e.jsx(o,{span:12,children:e.jsx(a.Item,{name:"department",label:"Department",children:e.jsx(g,{placeholder:"e.g., IT, Operations, Finance"})})}),e.jsx(o,{span:12,children:e.jsx(a.Item,{name:"urgency",label:"Urgency",rules:[{required:!0}],children:e.jsxs(l,{children:[e.jsx(l.Option,{value:"routine",children:"Routine"}),e.jsx(l.Option,{value:"urgent",children:"Urgent"}),e.jsx(l.Option,{value:"critical",children:"Critical"})]})})})]}),e.jsx(a.Item,{name:"requiredBy",label:"Required By",children:e.jsx(ee,{style:{width:"100%"}})}),e.jsx(a.Item,{name:"justification",label:"Justification",children:e.jsx(F,{rows:3,placeholder:"Why is this purchase needed?"})}),e.jsx(a.List,{name:"items",children:(t,{add:s,remove:i})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{fontWeight:600,marginBottom:8},children:"Items"}),t.map(({key:c,name:h,...j})=>e.jsxs(w,{size:"small",style:{marginBottom:8},children:[e.jsxs(q,{gutter:8,children:[e.jsx(o,{span:12,children:e.jsx(a.Item,{...j,name:[h,"description"],label:"Description",children:e.jsx(g,{placeholder:"Item description"})})}),e.jsx(o,{span:4,children:e.jsx(a.Item,{...j,name:[h,"quantity"],label:"Qty",children:e.jsx(M,{min:1,style:{width:"100%"}})})}),e.jsx(o,{span:4,children:e.jsx(a.Item,{...j,name:[h,"unit"],label:"Unit",children:e.jsxs(l,{children:[e.jsx(l.Option,{value:"pcs",children:"pcs"}),e.jsx(l.Option,{value:"kg",children:"kg"}),e.jsx(l.Option,{value:"litre",children:"litre"}),e.jsx(l.Option,{value:"m",children:"m"}),e.jsx(l.Option,{value:"set",children:"set"})]})})}),e.jsx(o,{span:4,children:e.jsx(a.Item,{...j,name:[h,"estimatedUnitCost"],label:"Unit Cost (OMR)",children:e.jsx(M,{min:0,step:.001,precision:3,style:{width:"100%"}})})})]}),e.jsx(u,{danger:!0,size:"small",onClick:()=>i(h),children:"Remove Item"})]},c)),e.jsx(u,{type:"dashed",onClick:()=>s(),block:!0,children:"+ Add Item"})]})}),e.jsx(a.Item,{name:"notes",label:"Notes",style:{marginTop:16},children:e.jsx(F,{rows:2})})]})}),e.jsx(v,{title:"Edit Purchase Request",open:ce,onCancel:()=>{_(!1),p.resetFields(),O(null)},onOk:()=>p.submit(),width:800,okText:"Update",okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:e.jsxs(a,{form:p,layout:"vertical",onFinish:ue,children:[e.jsx(a.Item,{name:"title",label:"Title",rules:[{required:!0,message:"Title is required"}],children:e.jsx(g,{placeholder:"Short description of what's needed"})}),e.jsxs(q,{gutter:16,children:[e.jsx(o,{span:12,children:e.jsx(a.Item,{name:"department",label:"Department",children:e.jsx(g,{placeholder:"e.g., IT, Operations, Finance"})})}),e.jsx(o,{span:12,children:e.jsx(a.Item,{name:"urgency",label:"Urgency",rules:[{required:!0}],children:e.jsxs(l,{children:[e.jsx(l.Option,{value:"routine",children:"Routine"}),e.jsx(l.Option,{value:"urgent",children:"Urgent"}),e.jsx(l.Option,{value:"critical",children:"Critical"})]})})})]}),e.jsx(a.Item,{name:"requiredBy",label:"Required By",children:e.jsx(ee,{style:{width:"100%"}})}),e.jsx(a.Item,{name:"justification",label:"Justification",children:e.jsx(F,{rows:3,placeholder:"Why is this purchase needed?"})}),e.jsx(a.List,{name:"items",children:(t,{add:s,remove:i})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{fontWeight:600,marginBottom:8},children:"Items"}),t.map(({key:c,name:h,...j})=>e.jsxs(w,{size:"small",style:{marginBottom:8},children:[e.jsxs(q,{gutter:8,children:[e.jsx(o,{span:12,children:e.jsx(a.Item,{...j,name:[h,"description"],label:"Description",children:e.jsx(g,{placeholder:"Item description"})})}),e.jsx(o,{span:4,children:e.jsx(a.Item,{...j,name:[h,"quantity"],label:"Qty",children:e.jsx(M,{min:1,style:{width:"100%"}})})}),e.jsx(o,{span:4,children:e.jsx(a.Item,{...j,name:[h,"unit"],label:"Unit",children:e.jsxs(l,{children:[e.jsx(l.Option,{value:"pcs",children:"pcs"}),e.jsx(l.Option,{value:"kg",children:"kg"}),e.jsx(l.Option,{value:"litre",children:"litre"}),e.jsx(l.Option,{value:"m",children:"m"}),e.jsx(l.Option,{value:"set",children:"set"})]})})}),e.jsx(o,{span:4,children:e.jsx(a.Item,{...j,name:[h,"estimatedUnitCost"],label:"Unit Cost (OMR)",children:e.jsx(M,{min:0,step:.001,precision:3,style:{width:"100%"}})})})]}),e.jsx(u,{danger:!0,size:"small",onClick:()=>i(h),children:"Remove Item"})]},c)),e.jsx(u,{type:"dashed",onClick:()=>s(),block:!0,children:"+ Add Item"})]})}),e.jsx(a.Item,{name:"notes",label:"Notes",style:{marginTop:16},children:e.jsx(F,{rows:2})})]})}),e.jsx(v,{title:`Purchase Request: ${(r==null?void 0:r.prNumber)||""}`,open:T,onCancel:()=>{I(!1),O(null)},footer:null,width:900,children:r&&e.jsxs(e.Fragment,{children:[e.jsxs(d,{bordered:!0,column:2,size:"small",children:[e.jsx(d.Item,{label:"PR Number",span:2,children:e.jsx(V,{strong:!0,style:{color:"#034D57"},children:r.prNumber})}),e.jsx(d.Item,{label:"Title",span:2,children:r.title}),e.jsx(d.Item,{label:"Requested By",children:((W=r.requestedBy)==null?void 0:W.name)||r.requestedByName}),e.jsx(d.Item,{label:"Department",children:r.department||"—"}),e.jsx(d.Item,{label:"Status",children:e.jsx(U,{color:se[r.status],children:(G=r.status)==null?void 0:G.toUpperCase()})}),e.jsx(d.Item,{label:"Urgency",children:e.jsx(U,{color:re[r.urgency],children:(Q=r.urgency)==null?void 0:Q.toUpperCase()})}),e.jsx(d.Item,{label:"Required By",children:r.requiredBy?D(r.requiredBy).format("DD MMM YYYY"):"—"}),e.jsx(d.Item,{label:"Total Estimate",children:P(r.totalEstimate,3)}),r.approvedBy&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{label:"Approved By",children:(K=r.approvedBy)==null?void 0:K.name}),e.jsx(d.Item,{label:"Approved At",children:D(r.approvedAt).format("DD MMM YYYY HH:mm")})]}),r.rejectedReason&&e.jsx(d.Item,{label:"Rejection Reason",span:2,children:e.jsx(V,{type:"danger",children:r.rejectedReason})}),r.linkedPO&&e.jsx(d.Item,{label:"Linked PO",span:2,children:e.jsxs("a",{onClick:()=>C(`/purchase-order/read/${r.linkedPO._id}`),children:["PO-",r.linkedPO.number,"/",r.linkedPO.year]})}),r.justification&&e.jsx(d.Item,{label:"Justification",span:2,children:r.justification}),r.notes&&e.jsx(d.Item,{label:"Notes",span:2,children:r.notes})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsx(V,{strong:!0,children:"Items:"}),e.jsx(Z,{dataSource:r.items||[],pagination:!1,size:"small",style:{marginTop:8},rowKey:(t,s)=>s,columns:[{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Qty",dataIndex:"quantity",width:60},{title:"Unit",dataIndex:"unit",width:60},{title:"Unit Cost (OMR)",dataIndex:"estimatedUnitCost",width:130,align:"right",render:t=>P(t,3,10)},{title:"Total (OMR)",dataIndex:"estimatedTotal",width:130,align:"right",render:t=>P(t,3,10)}]})]}),e.jsx("div",{style:{marginTop:24,textAlign:"right"},children:e.jsxs(te,{children:[k&&r.status==="submitted"&&e.jsxs(e.Fragment,{children:[e.jsx(u,{type:"primary",icon:e.jsx(X,{}),style:{background:"#4CB480",borderColor:"#4CB480"},onClick:()=>$(r._id),children:"Approve"}),e.jsx(u,{danger:!0,icon:e.jsx(z,{}),onClick:()=>L(r._id),children:"Reject"})]}),k&&r.status==="approved"&&e.jsx(u,{type:"primary",icon:e.jsx(Y,{}),style:{background:"#034D57",borderColor:"#034D57"},onClick:()=>J(r._id),children:"Convert to PO"})]})})]})})]})}export{rt as default};
