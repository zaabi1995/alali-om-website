import{m as N,o as $,r as l,j as e}from"./index-BcNLKCvS.js";import{o as B}from"./omrFormat-BbIz9DzS.js";import{d as E}from"./dayjs.min-F-PWr_1l.js";import{az as y,aD as F,ai as i,ax as M,aB as _,aC as I,ar as Y}from"./IdurarOs-Bnu_4kQ9.js";import{s as g}from"./index-Degu9Cxv.js";import{T as H}from"./index-BnGaNyE7.js";import{m as J,F as L}from"./ErpApp-Dinm6x2K.js";import{C as u}from"./index-cKS8OAZl.js";import{D as C}from"./index-BJdx4Rla.js";import{F as d}from"./Table-0rkgzMCC.js";import{M as V}from"./index-CbhJEeVv.js";import{A as W}from"./ArrowLeftOutlined-DVGL6QbS.js";import"./useClosable-DMcKrkSm.js";import"./Skeleton-C5m9T5dx.js";import"./index-Cp84zSwi.js";import"./PlusOutlined-DBlttavK.js";import"./pickAttrs-6YJIpkjS.js";import"./index-CHNYwYGg.js";import"./DownOutlined-DFIgJ0J3.js";import"./ActionButton-RaLR9R6a.js";import"./fade-nEuvLsZo.js";const{Title:P,Text:b}=Y,q={draft:"default",issued:"blue",applied:"green",voided:"red"};function S(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function c(m){return B(m)}function he(){var k,D;const m=N(),{id:n}=$(),[t,w]=l.useState(null),[U,z]=l.useState(!0),[v,R]=l.useState(!1),[a,f]=l.useState(null),[O,p]=l.useState(!1);l.useEffect(()=>{fetch(y+`creditnote/read/${n}`,{headers:S()}).then(s=>s.json()).then(s=>{s.success&&w(s.result)}).catch(()=>g.error("Failed")).finally(()=>z(!1))},[n]);const x=async(s=!1)=>{R(!0);try{const r=await fetch(y+`creditnote/pdf/${n}`,{headers:S()});if(!r.ok)throw new Error("PDF failed");const o=await r.blob(),h=URL.createObjectURL(o);if(s){const j=document.createElement("a");j.href=h,j.download=`CN-${t==null?void 0:t.number}-${t==null?void 0:t.year}.pdf`,j.click(),URL.revokeObjectURL(h)}else f(h),p(!0)}catch(r){g.error(r.message)}finally{R(!1)}},T=async s=>{const o=await(await fetch(y+`creditnote/update/${n}`,{method:"PATCH",headers:{...S(),"Content-Type":"application/json"},body:JSON.stringify({status:s})})).json();o.success&&(w(o.result),g.success(`Status: ${s}`))};if(U)return e.jsx("div",{style:{textAlign:"center",padding:60},children:e.jsx(F,{size:"large"})});if(!t)return e.jsx("div",{style:{padding:24},children:"Not found."});const A=[{title:"#",width:40,render:(s,r,o)=>o+1},{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Qty",dataIndex:"quantity",width:70,align:"center"},{title:"Unit Price",dataIndex:"price",align:"right",render:c},{title:"Total",dataIndex:"total",align:"right",render:s=>e.jsxs("strong",{style:{color:"#e53e3e"},children:["(",c(s),")"]})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,flexWrap:"wrap",gap:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx(i,{icon:e.jsx(W,{}),onClick:()=>m("/credit-note")}),e.jsxs("div",{children:[e.jsxs(P,{level:4,style:{margin:0,color:"#e53e3e"},children:["Credit Note CN-",t.number,"/",t.year]}),e.jsx(H,{color:q[t.status]||"default",style:{marginTop:4},children:(k=t.status)==null?void 0:k.toUpperCase()})]})]}),e.jsxs(J,{wrap:!0,children:[t.status==="draft"&&e.jsx(i,{onClick:()=>T("issued"),style:{borderColor:"#1890ff",color:"#1890ff"},children:"Issue"}),t.status==="issued"&&e.jsx(i,{onClick:()=>T("applied"),style:{borderColor:"#4CB480",color:"#4CB480"},children:"Mark Applied"}),e.jsx(i,{icon:e.jsx(L,{}),onClick:()=>x(!1),loading:v,children:"Preview PDF"}),e.jsx(i,{icon:e.jsx(L,{}),onClick:()=>x(!0),loading:v,danger:!0,children:"Download PDF"}),e.jsx(i,{icon:e.jsx(M,{}),onClick:()=>m(`/credit-note/edit/${n}`),children:"Edit"})]})]}),e.jsxs(_,{gutter:16,style:{marginBottom:16},children:[e.jsx(I,{xs:24,md:12,children:e.jsxs(u,{size:"small",title:"Issued To",children:[e.jsx(P,{level:5,style:{color:"#034D57",marginTop:0},children:((D=t.client)==null?void 0:D.name)||"—"}),t.reason&&e.jsxs(b,{type:"secondary",style:{fontSize:12},children:["Reason: ",t.reason]})]})}),e.jsx(I,{xs:24,md:12,children:e.jsx(u,{size:"small",title:"Details",children:e.jsxs(C,{size:"small",column:1,children:[e.jsx(C.Item,{label:"Date",children:E(t.date).format("DD MMM YYYY")}),t.invoice&&e.jsxs(C.Item,{label:"Invoice Ref",children:["INV-",t.invoice.number,"/",t.invoice.year]})]})})})]}),e.jsx(u,{size:"small",title:"Items",style:{marginBottom:16},children:e.jsx(d,{columns:A,dataSource:t.items||[],rowKey:(s,r)=>r,pagination:!1,size:"small",summary:()=>e.jsxs(d.Summary.Row,{style:{background:"#fff5f5"},children:[e.jsx(d.Summary.Cell,{index:0,colSpan:3,children:e.jsx("strong",{children:"Totals"})}),t.taxRate>0&&e.jsx(d.Summary.Cell,{index:3,align:"right",children:e.jsxs(b,{type:"secondary",children:["Sub: (",c(t.subTotal),") + VAT: (",c(t.taxTotal),")"]})}),e.jsx(d.Summary.Cell,{index:4,align:"right",colSpan:t.taxRate>0?0:2,children:e.jsxs("strong",{style:{color:"#e53e3e",fontSize:15},children:["CREDIT: (",c(t.total),")"]})})]})})}),t.notes&&e.jsx(u,{size:"small",style:{borderLeft:"3px solid #f59e0b"},children:e.jsx(b,{children:t.notes})}),e.jsx(V,{title:`PDF — CN-${t.number}/${t.year}`,open:O,width:"80%",style:{top:20},onCancel:()=>{p(!1),a&&URL.revokeObjectURL(a),f(null)},footer:[e.jsx(i,{danger:!0,onClick:()=>x(!0),children:"Download"},"dl"),e.jsx(i,{onClick:()=>{p(!1),a&&URL.revokeObjectURL(a),f(null)},children:"Close"},"cl")],children:a&&e.jsx("iframe",{src:a,style:{width:"100%",height:"70vh",border:"none"}})})]})}export{he as default};
