import{m as W,o as K,r as h,j as e}from"./index-BdDb7ySv.js";import{d as b}from"./dayjs.min-BwTYVMbN.js";import{aG as i,ay as y,ai as p,aA as w,aB as l,aD as v,ar as X}from"./IdurarOs-dHE_gtdC.js";import{C as j}from"./index-BXuZsnPN.js";import{S as c}from"./index-DegQHdRQ.js";import{D as F}from"./index-B7OdKOV7.js";import{T as D}from"./index-C5g6SJhI.js";import{F as Q}from"./Table-BFtvumgA.js";import{k as J}from"./ErpApp-DCg0EmsZ.js";import{s as S}from"./index-CahQuJzF.js";import{P as Y}from"./index-B_HQKmv-.js";import{A as Z}from"./ArrowLeftOutlined-BHfGXBHY.js";import{P as N}from"./PlusOutlined-DOWtOXxu.js";import{S as ee}from"./SaveOutlined-DXqnFCZ_.js";import{D as te}from"./DeleteOutlined-Yp2XNl_p.js";import"./Skeleton-DcxcBGAO.js";import"./index-DG8k-4gF.js";import"./pickAttrs-Bwg9skD5.js";import"./DownOutlined-DqKo3zi1.js";import"./ClockCircleOutlined-TuQZpWFp.js";import"./ActionButton-Ber1G2gT.js";const{Title:se,Text:we}=X,{TextArea:z}=v;function re(){return{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`,"Content-Type":"application/json"}}const O=["USD","EUR","GBP","AED","SAR","OMR"],B={key:Date.now(),partNumber:"",description:"",quantity:1,unit:"EA",unitPrice:0,currency:"USD",hsCode:""};function De(){const f=W(),{id:d}=K(),[I]=i.useForm(),[g,C]=h.useState([{...B}]),[R,E]=h.useState([]),[U,V]=h.useState([]),[L,k]=h.useState(!1),[x,A]=h.useState("USD");h.useEffect(()=>{const t={Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`};fetch(y+"vendor/listAll",{headers:t}).then(s=>s.json()).then(s=>{s.result&&E(s.result)}).catch(()=>{}),fetch(y+"invoice/listAll",{headers:t}).then(s=>s.json()).then(s=>{s.result&&V(s.result)}).catch(()=>{}),d&&fetch(y+`purchaseorder/read/${d}`,{headers:t}).then(s=>s.json()).then(s=>{var r,n,o;if(s.success&&s.result){const a=s.result;A(a.currency||"USD"),I.setFieldsValue({vendor:((r=a.vendor)==null?void 0:r._id)||a.vendor,date:a.date?b(a.date):null,deliveryDate:a.deliveryDate?b(a.deliveryDate):null,invoice:((n=a.invoice)==null?void 0:n._id)||a.invoice,currency:a.currency||"USD",vendorRef:a.vendorRef,incoterms:a.incoterms||"FCA",paymentTerms:a.paymentTerms||"Net 30",deliveryAddress:a.deliveryAddress,shippingCost:a.shippingCost||0,status:a.status||"draft",notes:a.notes}),(o=a.items)!=null&&o.length&&C(a.items.map((P,u)=>({...P,key:u})))}}).catch(()=>{})},[d]);const T=()=>C(t=>[...t,{...B,key:Date.now(),currency:x}]),_=t=>C(s=>s.filter(r=>r.key!==t)),m=(t,s,r)=>C(n=>n.map(o=>o.key===t?{...o,[s]:r}:o)),q=()=>{const t=g.reduce((r,n)=>r+parseFloat(n.unitPrice||0)*parseFloat(n.quantity||0),0),s=parseFloat(I.getFieldValue("shippingCost")||0);return{sub:t,total:t+s}},$=async t=>{var o,a;if(!g.length){S.error("Add at least one item");return}k(!0);const s={...t,date:(o=t.date)==null?void 0:o.toISOString(),deliveryDate:((a=t.deliveryDate)==null?void 0:a.toISOString())||null,items:g},r=d?y+`purchaseorder/update/${d}`:y+"purchaseorder/create",n=d?"PATCH":"POST";try{const u=await(await fetch(r,{method:n,headers:re(),body:JSON.stringify(s)})).json();u.success?(S.success(u.message||"Saved"),f(`/purchase-order/read/${u.result._id}`)):S.error(u.message||"Failed")}catch{S.error("Network error")}finally{k(!1)}},{sub:G,total:H}=q(),M=[{title:"Part Number",dataIndex:"partNumber",width:130,render:(t,s)=>e.jsx(v,{size:"small",value:t,placeholder:"P/N",onChange:r=>m(s.key,"partNumber",r.target.value)})},{title:"Description",dataIndex:"description",width:220,render:(t,s)=>e.jsx(v,{size:"small",value:t,placeholder:"Description",onChange:r=>m(s.key,"description",r.target.value)})},{title:"Qty",dataIndex:"quantity",width:80,render:(t,s)=>e.jsx(D,{size:"small",min:0,value:t,style:{width:"100%"},onChange:r=>m(s.key,"quantity",r)})},{title:"Unit",dataIndex:"unit",width:70,render:(t,s)=>e.jsx(c,{size:"small",value:t,style:{width:"100%"},onChange:r=>m(s.key,"unit",r),options:["EA","SET","PKG","LOT","MTR","KG","LTR","BOX"].map(r=>({value:r,label:r}))})},{title:"Unit Price",dataIndex:"unitPrice",width:100,render:(t,s)=>e.jsx(D,{size:"small",min:0,value:t,step:.01,precision:4,style:{width:"100%"},onChange:r=>m(s.key,"unitPrice",r)})},{title:"Curr.",dataIndex:"currency",width:80,render:(t,s)=>e.jsx(c,{size:"small",value:t||x,style:{width:"100%"},onChange:r=>m(s.key,"currency",r),options:O.map(r=>({value:r,label:r}))})},{title:"HS Code",dataIndex:"hsCode",width:90,render:(t,s)=>e.jsx(v,{size:"small",value:t,placeholder:"HS",onChange:r=>m(s.key,"hsCode",r.target.value)})},{title:"Total",width:100,align:"right",render:(t,s)=>e.jsx("strong",{style:{color:"#034D57"},children:(parseFloat(s.unitPrice||0)*parseFloat(s.quantity||0)).toFixed(2)})},{title:"",width:40,render:(t,s)=>e.jsx(Y,{title:"Remove?",onConfirm:()=>_(s.key),okText:"Yes",cancelText:"No",children:e.jsx(p,{size:"small",danger:!0,type:"text",icon:e.jsx(te,{})})})}];return e.jsxs("div",{style:{padding:"24px",maxWidth:1200},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:20},children:[e.jsx(p,{icon:e.jsx(Z,{}),onClick:()=>f("/purchase-order")}),e.jsx(se,{level:4,style:{margin:0,color:"#034D57"},children:d?"Edit Purchase Order":"New Purchase Order"})]}),e.jsxs(i,{form:I,layout:"vertical",onFinish:$,children:[e.jsxs(w,{gutter:24,children:[e.jsx(l,{xs:24,md:14,children:e.jsx(j,{title:"Order Details",size:"small",style:{marginBottom:16},children:e.jsxs(w,{gutter:16,children:[e.jsx(l,{xs:24,sm:12,children:e.jsx(i.Item,{name:"vendor",label:"Vendor / Supplier",rules:[{required:!0}],children:e.jsx(c,{showSearch:!0,placeholder:"Select vendor",filterOption:(t,s)=>s.label.toLowerCase().includes(t.toLowerCase()),options:R.map(t=>({value:t._id,label:t.companyName}))})})}),e.jsx(l,{xs:24,sm:12,children:e.jsx(i.Item,{name:"invoice",label:"Linked Invoice (optional)",children:e.jsx(c,{showSearch:!0,allowClear:!0,placeholder:"Link to invoice",filterOption:(t,s)=>s.label.toLowerCase().includes(t.toLowerCase()),options:U.map(t=>({value:t._id,label:`INV-${t.number}/${t.year}`}))})})}),e.jsx(l,{xs:24,sm:8,children:e.jsx(i.Item,{name:"date",label:"PO Date",rules:[{required:!0}],initialValue:b(),children:e.jsx(F,{style:{width:"100%"}})})}),e.jsx(l,{xs:24,sm:8,children:e.jsx(i.Item,{name:"deliveryDate",label:"Required By",children:e.jsx(F,{style:{width:"100%"}})})}),e.jsx(l,{xs:24,sm:8,children:e.jsx(i.Item,{name:"currency",label:"Currency",initialValue:"USD",children:e.jsx(c,{options:O.map(t=>({value:t,label:t})),onChange:t=>A(t)})})}),e.jsx(l,{xs:24,sm:12,children:e.jsx(i.Item,{name:"vendorRef",label:"Vendor Quote Ref",children:e.jsx(v,{placeholder:"Vendor's quote/reference number"})})}),e.jsx(l,{xs:24,sm:12,children:e.jsx(i.Item,{name:"status",label:"Status",initialValue:"draft",children:e.jsx(c,{options:["draft","sent","acknowledged","shipped","received","cancelled"].map(t=>({value:t,label:t.charAt(0).toUpperCase()+t.slice(1)}))})})}),e.jsx(l,{xs:24,children:e.jsx(i.Item,{name:"deliveryAddress",label:"Deliver To Address",children:e.jsx(z,{rows:2,placeholder:"Delivery address"})})})]})})}),e.jsxs(l,{xs:24,md:10,children:[e.jsxs(j,{title:"Terms",size:"small",style:{marginBottom:16},children:[e.jsx(i.Item,{name:"incoterms",label:"Incoterms",initialValue:"FCA",children:e.jsx(c,{options:["FCA","DAP","DDP","EXW","FOB","CIF","CPT"].map(t=>({value:t,label:t}))})}),e.jsx(i.Item,{name:"paymentTerms",label:"Payment Terms",initialValue:"Net 30",children:e.jsx(c,{options:["Advance","Net 15","Net 30","Net 45","Net 60","50/50","25/50/25"].map(t=>({value:t,label:t}))})}),e.jsx(i.Item,{name:"shippingCost",label:"Shipping Cost",initialValue:0,children:e.jsx(D,{min:0,precision:4,style:{width:"100%"},addonAfter:x})})]}),e.jsx(j,{size:"small",style:{background:"#f0f6f7"},children:e.jsxs(w,{gutter:8,children:[e.jsxs(l,{span:12,children:[e.jsx("div",{style:{fontSize:11,color:"#888"},children:"Subtotal"}),e.jsxs("div",{style:{fontWeight:700,color:"#034D57"},children:[G.toFixed(2)," ",x]})]}),e.jsxs(l,{span:12,children:[e.jsx("div",{style:{fontSize:11,color:"#888"},children:"Total"}),e.jsxs("div",{style:{fontWeight:800,fontSize:16,color:"#034D57"},children:[H.toFixed(2)," ",x]})]})]})})]})]}),e.jsx(j,{title:"Line Items",size:"small",style:{marginBottom:16},extra:e.jsx(p,{size:"small",icon:e.jsx(N,{}),onClick:T,style:{color:"#4CB480",borderColor:"#4CB480"},children:"Add Item"}),children:e.jsx("div",{style:{overflowX:"auto"},children:e.jsx(Q,{columns:M,dataSource:g,rowKey:"key",pagination:!1,size:"small",locale:{emptyText:e.jsx(p,{type:"dashed",onClick:T,icon:e.jsx(N,{}),children:"Add first item"})}})})}),e.jsx(j,{title:"Notes",size:"small",style:{marginBottom:16},children:e.jsx(i.Item,{name:"notes",noStyle:!0,children:e.jsx(z,{rows:3,placeholder:"Special terms, notes, instructions..."})})}),e.jsx("div",{style:{textAlign:"right"},children:e.jsxs(J,{children:[e.jsx(p,{onClick:()=>f("/purchase-order"),children:"Cancel"}),e.jsx(p,{type:"primary",htmlType:"submit",loading:L,icon:e.jsx(ee,{}),style:{background:"#034D57",borderColor:"#034D57"},children:d?"Update":"Create Purchase Order"})]})})]})]})}export{De as default};
