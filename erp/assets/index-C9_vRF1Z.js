import{m as q,o as B,r as m,j as e}from"./index-BolfsKLq.js";import{o as V}from"./omrFormat-FMhdtvvG.js";import{m as $,O as U}from"./ErpApp-CPyzesRl.js";import{d as b}from"./dayjs.min-CAlYWd28.js";import{aH as o,az as u,ai as p,aB as H,aC as d,aE as I,ar as J}from"./IdurarOs-ImGZrK6V.js";import{S as g}from"./index-B4i0fLDO.js";import{D as M}from"./index-8VRd4o8X.js";import{T as v}from"./index-DjaKzJDI.js";import{C as W}from"./index-B1-0owN0.js";import{F as G}from"./Table-DwPC3CMf.js";import{s as C}from"./index-Bcg4oSX2.js";import{P as K}from"./index-Cbsb8sNQ.js";import{A as Q}from"./ArrowLeftOutlined-CS_jDWyb.js";import{P as X}from"./PlusOutlined-CXeZI9c1.js";import{S as Y}from"./SaveOutlined-CodiroIL.js";import{D as Z}from"./DeleteOutlined-Drg8rgxA.js";import"./pickAttrs-rA9L7BI5.js";import"./DownOutlined-CA7fmMYD.js";import"./ClockCircleOutlined-C3FhYHW8.js";import"./Skeleton-D8BNZGpQ.js";import"./index-SyqhotZh.js";import"./Pagination-xSPnpsLs.js";import"./ActionButton-qVzEXLW3.js";const{Title:ee}=J,{TextArea:te}=I;function se(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`,"Content-Type":"application/json"}}const k={key:Date.now(),description:"",quantity:1,price:0};function ke(){const h=q(),{id:n}=B(),[j]=o.useForm(),[f,x]=m.useState([{...k}]),[T,O]=m.useState([]),[A,F]=m.useState([]),[N,S]=m.useState(!1);m.useEffect(()=>{const s={Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`};fetch(u+"client/listAll",{headers:s}).then(t=>t.json()).then(t=>{t.result&&O(t.result)}),fetch(u+"invoice/listAll",{headers:s}).then(t=>t.json()).then(t=>{t.result&&F(t.result)}),n&&fetch(u+`creditnote/read/${n}`,{headers:s}).then(t=>t.json()).then(t=>{var a,l,i;if(t.success&&t.result){const r=t.result;j.setFieldsValue({client:((a=r.client)==null?void 0:a._id)||r.client,date:r.date?b(r.date):null,invoice:((l=r.invoice)==null?void 0:l._id)||r.invoice,reason:r.reason,taxRate:r.taxRate,status:r.status,notes:r.notes}),(i=r.items)!=null&&i.length&&x(r.items.map((c,L)=>({...c,key:L})))}})},[n]);const R=()=>x(s=>[...s,{...k,key:Date.now()}]),z=s=>x(t=>t.filter(a=>a.key!==s)),y=(s,t,a)=>x(l=>l.map(i=>i.key===s?{...i,[t]:a}:i)),w=f.reduce((s,t)=>s+parseFloat(t.price||0)*parseFloat(t.quantity||1),0),D=j.getFieldValue("taxRate")||0,P=w+w*(D/100),_=async s=>{var i;S(!0);const t={...s,date:(i=s.date)==null?void 0:i.toISOString(),items:f},a=n?u+`creditnote/update/${n}`:u+"creditnote/create",l=n?"PATCH":"POST";try{const c=await(await fetch(a,{method:l,headers:se(),body:JSON.stringify(t)})).json();c.success?(C.success(c.message||"Saved"),h(`/credit-note/read/${c.result._id}`)):C.error(c.message||"Failed")}catch{C.error("Network error")}finally{S(!1)}},E=[{title:"Description",dataIndex:"description",render:(s,t)=>e.jsx(I,{size:"small",value:s,onChange:a=>y(t.key,"description",a.target.value)})},{title:"Qty",dataIndex:"quantity",width:80,render:(s,t)=>e.jsx(v,{size:"small",min:1,value:s,style:{width:"100%"},onChange:a=>y(t.key,"quantity",a)})},{title:"Unit Price (OMR)",dataIndex:"price",width:130,render:(s,t)=>e.jsx(v,{size:"small",min:0,value:s,precision:3,style:{width:"100%"},onChange:a=>y(t.key,"price",a)})},{title:"Total",width:100,align:"right",render:(s,t)=>e.jsxs("strong",{style:{color:"#e53e3e"},children:["(",(parseFloat(t.price||0)*parseFloat(t.quantity||1)).toFixed(3)," ",e.jsx(U,{size:10,color:"#e53e3e"}),")"]})},{title:"",width:40,render:(s,t)=>e.jsx(K,{title:"Remove?",onConfirm:()=>z(t.key),children:e.jsx(p,{size:"small",danger:!0,type:"text",icon:e.jsx(Z,{})})})}];return e.jsxs("div",{style:{padding:24,maxWidth:900},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:20},children:[e.jsx(p,{icon:e.jsx(Q,{}),onClick:()=>h("/credit-note")}),e.jsx(ee,{level:4,style:{margin:0,color:"#e53e3e"},children:n?"Edit Credit Note":"New Credit Note"})]}),e.jsxs(o,{form:j,layout:"vertical",onFinish:_,children:[e.jsxs(H,{gutter:16,children:[e.jsx(d,{xs:24,md:12,children:e.jsx(o.Item,{name:"client",label:"Client",rules:[{required:!0}],children:e.jsx(g,{showSearch:!0,placeholder:"Select client",filterOption:(s,t)=>t.label.toLowerCase().includes(s.toLowerCase()),options:T.map(s=>({value:s._id,label:s.name}))})})}),e.jsx(d,{xs:24,md:12,children:e.jsx(o.Item,{name:"invoice",label:"Original Invoice",children:e.jsx(g,{showSearch:!0,allowClear:!0,placeholder:"Link to invoice",filterOption:(s,t)=>t.label.toLowerCase().includes(s.toLowerCase()),options:A.map(s=>({value:s._id,label:`INV-${s.number}/${s.year}`}))})})}),e.jsx(d,{xs:12,md:6,children:e.jsx(o.Item,{name:"date",label:"Date",rules:[{required:!0}],initialValue:b(),children:e.jsx(M,{style:{width:"100%"}})})}),e.jsx(d,{xs:12,md:6,children:e.jsx(o.Item,{name:"taxRate",label:"VAT Rate (%)",initialValue:0,children:e.jsx(v,{min:0,max:100,style:{width:"100%"}})})}),e.jsx(d,{xs:12,md:6,children:e.jsx(o.Item,{name:"status",label:"Status",initialValue:"draft",children:e.jsx(g,{options:["draft","issued","applied","voided"].map(s=>({value:s,label:s.charAt(0).toUpperCase()+s.slice(1)}))})})}),e.jsx(d,{xs:24,children:e.jsx(o.Item,{name:"reason",label:"Reason for Credit Note",children:e.jsx(I,{placeholder:"e.g. Goods returned, Overcharge, etc."})})})]}),e.jsxs(W,{title:"Items",size:"small",style:{marginBottom:12},extra:e.jsx(p,{size:"small",icon:e.jsx(X,{}),onClick:R,danger:!0,children:"Add Item"}),children:[e.jsx(G,{columns:E,dataSource:f,rowKey:"key",pagination:!1,size:"small"}),e.jsx("div",{style:{textAlign:"right",marginTop:8,padding:8,background:"#fff5f5",borderRadius:4},children:e.jsxs("span",{style:{color:"#e53e3e",fontWeight:700},children:["CREDIT TOTAL: (",V(P),")"]})})]}),e.jsx(o.Item,{name:"notes",label:"Notes",children:e.jsx(te,{rows:2})}),e.jsx("div",{style:{textAlign:"right"},children:e.jsxs($,{children:[e.jsx(p,{onClick:()=>h("/credit-note"),children:"Cancel"}),e.jsx(p,{type:"primary",htmlType:"submit",loading:N,icon:e.jsx(Y,{}),danger:!0,children:n?"Update":"Create Credit Note"})]})})]})]})}export{ke as default};
