import{r as l,j as e}from"./index-DllBwakO.js";import{d as le,O as c,e as ne,T as N,r as re,F as Te}from"./ErpApp-8JV0hddW.js";import{o as m}from"./omrFormat-DH5IRqNB.js";import{d as ke}from"./dayjs.min-DaZr1Ooh.js";import{b7 as v,aB as h,aM as ie,aL as L,b9 as Oe,a_ as de,aY as _e,aZ as x,ac as Ie,b4 as Be}from"./IdurarOs-hlQABX05.js";import{C as Fe}from"./index-CyWvGQBP.js";import{F as ce}from"./Table-jVNeeDS0.js";import{M as pe}from"./index-Bq-H9Uzd.js";import{T as P}from"./index-B5nW5caG.js";import{A as Ee}from"./index-Ds0hiZK8.js";import{T as Ne}from"./index-C1pYz5Qc.js";import{s as d}from"./index-C3qVZkcK.js";import{P as me}from"./index-B5ah8Pog.js";import{P as ue}from"./PlusOutlined-DpixQtx6.js";import{D as he}from"./DeleteOutlined-CvLwbY8i.js";import{C as Le}from"./CheckCircleOutlined-CNydmddW.js";import"./Skeleton-CN3Ugn-J.js";import"./ActionButton-B6fUoYhP.js";import"./fade-3xYjZeiG.js";const{Title:Me,Text:f}=_e;function k(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function M(){return{...k(),"Content-Type":"application/json"}}const ye={draft:"default",approved:"processing",paid:"success"},b=["January","February","March","April","May","June","July","August","September","October","November","December"],Re=["housing","transport","food","phone","bonus","other"],$e=["absence","late","half_day","advance","other"],T=u=>(u||[]).reduce((O,_)=>O+(_.amount||0),0),C=u=>(u||0).toFixed(3);function rt(){var te,se,oe;const[u,O]=l.useState([]),[_,R]=l.useState(!1),[w,$]=l.useState(null),[xe,I]=l.useState(!1),[fe,H]=l.useState(!1),[G]=v.useForm(),[i,B]=l.useState(null),[je,J]=l.useState(!1),[j,U]=l.useState([]),[z,W]=l.useState([]),[Y,K]=l.useState(0),[A,V]=l.useState(0),[q,Z]=l.useState(""),g=async()=>{R(!0);const s=await fetch(x+"payrollrun/list?items=24",{headers:k()}).then(t=>t.json()).catch(()=>({}));s.success&&O(s.result||[]),R(!1)};l.useEffect(()=>{g()},[]);const p=u[0];u.reduce((s,t)=>({headcount:Math.max(s.headcount,t.headcount||0),gross:s.gross+(t.totalGross||0),deductions:s.deductions+(t.totalDeductions||0),net:s.net+(t.totalNet||0)}),{headcount:0,gross:0,deductions:0,net:0});const ge=async()=>{let s;try{s=await G.validateFields()}catch{return}H(!0);try{const t=await fetch(x+"payroll/generate",{method:"POST",headers:M(),body:JSON.stringify(s)}).then(o=>o.json());t.success?(d.success(t.message),I(!1),g()):d.error(t.message||"Failed")}finally{H(!1)}},Se=async s=>{const t=await fetch(`${x}payroll/approve/${s}`,{method:"PATCH",headers:k()}).then(o=>o.json()).catch(()=>({}));t.success?(d.success(t.message),g()):d.error(t.message)},ve=async s=>{const t=await fetch(`${x}payroll/mark-paid/${s}`,{method:"PATCH",headers:M(),body:JSON.stringify({paidVia:"Bank Transfer"})}).then(o=>o.json()).catch(()=>({}));t.success?(d.success(t.message),g()):d.error(t.message)},be=async(s,t,o,y,F)=>{try{const D=await fetch(`${x}payroll/payslip-pdf/${s}/${t}`,{headers:k()});if(!D.ok){d.error("PDF generation failed");return}const S=await D.blob(),n=URL.createObjectURL(S),a=document.createElement("a");a.href=n,a.download=`PaySlip-${o.replace(/\s+/g,"-")}-${b[y-1]}-${F}.pdf`,a.click(),URL.revokeObjectURL(n)}catch{d.error("PDF download failed")}},Ce=(s,t)=>{B({run:s,slip:t}),U(JSON.parse(JSON.stringify(t.allowances||[]))),W((t.deductions||[]).filter(o=>o.type!=="pasi").map(o=>JSON.parse(JSON.stringify(o)))),K(t.overtimeHours||0),V(t.overtimeAmt||0),Z(t.notes||"")},we=async()=>{if(i){J(!0);try{const s={allowances:j.filter(o=>o.amount>0),deductions:z.filter(o=>o.amount>0),overtimeHours:Y,overtimeAmt:A,notes:q},t=await fetch(`${x}payroll/update-slip/${i.run._id}/${i.slip._id}`,{method:"PATCH",headers:M(),body:JSON.stringify(s)}).then(o=>o.json());t.success?(d.success(t.message),B(null),g()):d.error(t.message||"Failed")}finally{J(!1)}}},Q=({items:s,setItems:t,types:o,addLabel:y})=>{const F=()=>t(n=>[...n,{type:o[0],description:"",amount:0}]),D=n=>t(a=>a.filter((r,E)=>E!==n)),S=(n,a,r)=>t(E=>E.map((ae,Pe)=>Pe===n?{...ae,[a]:r}:ae));return e.jsxs("div",{children:[s.map((n,a)=>e.jsxs("div",{style:{display:"flex",gap:6,marginBottom:6,alignItems:"center"},children:[e.jsx(ne,{size:"small",style:{width:120},value:n.type,onChange:r=>S(a,"type",r),options:o.map(r=>({value:r,label:r.charAt(0).toUpperCase()+r.slice(1).replace("_"," ")}))}),e.jsx(de,{size:"small",style:{flex:1},placeholder:"Description",value:n.description,onChange:r=>S(a,"description",r.target.value)}),e.jsx(P,{size:"small",style:{width:110},min:0,precision:3,placeholder:"0.000",value:n.amount,onChange:r=>S(a,"amount",r||0),addonBefore:"OMR"}),e.jsx(he,{onClick:()=>D(a),style:{color:"#e53e3e",cursor:"pointer",fontSize:14}})]},a)),e.jsx(h,{size:"small",icon:e.jsx(ue,{}),onClick:F,style:{marginTop:4},children:y})]})},X=i?(i.slip.basicSalary||0)+T(j)+(A||0):0,ee=T(z),ze=Math.max(0,X-ee),Ae=[{title:"Period",render:(s,t)=>e.jsxs(f,{strong:!0,style:{color:"#034D57"},children:[b[t.month-1]," ",t.year]})},{title:"Headcount",dataIndex:"headcount",align:"center",render:s=>e.jsx(N,{icon:e.jsx(le,{}),children:s})},{title:"Gross Pay",dataIndex:"totalGross",align:"right",render:s=>m(s)},{title:"PASI (Emp)",dataIndex:"totalPasiEmployee",align:"right",render:s=>s>0?e.jsx("span",{style:{color:"#b7700a",fontSize:12},children:m(s)}):e.jsx("span",{style:{color:"#ccc"},children:"â€”"})},{title:"Deductions",dataIndex:"totalDeductions",align:"right",render:s=>s>0?e.jsx("span",{style:{color:"#e53e3e"},children:m(s)}):"â€”"},{title:"Net Pay",dataIndex:"totalNet",align:"right",render:s=>e.jsx("strong",{style:{color:"#4CB480"},children:m(s)})},{title:"Status",dataIndex:"status",render:s=>e.jsx(N,{color:ye[s],children:s==null?void 0:s.toUpperCase()})},{title:"",width:220,render:(s,t)=>e.jsxs(re,{size:4,children:[t.status==="draft"&&e.jsx(me,{title:"Approve this payroll run?",onConfirm:()=>Se(t._id),okText:"Approve",children:e.jsx(h,{size:"small",type:"primary",style:{background:"#034D57",borderColor:"#034D57"},icon:e.jsx(Le,{}),children:"Approve"})}),t.status==="approved"&&e.jsx(me,{title:"Mark all pay slips as paid?",onConfirm:()=>ve(t._id),okText:"Confirm",children:e.jsx(h,{size:"small",style:{background:"#4CB480",borderColor:"#4CB480",color:"#fff"},children:"Mark Paid"})}),e.jsx(h,{size:"small",onClick:()=>$(w===t._id?null:t._id),children:w===t._id?"Close":"View Slips"})]})}],De=s=>[{title:"Employee",render:(t,o)=>e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:o.name}),e.jsxs(f,{type:"secondary",style:{fontSize:11},children:[o.department," Â· ",o.employeeId]})]})},{title:"Attendance",align:"center",render:(t,o)=>e.jsxs(f,{style:{fontSize:11},children:[e.jsxs("span",{style:{color:"#4CB480"},children:["âœ“",o.workingDays||0]})," ",e.jsxs("span",{style:{color:"#e53e3e"},children:["âœ—",o.absentDays||0]}),o.overtimeHours>0&&e.jsxs("span",{style:{color:"#b7700a"},children:[" OT:",(o.overtimeHours||0).toFixed(1),"h"]})]})},{title:"Basic",dataIndex:"basicSalary",align:"right",render:t=>m(t)},{title:"Allowances",align:"right",render:(t,o)=>{const y=T(o.allowances)+(o.overtimeAmt||0);return y>0?e.jsx("span",{style:{color:"#047857"},children:m(y)}):"â€”"}},{title:"Deductions",align:"right",render:(t,o)=>o.totalDeductions>0?e.jsx("span",{style:{color:"#e53e3e"},children:m(o.totalDeductions)}):"â€”"},{title:"Net Pay",dataIndex:"netPay",align:"right",render:t=>e.jsx("strong",{style:{color:"#4CB480"},children:m(t)})},{title:"Status",dataIndex:"status",render:t=>e.jsx(N,{color:ye[t],style:{fontSize:10},children:t==null?void 0:t.toUpperCase()})},{title:"",width:110,render:(t,o)=>e.jsxs(re,{size:4,children:[s.status!=="paid"&&e.jsx(Ie,{title:"Edit allowances / deductions",children:e.jsx(h,{size:"small",icon:e.jsx(Be,{}),onClick:()=>Ce(s,o)})}),e.jsx(h,{size:"small",icon:e.jsx(Te,{}),onClick:()=>be(s._id,o._id,o.name,s.month,s.year),children:"PDF"})]})}];return e.jsxs("div",{style:{padding:24},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx(Me,{level:4,style:{margin:0,color:"#034D57"},children:"Payroll"}),e.jsx(h,{type:"primary",icon:e.jsx(ue,{}),onClick:()=>I(!0),style:{background:"#034D57",borderColor:"#034D57"},children:"Generate Payroll Run"})]}),p&&e.jsx(ie,{gutter:12,style:{marginBottom:18},children:[{label:`Headcount (${b[(p.month||1)-1]} ${p.year})`,value:p.headcount,prefix:e.jsx(le,{}),color:"#034D57"},{label:"Latest Gross Pay",value:(te=p.totalGross)==null?void 0:te.toFixed(3),prefix:e.jsx(c,{size:13}),color:"#1a1a1a"},{label:"Latest Deductions",value:(se=p.totalDeductions)==null?void 0:se.toFixed(3),prefix:e.jsx(c,{size:13}),color:"#e53e3e"},{label:"Latest Net Pay",value:(oe=p.totalNet)==null?void 0:oe.toFixed(3),prefix:e.jsx(c,{size:13}),color:"#4CB480"},{label:"PASI Employer Cost",value:(p.totalPasiEmployer||0).toFixed(3),prefix:e.jsx(c,{size:13}),color:"#b7700a"}].map((s,t)=>e.jsx(L,{span:Math.floor(24/5),children:e.jsxs(Fe,{size:"small",bodyStyle:{padding:"10px 14px"},children:[e.jsx("div",{style:{fontSize:10,color:"#888",textTransform:"uppercase",marginBottom:4},children:s.label}),e.jsxs("div",{style:{fontSize:18,fontWeight:700,color:s.color},children:[s.prefix," ",s.value]})]})},t))}),e.jsx(ce,{columns:Ae,dataSource:u,rowKey:"_id",loading:_,size:"small",pagination:!1,expandable:{expandedRowKeys:w?[w]:[],onExpand:(s,t)=>$(o=>o===t._id?null:t._id),expandedRowRender:s=>e.jsx("div",{style:{padding:"8px 0 12px"},children:e.jsx(ce,{size:"small",pagination:!1,dataSource:s.paySlips||[],rowKey:"_id",columns:De(s)})})}}),e.jsx(pe,{title:"Generate Monthly Payroll",open:xe,onCancel:()=>I(!1),onOk:ge,okText:"Generate",confirmLoading:fe,okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:e.jsxs(v,{form:G,layout:"vertical",style:{marginTop:12},children:[e.jsxs(ie,{gutter:12,children:[e.jsx(L,{span:12,children:e.jsx(v.Item,{name:"month",label:"Month",rules:[{required:!0}],children:e.jsx(ne,{options:b.map((s,t)=>({value:t+1,label:s})),placeholder:"Select month"})})}),e.jsx(L,{span:12,children:e.jsx(v.Item,{name:"year",label:"Year",initialValue:ke().year(),rules:[{required:!0}],children:e.jsx(P,{style:{width:"100%"},min:2020,max:2100})})})]}),e.jsx(Ee,{type:"info",showIcon:!0,style:{fontSize:12},message:"Automatically generates pay slips for all active employees. Includes standard allowances from their profile, and deducts absences from attendance records."})]})}),i&&e.jsxs(pe,{title:e.jsxs("span",{children:["Edit Pay Slip â€” ",e.jsx("strong",{style:{color:"#034D57"},children:i.slip.name}),e.jsxs(f,{type:"secondary",style:{fontSize:12,marginLeft:8},children:[b[(i.run.month||1)-1]," ",i.run.year]})]}),open:!!i,onCancel:()=>B(null),onOk:we,okText:"Save Changes",confirmLoading:je,width:700,okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:[e.jsxs("div",{style:{background:"#f0f6f7",borderRadius:6,padding:"10px 14px",marginBottom:16,display:"flex",gap:24},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"Basic"}),e.jsx("div",{style:{fontWeight:700},children:e.jsxs(e.Fragment,{children:[e.jsx(c,{size:12})," ",C(i.slip.basicSalary)]})})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"+ Allowances"}),e.jsx("div",{style:{fontWeight:700,color:"#047857"},children:e.jsxs(e.Fragment,{children:[e.jsx(c,{size:12})," ",C(T(j)+A)]})})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"Gross"}),e.jsx("div",{style:{fontWeight:700},children:e.jsxs(e.Fragment,{children:[e.jsx(c,{size:12})," ",C(X)]})})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"â€“ Deductions"}),e.jsx("div",{style:{fontWeight:700,color:"#e53e3e"},children:e.jsxs(e.Fragment,{children:[e.jsx(c,{size:12})," ",C(ee)]})})]}),e.jsxs("div",{style:{marginLeft:"auto",textAlign:"right"},children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"NET PAY"}),e.jsx("div",{style:{fontWeight:800,fontSize:18,color:"#034D57"},children:e.jsxs(e.Fragment,{children:[e.jsx(c,{size:14})," ",C(ze)]})})]})]}),e.jsx(Ne,{items:[{key:"allowances",label:e.jsxs("span",{children:["ðŸ’° Allowances (",j.length,")"]}),children:e.jsxs("div",{children:[e.jsx(f,{type:"secondary",style:{fontSize:11,display:"block",marginBottom:10},children:"Add housing, transport, food, phone, bonus or any custom allowance."}),e.jsx(Q,{items:j,setItems:U,types:Re,addLabel:"Add Allowance"}),e.jsx(Oe,{style:{margin:"12px 0"}}),e.jsxs("div",{style:{display:"flex",gap:16,alignItems:"flex-end"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:11,color:"#888",marginBottom:4},children:"Overtime Hours"}),e.jsx(P,{size:"small",min:0,precision:2,value:Y,onChange:s=>K(s||0),addonAfter:"hrs",style:{width:120}})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:11,color:"#888",marginBottom:4},children:"Overtime Amount"}),e.jsx(P,{size:"small",min:0,precision:3,value:A,onChange:s=>V(s||0),addonBefore:"OMR",style:{width:150}})]})]})]})},{key:"deductions",label:e.jsxs("span",{children:[e.jsx(he,{})," Deductions (",z.length,")"]}),children:e.jsxs("div",{children:[e.jsx(f,{type:"secondary",style:{fontSize:11,display:"block",marginBottom:10},children:"PASI is auto-calculated from employee settings. Add absence, advances, or custom deductions here."}),e.jsx(Q,{items:z,setItems:W,types:$e,addLabel:"Add Deduction"})]})},{key:"notes",label:"Notes",children:e.jsx(v.Item,{label:"Internal notes (shown on pay slip)",children:e.jsx(de.TextArea,{rows:4,value:q,onChange:s=>Z(s.target.value),placeholder:"e.g. Includes Ramadan bonus, partial month..."})})}]})]})]})}export{rt as default};
