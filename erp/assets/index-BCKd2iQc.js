import{r as o,j as t}from"./index-P0d3qDOI.js";import{o as M}from"./omrFormat-DsLViM07.js";import{d as c}from"./dayjs.min-JkzBIzl3.js";import{b8 as l,aB as p,aM as J,aL as x,ch as L,aW as q,aY as W,aV as d}from"./IdurarOs-C9Hfvmhw.js";import{F as I}from"./Table-cLwJzRkI.js";import{M as w}from"./index-CqP-1A0t.js";import{C as g}from"./index-D7ycNofp.js";import{S as y}from"./index-B9Siwb96.js";import{A as K}from"./index-lSvV4oKT.js";import{ab as U,T as A,f as V}from"./ErpApp-DhsEC5_U.js";import{T as G}from"./index-CDFo9eRn.js";import{D as Q}from"./index-Brfpr6wL.js";import{s as u}from"./index-GLktio_A.js";import{P as X}from"./PlusOutlined-7jHXhlhV.js";import{C as Z}from"./CheckCircleOutlined-C1gnfKMP.js";import"./ActionButton-I_KEJ-cH.js";import"./fade-BGkIwWik.js";import"./Skeleton-HlVWT2JN.js";import"./index-uRPskGn0.js";const{Title:T,Text:Se}=W,{RangePicker:ee}=Q;function S(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function j(){return{...S(),"Content-Type":"application/json"}}function ke(){var B,D;const[R,Y]=o.useState([]),[P,F]=o.useState([]),[O,k]=o.useState(!1),[s,r]=o.useState(null),[$,h]=o.useState(!1),[_,b]=o.useState(!1),[C]=l.useForm(),f=async()=>{k(!0);const[e,a]=await Promise.all([fetch(d+"bankreconciliation/list?items=20",{headers:S()}).then(n=>n.json()).catch(()=>({})),fetch(d+"bankaccount/list",{headers:S()}).then(n=>n.json()).catch(()=>({}))]);e.success&&Y(e.result||[]),a.success&&F(a.result||[]),k(!1)};o.useEffect(()=>{f()},[]);const N=async()=>{let e;try{e=await C.validateFields()}catch{return}b(!0);try{const a={bankAccountId:e.bankAccountId,periodStart:e.period[0].toISOString(),periodEnd:e.period[1].toISOString(),statementBalance:e.statementBalance},n=await fetch(d+"bankreconciliation/start",{method:"POST",headers:j(),body:JSON.stringify(a)}).then(i=>i.json());n.success?(u.success(n.message),h(!1),r(n.result),f()):u.error(n.message||"Failed")}finally{b(!1)}},z=async(e,a)=>{const n=await fetch(`${d}bankreconciliation/update-items/${e}`,{method:"PATCH",headers:j(),body:JSON.stringify({clearedItems:a})}).then(i=>i.json()).catch(()=>({}));n.success&&r(n.result)},E=async e=>{const a=await fetch(`${d}bankreconciliation/complete/${e}`,{method:"PATCH",headers:j()}).then(n=>n.json()).catch(()=>({}));a.success?(u.success(a.message),r(null),f()):u.error(a.message||"Failed")},v=[{title:"Bank Account",dataIndex:"bankAccount",render:e=>(e==null?void 0:e.accountName)||"—"},{title:"Period",render:(e,a)=>`${c(a.periodStart).format("DD MMM")} – ${c(a.periodEnd).format("DD MMM YYYY")}`},{title:"Statement Balance",dataIndex:"statementBalance",align:"right",render:e=>M(e)},{title:"Difference",dataIndex:"difference",align:"right",render:e=>t.jsx("span",{style:{color:Math.abs(e)<.01?"#4CB480":"#e53e3e",fontWeight:700},children:e==null?void 0:e.toFixed(3)})},{title:"Status",dataIndex:"status",render:e=>t.jsx(A,{color:e==="reconciled"?"success":"default",children:e==null?void 0:e.toUpperCase()})},{title:"",render:(e,a)=>a.status==="draft"&&t.jsx(p,{size:"small",onClick:()=>r(a),style:{color:"#034D57"},children:"Open"})}];return t.jsxs("div",{style:{padding:24},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsxs(T,{level:4,style:{margin:0,color:"#034D57"},children:[t.jsx(U,{style:{marginRight:8}}),"Bank Reconciliation"]}),t.jsx(p,{type:"primary",icon:t.jsx(X,{}),onClick:()=>h(!0),style:{background:"#034D57",borderColor:"#034D57"},children:"Start Reconciliation"})]}),t.jsx(I,{columns:v,dataSource:R,rowKey:"_id",loading:O,size:"small",pagination:!1,onRow:e=>({onClick:()=>e.status==="draft"&&r(e)})}),s&&t.jsxs(w,{title:`Reconciliation — ${c(s.periodStart).format("DD MMM")} to ${c(s.periodEnd).format("DD MMM YYYY")}`,open:!!s,onCancel:()=>r(null),footer:null,width:800,children:[t.jsxs(J,{gutter:16,style:{marginBottom:16},children:[t.jsx(x,{span:8,children:t.jsx(g,{size:"small",children:t.jsx(y,{title:"Statement Balance",value:(B=s.statementBalance)==null?void 0:B.toFixed(3),valueStyle:{color:"#034D57"}})})}),t.jsx(x,{span:8,children:t.jsx(g,{size:"small",children:t.jsx(y,{title:"Cleared Balance",value:(s.statementBalance-s.difference).toFixed(3)})})}),t.jsx(x,{span:8,children:t.jsx(g,{size:"small",children:t.jsx(y,{title:"Difference",value:(D=s.difference)==null?void 0:D.toFixed(3),valueStyle:{color:Math.abs(s.difference)<.01?"#4CB480":"#e53e3e",fontWeight:700}})})})]}),Math.abs(s.difference)<.01&&t.jsx(K,{type:"success",message:"✓ Balanced — ready to reconcile",style:{marginBottom:12}}),t.jsx(T,{level:5,style:{color:"#034D57",marginBottom:8},children:"Transactions — check off what matches your statement"}),t.jsx(I,{size:"small",pagination:!1,dataSource:s.clearedItems||[],rowKey:(e,a)=>a,columns:[{title:"✓",width:40,render:(e,a,n)=>t.jsx(L,{checked:a.cleared,onChange:i=>{const m=[...s.clearedItems];m[n]={...m[n],cleared:i.target.checked};const H={...s,clearedItems:m};r(H),z(s._id,m)}})},{title:"Date",dataIndex:"date",width:100,render:e=>c(e).format("DD MMM YYYY")},{title:"Description",dataIndex:"description",ellipsis:!0},{title:"Type",dataIndex:"type",width:90,render:e=>t.jsx(A,{color:e==="deposit"?"green":"red",children:e})},{title:"Amount",dataIndex:"amount",align:"right",render:e=>M(e)}],rowClassName:e=>e.cleared?"row-cleared":""}),t.jsx(q,{}),t.jsx("div",{style:{textAlign:"right"},children:t.jsx(p,{type:"primary",icon:t.jsx(Z,{}),disabled:Math.abs(s.difference)>.01,onClick:()=>E(s._id),style:{background:"#4CB480",borderColor:"#4CB480"},children:"Complete Reconciliation"})})]}),t.jsx(w,{title:"Start New Reconciliation",open:$,onCancel:()=>h(!1),onOk:N,okText:"Start",confirmLoading:_,okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:t.jsxs(l,{form:C,layout:"vertical",style:{marginTop:12},children:[t.jsx(l.Item,{name:"bankAccountId",label:"Bank Account",rules:[{required:!0}],children:t.jsx(V,{options:P.map(e=>({value:e._id,label:`${e.accountName} (${e.currency})`}))})}),t.jsx(l.Item,{name:"period",label:"Statement Period",rules:[{required:!0}],children:t.jsx(ee,{style:{width:"100%"}})}),t.jsx(l.Item,{name:"statementBalance",label:"Closing Balance on Bank Statement",rules:[{required:!0}],children:t.jsx(G,{style:{width:"100%"},min:0,precision:3,placeholder:"0.000"})})]})})]})}export{ke as default};
