import{r as l,j as e}from"./index-fQzVIFut.js";import{d as le,O as z,e as ne,T as M,r as re,F as Pe}from"./ErpApp-uJl2ak2H.js";import{o as p}from"./omrFormat-DtWAs47D.js";import{d as Te}from"./dayjs.min-DCmJeTl0.js";import{b7 as S,aB as m,aM as ie,aL as R,b9 as ke,a_ as de,aY as _e,aZ as y,ac as Ie,b4 as Be}from"./IdurarOs-2nFZV4nX.js";import{C as Ee}from"./index-CcNtqXvO.js";import{F as ce}from"./Table-DNjCQysA.js";import{M as pe}from"./index-7PnpMk9R.js";import{T as D}from"./index-DkGnqCPT.js";import{A as Ne}from"./index-CljJJlns.js";import{T as Me}from"./index-NwmM02iY.js";import{s as d}from"./index-BaBBykAj.js";import{P as ue}from"./index-DRrDR0F-.js";import{P as me}from"./PlusOutlined-DGREacQj.js";import{D as he}from"./DeleteOutlined-CN22xrpw.js";import{C as Re}from"./CheckCircleOutlined-vp0V0gaR.js";import"./Skeleton-C1nKWVYB.js";import"./ActionButton-Cfpo3yur.js";import"./fade-c2Odf_qr.js";const{Title:Fe,Text:x}=_e;function T(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function F(){return{...T(),"Content-Type":"application/json"}}const ye={draft:"default",approved:"processing",paid:"success"},v=["January","February","March","April","May","June","July","August","September","October","November","December"],Le=["housing","transport","food","phone","bonus","other"],$e=["absence","late","half_day","advance","other"],P=u=>(u||[]).reduce((k,_)=>k+(_.amount||0),0),b=u=>(u||0).toFixed(3);function rt(){var te,se,oe;const[u,k]=l.useState([]),[_,L]=l.useState(!1),[C,$]=l.useState(null),[xe,I]=l.useState(!1),[fe,H]=l.useState(!1),[G]=S.useForm(),[i,B]=l.useState(null),[ge,J]=l.useState(!1),[f,U]=l.useState([]),[w,W]=l.useState([]),[Y,K]=l.useState(0),[A,V]=l.useState(0),[q,Z]=l.useState(""),g=async()=>{L(!0);const s=await fetch(y+"payrollrun/list?items=24",{headers:T()}).then(t=>t.json()).catch(()=>({}));s.success&&k(s.result||[]),L(!1)};l.useEffect(()=>{g()},[]);const c=u[0];u.reduce((s,t)=>({headcount:Math.max(s.headcount,t.headcount||0),gross:s.gross+(t.totalGross||0),deductions:s.deductions+(t.totalDeductions||0),net:s.net+(t.totalNet||0)}),{headcount:0,gross:0,deductions:0,net:0});const je=async()=>{let s;try{s=await G.validateFields()}catch{return}H(!0);try{const t=await fetch(y+"payroll/generate",{method:"POST",headers:F(),body:JSON.stringify(s)}).then(o=>o.json());t.success?(d.success(t.message),I(!1),g()):d.error(t.message||"Failed")}finally{H(!1)}},Se=async s=>{const t=await fetch(`${y}payroll/approve/${s}`,{method:"PATCH",headers:T()}).then(o=>o.json()).catch(()=>({}));t.success?(d.success(t.message),g()):d.error(t.message)},ve=async s=>{const t=await fetch(`${y}payroll/mark-paid/${s}`,{method:"PATCH",headers:F(),body:JSON.stringify({paidVia:"Bank Transfer"})}).then(o=>o.json()).catch(()=>({}));t.success?(d.success(t.message),g()):d.error(t.message)},be=async(s,t,o,h,E)=>{try{const O=await fetch(`${y}payroll/payslip-pdf/${s}/${t}`,{headers:T()});if(!O.ok){d.error("PDF generation failed");return}const j=await O.blob(),n=URL.createObjectURL(j),a=document.createElement("a");a.href=n,a.download=`PaySlip-${o.replace(/\s+/g,"-")}-${v[h-1]}-${E}.pdf`,a.click(),URL.revokeObjectURL(n)}catch{d.error("PDF download failed")}},Ce=(s,t)=>{B({run:s,slip:t}),U(JSON.parse(JSON.stringify(t.allowances||[]))),W((t.deductions||[]).filter(o=>o.type!=="pasi").map(o=>JSON.parse(JSON.stringify(o)))),K(t.overtimeHours||0),V(t.overtimeAmt||0),Z(t.notes||"")},we=async()=>{if(i){J(!0);try{const s={allowances:f.filter(o=>o.amount>0),deductions:w.filter(o=>o.amount>0),overtimeHours:Y,overtimeAmt:A,notes:q},t=await fetch(`${y}payroll/update-slip/${i.run._id}/${i.slip._id}`,{method:"PATCH",headers:F(),body:JSON.stringify(s)}).then(o=>o.json());t.success?(d.success(t.message),B(null),g()):d.error(t.message||"Failed")}finally{J(!1)}}},Q=({items:s,setItems:t,types:o,addLabel:h})=>{const E=()=>t(n=>[...n,{type:o[0],description:"",amount:0}]),O=n=>t(a=>a.filter((r,N)=>N!==n)),j=(n,a,r)=>t(N=>N.map((ae,De)=>De===n?{...ae,[a]:r}:ae));return e.jsxs("div",{children:[s.map((n,a)=>e.jsxs("div",{style:{display:"flex",gap:6,marginBottom:6,alignItems:"center"},children:[e.jsx(ne,{size:"small",style:{width:120},value:n.type,onChange:r=>j(a,"type",r),options:o.map(r=>({value:r,label:r.charAt(0).toUpperCase()+r.slice(1).replace("_"," ")}))}),e.jsx(de,{size:"small",style:{flex:1},placeholder:"Description",value:n.description,onChange:r=>j(a,"description",r.target.value)}),e.jsx(D,{size:"small",style:{width:110},min:0,precision:3,placeholder:"0.000",value:n.amount,onChange:r=>j(a,"amount",r||0),addonBefore:"OMR"}),e.jsx(he,{onClick:()=>O(a),style:{color:"#e53e3e",cursor:"pointer",fontSize:14}})]},a)),e.jsx(m,{size:"small",icon:e.jsx(me,{}),onClick:E,style:{marginTop:4},children:h})]})},X=i?(i.slip.basicSalary||0)+P(f)+(A||0):0,ee=P(w),Ae=Math.max(0,X-ee),Oe=[{title:"Period",render:(s,t)=>e.jsxs(x,{strong:!0,style:{color:"#034D57"},children:[v[t.month-1]," ",t.year]})},{title:"Headcount",dataIndex:"headcount",align:"center",render:s=>e.jsx(M,{icon:e.jsx(le,{}),children:s})},{title:"Gross Pay",dataIndex:"totalGross",align:"right",render:s=>p(s)},{title:"PASI (Emp)",dataIndex:"totalPasiEmployee",align:"right",render:s=>s>0?e.jsx("span",{style:{color:"#b7700a",fontSize:12},children:p(s)}):e.jsx("span",{style:{color:"#ccc"},children:"â€”"})},{title:"Deductions",dataIndex:"totalDeductions",align:"right",render:s=>s>0?e.jsx("span",{style:{color:"#e53e3e"},children:p(s)}):"â€”"},{title:"Net Pay",dataIndex:"totalNet",align:"right",render:s=>e.jsx("strong",{style:{color:"#4CB480"},children:p(s)})},{title:"Status",dataIndex:"status",render:s=>e.jsx(M,{color:ye[s],children:s==null?void 0:s.toUpperCase()})},{title:"",width:220,render:(s,t)=>e.jsxs(re,{size:4,children:[t.status==="draft"&&e.jsx(ue,{title:"Approve this payroll run?",onConfirm:()=>Se(t._id),okText:"Approve",children:e.jsx(m,{size:"small",type:"primary",style:{background:"#034D57",borderColor:"#034D57"},icon:e.jsx(Re,{}),children:"Approve"})}),t.status==="approved"&&e.jsx(ue,{title:"Mark all pay slips as paid?",onConfirm:()=>ve(t._id),okText:"Confirm",children:e.jsx(m,{size:"small",style:{background:"#4CB480",borderColor:"#4CB480",color:"#fff"},children:"Mark Paid"})}),e.jsx(m,{size:"small",onClick:()=>$(C===t._id?null:t._id),children:C===t._id?"Close":"View Slips"})]})}],ze=s=>[{title:"Employee",render:(t,o)=>e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:o.name}),e.jsxs(x,{type:"secondary",style:{fontSize:11},children:[o.department," Â· ",o.employeeId]})]})},{title:"Attendance",align:"center",render:(t,o)=>e.jsxs(x,{style:{fontSize:11},children:[e.jsxs("span",{style:{color:"#4CB480"},children:["âœ“",o.workingDays||0]})," ",e.jsxs("span",{style:{color:"#e53e3e"},children:["âœ—",o.absentDays||0]}),o.overtimeHours>0&&e.jsxs("span",{style:{color:"#b7700a"},children:[" OT:",(o.overtimeHours||0).toFixed(1),"h"]})]})},{title:"Basic",dataIndex:"basicSalary",align:"right",render:t=>p(t)},{title:"Allowances",align:"right",render:(t,o)=>{const h=P(o.allowances)+(o.overtimeAmt||0);return h>0?e.jsx("span",{style:{color:"#047857"},children:p(h)}):"â€”"}},{title:"Deductions",align:"right",render:(t,o)=>o.totalDeductions>0?e.jsx("span",{style:{color:"#e53e3e"},children:p(o.totalDeductions)}):"â€”"},{title:"Net Pay",dataIndex:"netPay",align:"right",render:t=>e.jsx("strong",{style:{color:"#4CB480"},children:p(t)})},{title:"Status",dataIndex:"status",render:t=>e.jsx(M,{color:ye[t],style:{fontSize:10},children:t==null?void 0:t.toUpperCase()})},{title:"",width:110,render:(t,o)=>e.jsxs(re,{size:4,children:[s.status!=="paid"&&e.jsx(Ie,{title:"Edit allowances / deductions",children:e.jsx(m,{size:"small",icon:e.jsx(Be,{}),onClick:()=>Ce(s,o)})}),e.jsx(m,{size:"small",icon:e.jsx(Pe,{}),onClick:()=>be(s._id,o._id,o.name,s.month,s.year),children:"PDF"})]})}];return e.jsxs("div",{style:{padding:24},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx(Fe,{level:4,style:{margin:0,color:"#034D57"},children:"Payroll"}),e.jsx(m,{type:"primary",icon:e.jsx(me,{}),onClick:()=>I(!0),style:{background:"#034D57",borderColor:"#034D57"},children:"Generate Payroll Run"})]}),c&&e.jsx(ie,{gutter:12,style:{marginBottom:18},children:[{label:`Headcount (${v[(c.month||1)-1]} ${c.year})`,value:c.headcount,prefix:e.jsx(le,{}),color:"#034D57"},{label:"Latest Gross Pay",value:(te=c.totalGross)==null?void 0:te.toFixed(3),prefix:e.jsx(z,{size:13}),color:"#1a1a1a"},{label:"Latest Deductions",value:(se=c.totalDeductions)==null?void 0:se.toFixed(3),prefix:e.jsx(z,{size:13}),color:"#e53e3e"},{label:"Latest Net Pay",value:(oe=c.totalNet)==null?void 0:oe.toFixed(3),prefix:e.jsx(z,{size:13}),color:"#4CB480"},{label:"PASI Employer Cost",value:(c.totalPasiEmployer||0).toFixed(3),prefix:e.jsx(z,{size:13}),color:"#b7700a"}].map((s,t)=>e.jsx(R,{span:Math.floor(24/5),children:e.jsxs(Ee,{size:"small",bodyStyle:{padding:"10px 14px"},children:[e.jsx("div",{style:{fontSize:10,color:"#888",textTransform:"uppercase",marginBottom:4},children:s.label}),e.jsxs("div",{style:{fontSize:18,fontWeight:700,color:s.color},children:[s.prefix," ",s.value]})]})},t))}),e.jsx(ce,{columns:Oe,dataSource:u,rowKey:"_id",loading:_,size:"small",pagination:!1,expandable:{expandedRowKeys:C?[C]:[],onExpand:(s,t)=>$(o=>o===t._id?null:t._id),expandedRowRender:s=>e.jsx("div",{style:{padding:"8px 0 12px"},children:e.jsx(ce,{size:"small",pagination:!1,dataSource:s.paySlips||[],rowKey:"_id",columns:ze(s)})})}}),e.jsx(pe,{title:"Generate Monthly Payroll",open:xe,onCancel:()=>I(!1),onOk:je,okText:"Generate",confirmLoading:fe,okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:e.jsxs(S,{form:G,layout:"vertical",style:{marginTop:12},children:[e.jsxs(ie,{gutter:12,children:[e.jsx(R,{span:12,children:e.jsx(S.Item,{name:"month",label:"Month",rules:[{required:!0}],children:e.jsx(ne,{options:v.map((s,t)=>({value:t+1,label:s})),placeholder:"Select month"})})}),e.jsx(R,{span:12,children:e.jsx(S.Item,{name:"year",label:"Year",initialValue:Te().year(),rules:[{required:!0}],children:e.jsx(D,{style:{width:"100%"},min:2020,max:2100})})})]}),e.jsx(Ne,{type:"info",showIcon:!0,style:{fontSize:12},message:"Automatically generates pay slips for all active employees. Includes standard allowances from their profile, and deducts absences from attendance records."})]})}),i&&e.jsxs(pe,{title:e.jsxs("span",{children:["Edit Pay Slip â€” ",e.jsx("strong",{style:{color:"#034D57"},children:i.slip.name}),e.jsxs(x,{type:"secondary",style:{fontSize:12,marginLeft:8},children:[v[(i.run.month||1)-1]," ",i.run.year]})]}),open:!!i,onCancel:()=>B(null),onOk:we,okText:"Save Changes",confirmLoading:ge,width:700,okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:[e.jsxs("div",{style:{background:"#f0f6f7",borderRadius:6,padding:"10px 14px",marginBottom:16,display:"flex",gap:24},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"Basic"}),e.jsxs("div",{style:{fontWeight:700},children:["OMR ",b(i.slip.basicSalary)]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"+ Allowances"}),e.jsxs("div",{style:{fontWeight:700,color:"#047857"},children:["OMR ",b(P(f)+A)]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"Gross"}),e.jsxs("div",{style:{fontWeight:700},children:["OMR ",b(X)]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"â€“ Deductions"}),e.jsxs("div",{style:{fontWeight:700,color:"#e53e3e"},children:["OMR ",b(ee)]})]}),e.jsxs("div",{style:{marginLeft:"auto",textAlign:"right"},children:[e.jsx("div",{style:{fontSize:10,color:"#888"},children:"NET PAY"}),e.jsxs("div",{style:{fontWeight:800,fontSize:18,color:"#034D57"},children:["OMR ",b(Ae)]})]})]}),e.jsx(Me,{items:[{key:"allowances",label:e.jsxs("span",{children:["ðŸ’° Allowances (",f.length,")"]}),children:e.jsxs("div",{children:[e.jsx(x,{type:"secondary",style:{fontSize:11,display:"block",marginBottom:10},children:"Add housing, transport, food, phone, bonus or any custom allowance."}),e.jsx(Q,{items:f,setItems:U,types:Le,addLabel:"Add Allowance"}),e.jsx(ke,{style:{margin:"12px 0"}}),e.jsxs("div",{style:{display:"flex",gap:16,alignItems:"flex-end"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:11,color:"#888",marginBottom:4},children:"Overtime Hours"}),e.jsx(D,{size:"small",min:0,precision:2,value:Y,onChange:s=>K(s||0),addonAfter:"hrs",style:{width:120}})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:11,color:"#888",marginBottom:4},children:"Overtime Amount"}),e.jsx(D,{size:"small",min:0,precision:3,value:A,onChange:s=>V(s||0),addonBefore:"OMR",style:{width:150}})]})]})]})},{key:"deductions",label:e.jsxs("span",{children:[e.jsx(he,{})," Deductions (",w.length,")"]}),children:e.jsxs("div",{children:[e.jsx(x,{type:"secondary",style:{fontSize:11,display:"block",marginBottom:10},children:"PASI is auto-calculated from employee settings. Add absence, advances, or custom deductions here."}),e.jsx(Q,{items:w,setItems:W,types:$e,addLabel:"Add Deduction"})]})},{key:"notes",label:"Notes",children:e.jsx(S.Item,{label:"Internal notes (shown on pay slip)",children:e.jsx(de.TextArea,{rows:4,value:q,onChange:s=>Z(s.target.value),placeholder:"e.g. Includes Ramadan bonus, partial month..."})})}]})]})]})}export{rt as default};
