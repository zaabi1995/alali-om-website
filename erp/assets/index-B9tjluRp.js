import{r,j as e}from"./index-P0d3qDOI.js";import{d as A}from"./dayjs.min-JkzBIzl3.js";import{b8 as l,aB as L,aM as B,aL as y,aY as ne,aX as oe,aV as m,Q as ie,C as ce}from"./IdurarOs-C9Hfvmhw.js";import{C as h}from"./index-D7ycNofp.js";import{S as f}from"./index-B9Siwb96.js";import{F as de}from"./Table-cLwJzRkI.js";import{M as E}from"./index-CqP-1A0t.js";import{a1 as ue,C as me,f as w,T as F,l as pe}from"./ErpApp-DhsEC5_U.js";import{D as ye}from"./index-Brfpr6wL.js";import{s as i}from"./index-GLktio_A.js";import{P as he}from"./PlusOutlined-7jHXhlhV.js";import"./Skeleton-HlVWT2JN.js";import"./index-uRPskGn0.js";import"./ActionButton-I_KEJ-cH.js";import"./fade-BGkIwWik.js";const{Title:fe,Text:p}=ne,{RangePicker:je}=ye,{TextArea:D}=oe;function x(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function k(){return{...x(),"Content-Type":"application/json"}}const xe={annual:"blue",sick:"orange",emergency:"red",unpaid:"default",maternity:"purple",paternity:"cyan"},ge={draft:"default",pending:"orange",approved:"green",rejected:"red"},ve=[{value:"annual",label:"Annual Leave"},{value:"sick",label:"Sick Leave"},{value:"emergency",label:"Emergency Leave"},{value:"unpaid",label:"Unpaid Leave"},{value:"maternity",label:"Maternity Leave"},{value:"paternity",label:"Paternity Leave"}];function Ae(){const[Y,_]=r.useState([]),[d,$]=r.useState(null),[n,N]=r.useState(null),[U,J]=r.useState([]),[H,T]=r.useState(!1),[V,S]=r.useState(!1),[K,C]=r.useState(!1),[Q,W]=r.useState(null),[X,q]=r.useState(!1),[b]=l.useForm(),[R]=l.useForm(),[g,O]=r.useState(null),[P,I]=r.useState(0),z=(JSON.parse(localStorage.getItem("auth"))||{}).current||{},G=z.role||"staff",j=z.admin||{},o=["manager","gm","admin","owner"].includes(G),v=async()=>{T(!0);try{const t=o?"":`?employeeId=${j.employeeId||""}`,[s,a,u]=await Promise.all([fetch(m+`leaverequest/list${t}`,{headers:x()}).then(c=>c.json()).catch(()=>({})),fetch(m+"leaverequest/stats",{headers:x()}).then(c=>c.json()).catch(()=>({})),o?fetch(m+"employee/list?items=200",{headers:x()}).then(c=>c.json()).catch(()=>({})):Promise.resolve({})]);if(s.success&&_(s.result||[]),a.success&&$(a.result),u.success&&J(u.result||[]),!o&&j.employeeId){const c=await fetch(m+`leaverequest/balance/${j.employeeId}`,{headers:x()}).then(le=>le.json()).catch(()=>({}));c.success&&N(c.result)}}finally{T(!1)}};r.useEffect(()=>{v()},[]);const Z=()=>{b.resetFields(),O(null),I(0),S(!0)},ee=async()=>{let t;try{t=await b.validateFields()}catch{return}!o&&j.employeeId&&(t.employee=j.employeeId),g&&g.length===2&&(t.fromDate=g[0].toISOString(),t.toDate=g[1].toISOString()),q(!0);try{const s=await fetch(m+"leaverequest/create",{method:"POST",headers:k(),body:JSON.stringify(t)}).then(a=>a.json());s.success?(i.success(s.message||"Leave request created"),S(!1),v()):i.error(s.message||"Failed to create leave request")}catch{i.error("Request failed")}finally{q(!1)}},te=async t=>{try{const s=await fetch(m+`leaverequest/approve/${t}`,{method:"PATCH",headers:k()}).then(a=>a.json());s.success?(i.success("Leave request approved"),v()):i.error(s.message||"Failed to approve")}catch{i.error("Request failed")}},se=t=>{W(t),R.resetFields(),C(!0)},ae=async()=>{let t;try{t=await R.validateFields()}catch{return}try{const s=await fetch(m+`leaverequest/reject/${Q}`,{method:"PATCH",headers:k(),body:JSON.stringify(t)}).then(a=>a.json());s.success?(i.success("Leave request rejected"),C(!1),v()):i.error(s.message||"Failed to reject")}catch{i.error("Request failed")}},re=t=>{if(O(t),t&&t.length===2){const s=t[0],u=t[1].diff(s,"day")+1;I(u)}else I(0)},M=[{title:"Leave #",dataIndex:"leaveNumber",width:100,render:t=>e.jsx(p,{code:!0,style:{fontSize:11},children:t})},{title:"Employee",render:(t,s)=>{var a,u;return e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:s.employeeName||((a=s.employee)==null?void 0:a.name)||"—"}),((u=s.employee)==null?void 0:u.department)&&e.jsx(p,{type:"secondary",style:{fontSize:11},children:s.employee.department})]})}},{title:"Type",dataIndex:"leaveType",width:130,render:t=>e.jsx(F,{color:xe[t]||"default",children:t==null?void 0:t.toUpperCase().replace("_"," ")})},{title:"From",dataIndex:"fromDate",width:110,render:t=>t?A(t).format("DD MMM YYYY"):"—"},{title:"To",dataIndex:"toDate",width:110,render:t=>t?A(t).format("DD MMM YYYY"):"—"},{title:"Days",dataIndex:"days",width:70,align:"center",render:t=>e.jsx(p,{strong:!0,style:{color:"#034D57"},children:t||0})},{title:"Reason",dataIndex:"reason",ellipsis:!0,render:t=>e.jsx(p,{style:{fontSize:12},children:t})},{title:"Status",dataIndex:"status",width:100,render:t=>e.jsx(F,{color:ge[t]||"default",children:t==null?void 0:t.toUpperCase()})}];return o&&M.push({title:"Actions",key:"actions",width:120,render:(t,s)=>s.status==="pending"?e.jsxs(pe,{size:4,children:[e.jsx(L,{size:"small",type:"primary",icon:e.jsx(ie,{}),onClick:()=>te(s._id),style:{background:"#4CB480",borderColor:"#4CB480"},children:"Approve"}),e.jsx(L,{size:"small",danger:!0,icon:e.jsx(ce,{}),onClick:()=>se(s._id),children:"Reject"})]}):e.jsx(p,{type:"secondary",style:{fontSize:11},children:"—"})}),e.jsxs("div",{style:{padding:24},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx(fe,{level:4,style:{margin:0,color:"#034D57"},children:o?"Leave Management":"My Leave Requests"}),e.jsx(L,{type:"primary",icon:e.jsx(he,{}),onClick:Z,style:{background:"#034D57",borderColor:"#034D57"},children:"Apply for Leave"})]}),!o&&n&&e.jsxs(B,{gutter:[12,12],style:{marginBottom:16},children:[e.jsx(y,{xs:24,sm:12,children:e.jsxs(h,{size:"small",style:{borderLeft:"4px solid #034D57"},children:[e.jsx(f,{title:"Annual Leave",value:`${n.annual.remaining} / ${n.annual.total}`,suffix:"days",valueStyle:{color:n.annual.remaining>0?"#4CB480":"#e53e3e",fontSize:20},prefix:e.jsx(ue,{})}),e.jsxs(p,{type:"secondary",style:{fontSize:11},children:["Used: ",n.annual.used," days"]})]})}),e.jsx(y,{xs:24,sm:12,children:e.jsxs(h,{size:"small",style:{borderLeft:"4px solid #4CB480"},children:[e.jsx(f,{title:"Sick Leave",value:`${n.sick.remaining} / ${n.sick.total}`,suffix:"days",valueStyle:{color:n.sick.remaining>0?"#034D57":"#e53e3e",fontSize:20},prefix:e.jsx(me,{})}),e.jsxs(p,{type:"secondary",style:{fontSize:11},children:["Used: ",n.sick.used," days"]})]})})]}),o&&d&&e.jsxs(B,{gutter:[12,12],style:{marginBottom:16},children:[e.jsx(y,{xs:12,sm:6,children:e.jsx(h,{size:"small",children:e.jsx(f,{title:"Pending",value:d.pending,valueStyle:{color:"#fa8c16"}})})}),e.jsx(y,{xs:12,sm:6,children:e.jsx(h,{size:"small",children:e.jsx(f,{title:"Approved",value:d.approved,valueStyle:{color:"#4CB480"}})})}),e.jsx(y,{xs:12,sm:6,children:e.jsx(h,{size:"small",children:e.jsx(f,{title:"Rejected",value:d.rejected,valueStyle:{color:"#e53e3e"}})})}),e.jsx(y,{xs:12,sm:6,children:e.jsx(h,{size:"small",children:e.jsx(f,{title:"Total Requests",value:d.pending+d.approved+d.rejected,valueStyle:{color:"#034D57"}})})})]}),e.jsx(de,{columns:M,dataSource:Y,rowKey:"_id",loading:H,pagination:{pageSize:20,showSizeChanger:!0},size:"small"}),e.jsx(E,{title:"Apply for Leave",open:V,onOk:ee,onCancel:()=>S(!1),confirmLoading:X,width:600,okText:"Submit Request",okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:e.jsxs(l,{form:b,layout:"vertical",style:{marginTop:16},children:[o&&e.jsx(l.Item,{label:"Employee",name:"employee",rules:[{required:!0,message:"Please select employee"}],children:e.jsx(w,{placeholder:"Select employee",showSearch:!0,optionFilterProp:"children",children:U.map(t=>e.jsxs(w.Option,{value:t._id,children:[t.name," ",t.employeeId&&`(${t.employeeId})`]},t._id))})}),e.jsx(l.Item,{label:"Leave Type",name:"leaveType",initialValue:"annual",rules:[{required:!0,message:"Please select leave type"}],children:e.jsx(w,{options:ve})}),e.jsx(l.Item,{label:"Date Range",required:!0,help:P>0?`${P} day(s) requested`:null,children:e.jsx(je,{style:{width:"100%"},onChange:re,format:"DD MMM YYYY"})}),e.jsx(l.Item,{label:"Reason",name:"reason",rules:[{required:!0,message:"Please provide a reason"}],children:e.jsx(D,{rows:3,placeholder:"Brief explanation for your leave request"})}),e.jsx(l.Item,{label:"Additional Notes (Optional)",name:"notes",children:e.jsx(D,{rows:2,placeholder:"Any additional information"})})]})}),e.jsx(E,{title:"Reject Leave Request",open:K,onOk:ae,onCancel:()=>C(!1),okText:"Confirm Rejection",okButtonProps:{danger:!0},children:e.jsx(l,{form:R,layout:"vertical",style:{marginTop:16},children:e.jsx(l.Item,{label:"Reason for Rejection",name:"reason",rules:[{required:!0,message:"Please provide a reason"}],children:e.jsx(D,{rows:3,placeholder:"Explain why this leave request is being rejected"})})})})]})}export{Ae as default};
