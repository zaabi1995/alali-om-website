import{m as E,r as o,j as e}from"./index-CZE4Emnq.js";import{aM as Y,aL as f,aY as $,aX as V,aV as v,aB as m,b4 as H}from"./IdurarOs-QyX9qaVp.js";import{d as J}from"./dayjs.min-CnUzT33n.js";import{C as g,O as K,l as U,T as y}from"./ErpApp-C4nlOv7S.js";import{C as j}from"./index-CJVnROOn.js";import{S as C}from"./index-D-f7_sak.js";import{F as X}from"./Table-B0OV9lnU.js";import{M as G}from"./index-D_Iny5RF.js";import{s as n}from"./index-DYgSJ7qL.js";import{C as W}from"./CheckCircleOutlined-Fxl9gZvu.js";import{C as Z}from"./CloseCircleOutlined-DZzDPP8J.js";import"./Skeleton-NJ_axQXU.js";import"./index-DHJTYrEo.js";import"./PlusOutlined-DNId2NLQ.js";import"./ActionButton-43bIcezm.js";import"./fade-C5VLvKC6.js";const{Title:ee}=$,{TextArea:te}=V;function w(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function B(l){return typeof l!="number"?"â€”":e.jsxs("span",{style:{whiteSpace:"nowrap"},children:[e.jsx(K,{})," ",l.toFixed(3)]})}function fe(){var b,q;const l=E(),[S,k]=o.useState([]),[O,A]=o.useState(!1),[_,Q]=o.useState({pending_manager:0,pending_owner:0}),[M,d]=o.useState(!1),[s,R]=o.useState("approve"),[a,c]=o.useState(null),[p,i]=o.useState(""),[F,u]=o.useState(!1),x=async()=>{A(!0);try{const r=await(await fetch(v+"quote/approval-queue",{headers:w()})).json();if(r.success){k(r.result||[]);const z=r.result.filter(h=>h.approvalStatus==="pending_manager").length,D=r.result.filter(h=>h.approvalStatus==="pending_owner").length;Q({pending_manager:z,pending_owner:D})}}catch{n.error("Failed to load approval queue")}finally{A(!1)}};o.useEffect(()=>{x()},[]);const I=async()=>{if(a){u(!0);try{const r=await(await fetch(v+`quote/approve/${a._id}`,{method:"PATCH",headers:{...w(),"Content-Type":"application/json"},body:JSON.stringify({notes:p})})).json();r.success?(n.success("Quote approved successfully"),d(!1),i(""),c(null),x()):n.error(r.message||"Failed to approve quote")}catch{n.error("Failed to approve quote")}finally{u(!1)}}},L=async()=>{if(!a||!p.trim()){n.warning("Rejection notes are required");return}u(!0);try{const r=await(await fetch(v+`quote/reject/${a._id}`,{method:"PATCH",headers:{...w(),"Content-Type":"application/json"},body:JSON.stringify({notes:p})})).json();r.success?(n.success("Quote rejected"),d(!1),i(""),c(null),x()):n.error(r.message||"Failed to reject quote")}catch{n.error("Failed to reject quote")}finally{u(!1)}},T=(t,r)=>{R(t),c(r),i(""),d(!0)},N=t=>t==="pending_manager"?e.jsx(y,{color:"orange",icon:e.jsx(g,{}),children:"Manager Approval"}):t==="pending_owner"?e.jsx(y,{color:"red",icon:e.jsx(g,{}),children:"Owner Approval"}):e.jsx(y,{children:t}),P=[{title:"Quote #",dataIndex:"number",width:100,render:(t,r)=>e.jsxs(m,{type:"link",onClick:()=>l(`/quote/read/${r._id}`),children:["#",t]})},{title:"Client",dataIndex:["client","name"],render:t=>e.jsx("strong",{children:t})},{title:"Date",dataIndex:"date",width:120,render:t=>J(t).format("DD/MM/YYYY")},{title:"Total",dataIndex:"total",width:130,align:"right",render:t=>B(t),sorter:(t,r)=>t.total-r.total},{title:"Approval Level",dataIndex:"approvalStatus",width:170,render:t=>N(t),filters:[{text:"Manager Approval",value:"pending_manager"},{text:"Owner Approval",value:"pending_owner"}],onFilter:(t,r)=>r.approvalStatus===t},{title:"Created By",dataIndex:["createdBy","name"],width:150},{title:"Actions",key:"actions",width:200,render:(t,r)=>e.jsxs(U,{children:[e.jsx(m,{type:"primary",icon:e.jsx(W,{}),size:"small",onClick:()=>T("approve",r),style:{backgroundColor:"#4CB480",borderColor:"#4CB480"},children:"Approve"}),e.jsx(m,{danger:!0,icon:e.jsx(Z,{}),size:"small",onClick:()=>T("reject",r),children:"Reject"}),e.jsx(m,{icon:e.jsx(H,{}),size:"small",onClick:()=>l(`/quote/read/${r._id}`),children:"View"})]})}];return e.jsxs("div",{style:{padding:"24px"},children:[e.jsx("div",{style:{marginBottom:"24px"},children:e.jsxs(ee,{level:3,children:[e.jsx(g,{style:{color:"#034D57",marginRight:"8px"}}),"Quote Approval Queue"]})}),e.jsxs(Y,{gutter:16,style:{marginBottom:"24px"},children:[e.jsx(f,{span:8,children:e.jsx(j,{children:e.jsx(C,{title:"Total Pending",value:S.length,valueStyle:{color:"#034D57"},prefix:e.jsx(g,{})})})}),e.jsx(f,{span:8,children:e.jsx(j,{children:e.jsx(C,{title:"Manager Approval Needed",value:_.pending_manager,valueStyle:{color:"#f59e0b"}})})}),e.jsx(f,{span:8,children:e.jsx(j,{children:e.jsx(C,{title:"Owner Approval Needed",value:_.pending_owner,valueStyle:{color:"#e53e3e"}})})})]}),e.jsx(j,{children:e.jsx(X,{columns:P,dataSource:S,loading:O,rowKey:"_id",pagination:{pageSize:20}})}),e.jsxs(G,{title:s==="approve"?"Approve Quote":"Reject Quote",open:M,onCancel:()=>{d(!1),i(""),c(null)},onOk:s==="approve"?I:L,confirmLoading:F,okText:s==="approve"?"Approve":"Reject",okButtonProps:{danger:s==="reject",style:s==="approve"?{backgroundColor:"#4CB480",borderColor:"#4CB480"}:{}},children:[a&&e.jsxs("div",{style:{marginBottom:"16px"},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Quote #:"})," ",a.number]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Client:"})," ",(b=a.client)==null?void 0:b.name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Total:"})," ",B(a.total)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Created by:"})," ",(q=a.createdBy)==null?void 0:q.name]})]}),e.jsx(te,{rows:4,placeholder:s==="approve"?"Optional approval notes...":"Required: Please provide reason for rejection",value:p,onChange:t=>i(t.target.value),required:s==="reject"})]})]})}export{fe as default};
