import{r as o,j as t}from"./index-D5UekElC.js";import{o as n}from"./omrFormat-BiSEXmPi.js";import{d as N}from"./dayjs.min-Cc9SuVrv.js";import{aG as p,ai as l,aA as U,aB as P,ar as H,ay as i}from"./IdurarOs-Czf_9sCK.js";import{F as k}from"./Table-DllBtUC2.js";import{T as h}from"./index-C32fgKEF.js";import{M as J}from"./index-gsiCY3FC.js";import{S as K}from"./index-B08isBVp.js";import{T as q}from"./index-DdtlyhfV.js";import{s as r}from"./index-DQ2R1AC0.js";import{F as V,T as W,l as Y}from"./ErpApp-BzOb2em0.js";import{P as T}from"./index-G8Gvhj4N.js";import{P as Q}from"./PlusOutlined-cr0dcF6Y.js";import{C as X}from"./CheckCircleOutlined-Dev_JTJ3.js";import"./pickAttrs-BSfxLktl.js";import"./DownOutlined-BhJP4mMa.js";import"./useClosable-B1cYkIyO.js";import"./ActionButton-CPWsPWif.js";import"./fade-CxBm_vTE.js";const{Title:Z,Text:f}=H;function m(){return{Authorization:`Bearer ${localStorage.getItem("x-auth-token")}`}}function w(){return{...m(),"Content-Type":"application/json"}}const _={draft:"default",approved:"processing",paid:"success"},I=["January","February","March","April","May","June","July","August","September","October","November","December"];function je(){const[D,F]=o.useState([]),[O,x]=o.useState(!1),[d,g]=o.useState(null),[R,j]=o.useState(!1),[A,u]=o.useState(!1),[b]=p.useForm(),c=async()=>{x(!0);const a=await fetch(i+"payrollrun/list?items=24",{headers:m()}).then(e=>e.json()).catch(()=>({}));a.success&&F(a.result||[]),x(!1)};o.useEffect(()=>{c()},[]);const M=async()=>{let a;try{a=await b.validateFields()}catch{return}j(!0);try{const e=await fetch(i+"payroll/generate",{method:"POST",headers:w(),body:JSON.stringify(a)}).then(s=>s.json());e.success?(r.success(e.message),u(!1),c()):r.error(e.message||"Failed")}finally{j(!1)}},$=async a=>{const e=await fetch(`${i}payroll/approve/${a}`,{method:"PATCH",headers:m()}).then(s=>s.json()).catch(()=>({}));e.success?(r.success(e.message),c()):r.error(e.message||"Failed")},z=async a=>{const e=await fetch(`${i}payroll/mark-paid/${a}`,{method:"PATCH",headers:w(),body:JSON.stringify({paidVia:"bank transfer"})}).then(s=>s.json()).catch(()=>({}));e.success?(r.success(e.message),c()):r.error(e.message||"Failed")},B=async(a,e,s,v,E)=>{try{const S=await fetch(`${i}payroll/payslip-pdf/${a}/${e}`,{headers:m()});if(!S.ok){r.error("PDF generation failed");return}const L=await S.blob(),C=URL.createObjectURL(L),y=document.createElement("a");y.href=C,y.download=`PaySlip-${s.replace(" ","-")}-${v}-${E}.pdf`,y.click(),URL.revokeObjectURL(C)}catch{r.error("PDF download failed")}},G=[{title:"Period",render:(a,e)=>t.jsxs(f,{strong:!0,style:{color:"#034D57"},children:[I[e.month-1]," ",e.year]})},{title:"Headcount",dataIndex:"headcount",align:"center",render:a=>t.jsx(h,{icon:t.jsx(W,{}),children:a})},{title:"Gross Pay",dataIndex:"totalGross",align:"right",render:a=>n(a)},{title:"Deductions",dataIndex:"totalDeductions",align:"right",render:a=>t.jsx("span",{style:{color:a>0?"#e53e3e":"#888"},children:n(a)})},{title:"Net Pay",dataIndex:"totalNet",align:"right",render:a=>t.jsx("strong",{style:{color:"#4CB480"},children:n(a)})},{title:"Status",dataIndex:"status",render:a=>t.jsx(h,{color:_[a],children:a==null?void 0:a.toUpperCase()})},{title:"",width:200,render:(a,e)=>t.jsxs(Y,{size:4,children:[e.status==="draft"&&t.jsx(T,{title:"Approve this payroll run?",onConfirm:()=>$(e._id),okText:"Approve",children:t.jsx(l,{size:"small",type:"primary",icon:t.jsx(X,{}),style:{background:"#034D57",borderColor:"#034D57"},children:"Approve"})}),e.status==="approved"&&t.jsx(T,{title:"Mark as paid? This will issue all pay slips.",onConfirm:()=>z(e._id),okText:"Confirm",children:t.jsx(l,{size:"small",style:{background:"#4CB480",borderColor:"#4CB480",color:"#fff"},children:"Mark Paid"})}),t.jsx(l,{size:"small",onClick:()=>g(d===e._id?null:e._id),children:d===e._id?"Close":"Pay Slips"})]})}];return t.jsxs("div",{style:{padding:24},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsx(Z,{level:4,style:{margin:0,color:"#034D57"},children:"Payroll"}),t.jsx(l,{type:"primary",icon:t.jsx(Q,{}),onClick:()=>u(!0),style:{background:"#034D57",borderColor:"#034D57"},children:"Generate Payroll"})]}),t.jsx(k,{columns:G,dataSource:D,rowKey:"_id",loading:O,size:"small",pagination:!1,expandable:{expandedRowKeys:d?[d]:[],onExpand:(a,e)=>g(s=>s===e._id?null:e._id),expandedRowRender:a=>t.jsx("div",{style:{padding:"12px 0"},children:t.jsx(k,{size:"small",pagination:!1,dataSource:a.paySlips||[],rowKey:"_id",columns:[{title:"Employee",dataIndex:"name",render:(e,s)=>t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:e}),t.jsxs(f,{type:"secondary",style:{fontSize:11},children:[s.department," · ",s.employeeId]})]})},{title:"Gross",dataIndex:"grossPay",align:"right",render:e=>n(e)},{title:"Deductions",dataIndex:"totalDeductions",align:"right",render:e=>e>0?t.jsx("span",{style:{color:"#e53e3e"},children:n(e)}):"—"},{title:"Net Pay",dataIndex:"netPay",align:"right",render:e=>t.jsx("strong",{style:{color:"#4CB480"},children:n(e)})},{title:"Status",dataIndex:"status",render:e=>t.jsx(h,{color:_[e],children:e==null?void 0:e.toUpperCase()})},{title:"PDF",render:(e,s)=>t.jsx(l,{size:"small",icon:t.jsx(V,{}),onClick:()=>B(a._id,s._id,s.name,a.month,a.year),children:"Pay Slip"})}]})})}}),t.jsx(J,{title:"Generate Payroll Run",open:A,onCancel:()=>u(!1),onOk:M,okText:"Generate",confirmLoading:R,okButtonProps:{style:{background:"#034D57",borderColor:"#034D57"}},children:t.jsxs(p,{form:b,layout:"vertical",style:{marginTop:12},children:[t.jsxs(U,{gutter:12,children:[t.jsx(P,{span:12,children:t.jsx(p.Item,{name:"month",label:"Month",rules:[{required:!0}],children:t.jsx(K,{options:I.map((a,e)=>({value:e+1,label:a})),placeholder:"Select month"})})}),t.jsx(P,{span:12,children:t.jsx(p.Item,{name:"year",label:"Year",initialValue:N().year(),rules:[{required:!0}],children:t.jsx(q,{style:{width:"100%"},min:2020,max:2100})})})]}),t.jsx(f,{type:"secondary",style:{fontSize:12},children:"Will auto-generate pay slips for all active employees based on their salary and attendance deductions for this month."})]})})]})}export{je as default};
