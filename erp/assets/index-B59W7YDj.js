import{r,j as e}from"./index-BcNLKCvS.js";import{u as A}from"./useMoney--idTMigE.js";import{g as M}from"./ErpApp-Dinm6x2K.js";import{c as T}from"./calculate-CoT1A6Sl.js";import{z as $,Z as z,a as k,$ as U,U as L,c as V,aB as W,aC as I,aH as f,aD as F,aE as R,az as G}from"./IdurarOs-Bnu_4kQ9.js";import{S as b}from"./index-CHNYwYGg.js";import{T as O}from"./index-Dez4e4gY.js";import{D as H}from"./DeleteOutlined-BlGNdGyB.js";const{Option:E}=b;function q(t){return t&&t.type&&(t.type.isSelectOption||t.type.isSelectOptGroup)}const K=(t,g)=>{var l;const{prefixCls:m,className:y,popupClassName:x,dropdownClassName:d,children:u,dataSource:p}=t,a=$(u);let S;a.length===1&&z(a[0])&&!q(a[0])&&([S]=a);const _=S?()=>S:void 0;let h;a.length&&q(a[0])?h=u:h=p?p.map(c=>{if(z(c))return c;switch(typeof c){case"string":return r.createElement(E,{key:c,value:c},c);case"object":{const{value:N}=c;return r.createElement(E,{key:N,value:N},c.text)}default:return}}):[];const{getPrefixCls:C}=r.useContext(k),j=C("select",m),[o]=U("SelectLike",(l=t.dropdownStyle)===null||l===void 0?void 0:l.zIndex);return r.createElement(b,Object.assign({ref:g,suffixIcon:null},L(t,["dataSource","dropdownClassName"]),{prefixCls:j,popupClassName:x||d,dropdownStyle:Object.assign(Object.assign({},t.dropdownStyle),{zIndex:o}),className:V(`${j}-auto-complete`,y),mode:b.SECRET_COMBOBOX_MODE_DO_NOT_USE,getInputElement:_}),h)},w=r.forwardRef(K),Q=M(w);w.Option=E;w._InternalPanelDoNotUseOrYouWillBeFired=Q;function Z(){return{Authorization:`Bearer ${((JSON.parse(localStorage.getItem("auth"))||{}).current||{}).token}`}}function oe({field:t,remove:g,current:l=null,form:m}){const[y,x]=r.useState(void 0),[d,u]=r.useState(0),[p,a]=r.useState(0),[S,_]=r.useState([]),[h,C]=r.useState(!1),j=r.useRef(null),o=A(),c=s=>{a(s)},N=s=>{u(s)};r.useEffect(()=>{if(l){const{items:s,invoice:i}=l,n=i?i[t.fieldKey]:s==null?void 0:s[t.fieldKey];n&&(a(n.quantity),u(n.price))}},[l]),r.useEffect(()=>{x(T.multiply(d,p))},[d,p]);const B=s=>{if(j.current&&clearTimeout(j.current),!s||s.length<2){_([]);return}j.current=setTimeout(async()=>{C(!0);try{const i=await fetch(G+`product/search?q=${encodeURIComponent(s)}`,{headers:Z()}).then(n=>n.json());i.success&&_((i.result||[]).map(n=>({value:n.name,label:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:600},children:n.name}),n.partNumber&&e.jsx("span",{style:{color:"#888",fontSize:11,marginLeft:6},children:n.partNumber}),n.description&&e.jsx("div",{style:{fontSize:11,color:"#aaa"},children:n.description.slice(0,60)})]}),e.jsx("span",{style:{color:"#034D57",fontWeight:700,fontSize:12,whiteSpace:"nowrap",marginLeft:8},children:parseFloat(n.salePrice||0).toFixed(3)})]}),_product:n})))}finally{C(!1)}},300)},D=(s,i)=>{var P;if(!(i!=null&&i._product)||!m)return;const n=i._product,v=m.getFieldValue("items")||[];v[t.name]={...v[t.name],itemName:n.name,description:n.description||"",price:n.salePrice||0},m.setFieldsValue({items:v}),u(n.salePrice||0),a(((P=v[t.name])==null?void 0:P.quantity)||1)};return e.jsxs(W,{gutter:[12,12],style:{position:"relative"},children:[e.jsx(I,{className:"gutter-row",span:5,children:e.jsx(f.Item,{name:[t.name,"itemName"],rules:[{required:!0,message:"Missing item name"},{pattern:/^(?!\s*$)[\s\S]+$/,message:"Item name required"}],children:e.jsx(w,{options:S,onSearch:B,onSelect:D,notFoundContent:h?e.jsx(F,{size:"small"}):null,dropdownMatchSelectWidth:340,children:e.jsx(R,{placeholder:"Item name (type to search catalog)",suffix:h?e.jsx(F,{size:"small"}):null})})})}),e.jsx(I,{className:"gutter-row",span:7,children:e.jsx(f.Item,{name:[t.name,"description"],children:e.jsx(R,{placeholder:"Description"})})}),e.jsx(I,{className:"gutter-row",span:3,children:e.jsx(f.Item,{name:[t.name,"quantity"],rules:[{required:!0}],children:e.jsx(O,{style:{width:"100%"},min:0,onChange:c})})}),e.jsx(I,{className:"gutter-row",span:4,children:e.jsx(f.Item,{name:[t.name,"price"],rules:[{required:!0}],children:e.jsx(O,{className:"moneyInput",onChange:N,min:0,controls:!1,addonAfter:o.currency_position==="after"?o.currency_symbol:void 0,addonBefore:o.currency_position==="before"?o.currency_symbol:void 0})})}),e.jsx(I,{className:"gutter-row",span:5,children:e.jsx(f.Item,{name:[t.name,"total"],children:e.jsx(f.Item,{children:e.jsx(O,{readOnly:!0,className:"moneyInput",value:y,min:0,controls:!1,addonAfter:o.currency_position==="after"?o.currency_symbol:void 0,addonBefore:o.currency_position==="before"?o.currency_symbol:void 0,formatter:s=>o.amountFormatter({amount:s,currency_code:o.currency_code})})})})}),e.jsx("div",{style:{position:"absolute",right:"-20px",top:"5px"},children:e.jsx(H,{onClick:()=>g(t.name)})})]})}function ae({updatePrice:t,value:g=0,readOnly:l=!1}){const{amountFormatter:m,currency_symbol:y,currency_position:x,cent_precision:d,currency_code:u}=A();return e.jsx(f.Item,{children:e.jsx(O,{readOnly:l,className:"moneyInput",onChange:t,precision:d||2,value:m({amount:g,currency_code:u}),controls:!1,addonAfter:x==="after"?y:void 0,addonBefore:x==="before"?y:void 0,formatter:p=>m({amount:p,currency_code:u})})})}export{oe as I,ae as M};
